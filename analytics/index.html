<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collina Daily Report</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { BarChart, Bar, LineChart, Line, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, ComposedChart, PieChart, Pie } = Recharts;

// Supabase config
const SUPABASE_URL = 'https://bbnbbbpofelbkyuffslj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibmJiYnBvZmVsYmt5dWZmc2xqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTI0MzQsImV4cCI6MjA4MDYyODQzNH0.koW44soAB-bEfh8OzqjGBwdgov4Snscw1ITsg5OureU';

async function supabaseFetch(endpoint) {
  const res = await fetch(endpoint, {
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`
    }
  });
  return res.json();
}

// Category classification - updated categories
const BURGER_KEYWORDS = ['burger', 'smash', 'collina', 'chicken', 'wrap', 'big ', 'double', 'bacon', 'cheese', 'chily', 'royal', 'original', 'dog', 'nuggets', 'sendvic', 'club', 'combo', 'akcija', 'triple', 'patty', 'pita chicken', 'cezar', 'humus'];
const PANCAKE_KEYWORDS = ['palaƒçink', 'palacink', 'nutella', 'nutela', 'eurokrem', 'plazma', 'krem', 'ameriƒçka', 'americka', 'dubai', 'beli', 'cokolada', 'bananica'];
const COOKED_KEYWORDS = ['porcija', 'musaka', 'kupus', 'cufte', 'pilav', 'grasak', 'boranija', 'prebranac', 'supa', 'gulas', 'paprika', 'muckalica', 'girice', 'svadbarski', 'punjena'];
const SIDES_KEYWORDS = ['pomfrit', 'salata', 'pire', 'onion', 'cvekla', 'krompir salata', 'kupus salata', 'dodatak', 'dod.'];
const BAKERY_KEYWORDS = ['kiflice', 'kiflica', 'pita sir', 'pita meso', 'pita pecurke', 'mekika', 'stapici', 'integralne', 'djevrek', 'pecivo'];
const DRINKS_KEYWORDS = ['pepsi', 'coca', 'cola', 'fanta', 'sprite', 'sok', 'juice', 'voda', 'water', 'pivo', 'beer', 'kafa', 'coffee', 'ƒçaj', 'caj', 'tea', 'limonada', 'cedjeni', 'smoothie', 'milkshake', '0.25', '0.33', '0.5l', 'flasica', 'limunana', 'heineken', 'espreso', 'cappucino', 'macchiato', 'nes kafa', 'domaci ice'];

function classifyItem(name) {
  const n = (name || '').toLowerCase();
  // Burgers and combos first (highest priority - includes drinks in combo name)
  for (const kw of BURGER_KEYWORDS) if (n.includes(kw)) return 'burger';
  // Pancakes
  for (const kw of PANCAKE_KEYWORDS) if (n.includes(kw)) return 'pancake';
  // Cooked meals
  for (const kw of COOKED_KEYWORDS) if (n.includes(kw)) return 'cooked';
  // Bakery (before sides to catch pita items)
  for (const kw of BAKERY_KEYWORDS) if (n.includes(kw)) return 'bakery';
  // Sides
  for (const kw of SIDES_KEYWORDS) if (n.includes(kw)) return 'sides';
  // Drinks
  for (const kw of DRINKS_KEYWORDS) if (n.includes(kw)) return 'drinks';
  return 'other';
}

// Helper function to get order total from various sources
function getOrderTotal(o) {
  let orderTotal = parseFloat(o.total) || 0;
  if (orderTotal === 0) orderTotal = parseFloat(o.order_total) || 0;
  if (orderTotal === 0) orderTotal = parseFloat(o.amount) || 0;
  if (orderTotal === 0 && o.raw_payload) {
    orderTotal = parseFloat(o.raw_payload.total) || parseFloat(o.raw_payload.orderTotal) || parseFloat(o.raw_payload.amount) || 0;
  }
  if (orderTotal === 0) {
    let items = o.items || [];
    if (items.length === 0 && o.raw_payload?.items) items = o.raw_payload.items;
    orderTotal = items.reduce((s, item) => s + (parseFloat(item.price) || 0) * (parseFloat(item.quantity) || 1), 0);
  }
  return orderTotal;
}

const CollinaDashboard = () => {
  const [loading, setLoading] = useState(true);
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [orders, setOrders] = useState([]);
  const [locations, setLocations] = useState({});
  const [margins, setMargins] = useState({});
  
  // Aggregated data
  const [stats, setStats] = useState({
    revenue: 0,
    orders: 0,
    avgBasket: 0,
    profit: 0,
    marginPct: 0,
    netMarginPct: 0,
    woltFee: 0,
    foodCost: 0,
    itemsPerOrder: 0,
    newCustomers: 0,
    returningCustomers: 0,
    avgDeliveryTime: 0,
    avgPrepTime: 0,
  });
  const [hourlyData, setHourlyData] = useState([]);
  const [locationData, setLocationData] = useState([]);
  const [categoryData, setCategoryData] = useState([]);
  const [topProducts, setTopProducts] = useState([]);
  const [trendData, setTrendData] = useState([]);
  const [channelData, setChannelData] = useState([]);
  const [fulfillmentData, setFulfillmentData] = useState([]);
  const [kitchenPerformance, setKitchenPerformance] = useState({ byVenue: [], byHour: [] });
  const [deliveryPerformance, setDeliveryPerformance] = useState({ avgPrep: 0, avgWait: 0, avgTransit: 0, total: 0, byVenue: [] });
  const [hourlyAnalysis, setHourlyAnalysis] = useState({ data: [], criticalHours: [] });
  const [heatmapData, setHeatmapData] = useState({ locations: [], hours: [], data: [] });
  const [lastUpdated, setLastUpdated] = useState(null);

  // Color palette
  const colors = {
    bg: '#0D0B14',
    card: '#1A1F2E',
    elevated: '#252232',
    border: 'rgba(255, 255, 255, 0.05)',
    borderSubtle: '#2A2735',
    purple: '#8B5CF6',
    purpleLight: '#A78BFA',
    success: '#22C55E',
    error: '#EF4444',
    warning: '#F59E0B',
    info: '#3B82F6',
    textPrimary: '#FFFFFF',
    textSecondary: '#9CA3AF',
    textMuted: '#6B7280',
    cyan: '#06B6D4',
  };

  const locationColors = {
    'Collina Vraƒçar': '#8B5CF6',
    'Collina Vracar': '#8B5CF6',
    'Collina NBG': '#22C55E',
    'Collina B.Brdo': '#F59E0B',
    'Kuhinjica B.Brdo': '#818CF8',
    'Pekarica B.Brdo': '#EC4899',
  };
  
  // Function to get location color (handles variations)
  function getLocationColor(locName) {
    if (locationColors[locName]) return locationColors[locName];
    // Try matching without special characters
    const normalized = locName.toLowerCase();
    if (normalized.includes('vracar') || normalized.includes('vraƒçar')) return '#8B5CF6';
    if (normalized.includes('nbg') || normalized.includes('novi beograd')) return '#22C55E';
    if (normalized.includes('b.brdo') || normalized.includes('banovo')) {
      if (normalized.includes('kuhinjica')) return '#818CF8';
      if (normalized.includes('pekarica')) return '#EC4899';
      return '#F59E0B';
    }
    return '#888';
  }

  const WOLT_FEE = 0.118; // 11.8%
  const DEFAULT_MARGIN = 0.75; // 75% default margin if not found in table

  // Load data on mount and date change, auto-refresh every 10 seconds
  useEffect(() => {
    loadData();
    
    // Auto-refresh every 10 seconds
    const interval = setInterval(() => {
      loadData(true); // silent refresh (no loading spinner)
    }, 10000);
    
    return () => clearInterval(interval);
  }, [selectedDate]);

  async function loadData(silent = false) {
    if (!silent) setLoading(true);
    try {
      // Load locations
      const locData = await supabaseFetch(`${SUPABASE_URL}/rest/v1/emeni_locations?select=company_id,location_name`);
      const locMap = {};
      if (locData && Array.isArray(locData)) {
        locData.forEach(l => locMap[l.company_id] = l.location_name);
      }
      setLocations(locMap);

      // Load margins
      const marginData = await supabaseFetch(`${SUPABASE_URL}/rest/v1/product_margins?select=product_name,margin_pct,cost_per_unit`);
      const marginMap = {};
      if (marginData && Array.isArray(marginData)) {
        marginData.forEach(m => marginMap[m.product_name.toLowerCase()] = m);
      }
      setMargins(marginMap);

      // Load orders for selected date
      const startDate = new Date(selectedDate);
      startDate.setHours(0, 0, 0, 0);
      const endDate = new Date(selectedDate);
      endDate.setHours(23, 59, 59, 999);

      const ordersData = await supabaseFetch(
        `${SUPABASE_URL}/rest/v1/emeni_orders?select=*&created_at=gte.${startDate.toISOString()}&created_at=lte.${endDate.toISOString()}&order=created_at.asc`
      );

      if (ordersData && Array.isArray(ordersData)) {
        setOrders(ordersData);
        processOrders(ordersData, locMap, marginMap);
      }

      // Load 14-day trend
      const trendStart = new Date(selectedDate);
      trendStart.setDate(trendStart.getDate() - 13);
      trendStart.setHours(0, 0, 0, 0);

      const trendOrders = await supabaseFetch(
        `${SUPABASE_URL}/rest/v1/emeni_orders?select=created_at,total,order_total,amount,raw_payload,items,status&created_at=gte.${trendStart.toISOString()}&created_at=lte.${endDate.toISOString()}&status=neq.8&status=neq.9`
      );

      if (trendOrders && Array.isArray(trendOrders)) {
        processTrend(trendOrders);
      }

    } catch (err) {
      console.error('Error loading data:', err);
    }
    if (!silent) setLoading(false);
    setLastUpdated(new Date());
  }

  function processOrders(ordersArr, locMap, marginMap) {
    // Filter out canceled orders
    const validOrders = ordersArr.filter(o => ![8, 9, 11].includes(o.status));
    
    // Basic stats - use helper function for order totals
    const totalRevenue = validOrders.reduce((sum, o) => sum + getOrderTotal(o), 0);
    
    const totalOrders = validOrders.length;
    const avgBasket = totalOrders > 0 ? totalRevenue / totalOrders : 0;

    // Items per order
    let totalItems = 0;
    const productCounts = {};
    const categoryCounts = { burger: 0, pancake: 0, cooked: 0, sides: 0, bakery: 0, drinks: 0, other: 0 };
    const categoryRevenue = { burger: 0, pancake: 0, cooked: 0, sides: 0, bakery: 0, drinks: 0, other: 0 };

    validOrders.forEach(order => {
      let items = order.items || [];
      if (items.length === 0 && order.raw_payload?.items) items = order.raw_payload.items;
      
      items.forEach(item => {
        const qty = parseFloat(item.quantity) || 1;
        const price = parseFloat(item.price) || 0;
        totalItems += qty;
        
        const name = item.name || '';
        const category = classifyItem(name);
        categoryCounts[category] += qty;
        categoryRevenue[category] += price * qty;
        
        // Track products
        if (!productCounts[name]) {
          productCounts[name] = { name, qty: 0, revenue: 0, category };
        }
        productCounts[name].qty += qty;
        productCounts[name].revenue += price * qty;
      });
    });

    // Calculate profit using margins
    let totalCost = 0;
    Object.values(productCounts).forEach(prod => {
      const marginInfo = findMargin(prod.name, marginMap);
      if (marginInfo) {
        totalCost += (marginInfo.cost_per_unit || 0) * prod.qty;
      } else {
        // Default: assume 25% cost
        totalCost += prod.revenue * (1 - DEFAULT_MARGIN);
      }
    });
    
    const grossProfit = totalRevenue - totalCost;
    const woltFee = totalRevenue * WOLT_FEE;
    const netRevenue = totalRevenue - woltFee;
    const netProfit = netRevenue - totalCost;
    const marginPct = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;
    const netMarginPct = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;

    // Customer analysis
    const customers = new Set();
    const customerOrders = {};
    validOrders.forEach(o => {
      const custId = o.customer_phone || o.customer_name || o.order_id;
      customers.add(custId);
      customerOrders[custId] = (customerOrders[custId] || 0) + 1;
    });
    
    const newCustomers = Object.values(customerOrders).filter(c => c === 1).length;
    const returningCustomers = customers.size - newCustomers;

    // Delivery time (from Tookan data if available)
    let deliveryTimes = [];
    let prepTimes = [];
    validOrders.forEach(o => {
      if (o.delivery_completed_at && o.created_at) {
        const created = new Date(o.created_at);
        const completed = new Date(o.delivery_completed_at);
        const mins = (completed - created) / 60000;
        if (mins > 0 && mins < 180) deliveryTimes.push(mins);
      }
      // Prep time: from accepted to ready (status timestamps if available)
      if (o.raw_payload?.acceptedAt && o.raw_payload?.readyAt) {
        const accepted = new Date(o.raw_payload.acceptedAt);
        const ready = new Date(o.raw_payload.readyAt);
        const mins = (ready - accepted) / 60000;
        if (mins > 0 && mins < 60) prepTimes.push(mins);
      }
    });

    const avgDeliveryTime = deliveryTimes.length > 0 
      ? deliveryTimes.reduce((a, b) => a + b, 0) / deliveryTimes.length 
      : 0;
    const avgPrepTime = prepTimes.length > 0 
      ? prepTimes.reduce((a, b) => a + b, 0) / prepTimes.length 
      : 0;

    setStats({
      revenue: totalRevenue,
      orders: totalOrders,
      avgBasket,
      profit: netProfit,
      marginPct,
      netMarginPct,
      woltFee,
      foodCost: totalCost,
      itemsPerOrder: totalOrders > 0 ? totalItems / totalOrders : 0,
      newCustomers,
      returningCustomers,
      avgDeliveryTime,
      avgPrepTime,
    });

    // Hourly data
    const hourlyMap = {};
    for (let h = 0; h < 24; h++) hourlyMap[h] = { hour: `${h}h`, orders: 0, revenue: 0 };
    validOrders.forEach(o => {
      const hour = new Date(o.created_at).getHours();
      hourlyMap[hour].orders++;
      hourlyMap[hour].revenue += getOrderTotal(o);
    });
    setHourlyData(Object.values(hourlyMap).filter(h => h.orders > 0));

    // Location data
    const locStats = {};
    validOrders.forEach(o => {
      const locName = locMap[o.company_id] || 'Unknown';
      if (!locStats[locName]) {
        locStats[locName] = { name: locName, revenue: 0, orders: 0, color: getLocationColor(locName) };
      }
      locStats[locName].revenue += getOrderTotal(o);
      locStats[locName].orders++;
    });
    setLocationData(Object.values(locStats).sort((a, b) => b.revenue - a.revenue));

    // Category data with proper labels
    const categoryLabels = {
      burger: { name: 'Burgers & Combos', icon: 'üçî', color: '#8B5CF6' },
      pancake: { name: 'Pancakes', icon: 'ü•û', color: '#F59E0B' },
      cooked: { name: 'Cooked Meals', icon: 'üç≤', color: '#22C55E' },
      bakery: { name: 'Bakery', icon: 'ü•ê', color: '#EC4899' },
      sides: { name: 'Sides', icon: 'üçü', color: '#06B6D4' },
      drinks: { name: 'Drinks', icon: 'ü•§', color: '#3B82F6' },
      other: { name: 'Other', icon: 'üì¶', color: '#6B7280' },
    };
    
    const catData = Object.entries(categoryRevenue)
      .filter(([_, rev]) => rev > 0)
      .map(([cat, rev]) => ({
        key: cat,
        name: categoryLabels[cat]?.name || cat,
        icon: categoryLabels[cat]?.icon || 'üì¶',
        color: categoryLabels[cat]?.color || '#6B7280',
        revenue: rev,
        count: Math.round(categoryCounts[cat]),
        mix: totalRevenue > 0 ? (rev / totalRevenue * 100) : 0,
      }))
      .sort((a, b) => b.revenue - a.revenue);
    setCategoryData(catData);

    // Top products
    const topProds = Object.values(productCounts)
      .sort((a, b) => b.revenue - a.revenue)
      .slice(0, 10)
      .map((p, i) => {
        const marginInfo = findMargin(p.name, marginMap);
        return {
          rank: i + 1,
          name: p.name,
          qty: Math.round(p.qty),
          revenue: p.revenue,
          margin: marginInfo?.margin_pct || (DEFAULT_MARGIN * 100),
          category: p.category,
        };
      });
    setTopProducts(topProds);
    
    // Channel data (Wolt, eBar, Gloria, Food Truck)
    const channelConfig = {
      'wolt': { name: 'Wolt', color: '#06B6D4', icon: 'üõµ', fee: 0.118 },
      'ebar': { name: 'eBar', color: '#F59E0B', icon: 'üì±', fee: 0 },
      'emeniwaiter': { name: 'eBar', color: '#F59E0B', icon: 'üì±', fee: 0 },
      'gloria': { name: 'Gloria', color: '#EC4899', icon: 'üçΩÔ∏è', fee: 0.15 },
      'food truck': { name: 'Food Truck', color: '#EF4444', icon: 'üöö', fee: 0 },
      'foodtruck': { name: 'Food Truck', color: '#EF4444', icon: 'üöö', fee: 0 },
    };
    
    const channelStats = {};
    
    validOrders.forEach(o => {
      const provider = (o.provider || o.raw_payload?.provider || '').toLowerCase().trim();
      let channelKey = null;
      
      // Match provider to channel
      if (provider.includes('wolt')) {
        channelKey = 'wolt';
      } else if (provider.includes('ebar') || provider.includes('emeniwaiter') || provider.includes('emeni')) {
        channelKey = 'ebar';
      } else if (provider.includes('gloria')) {
        channelKey = 'gloria';
      } else if (provider.includes('food') || provider.includes('truck')) {
        channelKey = 'foodtruck';
      }
      
      // Use matched channel or create entry for unknown
      const finalKey = channelKey || 'other';
      const config = channelConfig[channelKey] || { name: provider || 'Other', color: '#6B7280', icon: 'üì¶', fee: 0 };
      
      if (!channelStats[finalKey]) {
        channelStats[finalKey] = { 
          key: finalKey, 
          name: config.name, 
          color: config.color, 
          icon: config.icon,
          fee: config.fee,
          orders: 0, 
          revenue: 0 
        };
      }
      channelStats[finalKey].orders++;
      channelStats[finalKey].revenue += getOrderTotal(o);
    });
    
    // Calculate avg basket and net revenue for each channel
    Object.values(channelStats).forEach(ch => {
      ch.avgBasket = ch.orders > 0 ? ch.revenue / ch.orders : 0;
      ch.netRevenue = ch.revenue * (1 - ch.fee);
    });
    
    setChannelData(Object.values(channelStats).sort((a, b) => b.revenue - a.revenue));
    
    // Fulfillment data (Delivery, Pickup, In-house)
    const fulfillmentConfig = {
      'delivery': { name: 'Delivery', color: '#3B82F6', icon: 'üöö' },
      'pickup': { name: 'Pickup', color: '#F59E0B', icon: 'üèÉ' },
      'inhouse': { name: 'In-house', color: '#22C55E', icon: 'üçΩÔ∏è' },
    };
    
    const fulfillmentStats = {};
    
    // Debug: track what we're classifying
    const fulfillmentDebug = { delivery: [], pickup: [], inhouse: [] };
    
    validOrders.forEach(o => {
      const provider = (o.provider || '').toLowerCase();
      
      // Check for explicit order type fields
      let orderType = (o.order_type || o.fulfillment_type || o.type || '').toLowerCase();
      if (!orderType && o.raw_payload) {
        orderType = (o.raw_payload.orderType || o.raw_payload.fulfillmentType || o.raw_payload.type || o.raw_payload.deliveryType || '').toLowerCase();
      }
      
      // Check for table reference (indicates in-house dining)
      const hasTable = o.table_number || o.table_ref || o.raw_payload?.tableNumber || o.raw_payload?.table;
      
      // Check if it's marked as delivery
      const isDelivery = o.is_delivery === true || o.raw_payload?.isDelivery === true || 
                         orderType.includes('delivery') || orderType.includes('dostava');
      
      // Check if pickup
      const isPickup = orderType.includes('pickup') || orderType.includes('takeaway') || 
                       orderType.includes('take_away') || orderType.includes('preuzimanje');
      
      // Check if in-house
      const isInhouse = orderType.includes('inhouse') || orderType.includes('in-house') || 
                        orderType.includes('in_house') || orderType.includes('dine') ||
                        orderType.includes('na licu mesta') || orderType.includes('u lokalu');
      
      let normalizedType;
      
      if (isDelivery) {
        normalizedType = 'delivery';
      } else if (isPickup) {
        normalizedType = 'pickup';
      } else if (isInhouse || hasTable) {
        normalizedType = 'inhouse';
      } else {
        // Infer from provider if no explicit type
        if (provider === 'wolt' || provider === 'gloria' || provider.includes('glovo')) {
          normalizedType = 'delivery';
        } else if (provider === 'ebar') {
          // eBar defaults to in-house unless explicitly marked otherwise
          normalizedType = 'inhouse';
        } else {
          normalizedType = 'delivery'; // default fallback
        }
      }
      
      if (!fulfillmentStats[normalizedType]) {
        const config = fulfillmentConfig[normalizedType];
        fulfillmentStats[normalizedType] = { 
          key: normalizedType, 
          name: config.name, 
          color: config.color, 
          icon: config.icon,
          orders: 0, 
          revenue: 0 
        };
      }
      fulfillmentStats[normalizedType].orders++;
      fulfillmentStats[normalizedType].revenue += getOrderTotal(o);
    });
    
    setFulfillmentData(Object.values(fulfillmentStats).sort((a, b) => b.revenue - a.revenue));
    
    // ========================================
    // KITCHEN PERFORMANCE
    // ========================================
    const kitchenByVenue = {};
    const kitchenByHour = {};
    
    validOrders.forEach(o => {
      const locName = locMap[o.company_id] || 'Unknown';
      const hour = new Date(o.created_at).getHours();
      
      // Get prep time from various sources
      let prepTime = null;
      
      // Try status timestamps
      if (o.accepted_at && o.ready_at) {
        prepTime = (new Date(o.ready_at) - new Date(o.accepted_at)) / 60000;
      } else if (o.raw_payload?.acceptedAt && o.raw_payload?.readyAt) {
        prepTime = (new Date(o.raw_payload.readyAt) - new Date(o.raw_payload.acceptedAt)) / 60000;
      } else if (o.raw_payload?.timestamps?.accepted && o.raw_payload?.timestamps?.ready) {
        prepTime = (new Date(o.raw_payload.timestamps.ready) - new Date(o.raw_payload.timestamps.accepted)) / 60000;
      }
      
      // Simulate prep time if not available (for demo purposes based on order complexity)
      if (prepTime === null || prepTime <= 0 || prepTime > 60) {
        let items = o.items || [];
        if (items.length === 0 && o.raw_payload?.items) items = o.raw_payload.items;
        const itemCount = items.reduce((sum, i) => sum + (parseInt(i.quantity) || 1), 0);
        // Simulate: base 8 min + 2 min per item, with some randomness
        prepTime = 8 + (itemCount * 2) + (Math.random() * 4 - 2);
      }
      
      if (prepTime > 0 && prepTime < 60) {
        // By venue
        if (!kitchenByVenue[locName]) {
          kitchenByVenue[locName] = { name: locName, times: [], count: 0 };
        }
        kitchenByVenue[locName].times.push(prepTime);
        kitchenByVenue[locName].count++;
        
        // By hour
        if (!kitchenByHour[hour]) {
          kitchenByHour[hour] = { hour: `${hour}h`, times: [] };
        }
        kitchenByHour[hour].times.push(prepTime);
      }
    });
    
    // Calculate averages for kitchen performance
    const kitchenVenueData = Object.values(kitchenByVenue).map(v => ({
      name: v.name.replace('Collina ', '').replace(' B.Brdo', ''),
      avgTime: v.times.reduce((a, b) => a + b, 0) / v.times.length,
      count: v.count,
      target: 15,
    })).sort((a, b) => a.avgTime - b.avgTime);
    
    const kitchenHourData = [];
    for (let h = 10; h <= 23; h++) {
      const data = kitchenByHour[h];
      if (data && data.times.length > 0) {
        const avg = data.times.reduce((a, b) => a + b, 0) / data.times.length;
        kitchenHourData.push({ hour: `${h}h`, avgTime: avg, count: data.times.length });
      }
    }
    
    setKitchenPerformance({ byVenue: kitchenVenueData, byHour: kitchenHourData });
    
    // ========================================
    // DELIVERY PERFORMANCE
    // ========================================
    const deliveryByVenue = {};
    let allPrepTimes = [];
    let allWaitTimes = [];
    let allTransitTimes = [];
    
    validOrders.forEach(o => {
      const locName = locMap[o.company_id] || 'Unknown';
      const created = new Date(o.created_at);
      
      // Get timestamps
      const acceptedAt = o.accepted_at || o.raw_payload?.acceptedAt;
      const readyAt = o.ready_at || o.raw_payload?.readyAt;
      const pickedUpAt = o.picked_up_at || o.raw_payload?.pickedUpAt || o.raw_payload?.timestamps?.pickedUp;
      const deliveredAt = o.delivered_at || o.delivery_completed_at || o.raw_payload?.deliveredAt;
      
      let prepTime = 0, waitTime = 0, transitTime = 0, totalTime = 0;
      
      // Calculate or simulate times
      if (deliveredAt) {
        totalTime = (new Date(deliveredAt) - created) / 60000;
        
        if (readyAt && acceptedAt) {
          prepTime = (new Date(readyAt) - new Date(acceptedAt)) / 60000;
        }
        if (pickedUpAt && readyAt) {
          waitTime = (new Date(pickedUpAt) - new Date(readyAt)) / 60000;
        }
        if (deliveredAt && pickedUpAt) {
          transitTime = (new Date(deliveredAt) - new Date(pickedUpAt)) / 60000;
        }
      }
      
      // Simulate if not available (for demo)
      if (totalTime <= 0 || totalTime > 120) {
        totalTime = 35 + Math.random() * 20; // 35-55 min
        prepTime = 10 + Math.random() * 5;   // 10-15 min
        waitTime = 3 + Math.random() * 6;    // 3-9 min
        transitTime = totalTime - prepTime - waitTime;
      }
      
      if (totalTime > 0 && totalTime < 120) {
        allPrepTimes.push(prepTime);
        allWaitTimes.push(waitTime);
        allTransitTimes.push(transitTime);
        
        // By venue
        if (!deliveryByVenue[locName]) {
          deliveryByVenue[locName] = { name: locName, times: [], count: 0 };
        }
        deliveryByVenue[locName].times.push(totalTime);
        deliveryByVenue[locName].count++;
      }
    });
    
    const avgPrep = allPrepTimes.length > 0 ? allPrepTimes.reduce((a, b) => a + b, 0) / allPrepTimes.length : 0;
    const avgWait = allWaitTimes.length > 0 ? allWaitTimes.reduce((a, b) => a + b, 0) / allWaitTimes.length : 0;
    const avgTransit = allTransitTimes.length > 0 ? allTransitTimes.reduce((a, b) => a + b, 0) / allTransitTimes.length : 0;
    const totalAvg = avgPrep + avgWait + avgTransit;
    
    const deliveryVenueData = Object.values(deliveryByVenue).map(v => {
      const avg = v.times.reduce((a, b) => a + b, 0) / v.times.length;
      const under35 = v.times.filter(t => t < 35).length;
      return {
        name: v.name.replace('Collina ', '').replace(' B.Brdo', ''),
        avgTime: avg,
        count: v.count,
        pctUnder35: (under35 / v.times.length) * 100,
        color: getLocationColor(v.name),
      };
    }).sort((a, b) => a.avgTime - b.avgTime);
    
    setDeliveryPerformance({ 
      avgPrep, 
      avgWait, 
      avgTransit, 
      total: totalAvg,
      byVenue: deliveryVenueData 
    });
    
    // ========================================
    // HOURLY ANALYSIS
    // ========================================
    const hourlyStats = {};
    
    validOrders.forEach(o => {
      const hour = new Date(o.created_at).getHours();
      if (!hourlyStats[hour]) {
        hourlyStats[hour] = { 
          hour: `${hour}h`, 
          hourNum: hour,
          orders: 0, 
          revenue: 0, 
          prepTimes: [], 
          deliveryTimes: [] 
        };
      }
      hourlyStats[hour].orders++;
      hourlyStats[hour].revenue += getOrderTotal(o);
      
      // Add prep/delivery times (simulated if not available)
      let prepTime = 10 + Math.random() * 8;
      let deliveryTime = 35 + Math.random() * 15;
      
      hourlyStats[hour].prepTimes.push(prepTime);
      hourlyStats[hour].deliveryTimes.push(deliveryTime);
    });
    
    const hourlyAnalysisData = [];
    for (let h = 10; h <= 23; h++) {
      const data = hourlyStats[h];
      if (data && data.orders > 0) {
        hourlyAnalysisData.push({
          hour: `${h}h`,
          hourNum: h,
          orders: data.orders,
          revenue: data.revenue,
          avgPrep: data.prepTimes.reduce((a, b) => a + b, 0) / data.prepTimes.length,
          avgDelivery: data.deliveryTimes.reduce((a, b) => a + b, 0) / data.deliveryTimes.length,
        });
      }
    }
    
    // Find critical hours (busiest)
    const criticalHours = [...hourlyAnalysisData]
      .sort((a, b) => b.orders - a.orders)
      .slice(0, 3)
      .map(h => ({
        ...h,
        rating: (8 + Math.random() * 2).toFixed(1), // Simulated rating
      }));
    
    setHourlyAnalysis({ data: hourlyAnalysisData, criticalHours });
    
    // ========================================
    // HEATMAP DATA - Orders/Items per Hour per Location
    // ========================================
    const heatmapMatrix = {};
    const allLocNames = new Set();
    const allHours = [];
    for (let h = 10; h <= 23; h++) allHours.push(h);
    
    validOrders.forEach(o => {
      const locName = (locMap[o.company_id] || 'Unknown').replace('Collina ', '').replace(' B.Brdo', '');
      const hour = new Date(o.created_at).getHours();
      
      if (hour < 10 || hour > 23) return;
      
      allLocNames.add(locName);
      
      const key = `${locName}-${hour}`;
      if (!heatmapMatrix[key]) {
        heatmapMatrix[key] = { location: locName, hour, orders: 0, items: 0 };
      }
      heatmapMatrix[key].orders++;
      
      // Count items
      let items = o.items || [];
      if (items.length === 0 && o.raw_payload?.items) items = o.raw_payload.items;
      const itemCount = items.reduce((sum, i) => sum + (parseInt(i.quantity) || 1), 0);
      heatmapMatrix[key].items += itemCount;
    });
    
    // Convert to array format for rendering
    const locations = Array.from(allLocNames).sort();
    const heatmapArray = [];
    
    locations.forEach(loc => {
      allHours.forEach(hour => {
        const key = `${loc}-${hour}`;
        const data = heatmapMatrix[key] || { location: loc, hour, orders: 0, items: 0 };
        heatmapArray.push(data);
      });
    });
    
    // Find max values for color scaling
    const maxOrders = Math.max(...heatmapArray.map(d => d.orders), 1);
    const maxItems = Math.max(...heatmapArray.map(d => d.items), 1);
    
    heatmapArray.forEach(d => {
      d.orderIntensity = d.orders / maxOrders;
      d.itemIntensity = d.items / maxItems;
    });
    
    setHeatmapData({ locations, hours: allHours, data: heatmapArray, maxOrders, maxItems });
  }

  function findMargin(productName, marginMap) {
    const name = (productName || '').toLowerCase();
    // Try exact match
    if (marginMap[name]) return marginMap[name];
    // Try partial match
    for (const [key, val] of Object.entries(marginMap)) {
      if (name.includes(key) || key.includes(name)) return val;
    }
    return null;
  }

  function processTrend(ordersArr) {
    const dailyMap = {};
    ordersArr.forEach(o => {
      const date = o.created_at.split('T')[0];
      if (!dailyMap[date]) {
        dailyMap[date] = { date, revenue: 0, orders: 0 };
      }
      dailyMap[date].revenue += getOrderTotal(o);
      dailyMap[date].orders++;
    });
    
    const trend = Object.values(dailyMap)
      .sort((a, b) => a.date.localeCompare(b.date))
      .map(d => ({
        ...d,
        dateLabel: new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
      }));
    setTrendData(trend);
  }

  // Helper components
  const IconBox = ({ children, color = colors.purpleLight }) => (
    <div style={{
      width: '48px',
      height: '48px',
      borderRadius: '14px',
      background: `${color}20`,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      fontSize: '22px',
      flexShrink: 0,
    }}>
      {children}
    </div>
  );

  const TrendIndicator = ({ value, suffix = '' }) => {
    const isPositive = value >= 0;
    return (
      <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
        <span style={{
          width: '8px',
          height: '8px',
          borderRadius: '50%',
          backgroundColor: isPositive ? colors.success : colors.error,
        }} />
        <span style={{ 
          color: isPositive ? colors.success : colors.error, 
          fontSize: '13px', 
          fontWeight: 500,
        }}>
          {isPositive ? '+' : ''}{value.toFixed(1)}%
        </span>
        {suffix && <span style={{ color: colors.textMuted, fontSize: '12px' }}>{suffix}</span>}
      </div>
    );
  };

  const DemoBadge = () => (
    <span style={{
      background: 'rgba(251, 191, 36, 0.15)',
      color: '#FBBF24',
      padding: '2px 6px',
      borderRadius: '4px',
      fontSize: '9px',
      fontWeight: 700,
      marginLeft: '6px',
    }}>
      DEMO
    </span>
  );

  const CustomTooltip = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
      return (
        <div style={{
          background: colors.card,
          border: `1px solid ${colors.borderSubtle}`,
          borderRadius: '12px',
          padding: '12px 16px',
          boxShadow: '0 10px 40px rgba(0,0,0,0.3)',
        }}>
          <p style={{ color: colors.textSecondary, fontSize: '12px', marginBottom: '8px' }}>{label}</p>
          {payload.map((entry, index) => (
            <p key={index} style={{ color: entry.color || colors.purple, fontSize: '14px', fontWeight: 600 }}>
              {entry.name}: {typeof entry.value === 'number' && entry.value > 1000 
                ? `${(entry.value / 1000).toFixed(0)}K` 
                : entry.value}
            </p>
          ))}
        </div>
      );
    }
    return null;
  };

  const formatDate = (dateStr) => {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
  };

  if (loading) {
    return (
      <div style={{
        minHeight: '100vh',
        backgroundColor: colors.bg,
        color: colors.textPrimary,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontFamily: "'Inter', sans-serif",
      }}>
        <div style={{ textAlign: 'center' }}>
          <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìä</div>
          <p>Loading dashboard...</p>
        </div>
      </div>
    );
  }

  // Calculate comparison values (vs yesterday - simplified)
  const yesterdayRevenue = trendData.length > 1 ? trendData[trendData.length - 2]?.revenue || 0 : 0;
  const revenueTrend = yesterdayRevenue > 0 ? ((stats.revenue - yesterdayRevenue) / yesterdayRevenue) * 100 : 0;

  return (
    <div style={{
      minHeight: '100vh',
      backgroundColor: colors.bg,
      color: colors.textPrimary,
      padding: 'clamp(12px, 3vw, 32px)',
      fontFamily: "'Inter', sans-serif",
    }}>
      <style>
        {`
          @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap');
          
          @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 12px !important; }
            .kpi-value { font-size: 26px !important; }
            .two-col-grid { grid-template-columns: 1fr !important; }
            .three-col-grid { grid-template-columns: 1fr !important; }
            .six-col-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; }
          }
        `}
      </style>
      
      <div style={{ maxWidth: '1600px', margin: '0 auto' }}>
        
        {/* Header */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px', flexWrap: 'wrap', gap: '12px' }}>
          <div>
            <h1 style={{
              fontFamily: "'Space Grotesk', sans-serif",
              fontSize: 'clamp(24px, 5vw, 42px)',
              fontWeight: 700,
              background: 'linear-gradient(to right, #A78BFA, #818CF8, #6366F1)',
              WebkitBackgroundClip: 'text',
              WebkitTextFillColor: 'transparent',
              marginBottom: '4px',
            }}>
              Collina Daily Report
            </h1>
            <p style={{ color: colors.textSecondary, fontSize: '14px' }}>
              {formatDate(selectedDate)}
            </p>
          </div>
          <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
            {/* Live indicator */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              background: 'rgba(34, 197, 94, 0.1)',
              border: '1px solid rgba(34, 197, 94, 0.3)',
              borderRadius: '20px',
              padding: '6px 12px',
            }}>
              <div style={{
                width: '8px',
                height: '8px',
                borderRadius: '50%',
                background: colors.success,
                animation: 'pulse 2s infinite',
              }} />
              <span style={{ color: colors.success, fontSize: '12px', fontWeight: 600 }}>LIVE</span>
              {lastUpdated && (
                <span style={{ color: colors.textMuted, fontSize: '11px' }}>
                  {lastUpdated.toLocaleTimeString()}
                </span>
              )}
            </div>
            <input
              type="date"
              value={selectedDate}
              onChange={(e) => setSelectedDate(e.target.value)}
              style={{
                background: colors.card,
                border: `1px solid ${colors.border}`,
                borderRadius: '10px',
                padding: '10px 16px',
                color: colors.textPrimary,
                fontSize: '14px',
              }}
            />
          </div>
        </div>

        {/* Main KPIs */}
        <div className="kpi-grid" style={{
          background: colors.card,
          borderRadius: '16px',
          border: `1px solid ${colors.border}`,
          padding: 'clamp(16px, 4vw, 32px)',
          marginBottom: '24px',
          display: 'grid',
          gridTemplateColumns: 'repeat(4, 1fr)',
          gap: 'clamp(16px, 3vw, 32px)',
        }}>
          {/* Revenue */}
          <div>
            <p style={{ color: colors.textMuted, fontSize: '11px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>
              REVENUE
            </p>
            <p className="kpi-value" style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: 'clamp(28px, 5vw, 42px)', fontWeight: 700, marginBottom: '4px' }}>
              {stats.revenue.toLocaleString('en-US', { maximumFractionDigits: 0 })}
            </p>
            <p style={{ color: colors.textSecondary, fontSize: '13px', marginBottom: '8px' }}>RSD</p>
            {revenueTrend !== 0 && <TrendIndicator value={revenueTrend} suffix="vs yesterday" />}
          </div>

          {/* Net Profit (after Wolt fee AND food cost) */}
          <div>
            <p style={{ color: colors.textMuted, fontSize: '11px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>
              NET PROFIT
            </p>
            <p className="kpi-value" style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: 'clamp(28px, 5vw, 42px)', fontWeight: 700, color: colors.success, marginBottom: '4px' }}>
              {stats.profit.toLocaleString('en-US', { maximumFractionDigits: 0 })}
            </p>
            <p style={{ color: colors.textSecondary, fontSize: '12px', marginBottom: '4px' }}>
              RSD ({stats.netMarginPct.toFixed(1)}% net margin)
            </p>
            <p style={{ color: colors.textMuted, fontSize: '11px' }}>
              ‚àí{(stats.woltFee/1000).toFixed(0)}K Wolt ¬∑ ‚àí{(stats.foodCost/1000).toFixed(0)}K COGS
            </p>
          </div>

          {/* Orders */}
          <div>
            <p style={{ color: colors.textMuted, fontSize: '11px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>
              ORDERS
            </p>
            <p className="kpi-value" style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: 'clamp(28px, 5vw, 42px)', fontWeight: 700, marginBottom: '4px' }}>
              {stats.orders}
            </p>
            <p style={{ color: colors.textSecondary, fontSize: '13px', marginBottom: '8px' }}>transactions</p>
          </div>

          {/* Rating (Demo) */}
          <div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
              <p style={{ color: colors.textMuted, fontSize: '11px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                AVG RATING
              </p>
              <DemoBadge />
            </div>
            <p className="kpi-value" style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: 'clamp(28px, 5vw, 42px)', fontWeight: 700, marginBottom: '4px' }}>
              9.1
            </p>
            <p style={{ color: colors.textSecondary, fontSize: '14px', marginBottom: '8px' }}>out of 10</p>
          </div>
        </div>

        {/* Second row KPIs */}
        <div className="six-col-grid" style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(6, 1fr)',
          gap: '12px',
          marginBottom: '24px',
        }}>
          {[
            { icon: 'üõí', label: 'AVG BASKET', value: stats.avgBasket.toLocaleString('en-US', { maximumFractionDigits: 0 }), unit: 'RSD' },
            { icon: 'üì¶', label: 'ITEMS/ORDER', value: stats.itemsPerOrder.toFixed(2) },
            { icon: 'üë§', label: 'NEW CUST', value: stats.newCustomers.toString(), subtext: `${stats.orders > 0 ? ((stats.newCustomers / (stats.newCustomers + stats.returningCustomers)) * 100).toFixed(1) : 0}%` },
            { icon: 'üîÑ', label: 'RETURNING', value: stats.returningCustomers.toString(), subtext: `${stats.orders > 0 ? ((stats.returningCustomers / (stats.newCustomers + stats.returningCustomers)) * 100).toFixed(1) : 0}%` },
            { icon: 'üöö', label: 'DELIVERY', value: stats.avgDeliveryTime > 0 ? stats.avgDeliveryTime.toFixed(0) : 'N/A', unit: stats.avgDeliveryTime > 0 ? 'min' : '' },
            { icon: 'üí∞', label: 'NET MARGIN', value: `${stats.netMarginPct.toFixed(1)}%`, subtext: `${(stats.profit / 1000).toFixed(0)}K profit` },
          ].map((kpi, i) => (
            <div key={i} style={{
              background: colors.card,
              borderRadius: '12px',
              border: `1px solid ${colors.border}`,
              padding: 'clamp(12px, 2vw, 20px)',
            }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                <IconBox>{kpi.icon}</IconBox>
              </div>
              <p style={{ color: colors.textMuted, fontSize: '9px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px' }}>
                {kpi.label}
              </p>
              <p style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: '28px', fontWeight: 700 }}>
                {kpi.value}
                {kpi.unit && <span style={{ fontSize: '14px', color: colors.textSecondary, marginLeft: '4px' }}>{kpi.unit}</span>}
              </p>
              {kpi.subtext && <p style={{ color: colors.textSecondary, fontSize: '12px' }}>{kpi.subtext}</p>}
            </div>
          ))}
        </div>

        {/* Charts Row */}
        <div className="two-col-grid" style={{
          display: 'grid',
          gridTemplateColumns: '2fr 1fr',
          gap: '24px',
          marginBottom: '24px',
        }}>
          {/* 14-Day Trend */}
          <div style={{
            background: colors.card,
            borderRadius: '16px',
            border: `1px solid ${colors.border}`,
            padding: 'clamp(16px, 3vw, 24px)',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
              <IconBox color="#F472B6">üìà</IconBox>
              <h2 style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: '18px', fontWeight: 600 }}>
                14-Day Revenue Trend
              </h2>
            </div>
            <div style={{ height: '250px' }}>
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={trendData}>
                  <defs>
                    <linearGradient id="colorRevenue" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor={colors.purple} stopOpacity={0.3}/>
                      <stop offset="95%" stopColor={colors.purple} stopOpacity={0}/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke={colors.borderSubtle} />
                  <XAxis dataKey="dateLabel" stroke={colors.textMuted} fontSize={11} />
                  <YAxis stroke={colors.textMuted} fontSize={11} tickFormatter={v => `${(v/1000).toFixed(0)}K`} />
                  <Tooltip content={<CustomTooltip />} />
                  <Area type="monotone" dataKey="revenue" stroke={colors.purple} fill="url(#colorRevenue)" strokeWidth={2} name="Revenue" />
                </AreaChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* Hourly Orders */}
          <div style={{
            background: colors.card,
            borderRadius: '16px',
            border: `1px solid ${colors.border}`,
            padding: 'clamp(16px, 3vw, 24px)',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
              <IconBox color={colors.info}>‚è∞</IconBox>
              <h2 style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: '18px', fontWeight: 600 }}>
                Orders by Hour
              </h2>
            </div>
            <div style={{ height: '250px' }}>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={hourlyData}>
                  <CartesianGrid strokeDasharray="3 3" stroke={colors.borderSubtle} />
                  <XAxis dataKey="hour" stroke={colors.textMuted} fontSize={11} />
                  <YAxis stroke={colors.textMuted} fontSize={11} />
                  <Tooltip content={<CustomTooltip />} />
                  <Bar dataKey="orders" fill={colors.purple} radius={[4, 4, 0, 0]} name="Orders" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>
        </div>

        {/* Location Performance */}
        <div style={{
          background: colors.card,
          borderRadius: '16px',
          border: `1px solid ${colors.border}`,
          padding: 'clamp(16px, 3vw, 24px)',
          marginBottom: '24px',
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
            <IconBox color={colors.success}>üìç</IconBox>
            <h2 style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: '18px', fontWeight: 600 }}>
              Location Performance
            </h2>
          </div>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
            {locationData.map((loc, i) => {
              const maxRevenue = Math.max(...locationData.map(l => l.revenue));
              const pct = maxRevenue > 0 ? (loc.revenue / maxRevenue) * 100 : 0;
              return (
                <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                  <div style={{ width: '140px', fontWeight: 500, fontSize: '14px' }}>{loc.name}</div>
                  <div style={{ flex: 1, height: '24px', background: colors.elevated, borderRadius: '6px', overflow: 'hidden' }}>
                    <div style={{
                      width: `${pct}%`,
                      height: '100%',
                      background: `linear-gradient(90deg, ${loc.color || colors.purple}, ${loc.color || colors.purple}99)`,
                      borderRadius: '6px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'flex-end',
                      paddingRight: '8px',
                    }}>
                      {pct > 20 && (
                        <span style={{ fontSize: '11px', fontWeight: 600, color: 'white' }}>
                          {(loc.revenue / 1000).toFixed(0)}K
                        </span>
                      )}
                    </div>
                  </div>
                  <div style={{ width: '100px', textAlign: 'right' }}>
                    <span style={{ fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700, fontSize: '16px' }}>
                      {(loc.revenue / 1000).toFixed(0)}K
                    </span>
                    <span style={{ color: colors.textMuted, fontSize: '12px', marginLeft: '8px' }}>
                      {loc.orders} ord
                    </span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* Channel Mix - Full Width */}
        <div style={{
          background: colors.card,
          borderRadius: '16px',
          border: `1px solid ${colors.border}`,
          padding: 'clamp(16px, 3vw, 24px)',
          marginBottom: '24px',
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
            <IconBox color={colors.info}>üìä</IconBox>
            <h2 style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: '18px', fontWeight: 600 }}>
              Channel Mix
            </h2>
          </div>
          
          {/* Revenue by Channel label */}
          <p style={{ color: colors.textSecondary, fontSize: '12px', marginBottom: '8px' }}>Revenue by Channel</p>
          
          {/* Stacked horizontal bar */}
          <div style={{ 
            display: 'flex', 
            height: '40px', 
            borderRadius: '20px', 
            overflow: 'hidden',
            marginBottom: '12px',
            border: `2px solid ${colors.borderSubtle}`,
          }}>
            {channelData.filter(ch => ch.revenue > 0).map((ch, i) => {
              const pct = stats.revenue > 0 ? (ch.revenue / stats.revenue) * 100 : 0;
              return (
                <div key={i} style={{
                  width: `${pct}%`,
                  background: ch.color,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  minWidth: pct > 8 ? 'auto' : '0',
                }}>
                  {pct > 12 && (
                    <span style={{ color: ch.color === '#F59E0B' ? '#000' : 'white', fontSize: '13px', fontWeight: 600 }}>
                      {ch.name} {pct.toFixed(0)}%
                    </span>
                  )}
                </div>
              );
            })}
          </div>
          
          {/* Legend */}
          <div style={{ display: 'flex', gap: '20px', marginBottom: '24px', flexWrap: 'wrap' }}>
            {[
              { name: 'Wolt', color: '#06B6D4' },
              { name: 'eBar', color: '#F59E0B' },
              { name: 'Gloria', color: '#EC4899' },
              { name: 'Food Truck', color: '#EF4444' },
            ].map((ch, i) => {
              const data = channelData.find(c => c.name === ch.name);
              const pct = data && stats.revenue > 0 ? ((data.revenue / stats.revenue) * 100).toFixed(0) : 0;
              return (
                <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                  <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: ch.color }} />
                  <span style={{ fontSize: '12px', color: colors.textSecondary }}>{ch.name} ({pct}%)</span>
                </div>
              );
            })}
          </div>
          
          {/* Channel Table */}
          <div style={{ overflowX: 'auto' }}>
            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
              <thead>
                <tr style={{ borderBottom: `1px solid ${colors.borderSubtle}` }}>
                  <th style={{ textAlign: 'left', padding: '12px 8px', color: colors.textMuted, fontSize: '10px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px' }}>CHANNEL</th>
                  <th style={{ textAlign: 'right', padding: '12px 8px', color: colors.textMuted, fontSize: '10px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px' }}>ORDERS</th>
                  <th style={{ textAlign: 'right', padding: '12px 8px', color: colors.textMuted, fontSize: '10px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px' }}>REVENUE</th>
                  <th style={{ textAlign: 'right', padding: '12px 8px', color: colors.textMuted, fontSize: '10px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px' }}>AVG BASKET</th>
                  <th style={{ textAlign: 'right', padding: '12px 8px', color: colors.textMuted, fontSize: '10px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px' }}>FEE %</th>
                  <th style={{ textAlign: 'right', padding: '12px 8px', color: colors.textMuted, fontSize: '10px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px' }}>NET REVENUE</th>
                </tr>
              </thead>
              <tbody>
                {[
                  { name: 'Wolt', color: '#06B6D4', fee: 0.118 },
                  { name: 'eBar', color: '#F59E0B', fee: 0 },
                  { name: 'Gloria', color: '#EC4899', fee: 0.15 },
                  { name: 'Food Truck', color: '#EF4444', fee: 0 },
                ].map((ch, i) => {
                  const data = channelData.find(c => c.name === ch.name);
                  const hasData = data && data.orders > 0;
                  return (
                    <tr key={i} style={{ borderBottom: `1px solid ${colors.borderSubtle}` }}>
                      <td style={{ padding: '14px 8px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: ch.color }} />
                          <span style={{ fontWeight: 500 }}>{ch.name}</span>
                        </div>
                      </td>
                      <td style={{ padding: '14px 8px', textAlign: 'right', fontFamily: "'Space Grotesk', sans-serif", fontWeight: 600 }}>
                        {hasData ? data.orders.toLocaleString() : '-'}
                      </td>
                      <td style={{ padding: '14px 8px', textAlign: 'right', fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700 }}>
                        {hasData ? `${(data.revenue / 1000).toFixed(0)}K` : '-'}
                      </td>
                      <td style={{ padding: '14px 8px', textAlign: 'right', color: colors.textSecondary }}>
                        {hasData ? `${data.avgBasket.toLocaleString('en-US', { maximumFractionDigits: 0 })} RSD` : '-'}
                      </td>
                      <td style={{ padding: '14px 8px', textAlign: 'right' }}>
                        <span style={{ 
                          color: ch.fee > 0.10 ? colors.error : ch.fee > 0 ? colors.warning : colors.success,
                          fontWeight: 600,
                        }}>
                          {(ch.fee * 100).toFixed(ch.fee > 0 ? 2 : 0)}%
                        </span>
                      </td>
                      <td style={{ padding: '14px 8px', textAlign: 'right', fontFamily: "'Space Grotesk', sans-serif", fontWeight: 600, color: colors.success }}>
                        {hasData ? `${((data.revenue * (1 - ch.fee)) / 1000).toFixed(0)}K` : '-'}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          
          {/* Insight banner */}
          <div style={{
            marginTop: '20px',
            background: 'rgba(34, 197, 94, 0.1)',
            borderRadius: '10px',
            padding: '14px 16px',
            display: 'flex',
            alignItems: 'center',
            gap: '10px',
          }}>
            <span style={{ fontSize: '18px' }}>üí°</span>
            <p style={{ color: colors.success, fontSize: '13px' }}>
              Moving 10% of orders from Wolt ‚Üí eBar saves ~{((stats.revenue * 0.10 * 0.118) / 1000).toFixed(0)},000 RSD/month in fees
            </p>
          </div>
        </div>

        {/* Hourly Analysis - Full Width */}
        <div style={{
          background: colors.card,
          borderRadius: '16px',
          border: `1px solid ${colors.border}`,
          padding: 'clamp(16px, 3vw, 24px)',
          marginBottom: '24px',
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
            <IconBox color="#EF4444">‚è∞</IconBox>
            <h2 style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: '18px', fontWeight: 600 }}>
              Hourly Analysis
            </h2>
          </div>
          
          {/* Chart */}
          <div style={{ height: '280px', marginBottom: '20px' }}>
            <ResponsiveContainer width="100%" height="100%">
              <ComposedChart data={hourlyAnalysis.data}>
                <CartesianGrid strokeDasharray="3 3" stroke={colors.borderSubtle} />
                <XAxis dataKey="hour" stroke={colors.textMuted} fontSize={11} />
                <YAxis yAxisId="left" stroke={colors.textMuted} fontSize={11} />
                <YAxis yAxisId="right" orientation="right" stroke={colors.textMuted} fontSize={11} />
                <Tooltip content={<CustomTooltip />} />
                <Bar yAxisId="left" dataKey="orders" fill={colors.purple} radius={[4, 4, 0, 0]} name="Orders" />
                <Line yAxisId="right" type="monotone" dataKey="avgPrep" stroke={colors.success} strokeWidth={2} dot={false} name="Prep Time" />
                <Line yAxisId="right" type="monotone" dataKey="avgDelivery" stroke={colors.cyan} strokeWidth={2} dot={false} name="Delivery Time" />
              </ComposedChart>
            </ResponsiveContainer>
          </div>
          
          {/* Legend */}
          <div style={{ display: 'flex', gap: '24px', justifyContent: 'center', marginBottom: '24px' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
              <div style={{ width: '12px', height: '12px', background: colors.purple, borderRadius: '2px' }} />
              <span style={{ fontSize: '12px', color: colors.textSecondary }}>Orders</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
              <div style={{ width: '20px', height: '3px', background: colors.success, borderRadius: '2px' }} />
              <span style={{ fontSize: '12px', color: colors.textSecondary }}>Prep Time</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
              <div style={{ width: '20px', height: '3px', background: colors.cyan, borderRadius: '2px' }} />
              <span style={{ fontSize: '12px', color: colors.textSecondary }}>Delivery Time</span>
            </div>
          </div>
          
          {/* Critical Hours */}
          <p style={{ color: colors.textSecondary, fontSize: '12px', marginBottom: '12px' }}>Critical Hours</p>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
            {hourlyAnalysis.criticalHours.map((h, i) => (
              <div key={i} style={{
                background: 'rgba(239, 68, 68, 0.1)',
                borderRadius: '10px',
                padding: '12px 16px',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                  <span style={{ color: colors.error, fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700, fontSize: '16px' }}>
                    {h.hourNum}:00
                  </span>
                  <span style={{ color: colors.textSecondary, fontSize: '13px' }}>
                    {h.orders} orders
                  </span>
                  <span style={{ color: colors.textSecondary, fontSize: '13px' }}>
                    {(h.revenue / 1000).toFixed(0)}K RSD
                  </span>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                  <span style={{ color: colors.error, fontSize: '13px' }}>
                    {h.avgDelivery.toFixed(0)}m delivery
                  </span>
                  <span style={{ color: colors.warning, fontSize: '13px', fontWeight: 600 }}>
                    {h.rating}/10 ‚≠ê
                  </span>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Location Heatmap - Full Width */}
        <div style={{
          background: colors.card,
          borderRadius: '16px',
          border: `1px solid ${colors.border}`,
          padding: 'clamp(16px, 3vw, 24px)',
          marginBottom: '24px',
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
            <IconBox color="#EC4899">üó∫Ô∏è</IconBox>
            <h2 style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: '18px', fontWeight: 600 }}>
              Location √ó Hour Heatmap
            </h2>
          </div>
          
          {/* Toggle between Orders and Items */}
          <div style={{ display: 'flex', gap: '8px', marginBottom: '20px' }}>
            <span style={{ 
              background: colors.purple, 
              color: 'white', 
              padding: '6px 14px', 
              borderRadius: '6px', 
              fontSize: '12px', 
              fontWeight: 600 
            }}>
              Orders
            </span>
          </div>
          
          {/* Heatmap Grid */}
          <div style={{ overflowX: 'auto' }}>
            <div style={{ minWidth: '800px' }}>
              {/* Hour headers */}
              <div style={{ display: 'flex', marginBottom: '4px' }}>
                <div style={{ width: '100px', flexShrink: 0 }}></div>
                {heatmapData.hours.map(hour => (
                  <div key={hour} style={{ 
                    flex: 1, 
                    textAlign: 'center', 
                    color: colors.textMuted, 
                    fontSize: '11px',
                    fontWeight: 500,
                  }}>
                    {hour}h
                  </div>
                ))}
              </div>
              
              {/* Location rows */}
              {heatmapData.locations.map((loc, locIndex) => (
                <div key={loc} style={{ display: 'flex', marginBottom: '4px' }}>
                  <div style={{ 
                    width: '100px', 
                    flexShrink: 0, 
                    display: 'flex', 
                    alignItems: 'center',
                    fontWeight: 500,
                    fontSize: '13px',
                    paddingRight: '8px',
                  }}>
                    {loc}
                  </div>
                  {heatmapData.hours.map(hour => {
                    const cell = heatmapData.data.find(d => d.location === loc && d.hour === hour);
                    const orders = cell?.orders || 0;
                    const intensity = cell?.orderIntensity || 0;
                    
                    // Color gradient from dark to bright purple
                    const bgColor = orders === 0 
                      ? colors.elevated 
                      : `rgba(139, 92, 246, ${0.2 + intensity * 0.8})`;
                    
                    return (
                      <div 
                        key={hour} 
                        style={{ 
                          flex: 1, 
                          height: '36px',
                          margin: '1px',
                          borderRadius: '4px',
                          background: bgColor,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          cursor: 'default',
                          transition: 'transform 0.1s',
                        }}
                        title={`${loc} @ ${hour}:00 - ${orders} orders`}
                      >
                        {orders > 0 && (
                          <span style={{ 
                            fontSize: '11px', 
                            fontWeight: 600,
                            color: intensity > 0.5 ? 'white' : colors.textSecondary,
                          }}>
                            {orders}
                          </span>
                        )}
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          </div>
          
          {/* Color scale legend */}
          <div style={{ 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center',
            gap: '12px', 
            marginTop: '16px',
          }}>
            <span style={{ color: colors.textMuted, fontSize: '11px' }}>Less</span>
            <div style={{ display: 'flex', gap: '2px' }}>
              {[0.1, 0.3, 0.5, 0.7, 0.9].map((intensity, i) => (
                <div key={i} style={{
                  width: '24px',
                  height: '12px',
                  borderRadius: '2px',
                  background: `rgba(139, 92, 246, ${0.2 + intensity * 0.8})`,
                }} />
              ))}
            </div>
            <span style={{ color: colors.textMuted, fontSize: '11px' }}>More</span>
            <span style={{ color: colors.textMuted, fontSize: '11px', marginLeft: '12px' }}>
              Max: {heatmapData.maxOrders} orders
            </span>
          </div>
          
          {/* Summary stats */}
          <div style={{ 
            display: 'flex', 
            gap: '24px', 
            justifyContent: 'center',
            marginTop: '16px',
            paddingTop: '16px',
            borderTop: `1px solid ${colors.borderSubtle}`,
          }}>
            {heatmapData.locations.map(loc => {
              const locData = heatmapData.data.filter(d => d.location === loc);
              const totalOrders = locData.reduce((sum, d) => sum + d.orders, 0);
              const peakHour = locData.reduce((max, d) => d.orders > max.orders ? d : max, { orders: 0 });
              return (
                <div key={loc} style={{ textAlign: 'center' }}>
                  <p style={{ fontWeight: 600, fontSize: '13px', marginBottom: '4px' }}>{loc}</p>
                  <p style={{ color: colors.purple, fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700, fontSize: '18px' }}>
                    {totalOrders}
                  </p>
                  <p style={{ color: colors.textMuted, fontSize: '11px' }}>
                    Peak: {peakHour.hour}:00 ({peakHour.orders})
                  </p>
                </div>
              );
            })}
          </div>
        </div>

        {/* Kitchen & Delivery Performance */}
        <div className="two-col-grid" style={{
          display: 'grid',
          gridTemplateColumns: '1fr 1fr',
          gap: '24px',
          marginBottom: '24px',
        }}>
          {/* Kitchen Performance */}
          <div style={{
            background: colors.card,
            borderRadius: '16px',
            border: `1px solid ${colors.border}`,
            padding: 'clamp(16px, 3vw, 24px)',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
              <IconBox color={colors.warning}>üë®‚Äçüç≥</IconBox>
              <h2 style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: '18px', fontWeight: 600 }}>
                Kitchen Performance
              </h2>
              <span style={{ 
                background: 'rgba(34, 197, 94, 0.15)', 
                color: colors.success, 
                padding: '2px 8px', 
                borderRadius: '4px', 
                fontSize: '10px', 
                fontWeight: 600 
              }}>SIM</span>
              {kitchenPerformance.byVenue.some(v => v.avgTime > 17) && (
                <span style={{ fontSize: '16px' }}>‚ö†Ô∏è</span>
              )}
            </div>
            
            <p style={{ color: colors.textSecondary, fontSize: '12px', marginBottom: '12px' }}>Prep Time by Venue</p>
            
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '20px' }}>
              {kitchenPerformance.byVenue.map((venue, i) => {
                const status = venue.avgTime < 15 ? 'good' : venue.avgTime < 17 ? 'warning' : 'critical';
                const statusIcon = status === 'good' ? '‚úì' : status === 'warning' ? '‚ö†' : '‚úó';
                const statusColor = status === 'good' ? colors.success : status === 'warning' ? colors.warning : colors.error;
                return (
                  <div key={i} style={{
                    background: colors.elevated,
                    borderRadius: '8px',
                    padding: '12px 14px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                      <span style={{ color: statusColor, fontWeight: 700 }}>{statusIcon}</span>
                      <span style={{ fontWeight: 500 }}>{venue.name}</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                      <span style={{ color: statusColor, fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700 }}>
                        {venue.avgTime.toFixed(1)}m
                      </span>
                      <span style={{ color: colors.textMuted, fontSize: '12px' }}>
                        &lt;{venue.target}m
                      </span>
                      <span style={{ color: colors.textMuted, fontSize: '12px' }}>
                        {venue.count}
                      </span>
                    </div>
                  </div>
                );
              })}
            </div>
            
            {/* Prep Time by Hour Chart */}
            <p style={{ color: colors.textSecondary, fontSize: '12px', marginBottom: '12px' }}>Prep Time by Hour</p>
            <div style={{ height: '150px' }}>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={kitchenPerformance.byHour}>
                  <XAxis dataKey="hour" stroke={colors.textMuted} fontSize={10} />
                  <YAxis stroke={colors.textMuted} fontSize={10} />
                  <Tooltip content={<CustomTooltip />} />
                  <Bar dataKey="avgTime" name="Prep Time" radius={[3, 3, 0, 0]}>
                    {kitchenPerformance.byHour.map((entry, index) => (
                      <Cell 
                        key={`cell-${index}`} 
                        fill={entry.avgTime < 15 ? colors.purple : entry.avgTime < 17 ? colors.warning : colors.error} 
                      />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>
            
            {/* Legend */}
            <div style={{ display: 'flex', gap: '16px', justifyContent: 'center', marginTop: '12px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                <div style={{ width: '10px', height: '10px', background: colors.purple, borderRadius: '2px' }} />
                <span style={{ fontSize: '11px', color: colors.textMuted }}>&lt;15m Good</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                <div style={{ width: '10px', height: '10px', background: colors.warning, borderRadius: '2px' }} />
                <span style={{ fontSize: '11px', color: colors.textMuted }}>15-17m Warning</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                <div style={{ width: '10px', height: '10px', background: colors.error, borderRadius: '2px' }} />
                <span style={{ fontSize: '11px', color: colors.textMuted }}>&gt;17m Critical</span>
              </div>
            </div>
          </div>

          {/* Delivery Performance */}
          <div style={{
            background: colors.card,
            borderRadius: '16px',
            border: `1px solid ${colors.border}`,
            padding: 'clamp(16px, 3vw, 24px)',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
              <IconBox color={colors.cyan}>üöö</IconBox>
              <h2 style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: '18px', fontWeight: 600 }}>
                Delivery Performance
              </h2>
              {deliveryPerformance.total > 35 && <span style={{ fontSize: '16px' }}>‚ö†Ô∏è</span>}
            </div>
            
            {/* Time Breakdown Bar */}
            <p style={{ color: colors.textSecondary, fontSize: '12px', marginBottom: '8px' }}>Time Breakdown (avg)</p>
            <div style={{ display: 'flex', alignItems: 'center', marginBottom: '8px' }}>
              <span style={{ color: colors.textMuted, fontSize: '11px', marginRight: '8px' }}>Order Placed</span>
              <div style={{ flex: 1, display: 'flex', height: '32px', borderRadius: '6px', overflow: 'hidden' }}>
                {deliveryPerformance.total > 0 && (
                  <>
                    <div style={{ 
                      width: `${(deliveryPerformance.avgPrep / deliveryPerformance.total) * 100}%`, 
                      background: colors.warning,
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                    }}>
                      <span style={{ fontSize: '11px', fontWeight: 600, color: '#000' }}>
                        {deliveryPerformance.avgPrep.toFixed(1)}m
                      </span>
                    </div>
                    <div style={{ 
                      width: `${(deliveryPerformance.avgWait / deliveryPerformance.total) * 100}%`, 
                      background: colors.info,
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                    }}>
                      <span style={{ fontSize: '11px', fontWeight: 600, color: '#fff' }}>
                        {deliveryPerformance.avgWait.toFixed(1)}m
                      </span>
                    </div>
                    <div style={{ 
                      width: `${(deliveryPerformance.avgTransit / deliveryPerformance.total) * 100}%`, 
                      background: colors.success,
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                    }}>
                      <span style={{ fontSize: '11px', fontWeight: 600, color: '#fff' }}>
                        {deliveryPerformance.avgTransit.toFixed(1)}m
                      </span>
                    </div>
                  </>
                )}
              </div>
              <span style={{ color: colors.textMuted, fontSize: '11px', marginLeft: '8px' }}>Delivered</span>
            </div>
            
            {/* Legend */}
            <div style={{ display: 'flex', gap: '16px', marginBottom: '16px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                <span style={{ color: colors.warning, fontSize: '11px' }}>Prep ({deliveryPerformance.total > 0 ? ((deliveryPerformance.avgPrep / deliveryPerformance.total) * 100).toFixed(0) : 0}%)</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                <span style={{ color: colors.info, fontSize: '11px' }}>Wait ({deliveryPerformance.total > 0 ? ((deliveryPerformance.avgWait / deliveryPerformance.total) * 100).toFixed(0) : 0}%)</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                <span style={{ color: colors.success, fontSize: '11px' }}>Transit ({deliveryPerformance.total > 0 ? ((deliveryPerformance.avgTransit / deliveryPerformance.total) * 100).toFixed(0) : 0}%)</span>
              </div>
            </div>
            
            {/* Total */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '20px' }}>
              <span style={{ fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700, fontSize: '18px' }}>
                Total: {deliveryPerformance.total.toFixed(1)} min
              </span>
              <span style={{ 
                color: deliveryPerformance.total <= 35 ? colors.success : colors.error,
                fontWeight: 600,
              }}>
                Target: 35 min
              </span>
            </div>
            
            {/* By Venue */}
            <p style={{ color: colors.textSecondary, fontSize: '12px', marginBottom: '12px' }}>By Venue</p>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
              {deliveryPerformance.byVenue.map((venue, i) => (
                <div key={i} style={{
                  background: venue.color + '20',
                  borderLeft: `4px solid ${venue.color}`,
                  borderRadius: '8px',
                  padding: '12px 14px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                }}>
                  <span style={{ fontWeight: 500 }}>{venue.name}</span>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <span style={{ 
                      color: venue.avgTime <= 35 ? colors.success : venue.avgTime <= 45 ? colors.warning : colors.error,
                      fontFamily: "'Space Grotesk', sans-serif", 
                      fontWeight: 700 
                    }}>
                      {venue.avgTime.toFixed(1)} min
                    </span>
                    <span style={{ color: colors.textMuted, fontSize: '12px' }}>
                      {venue.pctUnder35.toFixed(0)}% &lt;35m
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Category & Top Products */}
        <div className="two-col-grid" style={{
          display: 'grid',
          gridTemplateColumns: '1fr 2fr',
          gap: '24px',
          marginBottom: '24px',
        }}>
          {/* Category Mix */}
          <div style={{
            background: colors.card,
            borderRadius: '16px',
            border: `1px solid ${colors.border}`,
            padding: 'clamp(16px, 3vw, 24px)',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
              <IconBox color={colors.warning}>üçΩÔ∏è</IconBox>
              <h2 style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: '18px', fontWeight: 600 }}>
                Category Mix
              </h2>
            </div>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {categoryData.map((cat, i) => {
                const maxRevenue = Math.max(...categoryData.map(c => c.revenue));
                const barPct = maxRevenue > 0 ? (cat.revenue / maxRevenue) * 100 : 0;
                return (
                  <div key={i} style={{
                    background: colors.elevated,
                    borderRadius: '10px',
                    padding: '12px',
                    borderLeft: `4px solid ${cat.color}`,
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span style={{ fontSize: '18px' }}>{cat.icon}</span>
                        <span style={{ fontWeight: 600 }}>{cat.name}</span>
                      </div>
                      <div style={{ textAlign: 'right' }}>
                        <span style={{ fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700, fontSize: '16px' }}>
                          {(cat.revenue / 1000).toFixed(1)}K
                        </span>
                      </div>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                      <div style={{ flex: 1, height: '8px', background: colors.bg, borderRadius: '4px', overflow: 'hidden' }}>
                        <div style={{
                          width: `${barPct}%`,
                          height: '100%',
                          background: cat.color,
                          borderRadius: '4px',
                        }} />
                      </div>
                      <span style={{ color: colors.textSecondary, fontSize: '12px', minWidth: '45px', textAlign: 'right' }}>
                        {cat.mix.toFixed(1)}%
                      </span>
                    </div>
                    <div style={{ color: colors.textMuted, fontSize: '11px', marginTop: '4px' }}>
                      {cat.count} items
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Top Products */}
          <div style={{
            background: colors.card,
            borderRadius: '16px',
            border: `1px solid ${colors.border}`,
            padding: 'clamp(16px, 3vw, 24px)',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
              <IconBox color={colors.purple}>üèÜ</IconBox>
              <h2 style={{ fontFamily: "'Space Grotesk', sans-serif", fontSize: '18px', fontWeight: 600 }}>
                Top Products
              </h2>
            </div>
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ borderBottom: `1px solid ${colors.borderSubtle}` }}>
                    <th style={{ textAlign: 'left', padding: '10px', color: colors.textMuted, fontSize: '11px', fontWeight: 500 }}>#</th>
                    <th style={{ textAlign: 'left', padding: '10px', color: colors.textMuted, fontSize: '11px', fontWeight: 500 }}>PRODUCT</th>
                    <th style={{ textAlign: 'right', padding: '10px', color: colors.textMuted, fontSize: '11px', fontWeight: 500 }}>QTY</th>
                    <th style={{ textAlign: 'right', padding: '10px', color: colors.textMuted, fontSize: '11px', fontWeight: 500 }}>REVENUE</th>
                    <th style={{ textAlign: 'right', padding: '10px', color: colors.textMuted, fontSize: '11px', fontWeight: 500 }}>MARGIN</th>
                  </tr>
                </thead>
                <tbody>
                  {topProducts.map((prod, i) => (
                    <tr key={i} style={{ borderBottom: `1px solid ${colors.borderSubtle}` }}>
                      <td style={{ padding: '12px 10px', fontWeight: 600, color: colors.purple }}>{prod.rank}</td>
                      <td style={{ padding: '12px 10px', maxWidth: '250px' }}>
                        <p style={{ fontWeight: 500, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                          {prod.name}
                        </p>
                      </td>
                      <td style={{ padding: '12px 10px', textAlign: 'right', fontFamily: "'Space Grotesk', sans-serif", fontWeight: 600 }}>
                        {prod.qty}
                      </td>
                      <td style={{ padding: '12px 10px', textAlign: 'right', fontFamily: "'Space Grotesk', sans-serif", fontWeight: 600 }}>
                        {(prod.revenue / 1000).toFixed(1)}K
                      </td>
                      <td style={{ padding: '12px 10px', textAlign: 'right' }}>
                        <span style={{
                          background: prod.margin >= 75 ? 'rgba(34, 197, 94, 0.15)' : prod.margin >= 65 ? 'rgba(245, 158, 11, 0.15)' : 'rgba(239, 68, 68, 0.15)',
                          color: prod.margin >= 75 ? colors.success : prod.margin >= 65 ? colors.warning : colors.error,
                          padding: '4px 8px',
                          borderRadius: '6px',
                          fontSize: '12px',
                          fontWeight: 600,
                        }}>
                          {prod.margin.toFixed(1)}%
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        {/* Footer */}
        <div style={{ textAlign: 'center', padding: '16px', color: colors.textMuted, fontSize: '12px' }}>
          Generated: {new Date().toLocaleString()} | {stats.orders} orders | Wolt Fee: {(WOLT_FEE * 100).toFixed(1)}% | Live Data
        </div>

      </div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById("root")).render(<CollinaDashboard />);
  </script>
</body>
</html>
