<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collina Orders Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #0f0f0f;
      color: #ffffff;
      min-height: 100vh;
      padding: 15px 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #333;
      gap: 15px;
      flex-wrap: nowrap;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .burger-btn {
      background: #1a1a2e;
      border: 1px solid #333;
      border-radius: 8px;
      color: #8B5CF6;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      position: relative;
    }

    .burger-btn:hover {
      background: rgba(139, 92, 246, 0.2);
      border-color: #8B5CF6;
    }

    .burger-btn .filter-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ef4444;
      color: #fff;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      font-size: 10px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .burger-btn .filter-badge.hidden {
      display: none;
    }

    .header h1 {
      font-size: 22px;
      color: #8B5CF6;
      white-space: nowrap;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-shrink: 0;
    }

    .header .status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .date-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-selector input[type="date"] {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    .date-selector input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    .date-btn {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #8B5CF6;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .date-btn:hover {
      background: #8B5CF6;
      color: #fff;
    }

    /* Status Filter Tabs - Compact */
    .status-tabs {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      flex-shrink: 0;
    }

    .status-tab {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #888;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      font-size: 12px;
    }

    .status-tab:hover {
      border-color: #555;
      color: #fff;
    }

    .status-tab.active {
      border-color: #8B5CF6;
      background: linear-gradient(135deg, #1a1a2e 0%, #252540 100%);
      color: #fff;
    }

    .status-tab .tab-icon {
      font-size: 14px;
    }

    .status-tab .tab-label {
      font-weight: 500;
      font-size: 12px;
      display: none;
    }

    @media (min-width: 1200px) {
      .status-tab .tab-label {
        display: inline;
      }
    }

    .status-tab .tab-count {
      background: #333;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-tab.active .tab-count {
      background: #8B5CF6;
    }

    .status-tab[data-status="new"].active { border-color: #f59e0b; }
    .status-tab[data-status="new"].active .tab-count { background: #f59e0b; }
    
    .status-tab[data-status="production"].active { border-color: #f97316; }
    .status-tab[data-status="production"].active .tab-count { background: #f97316; }
    
    .status-tab[data-status="ready"].active { border-color: #3b82f6; }
    .status-tab[data-status="ready"].active .tab-count { background: #3b82f6; }
    
    .status-tab[data-status="paid"].active { border-color: #22c55e; }
    .status-tab[data-status="paid"].active .tab-count { background: #22c55e; }
    
    .status-tab[data-status="canceled"].active { border-color: #ef4444; }
    .status-tab[data-status="canceled"].active .tab-count { background: #ef4444; }

    /* View Toggle - Compact */
    .view-toggle {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .view-btn {
      padding: 6px 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      color: #888;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .view-btn:first-child {
      border-radius: 8px 0 0 8px;
    }

    .view-btn:last-child {
      border-radius: 0 8px 8px 0;
    }

    .view-btn.active {
      background: #8B5CF6;
      border-color: #8B5CF6;
      color: white;
    }

    /* Grid view for filtered orders */
    .orders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 15px;
      padding: 10px 0;
    }

    .orders-grid .order-card {
      margin: 0;
    }

    .orders-grid-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 16px;
    }

    /* View Toggle */
    .view-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }

    .view-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #888;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .view-btn:hover {
      border-color: #555;
      color: #fff;
    }

    .view-btn.active {
      background: #8B5CF6;
      border-color: #8B5CF6;
      color: #fff;
    }

    /* Table View */
    .orders-table-container {
      background: #1a1a1a;
      border-radius: 12px;
      border: 1px solid #333;
      overflow: hidden;
    }

    .orders-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .orders-table th {
      background: #252525;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      color: #888;
      border-bottom: 1px solid #333;
      white-space: nowrap;
    }

    .orders-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #2a2a2a;
      vertical-align: middle;
    }

    .orders-table tr:hover {
      background: #252525;
      cursor: pointer;
    }

    .orders-table tr:last-child td {
      border-bottom: none;
    }

    .table-location {
      display: inline-block;
      background: #8B5CF6;
      color: #fff;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
    }

    .table-provider {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .table-provider.wolt { background: #00b4d8; color: #000; }
    .table-provider.gloriafood { background: #f59e0b; color: #000; }
    .table-provider.ebar { background: #22c55e; color: #000; }
    .table-provider.pult { background: #8B5CF6; color: #fff; }

    .table-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    .table-status.new { background: #f59e0b20; color: #f59e0b; }
    .table-status.production { background: #f9731620; color: #f97316; }
    .table-status.ready { background: #3b82f620; color: #3b82f6; }
    .table-status.paid { background: #22c55e20; color: #22c55e; }
    .table-status.canceled { background: #ef444420; color: #ef4444; }

    .table-delivery {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .table-delivery-status {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
    }

    .table-delivery-status.delivered { background: #065F46; color: #A7F3D0; }
    .table-delivery-status.pending { background: #374151; color: #9CA3AF; }
    .table-delivery-status.started { background: #5B21B6; color: #DDD6FE; }

    .table-items {
      max-width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #aaa;
      font-size: 12px;
    }

    .table-total {
      font-weight: 600;
      color: #22c55e;
    }

    .table-empty {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .stats-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      flex: 1;
      border: 1px solid #333;
    }

    .stat-card h3 {
      font-size: 14px;
      color: #888;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
    }

    .stat-card.production .value { color: #f59e0b; }
    .stat-card.ready .value { color: #3b82f6; }
    .stat-card.delivery .value { color: #8b5cf6; }
    .stat-card.paid .value { color: #22c55e; }
    .stat-card.canceled .value { color: #ef4444; }

    .columns {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
    }

    .column {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 15px;
      border: 1px solid #333;
      min-height: 500px;
    }

    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #333;
    }

    .column-header h2 {
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .column-header .count {
      background: #333;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 14px;
    }

    .column.new .column-header { border-bottom-color: #f59e0b; }
    .column.production .column-header { border-bottom-color: #f97316; }
    .column.ready .column-header { border-bottom-color: #3b82f6; }
    .column.paid .column-header { border-bottom-color: #22c55e; }
    .column.canceled .column-header { border-bottom-color: #ef4444; }

    .order-card {
      background: #252525;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 4px solid #666;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .order-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      border-color: #8B5CF6;
    }

    .order-card.new { border-left-color: #f59e0b; }
    .order-card.production { border-left-color: #f97316; }
    .order-card.ready { border-left-color: #3b82f6; }
    .order-card.paid { border-left-color: #22c55e; }

    .stickers-container {
      position: absolute;
      top: -8px;
      right: 10px;
      display: flex;
      gap: 6px;
      z-index: 10;
    }

    .sticker {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .sticker.delivered {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
    }

    .sticker.paid {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: #fff;
    }

    .order-card {
      position: relative;
    }
    .order-card.canceled { border-left-color: #ef4444; }

    .order-location-tag {
      background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);
      color: #fff;
      font-size: 12px;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      display: inline-block;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 8px;
    }

    .order-number {
      font-size: 20px;
      font-weight: bold;
    }

    .order-note-icon {
      font-size: 14px;
      cursor: help;
      animation: pulse-note 2s infinite;
    }

    @keyframes pulse-note {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .order-note-preview {
      background: rgba(251, 191, 36, 0.15);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #fbbf24;
      margin-bottom: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .order-provider {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      background: #333;
      color: #aaa;
    }

    .order-provider.eBar { background: #7c3aed20; color: #a78bfa; }
    .order-provider.gloriafood { background: #f59e0b20; color: #fbbf24; }
    .order-provider.wolt { background: #3b82f620; color: #60a5fa; }

    .order-meta {
      font-size: 12px;
      color: #888;
      margin-bottom: 10px;
    }

    .order-meta .waiter { color: #a78bfa; }
    .order-meta .table { color: #60a5fa; }

    .order-items {
      font-size: 13px;
      color: #ccc;
      margin-bottom: 10px;
    }

    .order-items .item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #333;
    }

    .order-items .item:last-child {
      border-bottom: none;
    }

    .order-items .quantity {
      color: #888;
      margin-right: 8px;
    }

    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #333;
    }

    .order-total {
      font-size: 18px;
      font-weight: bold;
      color: #22c55e;
    }

    .order-time {
      font-size: 12px;
      color: #666;
    }

    /* Prep Time Badge */
    .prep-time-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      background: #1a1a2e;
      border: 1px solid #333;
    }
    
    .prep-time-badge.fast {
      background: rgba(34, 197, 94, 0.15);
      border-color: #22c55e;
      color: #4ade80;
    }
    
    .prep-time-badge.normal {
      background: rgba(251, 191, 36, 0.15);
      border-color: #f59e0b;
      color: #fbbf24;
    }
    
    .prep-time-badge.slow {
      background: rgba(239, 68, 68, 0.15);
      border-color: #ef4444;
      color: #f87171;
    }
    
    .prep-time-badge.pending {
      color: #666;
    }

    .order-footer .prep-time-badge {
      margin-left: auto;
      margin-right: 10px;
    }

    .table-prep-time {
      font-weight: 600;
      font-size: 12px;
    }
    
    .table-prep-time.fast { color: #4ade80; }
    .table-prep-time.normal { color: #fbbf24; }
    .table-prep-time.slow { color: #f87171; }
    .table-prep-time.pending { color: #666; }

    /* Delivery Tracking Styles */
    .delivery-info {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 10px 12px;
      margin-top: 10px;
      border: 1px solid #333;
    }

    .delivery-status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .delivery-status-badge.pending { background: #374151; color: #9CA3AF; }
    .delivery-status-badge.assigned { background: #1E3A5F; color: #93C5FD; }
    .delivery-status-badge.started { background: #5B21B6; color: #DDD6FE; }
    .delivery-status-badge.in_progress { background: #7C3AED; color: #EDE9FE; }
    .delivery-status-badge.arrived { background: #B45309; color: #FDE68A; }
    .delivery-status-badge.delivered { background: #065F46; color: #A7F3D0; }
    .delivery-status-badge.failed { background: #7F1D1D; color: #FECACA; }

    .delivery-courier {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #ccc;
    }

    .delivery-courier .courier-icon {
      font-size: 16px;
    }

    .delivery-courier .courier-name {
      font-weight: 500;
    }

    .delivery-courier .track-link {
      margin-left: auto;
      color: #8B5CF6;
      text-decoration: none;
      font-size: 11px;
    }

    .delivery-courier .track-link:hover {
      text-decoration: underline;
    }

    .empty-state {
      text-align: center;
      color: #555;
      padding: 40px 20px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .last-updated {
      color: #666;
      font-size: 12px;
    }

    /* Sidebar Filters */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    
    .sidebar-overlay.active {
      display: block;
    }
    
    .filters-sidebar {
      position: fixed;
      top: 0;
      left: -350px;
      width: 320px;
      height: 100vh;
      background: #1a1a2e;
      border-right: 1px solid #333;
      z-index: 1000;
      transition: left 0.3s ease;
      overflow-y: auto;
      padding: 20px;
    }
    
    .filters-sidebar.active {
      left: 0;
    }
    
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #333;
    }
    
    .sidebar-header h2 {
      font-size: 18px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sidebar-close {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      line-height: 1;
    }
    
    .sidebar-close:hover {
      color: #fff;
    }
    
    .clear-filters-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 25px;
      transition: all 0.2s;
    }
    
    .clear-filters-btn:hover {
      background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%);
    }
    
    .filter-section {
      margin-bottom: 25px;
    }
    
    .filter-section-title {
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .filter-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-option:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    
    .filter-option.selected {
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid #8B5CF6;
    }
    
    .filter-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #8B5CF6;
      cursor: pointer;
    }
    
    .filter-option label {
      flex: 1;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #1a1a1a;
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid #333;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 1px solid #333;
      position: sticky;
      top: 0;
      background: #1a1a1a;
      z-index: 10;
    }

    .modal-header h2 {
      font-size: 24px;
      color: #8B5CF6;
    }

    .modal-close {
      background: #333;
      border: none;
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .modal-close:hover {
      background: #8B5CF6;
    }

    .modal-content {
      padding: 25px;
    }

    .detail-section {
      margin-bottom: 25px;
    }

    .detail-section h3 {
      font-size: 14px;
      color: #8B5CF6;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid #333;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .detail-item {
      background: #252525;
      padding: 12px 15px;
      border-radius: 8px;
    }

    .detail-item.full-width {
      grid-column: span 2;
    }

    .detail-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .detail-value {
      font-size: 15px;
      color: #fff;
      word-break: break-word;
    }

    .detail-value.highlight {
      color: #8B5CF6;
      font-weight: 600;
    }

    .detail-value.success {
      color: #22c55e;
    }

    .detail-value.warning {
      color: #f59e0b;
    }

    .detail-value.error {
      color: #ef4444;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
    }

    .items-table th {
      text-align: left;
      padding: 10px 12px;
      background: #252525;
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
    }

    .items-table td {
      padding: 12px;
      border-bottom: 1px solid #333;
      font-size: 14px;
    }

    .items-table tr:last-child td {
      border-bottom: none;
    }

    .items-table .item-name {
      font-weight: 500;
    }

    .items-table .item-modifiers {
      font-size: 12px;
      color: #888;
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .items-table .modifier-tag {
      background: rgba(139, 92, 246, 0.15);
      color: #A78BFA;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
    }

    .lifecycle-timeline {
      position: relative;
      padding-left: 30px;
    }

    .lifecycle-timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #333;
    }

    .lifecycle-event {
      position: relative;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: #252525;
      border-radius: 8px;
    }

    .lifecycle-event::before {
      content: '';
      position: absolute;
      left: -26px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #8B5CF6;
      border: 2px solid #1a1a1a;
    }

    .lifecycle-event .event-type {
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .lifecycle-event .event-status {
      font-size: 13px;
      color: #a78bfa;
    }

    .lifecycle-event .event-time {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .raw-json {
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      color: #888;
      overflow-x: auto;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    @media (max-width: 1400px) {
      .columns {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 1000px) {
      .columns {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .columns {
        grid-template-columns: 1fr;
      }
      .stats-bar {
        flex-wrap: wrap;
      }
      .stat-card {
        min-width: 30%;
        flex: 1 1 30%;
      }
      .detail-grid {
        grid-template-columns: 1fr;
      }
      .detail-item.full-width {
        grid-column: span 1;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
  
  <!-- Filters Sidebar (LEFT) -->
  <div class="filters-sidebar" id="filtersSidebar">
    <div class="sidebar-header">
      <h2>üéöÔ∏è Filters</h2>
      <button class="sidebar-close" onclick="toggleSidebar()">√ó</button>
    </div>
    
    <button class="clear-filters-btn" onclick="clearAllFilters()">Clear All Filters</button>
    
    <div class="filter-section">
      <div class="filter-section-title">üìç LOCATIONS</div>
      <div id="sidebarLocationOptions"></div>
    </div>
    
    <div class="filter-section">
      <div class="filter-section-title">üì± CHANNELS</div>
      <div class="filter-option">
        <input type="checkbox" id="channel-wolt" value="wolt" checked onchange="updateChannelFilter()">
        <label for="channel-wolt">üèÉ Wolt</label>
      </div>
      <div class="filter-option">
        <input type="checkbox" id="channel-ebar" value="ebar" checked onchange="updateChannelFilter()">
        <label for="channel-ebar">üì± eBar</label>
      </div>
      <div class="filter-option">
        <input type="checkbox" id="channel-gloriafood" value="gloriafood" checked onchange="updateChannelFilter()">
        <label for="channel-gloriafood">üçΩÔ∏è Gloria</label>
      </div>
      <div class="filter-option">
        <input type="checkbox" id="channel-pult" value="pult" checked onchange="updateChannelFilter()">
        <label for="channel-pult">üöö Food Truck</label>
      </div>
    </div>
  </div>

  <!-- Single Line Header -->
  <div class="header">
    <div class="header-left">
      <button class="burger-btn" onclick="toggleSidebar()">
        ‚ò∞
        <span class="filter-badge hidden" id="activeFiltersCount">0</span>
      </button>
      <h1>üçî Collina Orders</h1>
      <div class="date-selector">
        <button class="date-btn" onclick="changeDate(-1)">‚óÄ</button>
        <input type="date" id="selectedDate" onchange="loadOrdersForDate()">
        <button class="date-btn" onclick="changeDate(1)">‚ñ∂</button>
      </div>
    </div>
    
    <!-- Status Filter Tabs (inline) -->
    <div class="status-tabs">
      <button class="status-tab active" data-status="all" onclick="setStatusFilter('all')">
        <span class="tab-icon">üìã</span>
        <span class="tab-label">Sve</span>
        <span class="tab-count" id="countAll">0</span>
      </button>
      <button class="status-tab" data-status="new" onclick="setStatusFilter('new')">
        <span class="tab-icon">üÜï</span>
        <span class="tab-label">Novo</span>
        <span class="tab-count" id="countNew">0</span>
      </button>
      <button class="status-tab" data-status="production" onclick="setStatusFilter('production')">
        <span class="tab-icon">üë®‚Äçüç≥</span>
        <span class="tab-label">Priprema</span>
        <span class="tab-count" id="countProduction">0</span>
      </button>
      <button class="status-tab" data-status="ready" onclick="setStatusFilter('ready')">
        <span class="tab-icon">‚úÖ</span>
        <span class="tab-label">Spremno</span>
        <span class="tab-count" id="countReady">0</span>
      </button>
      <button class="status-tab" data-status="paid" onclick="setStatusFilter('paid')">
        <span class="tab-icon">üí∞</span>
        <span class="tab-label">Zavr≈°eno</span>
        <span class="tab-count" id="countPaid">0</span>
      </button>
      <button class="status-tab" data-status="canceled" onclick="setStatusFilter('canceled')">
        <span class="tab-icon">‚ùå</span>
        <span class="tab-label">Otkazano</span>
        <span class="tab-count" id="countCanceled">0</span>
      </button>
    </div>

    <div class="header-right">
      <!-- View Toggle -->
      <div class="view-toggle">
        <button class="view-btn active" data-view="cards" onclick="setViewMode('cards')">
          <span>üÉè</span>
        </button>
        <button class="view-btn" data-view="table" onclick="setViewMode('table')">
          <span>üìã</span>
        </button>
      </div>
      
      <div class="status">
        <div class="status-dot"></div>
        <span>Live</span>
        <span class="last-updated" id="lastUpdated">Loading...</span>
      </div>
    </div>
  </div>

  <!-- Stats bar hidden, counts now in tabs -->
  <div class="stats-bar" style="display: none;">
    <div class="stat-card new">
      <h3>New / Pending</h3>
      <div class="value" id="statNew">0</div>
    </div>
    <div class="stat-card production">
      <h3>Accepted / In Production</h3>
      <div class="value" id="statProduction">0</div>
    </div>
    <div class="stat-card ready">
      <h3>Ready / Delivery</h3>
      <div class="value" id="statReady">0</div>
    </div>
    <div class="stat-card paid">
      <h3>Paid Today</h3>
      <div class="value" id="statPaid">0</div>
    </div>
    <div class="stat-card canceled">
      <h3>Canceled / Rejected</h3>
      <div class="value" id="statCanceled">0</div>
    </div>
  </div>

  <!-- Grid view for filtered status -->
  <div class="orders-grid" id="ordersGrid" style="display: none;"></div>

  <!-- Table view -->
  <div class="orders-table-container" id="ordersTableContainer" style="display: none;">
    <table class="orders-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Lokacija</th>
          <th>Kanal</th>
          <th>Tip</th>
          <th>Stavke</th>
          <th>Ukupno</th>
          <th>Status</th>
          <th>Priprema</th>
          <th>Dostava</th>
          <th>Vreme</th>
        </tr>
      </thead>
      <tbody id="ordersTableBody"></tbody>
    </table>
  </div>

  <div class="columns" id="columnsView">
    <div class="column new">
      <div class="column-header">
        <h2>üÜï Novo</h2>
        <span class="count" id="colCountNew">0</span>
      </div>
      <div id="ordersNew" class="orders-list">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <div class="column production">
      <div class="column-header">
        <h2>üë®‚Äçüç≥ Priprema</h2>
        <span class="count" id="colCountProduction">0</span>
      </div>
      <div id="ordersProduction" class="orders-list">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <div class="column ready">
      <div class="column-header">
        <h2>‚úÖ Spremno / Dostava</h2>
        <span class="count" id="colCountReady">0</span>
      </div>
      <div id="ordersReady" class="orders-list">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <div class="column paid">
      <div class="column-header">
        <h2>üí∞ Zavr≈°eno</h2>
        <span class="count" id="colCountPaid">0</span>
      </div>
      <div id="ordersPaid" class="orders-list">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <div class="column canceled">
      <div class="column-header">
        <h2>‚ùå Otkazano</h2>
        <span class="count" id="colCountCanceled">0</span>
      </div>
      <div id="ordersCanceled" class="orders-list">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Order Detail Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Order Details</h2>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-content" id="modalContent">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://bbnbbbpofelbkyuffslj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibmJiYnBvZmVsYmt5dWZmc2xqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTI0MzQsImV4cCI6MjA4MDYyODQzNH0.koW44soAB-bEfh8OzqjGBwdgov4Snscw1ITsg5OureU';

    // ============================================
    // Initialize Supabase
    // ============================================
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Store all orders for quick access
    let allOrders = [];
    let locations = {};
    
    // Filter state
    let selectedLocations = new Set(); // Empty = all
    let selectedChannels = new Set(['wolt', 'gloriafood', 'ebar', 'pult']); // All by default
    let selectedStatus = 'all'; // Status filter: 'all', 'new', 'production', 'ready', 'paid', 'canceled'
    let viewMode = 'cards'; // 'cards' or 'table'

    // E-BAR items map for resolving modifier names (Sifra -> {n: name, p: price})
    const EBAR_ITEMS = {"6985164":{"n":"2X Collina burger+pomfrit+2x Pepsi 0.33","p":1527},"30410":{"n":"2x Pepsi+2xDouble collina SMASH","p":1584},"30411":{"n":"2xPepsi+2xDouble jalapeSMASH+2xPOMFRIT","p":1968},"8642":{"n":"7 Up 0.25 flasica","p":220},"778229":{"n":"7 UP 0.33 l","p":130},"8640":{"n":"7 UP 0.33 limenka","p":280},"10192":{"n":"Am.Nutela plazma visnja+kokta 0,33","p":512},"30413":{"n":"Am.pal.krem plazma+pepsi 0.33","p":572},"6985147":{"n":"Amer.Dubai palacinka","p":960},"10067":{"n":"Amercka palacinka javorov sirup","p":395},"5122":{"n":"Americka beli eurokrem","p":410},"20201":{"n":"Americka beli krem -D","p":575},"65203":{"n":"Americka cipiripi","p":395},"20203":{"n":"Americka cipiripi-D","p":555},"6985149":{"n":"Americka DUBAI pal.","p":790},"65120":{"n":"Americka eurokrem","p":395},"20202":{"n":"Americka eurokrem-D","p":555},"65121":{"n":"Americka nutella","p":445},"20200":{"n":"Americka nutella-D","p":575},"20252":{"n":"dod.banana dos.","p":80},"20224":{"n":"dod.barbique sos dos.","p":80},"20218":{"n":"dod.barbique sos dos.1","p":80},"20225":{"n":"dod.chily sos dos.","p":80},"20230":{"n":"dod.jaje dos.","p":85},"20262":{"n":"dod.kikiriki dos.","p":80},"20254":{"n":"dod.kokos dos.","p":75},"20227":{"n":"dod.krastavcici dos.","p":85},"20255":{"n":"dod.krem bananica dos.","p":90},"20233":{"n":"dod.kukuruz sal.dos.","p":145},"20264":{"n":"dod.lesnik dos.","p":90},"20229":{"n":"dod.majonez dos.","p":80},"20249":{"n":"dod.malina dos.","p":110},"20247":{"n":"dod.meso 120g dos.","p":215},"20246":{"n":"dod.meso 80g dos.","p":145},"20263":{"n":"dod.orah dos.","p":80},"20248":{"n":"dod.panirani kackavalj dos.","p":100},"20228":{"n":"dod.paradajz dos.","p":80},"20231":{"n":"dod.pavlaka dos.","p":80},"20237":{"n":"dod.pecenica dos.","p":100},"20244":{"n":"dod.pecurke dos.","p":85},"20234":{"n":"dod.pileca sal.dos","p":145},"20260":{"n":"dod.plazma dos.","p":80},"20261":{"n":"dod.plazma u mleku dos.","p":100},"20289":{"n":"Dod.polimark kecap dos.","p":85},"20245":{"n":"dod.pomfrit dos.","p":250},"20250":{"n":"dod.pomorandza dos.","p":80},"20256":{"n":"dod.preliv cokolada dos.","p":80},"20257":{"n":"dod.preliv karamela dos.","p":80},"20258":{"n":"dod.preliv sumsko voce dos.","p":80},"20238":{"n":"dod.prsuta dos.","p":120},"20235":{"n":"dod.ruska sal.dos","p":125},"20242":{"n":"dod.senf dos.","p":80},"20226":{"n":"dod.slanina dos.","p":90},"20236":{"n":"dod.sunka dos.","p":100},"20253":{"n":"dod.suvo grozdje dos.","p":85},"20243":{"n":"dod.tartar sos dos","p":80},"20239":{"n":"dod.topljeni sir dos.","p":90},"20232":{"n":"dod.urnebes dos.","p":85},"20251":{"n":"dod.visnja dos.","p":90},"238":{"n":"Dodatak Banana","p":80},"8809":{"n":"Dodatak barbiqu sos","p":80},"222":{"n":"Dodatak chily sos","p":80},"258":{"n":"Dodatak feta sir","p":80},"212":{"n":"Dodatak govedja prsuta","p":120},"8695":{"n":"Dodatak heinz kecap","p":85},"10041":{"n":"Dodatak jaje a","p":85},"8670":{"n":"Dodatak kackavalj 50 gr","p":80},"240":{"n":"Dodatak karamela","p":60},"9690":{"n":"Dodatak kecap bb","p":85},"221":{"n":"Dodatak Kikiriki","p":80},"9653":{"n":"Dodatak kikiriki c","p":80},"233":{"n":"Dodatak Kokos","p":75},"244":{"n":"Dodatak krastavcici kiseli","p":85},"234":{"n":"Dodatak krem bananica","p":90},"246":{"n":"Dodatak kukuruz","p":75},"218":{"n":"Dodatak lesnik","p":90},"8684":{"n":"Dodatak luk","p":20},"202":{"n":"Dodatak majonez","p":80},"237":{"n":"Dodatak malina","p":110},"10036":{"n":"Dodatak malina a","p":110},"9662":{"n":"Dodatak malina c","p":110},"9703":{"n":"Dodatak malo meso","p":145},"10059":{"n":"Dodatak malo meso bb","p":145},"287":{"n":"Dodatak Margarin","p":60},"223":{"n":"Dodatak orah","p":80},"8667":{"n":"Dodatak origano","p":20},"8703":{"n":"Dodatak panirani kackavalj","p":100},"257":{"n":"Dodatak paradajz","p":80},"210":{"n":"Dodatak pecenica","p":100},"283":{"n":"Dodatak pecurke","p":85},"215":{"n":"Dodatak pecurke m","p":85},"10043":{"n":"Dodatak pileca salata a","p":145},"8721":{"n":"Dodatak piletina 70 gr","p":90},"216":{"n":"Dodatak plazma","p":80},"239":{"n":"Dodatak plazma u mleku","p":100},"200":{"n":"Dodatak polimark kecap","p":85},"225":{"n":"Dodatak pomfrit 150 gr","p":200},"232":{"n":"Dodatak pomorandza","p":80},"241":{"n":"Dodatak preliv cokolada","p":80},"242":{"n":"Dodatak preliv sumsko voce","p":80},"259":{"n":"Dodatak ruska salata","p":145},"206":{"n":"Dodatak senf","p":80},"289":{"n":"Dodatak slag","p":70},"286":{"n":"Dodatak slanina","p":90},"208":{"n":"Dodatak sunka","p":100},"236":{"n":"Dodatak suvo grozdje","p":85},"8804":{"n":"Dodatak tartar sos","p":80},"278":{"n":"Dodatak topljeni sir","p":90},"282":{"n":"Dodatak tunjevina","p":80},"245":{"n":"Dodatak urnebes","p":85},"9704":{"n":"Dodatak veliko meso","p":215},"10060":{"n":"Dodatak veliko meso bb","p":215},"235":{"n":"Dodatak visnja","p":90},"8663":{"n":"Dodatak zelena salata","p":60}};

    // Price-based modifier name lookup (for when referenceID doesn't match E-BAR Sifra)
    // Maps price -> most common modifier name for that price (for sweet pancakes context)
    const MODIFIER_BY_PRICE = {
      20: "Dodatak luk",
      50: "Jalapeno dodatak", 
      60: "Dodatak karamela",
      65: "Jaje dodatak",
      70: "Dodatak slag",
      75: "Dodatak kokos",
      80: "Dodatak",  // Many options at 80 - show generic
      85: "Dodatak jaje",
      90: "Dodatak slanina",
      100: "Dodatak plazma u mleku",
      110: "Dodatak malina",
      120: "Dodatak prsuta",
      125: "Dodatak ruska salata",
      145: "Dodatak malo meso",
      200: "Dodatak pomfrit",
      215: "Dodatak veliko meso",
      250: "Dodatak pomfrit"
    };
    
    // Cache for product names fetched from Supabase
    let productNamesCache = {};
    let productNamesFetched = false;
    
    // Fetch product names from Supabase emeni_products table
    async function fetchProductNames() {
      if (productNamesFetched) return;
      
      try {
        const { data, error } = await supabaseClient
          .from('emeni_products')
          .select('product_id, name, price');
        
        if (data && Array.isArray(data)) {
          data.forEach(p => {
            productNamesCache[p.product_id] = { name: p.name, price: p.price };
          });
          console.log(`Loaded ${data.length} product names`);
        }
      } catch (e) {
        console.log('Could not fetch product names:', e);
      }
      productNamesFetched = true;
    }

    // Helper function to resolve modifier name from productID, referenceID or price
    function getModifierName(modifier) {
      // First try to get name from modifier itself
      if (modifier.name && modifier.name !== 'Modifier' && !modifier.name.startsWith('Modifier')) {
        return modifier.name;
      }
      
      // Try to get name from productNamesCache using productID
      const productId = modifier.productID || modifier.product_id;
      if (productId && productNamesCache[productId]) {
        return productNamesCache[productId].name;
      }
      
      // Try to get name from EBAR_ITEMS using productReferenceID
      const refId = modifier.productReferenceID || modifier.referenceID || modifier.reference_id;
      if (refId && EBAR_ITEMS[refId]) {
        return EBAR_ITEMS[refId].n;
      }
      
      // Fallback: match by price to get a reasonable name
      const price = parseFloat(modifier.price) || 0;
      if (MODIFIER_BY_PRICE[price]) {
        return MODIFIER_BY_PRICE[price];
      }
      
      // Last resort - show price in name
      return modifier.value || `Dodatak (${price} RSD)`;
    }

    // Helper function to get modifier price
    function getModifierPrice(modifier) {
      // First try modifier's own price
      if (modifier.price !== undefined && modifier.price !== null) {
        return parseFloat(modifier.price) || 0;
      }
      // Fallback to EBAR_ITEMS
      const refId = modifier.productReferenceID || modifier.referenceID || modifier.reference_id;
      if (refId && EBAR_ITEMS[refId]) {
        return EBAR_ITEMS[refId].p || 0;
      }
      return 0;
    }

    // Helper function to calculate item total including modifiers
    function calculateItemTotal(item) {
      const qty = parseFloat(item.quantity) || 1;
      let itemTotal = (parseFloat(item.price) || 0) * qty;
      
      if (item.modifiers && Array.isArray(item.modifiers)) {
        item.modifiers.forEach(mod => {
          const modPrice = getModifierPrice(mod);
          const modQty = parseFloat(mod.quantity) || 1;
          itemTotal += modPrice * modQty * qty;
        });
      }
      return itemTotal;
    }

    // Fetch locations
    async function fetchLocations() {
      const { data, error } = await supabaseClient
        .from('emeni_locations')
        .select('*');
      
      if (!error && data) {
        data.forEach(loc => {
          locations[loc.company_id] = loc.location_name;
        });
        // Populate location filter dropdown
        populateLocationFilter();
      }
    }

    // ============================================
    // Filter Functions
    // ============================================
    function populateLocationFilter() {
      const container = document.getElementById('sidebarLocationOptions');
      container.innerHTML = '';
      
      Object.entries(locations).forEach(([id, name]) => {
        const div = document.createElement('div');
        div.className = 'filter-option';
        div.innerHTML = `
          <input type="checkbox" id="loc-${id}" value="${id}" checked onchange="updateLocationFilter()">
          <label for="loc-${id}">${name}</label>
        `;
        container.appendChild(div);
      });
    }
    
    function toggleSidebar() {
      const sidebar = document.getElementById('filtersSidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }
    
    function clearAllFilters() {
      // Reset all location checkboxes
      document.querySelectorAll('#sidebarLocationOptions input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
      });
      // Reset all channel checkboxes
      document.querySelectorAll('.filters-sidebar input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
      });
      
      selectedLocations = new Set();
      selectedChannels = new Set(['wolt', 'gloriafood', 'ebar', 'pult']);
      updateActiveFiltersCount();
      applyFilters();
    }
    
    function updateActiveFiltersCount() {
      let count = 0;
      
      // Count unchecked locations
      const totalLocations = Object.keys(locations).length;
      const checkedLocations = document.querySelectorAll('#sidebarLocationOptions input[type="checkbox"]:checked').length;
      if (checkedLocations < totalLocations && checkedLocations > 0) {
        count += (totalLocations - checkedLocations);
      }
      
      // Count unchecked channels
      const totalChannels = 4;
      const checkedChannels = document.querySelectorAll('.filters-sidebar input[id^="channel-"]:checked').length;
      if (checkedChannels < totalChannels) {
        count += (totalChannels - checkedChannels);
      }
      
      const badge = document.getElementById('activeFiltersCount');
      badge.textContent = count;
      badge.classList.toggle('hidden', count === 0);
    }

    function toggleAllLocations(checkbox) {
      const checkboxes = document.querySelectorAll('#sidebarLocationOptions input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
      updateLocationFilter();
    }

    function toggleAllChannels(checkbox) {
      const checkboxes = document.querySelectorAll('.filters-sidebar input[id^="channel-"]');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
      updateChannelFilter();
    }

    function updateLocationFilter() {
      const checkboxes = document.querySelectorAll('#sidebarLocationOptions input[type="checkbox"]:checked');
      const allCheckboxes = document.querySelectorAll('#sidebarLocationOptions input[type="checkbox"]');
      
      if (checkboxes.length === allCheckboxes.length) {
        // All selected = no filter
        selectedLocations = new Set();
      } else {
        selectedLocations = new Set(Array.from(checkboxes).map(cb => cb.value));
      }
      
      updateActiveFiltersCount();
      applyFilters();
    }

    function updateChannelFilter() {
      const checkboxes = document.querySelectorAll('.filters-sidebar input[id^="channel-"]:checked');
      selectedChannels = new Set(Array.from(checkboxes).map(cb => cb.value));
      
      updateActiveFiltersCount();
      applyFilters();
    }

    function setStatusFilter(status) {
      selectedStatus = status;
      
      // Update active tab
      document.querySelectorAll('.status-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.status === status);
      });
      
      applyFilters();
    }

    function setViewMode(mode) {
      viewMode = mode;
      
      // Update active button
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === mode);
      });
      
      applyFilters();
    }

    function getStatusGroup(order) {
      const status = order.status;
      // Check paid first - paid orders should go to paid regardless of status
      if (order.is_paid === true || order.is_paid === 'true') return 'paid';
      if (STATUS_GROUPS.canceled.includes(status)) return 'canceled';
      if (STATUS_GROUPS.new.includes(status)) return 'new';
      if (STATUS_GROUPS.production.includes(status)) return 'production';
      if (STATUS_GROUPS.ready.includes(status)) return 'ready';
      return 'other';
    }

    function updateStatusCounts(orders) {
      const counts = { all: 0, new: 0, production: 0, ready: 0, paid: 0, canceled: 0 };
      
      orders.forEach(order => {
        counts.all++;
        const group = getStatusGroup(order);
        if (counts[group] !== undefined) counts[group]++;
      });
      
      // Update tab counts
      document.getElementById('countAll').textContent = counts.all;
      document.getElementById('countNew').textContent = counts.new;
      document.getElementById('countProduction').textContent = counts.production;
      document.getElementById('countReady').textContent = counts.ready;
      document.getElementById('countPaid').textContent = counts.paid;
      document.getElementById('countCanceled').textContent = counts.canceled;
    }

    function applyFilters() {
      // First apply location and channel filters
      const baseFiltered = allOrders.filter(order => {
        // Location filter
        const locationMatch = selectedLocations.size === 0 || 
                             selectedLocations.size === Object.keys(locations).length ||
                             selectedLocations.has(String(order.company_id));
        
        // Channel filter
        const provider = (order.provider || '').toLowerCase();
        const channelMatch = selectedChannels.has(provider) || 
                            (provider === '' && selectedChannels.has('pult'));
        
        return locationMatch && channelMatch;
      });
      
      // Update counts based on location/channel filtered orders
      updateStatusCounts(baseFiltered);
      
      // Then apply status filter
      const filteredOrders = baseFiltered.filter(order => {
        if (selectedStatus === 'all') return true;
        return getStatusGroup(order) === selectedStatus;
      });
      
      renderOrders(filteredOrders);
    }

    // Status groupings
    const STATUS_GROUPS = {
      new: [1, 12, 13],
      production: [3, 4],
      ready: [5, 6, 7],
      paid: [],
      canceled: [8, 9, 11]  // Rejected, Canceled, Invalid
    };

    const STATUS_NAMES = {
      1: 'New',
      3: 'Accepted',
      4: 'In Production',
      5: 'Ready',
      6: 'Dispatched',
      7: 'Delivered',
      8: 'Rejected',
      9: 'Canceled',
      10: 'Completed',
      11: 'Invalid',
      12: 'New Preorder',
      13: 'Pending',
      14: 'Pending Payment'
    };

    // ============================================
    // Fetch Orders
    // ============================================
    let selectedDateValue = null;

    async function fetchOrders() {
      const dateInput = document.getElementById('selectedDate');
      let startDate, endDate;
      
      if (dateInput && dateInput.value) {
        // Use selected date
        startDate = new Date(dateInput.value + 'T00:00:00');
        endDate = new Date(dateInput.value + 'T23:59:59');
      } else {
        // Default to today
        startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
        endDate = new Date();
        endDate.setHours(23, 59, 59, 999);
      }

      const { data: orders, error } = await supabaseClient
        .from('emeni_orders')
        .select('*')
        .gte('created_at', startDate.toISOString())
        .lte('created_at', endDate.toISOString())
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error fetching orders:', error);
        return [];
      }

      const orderIds = orders.map(o => o.order_id);
      const { data: items } = await supabaseClient
        .from('emeni_order_items')
        .select('*')
        .in('order_id', orderIds);

      // Fetch lifecycle data - use order_id from database (batch to avoid limits)
      const orderIdsForLifecycle = orders.map(o => o.order_id);
      
      let lifecycleData = [];
      if (orderIdsForLifecycle.length > 0) {
        const batchSize = 100;
        for (let i = 0; i < orderIdsForLifecycle.length; i += batchSize) {
          const batch = orderIdsForLifecycle.slice(i, i + batchSize);
          const { data } = await supabaseClient
            .from('emeni_order_lifecycle')
            .select('*')
            .in('order_id', batch);
          if (data) {
            lifecycleData = lifecycleData.concat(data);
          }
        }
      }

      orders.forEach(order => {
        order.items = items?.filter(i => i.order_id === order.order_id) || [];
        
        // Match lifecycle by order_id from database
        const lifecycle = lifecycleData.filter(l => l.order_id === order.order_id);
        
        // Determine provider type for different prep time logic
        const provider = (order.provider || '').toLowerCase();
        const isEbar = provider === 'ebar' || provider === 'emeniwaiter';
        
        // For eBar: prep time = Accepted (status 3) to Paid (status 5)
        // For Wolt/Gloria: prep time = Accepted (status 3) to Ready (status 5 or 7)
        const acceptedEvent = lifecycle.find(l => Number(l.status) === 3); // status 3 = accepted
        const paidEvent = lifecycle.find(l => l.event_type === 'order.paid' || Number(l.status) === 5); // paid event or status 5
        const readyEvent = lifecycle.find(l => Number(l.status) === 5 || Number(l.status) === 7); // status 5/7 = ready/delivered
        
        if (isEbar) {
          // eBar: from accepted/created to paid
          const startEvent = acceptedEvent || lifecycle.find(l => l.event_type === 'order.created');
          const endEvent = paidEvent;
          
          if (startEvent && endEvent) {
            const startTime = new Date(startEvent.timestamp);
            const endTime = new Date(endEvent.timestamp);
            order.prep_minutes = Math.round((endTime - startTime) / 60000);
          } else if (startEvent && Number(order.status) < 5) {
            // Still in progress - calculate time since started
            const startTime = new Date(startEvent.timestamp);
            order.prep_minutes_ongoing = Math.round((new Date() - startTime) / 60000);
          }
        } else {
          // Wolt/Gloria: from accepted to ready
          if (acceptedEvent && readyEvent) {
            const acceptedTime = new Date(acceptedEvent.timestamp);
            const readyTime = new Date(readyEvent.timestamp);
            order.prep_minutes = Math.round((readyTime - acceptedTime) / 60000);
          } else if (acceptedEvent) {
            // Still in production - calculate time since accepted
            const acceptedTime = new Date(acceptedEvent.timestamp);
            order.prep_minutes_ongoing = Math.round((new Date() - acceptedTime) / 60000);
          } else {
            // Fallback: try to get times from raw_payload
            const rp = order.raw_payload || {};
            
            // Get accepted time from various possible fields
            const acceptedStr = rp.accepted || rp.acceptedAt || rp.confirmed_at || rp.pickup?.time;
            // Get ready time from various possible fields  
            const readyStr = rp.ready || rp.readyAt || rp.ready_at || rp.completed || rp.completedAt;
            
            if (acceptedStr && readyStr) {
              const acceptedTime = new Date(acceptedStr);
              const readyTime = new Date(readyStr);
              if (!isNaN(acceptedTime) && !isNaN(readyTime)) {
                order.prep_minutes = Math.round((readyTime - acceptedTime) / 60000);
              }
            } else if (acceptedStr && (Number(order.status) === 3 || Number(order.status) === 4)) {
              // In production with accepted time from raw_payload
              const acceptedTime = new Date(acceptedStr);
              if (!isNaN(acceptedTime)) {
                order.prep_minutes_ongoing = Math.round((new Date() - acceptedTime) / 60000);
              }
            }
            
            // For Wolt: check pickup.time as accepted and delivery estimates
            if (!order.prep_minutes && !order.prep_minutes_ongoing && rp.pickup?.time) {
              const pickupTime = new Date(rp.pickup.time);
              // If order is ready/delivered, estimate from pickup to now or delivery
              if (Number(order.status) >= 5 && rp.dropoff?.time) {
                const dropoffTime = new Date(rp.dropoff.time);
                // Rough estimate: prep time is ~70% of total time (pickup to dropoff)
                const totalMins = Math.round((dropoffTime - pickupTime) / 60000);
                order.prep_minutes = Math.max(5, Math.round(totalMins * 0.5)); // Estimate
              }
            }
          }
        }
        
        // Sanity check - cap unrealistic values
        if (order.prep_minutes > 180) order.prep_minutes = undefined; // More than 3 hours is likely wrong
        if (order.prep_minutes_ongoing > 180) order.prep_minutes_ongoing = undefined;
      });

      allOrders = orders;
      return orders;
    }

    // ============================================
    // Fetch Order Lifecycle
    // ============================================
    async function fetchOrderLifecycle(orderId) {
      const { data, error } = await supabaseClient
        .from('emeni_order_lifecycle')
        .select('*')
        .eq('order_id', orderId)
        .order('timestamp', { ascending: true });

      if (error) {
        console.error('Error fetching lifecycle:', error);
        return [];
      }
      return data || [];
    }

    // ============================================
    // Modal Functions
    // ============================================
    async function openOrderDetail(orderId) {
      const order = allOrders.find(o => o.order_id === orderId);
      if (!order) return;

      const lifecycle = await fetchOrderLifecycle(orderId);
      
      document.getElementById('modalTitle').textContent = `Order #${order.order_no}`;
      document.getElementById('modalContent').innerHTML = renderOrderDetail(order, lifecycle);
      document.getElementById('modalOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    // Close modal on overlay click
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('modalOverlay')) {
        closeModal();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
        // Also close sidebar if open
        const sidebar = document.getElementById('filtersSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        if (sidebar.classList.contains('active')) {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
        }
      }
    });

    // ============================================
    // Render Order Detail
    // ============================================
    function renderOrderDetail(order, lifecycle) {
      // Get items from regular items, raw_payload.items, or invalidOrderDetails
      let items = order.items || [];
      let total = 0;
      
      if (items.length === 0 && order.raw_payload?.items) {
        // Use items directly from raw_payload (for eBar, etc.)
        items = order.raw_payload.items;
        total = items.reduce((sum, item) => sum + (parseFloat(item.price) * parseFloat(item.quantity)), 0);
      } else if (items.length === 0 && order.raw_payload?.invalidOrderDetails?.items) {
        items = order.raw_payload.invalidOrderDetails.items;
        total = order.raw_payload.invalidOrderDetails.total || 0;
      } else {
        total = items.reduce((sum, item) => sum + (parseFloat(item.price) * parseFloat(item.quantity)), 0);
      }
      
      const formatDate = (date) => date ? new Date(date).toLocaleString('sr-RS') : 'N/A';
      const formatValue = (val) => val !== null && val !== undefined && val !== '' ? val : 'N/A';

      // Items table with correct modifier names and totals
      const itemsHtml = items.map(item => {
        const itemTotal = calculateItemTotal(item);
        const modifiersHtml = item.modifiers && item.modifiers.length > 0 
          ? `<div class="item-modifiers">
              ${item.modifiers.map(m => {
                const modName = getModifierName(m);
                const modPrice = getModifierPrice(m);
                const modQty = parseFloat(m.quantity) || 1;
                return `<span class="modifier-tag">+ ${modName} (${modPrice} RSD${modQty > 1 ? ' x' + modQty : ''})</span>`;
              }).join(' ')}
            </div>`
          : '';
        
        return `
        <tr>
          <td>
            <div class="item-name">${item.name}</div>
            ${modifiersHtml}
            ${item.note ? `<div class="item-modifiers">üìù ${item.note}</div>` : ''}
          </td>
          <td>${item.quantity}</td>
          <td>${parseFloat(item.price).toFixed(0)} RSD</td>
          <td>${itemTotal.toFixed(0)} RSD</td>
          <td>${item.reference_id || item.posID || item.referenceID || 'N/A'}</td>
        </tr>
      `}).join('') || '<tr><td colspan="5" style="text-align:center;color:#666;">Nema stavki</td></tr>';
      
      // Calculate correct total including modifiers
      const correctTotal = items.reduce((sum, item) => sum + calculateItemTotal(item), 0);

      // Lifecycle timeline
      const lifecycleHtml = lifecycle.map(event => `
        <div class="lifecycle-event">
          <div class="event-type">${event.event_type}</div>
          ${event.status ? `<div class="event-status">Status: ${STATUS_NAMES[event.status] || event.status}</div>` : ''}
          <div class="event-time">${formatDate(event.timestamp)}</div>
        </div>
      `).join('') || '<p style="color: #666;">No lifecycle events</p>';

      return `
        <!-- Order Info -->
        <div class="detail-section">
          <h3>Order Information</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Order ID</div>
              <div class="detail-value">${order.order_id}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Order Number</div>
              <div class="detail-value highlight">#${order.order_no}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Provider</div>
              <div class="detail-value">${formatValue(order.provider)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Location</div>
              <div class="detail-value highlight">${locations[order.company_id] || 'Unknown'} (ID: ${formatValue(order.company_id)})</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status</div>
              <div class="detail-value ${order.status === 5 ? 'success' : ''}">${STATUS_NAMES[order.status] || order.status} (${order.status})</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Delivery Type</div>
              <div class="detail-value">${formatValue(order.delivery_type)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Is Paid</div>
              <div class="detail-value ${order.is_paid ? 'success' : 'warning'}">${order.is_paid ? '‚úÖ Yes' : '‚ùå No'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Is Invalid</div>
              <div class="detail-value ${order.is_invalid ? 'error' : ''}">${order.is_invalid ? '‚ö†Ô∏è Yes' : 'No'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Payment Method</div>
              <div class="detail-value">${formatValue(order.payment_method)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Total</div>
              <div class="detail-value success" style="font-size: 20px; font-weight: bold;">${correctTotal.toFixed(0)} RSD</div>
            </div>
          </div>
        </div>

        <!-- Staff & Table -->
        <div class="detail-section">
          <h3>Staff & Table</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Waiter ID</div>
              <div class="detail-value">${formatValue(order.waiter_id)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Waiter Name</div>
              <div class="detail-value">${formatValue(order.waiter_name)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Waiter Reference ID</div>
              <div class="detail-value">${formatValue(order.waiter_reference_id)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Table ID</div>
              <div class="detail-value">${formatValue(order.table_id)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Table Reference ID</div>
              <div class="detail-value">${formatValue(order.table_reference_id)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Created By</div>
              <div class="detail-value">${formatValue(order.created_by_name)} (ID: ${formatValue(order.created_by_user_id)})</div>
            </div>
          </div>
        </div>

        <!-- Customer Info -->
        <div class="detail-section">
          <h3>Customer Information</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Customer ID</div>
              <div class="detail-value">${formatValue(order.customer_id)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Customer Name</div>
              <div class="detail-value">${formatValue(order.customer_name)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Phone</div>
              <div class="detail-value">${formatValue(order.customer_phone)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Latitude</div>
              <div class="detail-value">${formatValue(order.latitude)}</div>
            </div>
            <div class="detail-item full-width">
              <div class="detail-label">Address</div>
              <div class="detail-value">${formatValue(order.customer_address)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Longitude</div>
              <div class="detail-value">${formatValue(order.longitude)}</div>
            </div>
          </div>
        </div>

        <!-- Delivery Tracking -->
        ${order.delivery_type === 'Delivery' ? `
        <div class="detail-section">
          <h3>üõµ Delivery Tracking</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Delivery Status</div>
              <div class="detail-value"><span class="delivery-status-badge ${order.delivery_status || 'pending'}">${order.delivery_status || 'pending'}</span></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Tookan Job ID</div>
              <div class="detail-value">${formatValue(order.tookan_job_id)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Courier</div>
              <div class="detail-value">${order.is_wolt_drive ? 'üöó ' : 'üõµ '}${formatValue(order.fleet_name)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Courier Phone</div>
              <div class="detail-value">${formatValue(order.fleet_phone)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Started At</div>
              <div class="detail-value">${formatDate(order.delivery_started_at)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Arrived At</div>
              <div class="detail-value">${formatDate(order.delivery_arrived_at)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Completed At</div>
              <div class="detail-value">${formatDate(order.delivery_completed_at)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Tracking Link</div>
              <div class="detail-value">${order.tracking_link ? `<a href="${order.tracking_link}" target="_blank" style="color: #8B5CF6;">Open Tracking ‚Üí</a>` : '-'}</div>
            </div>
          </div>
        </div>
        ` : ''}

        <!-- Timestamps -->
        <div class="detail-section">
          <h3>Timestamps</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Created At</div>
              <div class="detail-value">${formatDate(order.created_at)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Modified At</div>
              <div class="detail-value">${formatDate(order.modified_at)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Accepted At</div>
              <div class="detail-value">${formatDate(order.accepted_at)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Due Date</div>
              <div class="detail-value">${formatDate(order.due_date)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Received At</div>
              <div class="detail-value">${formatDate(order.received_at)}</div>
            </div>
          </div>
        </div>

        <!-- Notes -->
        ${order.note ? `
        <div class="detail-section">
          <h3>Notes</h3>
          <div class="detail-item full-width" style="background: #3b2f00; border: 1px solid #f59e0b;">
            <div class="detail-value" style="color: #fbbf24;">${order.note}</div>
          </div>
        </div>
        ` : ''}

        <!-- Order Items -->
        <div class="detail-section">
          <h3>Order Items (${order.items.length})</h3>
          <table class="items-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Total</th>
                <th>Ref ID</th>
              </tr>
            </thead>
            <tbody>
              ${itemsHtml}
            </tbody>
          </table>
        </div>

        <!-- Lifecycle -->
        <div class="detail-section">
          <h3>Order Lifecycle</h3>
          <div class="lifecycle-timeline">
            ${lifecycleHtml}
          </div>
        </div>

        <!-- Raw Payload -->
        <div class="detail-section">
          <h3>Raw Payload (JSON)</h3>
          <pre class="raw-json">${JSON.stringify(order.raw_payload, null, 2) || 'No raw payload available'}</pre>
        </div>
      `;
    }

    // ============================================
    // Render Table Row
    // ============================================
    function renderTableRow(order) {
      // Get items from regular items, raw_payload.items, or invalidOrderDetails
      let items = order.items || [];
      
      if (items.length === 0 && order.raw_payload?.items) {
        items = order.raw_payload.items;
      } else if (items.length === 0 && order.raw_payload?.invalidOrderDetails?.items) {
        items = order.raw_payload.invalidOrderDetails.items;
      }
      
      // Calculate total including modifiers
      const total = items.reduce((sum, item) => sum + calculateItemTotal(item), 0);
      
      const time = new Date(order.created_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
      const locationName = locations[order.company_id] || `ID: ${order.company_id}`;
      const statusGroup = getStatusGroup(order);
      
      const statusLabels = {
        new: 'Novo',
        production: 'Priprema',
        ready: 'Spremno / Dostava',
        paid: 'Zavr≈°eno',
        canceled: 'Otkazano',
        other: 'Ostalo'
      };
      
      const deliveryLabels = {
        pending: 'ƒåeka se',
        assigned: 'Dodeljeno',
        started: 'Krenuo',
        in_progress: 'U toku',
        arrived: 'Stigao',
        delivered: 'Dostavljeno',
        failed: 'Neuspe≈°no'
      };
      
      const itemsSummary = items.map(i => `${i.quantity}x ${i.name}`).join(', ') || 'Nema stavki';
      const provider = (order.provider || 'pult').toLowerCase();
      const deliveryStatus = order.delivery_status || 'pending';
      
      // Check for notes - can be on order level OR on individual items
      const orderNote = order.note || order.raw_payload?.note || '';
      const itemNotes = items.filter(i => i.note).map(i => `${i.name}: ${i.note}`);
      const hasNotes = orderNote || itemNotes.length > 0;
      const allNotes = [orderNote, ...itemNotes].filter(n => n).join(' | ');
      
      let deliveryHtml = '-';
      if (order.delivery_type === 'Delivery') {
        deliveryHtml = `
          <div class="table-delivery">
            <span class="table-delivery-status ${deliveryStatus}">${deliveryLabels[deliveryStatus] || deliveryStatus}</span>
            ${order.fleet_name ? `<span style="color:#888;font-size:11px;">${order.fleet_name}</span>` : ''}
          </div>
        `;
      }
      
      // Prep time display
      let prepTimeHtml = '-';
      let prepTimeClass = 'pending';
      if (order.prep_minutes !== undefined) {
        const mins = order.prep_minutes;
        prepTimeClass = mins <= 15 ? 'fast' : mins <= 30 ? 'normal' : 'slow';
        prepTimeHtml = `<span class="table-prep-time ${prepTimeClass}">‚úì ${mins} min</span>`;
      } else if (order.prep_minutes_ongoing !== undefined) {
        const mins = order.prep_minutes_ongoing;
        prepTimeClass = mins <= 15 ? 'fast' : mins <= 30 ? 'normal' : 'slow';
        prepTimeHtml = `<span class="table-prep-time ${prepTimeClass}">‚è± ${mins} min</span>`;
      }
      
      return `
        <tr onclick="openOrderDetail(${order.order_id})">
          <td><strong>#${order.order_no}</strong> ${hasNotes ? `<span title="${allNotes.replace(/"/g, '&quot;')}" style="cursor:help;">üìù</span>` : ''}</td>
          <td><span class="table-location">${locationName}</span></td>
          <td><span class="table-provider ${provider}">${provider}</span></td>
          <td>${order.delivery_type || 'N/A'}</td>
          <td><div class="table-items" title="${itemsSummary}">${itemsSummary}</div></td>
          <td class="table-total">${total.toFixed(0)} RSD</td>
          <td><span class="table-status ${statusGroup}">${statusLabels[statusGroup]}</span></td>
          <td>${prepTimeHtml}</td>
          <td>${deliveryHtml}</td>
          <td>${time}</td>
        </tr>
      `;
    }

    // ============================================
    // Render Order Card
    // ============================================
    function renderOrderCard(order, statusClass) {
      // Get items from regular items, raw_payload.items, or invalidOrderDetails
      let items = order.items || [];
      
      if (items.length === 0 && order.raw_payload?.items) {
        items = order.raw_payload.items;
      } else if (items.length === 0 && order.raw_payload?.invalidOrderDetails?.items) {
        items = order.raw_payload.invalidOrderDetails.items;
      }
      
      // Calculate total including modifiers
      const total = items.reduce((sum, item) => sum + calculateItemTotal(item), 0);
      
      const time = new Date(order.created_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
      const locationName = locations[order.company_id] || `ID: ${order.company_id}`;
      
      // Show item prices including modifiers
      const itemsHtml = items.slice(0, 3).map(item => {
        const itemTotal = calculateItemTotal(item);
        const hasModifiers = item.modifiers && item.modifiers.length > 0;
        return `
        <div class="item">
          <span><span class="quantity">${item.quantity}x</span> ${item.name}${hasModifiers ? ' <span style="color:#8B5CF6;font-size:10px;">+${item.modifiers.length}</span>' : ''}</span>
          <span>${itemTotal.toFixed(0)}</span>
        </div>
      `}).join('');

      const moreItems = items.length > 3 ? `<div class="item" style="color: #666;">+ ${items.length - 3} more items...</div>` : '';

      // Delivery tracking info
      let deliveryHtml = '';
      if (order.delivery_type === 'Delivery') {
        const deliveryStatus = order.delivery_status || 'pending';
        const statusLabels = {
          pending: '‚è≥ ƒåeka se',
          assigned: 'üë§ Dodeljeno',
          started: 'üõµ Kurir krenuo',
          in_progress: 'üìç U toku',
          arrived: 'üè† Stigao',
          delivered: '‚úÖ Dostavljeno',
          failed: '‚ùå Neuspe≈°no'
        };
        
        // Map job_status numbers to status names
        const jobStatusMap = {
          0: 'assigned',      // Assigned
          1: 'started',       // Started  
          2: 'delivered',     // Successful/Completed
          3: 'failed',        // Failed
          4: 'in_progress',   // In Progress
          6: 'pending',       // Unassigned
          7: 'pending',       // Accepted
          8: 'pending',       // Decline
          9: 'arrived'        // Arrived
        };
        
        // Use job_status if delivery_status is not set
        let displayStatus = deliveryStatus;
        if (order.job_status !== undefined && !order.delivery_status) {
          displayStatus = jobStatusMap[order.job_status] || 'pending';
        }
        
        deliveryHtml = `
          <div class="delivery-info">
            <span class="delivery-status-badge ${displayStatus}">${statusLabels[displayStatus] || displayStatus}</span>
            ${order.fleet_name ? `
              <div class="delivery-courier">
                <span class="courier-icon">${order.is_wolt_drive ? 'üöó' : 'üõµ'}</span>
                <span class="courier-name">${order.fleet_name}</span>
                ${order.tracking_link ? `<a href="${order.tracking_link}" target="_blank" class="track-link" onclick="event.stopPropagation()">Prati ‚Üí</a>` : ''}
              </div>
            ` : `
              <div class="delivery-courier" style="color: #666;">
                <span class="courier-icon">‚è≥</span>
                <span class="courier-name">ƒåeka se kurir...</span>
              </div>
            `}
          </div>
        `;
      }

      // Check if order is paid and/or delivered
      const isPaidOrder = order.is_paid === true || order.is_paid === 'true';
      const isDelivered = order.delivery_status === 'delivered';
      
      let stickersHtml = '';
      if (isDelivered || isPaidOrder) {
        stickersHtml = '<div class="stickers-container">';
        if (isDelivered) {
          stickersHtml += '<div class="sticker delivered">‚úÖ Isporuƒçeno</div>';
        }
        if (isPaidOrder) {
          stickersHtml += '<div class="sticker paid">üí∞ Plaƒáeno</div>';
        }
        stickersHtml += '</div>';
      }

      // Check for notes - can be on order level OR on individual items
      const orderNote = order.note || order.raw_payload?.note || '';
      const itemNotes = items.filter(i => i.note).map(i => `${i.name}: ${i.note}`);
      const hasNotes = orderNote || itemNotes.length > 0;
      const allNotes = [orderNote, ...itemNotes].filter(n => n).join(' | ');
      const notePreview = orderNote || itemNotes[0] || '';

      return `
        <div class="order-card ${statusClass}" onclick="openOrderDetail(${order.order_id})">
          ${stickersHtml}
          <div class="order-location-tag">üìç ${locationName}</div>
          <div class="order-header">
            <span class="order-number">#${order.order_no}</span>
            ${hasNotes ? `<span class="order-note-icon" title="${allNotes.replace(/"/g, '&quot;')}">üìù</span>` : ''}
            <span class="order-provider ${order.provider}">${order.provider}</span>
          </div>
          <div class="order-meta">
            ${order.waiter_name ? `<span class="waiter">üë®‚Äçüç≥ ${order.waiter_name}</span> ‚Ä¢ ` : ''}
            ${order.table_reference_id ? `<span class="table">ü™ë ${order.table_reference_id}</span> ‚Ä¢ ` : ''}
            <span>${order.delivery_type || 'N/A'}</span>
          </div>
          ${hasNotes ? `<div class="order-note-preview">üìù ${notePreview}</div>` : ''}
          <div class="order-items">
            ${itemsHtml}
            ${moreItems}
          </div>
          ${deliveryHtml}
          <div class="order-footer">
            <span class="order-total">${total.toFixed(0)} RSD</span>
            ${order.prep_minutes !== undefined ? `
              <span class="prep-time-badge ${order.prep_minutes <= 15 ? 'fast' : order.prep_minutes <= 30 ? 'normal' : 'slow'}">
                ‚úì ${order.prep_minutes} min
              </span>
            ` : order.prep_minutes_ongoing !== undefined ? `
              <span class="prep-time-badge ${order.prep_minutes_ongoing <= 15 ? 'fast' : order.prep_minutes_ongoing <= 30 ? 'normal' : 'slow'}">
                ‚è± ${order.prep_minutes_ongoing} min
              </span>
            ` : ''}
            <span class="order-time">${time}</span>
          </div>
        </div>
      `;
    }

    // ============================================
    // Render All Orders
    // ============================================
    function renderOrders(orders) {
      const columnsView = document.getElementById('columnsView');
      const gridView = document.getElementById('ordersGrid');
      const tableContainer = document.getElementById('ordersTableContainer');
      const tableBody = document.getElementById('ordersTableBody');
      
      // Hide all views first
      columnsView.style.display = 'none';
      gridView.style.display = 'none';
      tableContainer.style.display = 'none';
      
      if (viewMode === 'table') {
        // TABLE VIEW
        tableContainer.style.display = 'block';
        
        if (orders.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="10" class="table-empty">Nema porud≈æbina</td></tr>';
        } else {
          tableBody.innerHTML = orders.map(o => renderTableRow(o)).join('');
        }
      } else {
        // CARDS VIEW
        if (selectedStatus === 'all') {
          // Show columns view
          columnsView.style.display = 'grid';
          
          const isPaid = (o) => o.is_paid === true || o.is_paid === 'true';
          const newOrders = orders.filter(o => STATUS_GROUPS.new.includes(o.status) && !isPaid(o));
          const productionOrders = orders.filter(o => STATUS_GROUPS.production.includes(o.status) && !isPaid(o));
          const readyOrders = orders.filter(o => STATUS_GROUPS.ready.includes(o.status) && !isPaid(o));
          const paidOrders = orders.filter(o => isPaid(o));
          const canceledOrders = orders.filter(o => STATUS_GROUPS.canceled.includes(o.status));

          document.getElementById('ordersNew').innerHTML = newOrders.length 
            ? newOrders.map(o => renderOrderCard(o, 'new')).join('')
            : '<div class="empty-state">Nema novih porud≈æbina</div>';

          document.getElementById('ordersProduction').innerHTML = productionOrders.length
            ? productionOrders.map(o => renderOrderCard(o, 'production')).join('')
            : '<div class="empty-state">Nema porud≈æbina u pripremi</div>';

          document.getElementById('ordersReady').innerHTML = readyOrders.length
            ? readyOrders.map(o => renderOrderCard(o, 'ready')).join('')
            : '<div class="empty-state">Nema spremnih porud≈æbina</div>';

          document.getElementById('ordersPaid').innerHTML = paidOrders.length
            ? paidOrders.map(o => renderOrderCard(o, 'paid')).join('')
            : '<div class="empty-state">Nema zavr≈°enih porud≈æbina</div>';

          document.getElementById('ordersCanceled').innerHTML = canceledOrders.length
            ? canceledOrders.map(o => renderOrderCard(o, 'canceled')).join('')
            : '<div class="empty-state">Nema otkazanih porud≈æbina</div>';

          // Update column counts
          document.getElementById('colCountNew').textContent = newOrders.length;
          document.getElementById('colCountProduction').textContent = productionOrders.length;
          document.getElementById('colCountReady').textContent = readyOrders.length;
          document.getElementById('colCountPaid').textContent = paidOrders.length;
          document.getElementById('colCountCanceled').textContent = canceledOrders.length;
        } else {
          // Show grid view for single status
          gridView.style.display = 'grid';
          
          if (orders.length === 0) {
            gridView.innerHTML = '<div class="orders-grid-empty">Nema porud≈æbina u ovoj kategoriji</div>';
          } else {
            gridView.innerHTML = orders.map(o => renderOrderCard(o, selectedStatus)).join('');
          }
        }
      }

      document.getElementById('statNew').textContent = document.getElementById('countNew').textContent;
      document.getElementById('statProduction').textContent = document.getElementById('countProduction').textContent;
      document.getElementById('statReady').textContent = document.getElementById('countReady').textContent;
      document.getElementById('statPaid').textContent = document.getElementById('countPaid').textContent;
      document.getElementById('statCanceled').textContent = document.getElementById('countCanceled').textContent;

      document.getElementById('lastUpdated').textContent = 
        `Updated: ${new Date().toLocaleTimeString('sr-RS')}`;
    }

    // ============================================
    // Real-time Subscription
    // ============================================
    function setupRealtimeSubscription() {
      supabaseClient
        .channel('orders-changes')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'emeni_orders' },
          (payload) => {
            console.log('Order change:', payload);
            loadOrders();
          }
        )
        .subscribe();
    }

    // ============================================
    // Initialize
    // ============================================
    // Date Selector Functions
    // ============================================
    function initDateSelector() {
      const dateInput = document.getElementById('selectedDate');
      // Default to today
      const today = new Date();
      dateInput.value = today.toISOString().split('T')[0];
    }

    function changeDate(delta) {
      const dateInput = document.getElementById('selectedDate');
      const current = new Date(dateInput.value);
      current.setDate(current.getDate() + delta);
      dateInput.value = current.toISOString().split('T')[0];
      loadOrdersForDate();
    }

    async function loadOrdersForDate() {
      document.getElementById('lastUpdated').textContent = 'Loading...';
      await loadOrders();
    }

    // ============================================
    // Load Orders
    // ============================================
    async function loadOrders() {
      const orders = await fetchOrders();
      allOrders = orders; // Store for filtering
      applyFilters(); // Apply current filters
    }

    async function init() {
      initDateSelector();
      await fetchLocations();
      await fetchProductNames(); // Load product names for modifier display
      await loadOrders();
      setupRealtimeSubscription();
      setInterval(loadOrders, 30000);
    }

    init();
  </script>
</body>
</html>
