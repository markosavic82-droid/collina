<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collina Analytics Dashboard</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { BarChart, Bar, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } = Recharts;

    // Margin lookup for profit calculation
    const MARGINS = {
      'big double collina smash': 62.4,
      'supreme': 53.5,
      'doublecheese': 69.5,
      'collina burger': 68.5,
      'vege burger': 86.0,
      'palaƒçinka': 77.7,
      'pancake': 77.7,
      'nutela': 77.7,
      'eurokrem': 82.4,
      'pomfrit': 83.6,
      'fries': 83.6,
      'onion': 87.5,
      'pepsi': 72.5,
      'default': 65.0,
    };

    const getMargin = (productName) => {
      const name = productName.toLowerCase();
      for (const [key, margin] of Object.entries(MARGINS)) {
        if (name.includes(key)) return margin;
      }
      return MARGINS.default;
    };

    const CollinaDashboard = () => {
      const [orders, setOrders] = useState([]);
      const [loading, setLoading] = useState(true);
      const [dateRange, setDateRange] = useState('1D');
      const [customStart, setCustomStart] = useState('');
      const [customEnd, setCustomEnd] = useState('');

      const colors = {
        bg: '#0D0B14',
        card: '#1A1F2E',
        elevated: '#252232',
        border: 'rgba(255, 255, 255, 0.08)',
        purple: '#8B5CF6',
        success: '#22C55E',
        error: '#EF4444',
        warning: '#F59E0B',
        info: '#3B82F6',
        textPrimary: '#FFFFFF',
        textSecondary: '#9CA3AF',
        textMuted: '#6B7280',
      };

      // Load data
      useEffect(() => {
        fetch('orders.json')
          .then(res => res.json())
          .then(data => {
            setOrders(data);
            setLoading(false);
            // Set default dates
            if (data.length > 0) {
              const latest = data[0].date.split('T')[0];
              const earliest = data[data.length - 1].date.split('T')[0];
              setCustomEnd(latest);
              setCustomStart(earliest);
            }
          })
          .catch(err => {
            console.error('Failed to load data:', err);
            setLoading(false);
          });
      }, []);

      // Filter orders by date range
      const filteredOrders = useMemo(() => {
        if (orders.length === 0) return [];
        
        const latest = new Date(orders[0].date);
        let startDate, endDate;

        if (dateRange === 'custom') {
          startDate = new Date(customStart);
          endDate = new Date(customEnd);
          endDate.setHours(23, 59, 59);
        } else {
          endDate = latest;
          startDate = new Date(latest);
          
          switch (dateRange) {
            case '1D':
              startDate.setHours(0, 0, 0, 0);
              break;
            case '3D':
              startDate.setDate(startDate.getDate() - 2);
              startDate.setHours(0, 0, 0, 0);
              break;
            case '7D':
              startDate.setDate(startDate.getDate() - 6);
              startDate.setHours(0, 0, 0, 0);
              break;
            case 'ALL':
              startDate = new Date(orders[orders.length - 1].date);
              break;
          }
        }

        return orders.filter(o => {
          const d = new Date(o.date);
          return d >= startDate && d <= endDate;
        });
      }, [orders, dateRange, customStart, customEnd]);

      // Compute metrics
      const metrics = useMemo(() => {
        if (filteredOrders.length === 0) {
          return { revenue: 0, orders: 0, avgBasket: 0, avgDelivery: 0, avgRating: 0, profit: 0, margin: 0 };
        }

        const revenue = filteredOrders.reduce((sum, o) => sum + o.price, 0);
        const orderCount = filteredOrders.length;
        const avgBasket = Math.round(revenue / orderCount);
        
        const deliveryTimes = filteredOrders.filter(o => o.deliveryMins).map(o => o.deliveryMins);
        const avgDelivery = deliveryTimes.length > 0 
          ? (deliveryTimes.reduce((a, b) => a + b, 0) / deliveryTimes.length).toFixed(1)
          : 0;
        
        const ratings = filteredOrders.filter(o => o.rating).map(o => o.rating);
        const avgRating = ratings.length > 0 
          ? ((ratings.reduce((a, b) => a + b, 0) / ratings.length) * 2).toFixed(1)
          : 0;

        // Calculate profit from items
        let profit = 0;
        filteredOrders.forEach(o => {
          o.items.forEach(item => {
            const margin = getMargin(item.name);
            profit += (item.price * item.qty * margin / 100);
          });
        });
        profit = Math.round(profit);
        const margin = ((profit / revenue) * 100).toFixed(1);

        return { revenue, orders: orderCount, avgBasket, avgDelivery, avgRating, profit, margin, reviewCount: ratings.length };
      }, [filteredOrders]);

      // Hourly data
      const hourlyData = useMemo(() => {
        const hourMap = {};
        for (let h = 10; h <= 23; h++) hourMap[h] = { orders: 0, revenue: 0, deliverySum: 0, deliveryCount: 0 };
        
        filteredOrders.forEach(o => {
          const hour = new Date(o.date).getHours();
          if (hourMap[hour]) {
            hourMap[hour].orders++;
            hourMap[hour].revenue += o.price;
            if (o.deliveryMins) {
              hourMap[hour].deliverySum += o.deliveryMins;
              hourMap[hour].deliveryCount++;
            }
          }
        });

        return Object.entries(hourMap).map(([hour, data]) => ({
          hour: `${hour}h`,
          orders: data.orders,
          avgDelivery: data.deliveryCount > 0 ? Math.round(data.deliverySum / data.deliveryCount) : 0,
        }));
      }, [filteredOrders]);

      // Location data
      const locationData = useMemo(() => {
        const locMap = {};
        filteredOrders.forEach(o => {
          if (!locMap[o.location]) locMap[o.location] = { orders: 0, revenue: 0 };
          locMap[o.location].orders++;
          locMap[o.location].revenue += o.price;
        });

        return Object.entries(locMap)
          .map(([name, data]) => ({ name, ...data }))
          .sort((a, b) => b.revenue - a.revenue);
      }, [filteredOrders]);

      // Top products
      const topProducts = useMemo(() => {
        const productMap = {};
        filteredOrders.forEach(o => {
          o.items.forEach(item => {
            const name = item.name.substring(0, 50);
            if (!productMap[name]) productMap[name] = { qty: 0, revenue: 0 };
            productMap[name].qty += item.qty;
            productMap[name].revenue += item.price * item.qty;
          });
        });

        return Object.entries(productMap)
          .map(([name, data]) => ({ name, ...data, pct: ((data.revenue / metrics.revenue) * 100).toFixed(1) }))
          .sort((a, b) => b.revenue - a.revenue)
          .slice(0, 10);
      }, [filteredOrders, metrics.revenue]);

      // Daily trend
      const dailyTrend = useMemo(() => {
        const dayMap = {};
        filteredOrders.forEach(o => {
          const day = o.date.split('T')[0];
          if (!dayMap[day]) dayMap[day] = { revenue: 0, orders: 0 };
          dayMap[day].revenue += o.price;
          dayMap[day].orders++;
        });

        return Object.entries(dayMap)
          .map(([date, data]) => ({ date: date.slice(5), ...data }))
          .sort((a, b) => a.date.localeCompare(b.date));
      }, [filteredOrders]);

      const formatRSD = (n) => n.toLocaleString('sr-RS');
      const formatK = (n) => `${(n/1000).toFixed(0)}K`;

      if (loading) {
        return (
          <div style={{ background: colors.bg, minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
            <div style={{ color: colors.textPrimary, fontSize: 24 }}>Loading data...</div>
          </div>
        );
      }

      return (
        <div style={{ background: colors.bg, minHeight: '100vh', padding: 16 }}>
          <div style={{ maxWidth: 1400, margin: '0 auto' }}>
            
            {/* Header */}
            <div style={{ 
              background: `linear-gradient(135deg, ${colors.purple} 0%, #6366F1 100%)`,
              borderRadius: 16, padding: 24, marginBottom: 16, color: 'white'
            }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 16 }}>
                <div>
                  <h1 style={{ fontSize: 28, fontWeight: 700, marginBottom: 4 }}>üçî Collina Analytics</h1>
                  <p style={{ opacity: 0.9 }}>Interactive Dashboard</p>
                </div>
                <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                  {['1D', '3D', '7D', 'ALL'].map(range => (
                    <button
                      key={range}
                      onClick={() => setDateRange(range)}
                      style={{
                        padding: '8px 16px',
                        borderRadius: 8,
                        border: 'none',
                        background: dateRange === range ? 'white' : 'rgba(255,255,255,0.2)',
                        color: dateRange === range ? colors.purple : 'white',
                        cursor: 'pointer',
                        fontWeight: 600,
                      }}
                    >
                      {range}
                    </button>
                  ))}
                  <button
                    onClick={() => setDateRange('custom')}
                    style={{
                      padding: '8px 16px',
                      borderRadius: 8,
                      border: 'none',
                      background: dateRange === 'custom' ? 'white' : 'rgba(255,255,255,0.2)',
                      color: dateRange === 'custom' ? colors.purple : 'white',
                      cursor: 'pointer',
                      fontWeight: 600,
                    }}
                  >
                    Custom
                  </button>
                </div>
              </div>
              
              {dateRange === 'custom' && (
                <div style={{ marginTop: 16, display: 'flex', gap: 12, alignItems: 'center' }}>
                  <input
                    type="date"
                    value={customStart}
                    onChange={(e) => setCustomStart(e.target.value)}
                    style={{ padding: '8px 12px', borderRadius: 8, border: 'none' }}
                  />
                  <span>to</span>
                  <input
                    type="date"
                    value={customEnd}
                    onChange={(e) => setCustomEnd(e.target.value)}
                    style={{ padding: '8px 12px', borderRadius: 8, border: 'none' }}
                  />
                </div>
              )}
            </div>

            {/* KPI Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: 12, marginBottom: 16 }}>
              {[
                { label: 'Revenue', value: formatRSD(metrics.revenue), sub: 'RSD', color: colors.purple },
                { label: 'Profit', value: formatRSD(metrics.profit), sub: `${metrics.margin}% margin`, color: colors.success },
                { label: 'Orders', value: metrics.orders, sub: 'delivered', color: colors.info },
                { label: 'Avg Basket', value: formatRSD(metrics.avgBasket), sub: 'RSD', color: colors.warning },
                { label: 'Avg Delivery', value: `${metrics.avgDelivery}`, sub: 'minutes', color: colors.error },
                { label: 'Avg Rating', value: metrics.avgRating, sub: `/10 (${metrics.reviewCount} reviews)`, color: colors.success },
              ].map((kpi, i) => (
                <div key={i} style={{ 
                  background: colors.card, 
                  borderRadius: 12, 
                  padding: 16,
                  borderLeft: `4px solid ${kpi.color}`,
                }}>
                  <div style={{ color: colors.textMuted, fontSize: 12, marginBottom: 4 }}>{kpi.label}</div>
                  <div style={{ color: colors.textPrimary, fontSize: 24, fontWeight: 700 }}>{kpi.value}</div>
                  <div style={{ color: colors.textSecondary, fontSize: 12 }}>{kpi.sub}</div>
                </div>
              ))}
            </div>

            {/* Charts Row */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: 16, marginBottom: 16 }}>
              
              {/* Daily Trend */}
              <div style={{ background: colors.card, borderRadius: 12, padding: 16 }}>
                <h3 style={{ color: colors.textPrimary, marginBottom: 12, fontSize: 14 }}>üìà Daily Revenue Trend</h3>
                <ResponsiveContainer width="100%" height={200}>
                  <AreaChart data={dailyTrend}>
                    <defs>
                      <linearGradient id="colorRevenue" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor={colors.purple} stopOpacity={0.4}/>
                        <stop offset="95%" stopColor={colors.purple} stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke={colors.border} />
                    <XAxis dataKey="date" tick={{ fill: colors.textMuted, fontSize: 10 }} />
                    <YAxis tickFormatter={formatK} tick={{ fill: colors.textMuted, fontSize: 10 }} />
                    <Tooltip 
                      formatter={(v) => [`${formatRSD(v)} RSD`, 'Revenue']}
                      contentStyle={{ background: colors.elevated, border: 'none', borderRadius: 8 }}
                    />
                    <Area type="monotone" dataKey="revenue" stroke={colors.purple} fill="url(#colorRevenue)" />
                  </AreaChart>
                </ResponsiveContainer>
              </div>

              {/* Hourly Orders */}
              <div style={{ background: colors.card, borderRadius: 12, padding: 16 }}>
                <h3 style={{ color: colors.textPrimary, marginBottom: 12, fontSize: 14 }}>‚è∞ Orders by Hour</h3>
                <ResponsiveContainer width="100%" height={200}>
                  <BarChart data={hourlyData}>
                    <CartesianGrid strokeDasharray="3 3" stroke={colors.border} />
                    <XAxis dataKey="hour" tick={{ fill: colors.textMuted, fontSize: 10 }} />
                    <YAxis tick={{ fill: colors.textMuted, fontSize: 10 }} />
                    <Tooltip contentStyle={{ background: colors.elevated, border: 'none', borderRadius: 8 }} />
                    <Bar dataKey="orders" fill={colors.info} radius={[4, 4, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* Second Row */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: 16, marginBottom: 16 }}>
              
              {/* Location */}
              <div style={{ background: colors.card, borderRadius: 12, padding: 16 }}>
                <h3 style={{ color: colors.textPrimary, marginBottom: 12, fontSize: 14 }}>üìç Revenue by Location</h3>
                <ResponsiveContainer width="100%" height={180}>
                  <BarChart data={locationData} layout="vertical">
                    <CartesianGrid strokeDasharray="3 3" stroke={colors.border} />
                    <XAxis type="number" tickFormatter={formatK} tick={{ fill: colors.textMuted, fontSize: 10 }} />
                    <YAxis type="category" dataKey="name" width={90} tick={{ fill: colors.textMuted, fontSize: 10 }} />
                    <Tooltip 
                      formatter={(v) => [`${formatRSD(v)} RSD`, 'Revenue']}
                      contentStyle={{ background: colors.elevated, border: 'none', borderRadius: 8 }}
                    />
                    <Bar dataKey="revenue" fill={colors.success} radius={[0, 4, 4, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              </div>

              {/* Delivery by Hour */}
              <div style={{ background: colors.card, borderRadius: 12, padding: 16 }}>
                <h3 style={{ color: colors.textPrimary, marginBottom: 12, fontSize: 14 }}>üöö Avg Delivery Time by Hour</h3>
                <ResponsiveContainer width="100%" height={180}>
                  <BarChart data={hourlyData}>
                    <CartesianGrid strokeDasharray="3 3" stroke={colors.border} />
                    <XAxis dataKey="hour" tick={{ fill: colors.textMuted, fontSize: 10 }} />
                    <YAxis tick={{ fill: colors.textMuted, fontSize: 10 }} />
                    <Tooltip 
                      formatter={(v) => [`${v} min`, 'Avg Delivery']}
                      contentStyle={{ background: colors.elevated, border: 'none', borderRadius: 8 }}
                    />
                    <Bar dataKey="avgDelivery" radius={[4, 4, 0, 0]}>
                      {hourlyData.map((entry, i) => (
                        <Cell 
                          key={i} 
                          fill={entry.avgDelivery <= 35 ? colors.success : entry.avgDelivery <= 45 ? colors.warning : colors.error} 
                        />
                      ))}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* Top Products */}
            <div style={{ background: colors.card, borderRadius: 12, padding: 16, marginBottom: 16 }}>
              <h3 style={{ color: colors.textPrimary, marginBottom: 12, fontSize: 14 }}>üèÜ Top 10 Products</h3>
              <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 13 }}>
                  <thead>
                    <tr style={{ borderBottom: `1px solid ${colors.border}` }}>
                      <th style={{ textAlign: 'left', padding: 8, color: colors.textMuted }}>#</th>
                      <th style={{ textAlign: 'left', padding: 8, color: colors.textMuted }}>Product</th>
                      <th style={{ textAlign: 'right', padding: 8, color: colors.textMuted }}>Qty</th>
                      <th style={{ textAlign: 'right', padding: 8, color: colors.textMuted }}>Revenue</th>
                      <th style={{ textAlign: 'right', padding: 8, color: colors.textMuted }}>% Sales</th>
                    </tr>
                  </thead>
                  <tbody>
                    {topProducts.map((p, i) => (
                      <tr key={i} style={{ borderBottom: `1px solid ${colors.border}` }}>
                        <td style={{ padding: 8, color: colors.textMuted }}>{i + 1}</td>
                        <td style={{ padding: 8, color: colors.textPrimary, maxWidth: 300, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{p.name}</td>
                        <td style={{ padding: 8, color: colors.textSecondary, textAlign: 'right' }}>{p.qty}</td>
                        <td style={{ padding: 8, color: colors.success, textAlign: 'right', fontWeight: 600 }}>{formatK(p.revenue)}</td>
                        <td style={{ padding: 8, color: colors.textSecondary, textAlign: 'right' }}>{p.pct}%</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Footer */}
            <div style={{ textAlign: 'center', color: colors.textMuted, fontSize: 12, padding: 16 }}>
              Collina Interactive Dashboard v1.0 | Data: {orders.length} orders | 
              Range: {orders.length > 0 ? `${orders[orders.length-1].date.split('T')[0]} to ${orders[0].date.split('T')[0]}` : 'N/A'}
            </div>

          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<CollinaDashboard />);
  </script>
</body>
</html>
