<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collina Orders Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #0f0f0f;
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #333;
    }

    .header h1 {
      font-size: 28px;
      color: #8B5CF6;
    }

    .header .status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .stats-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      flex: 1;
      border: 1px solid #333;
    }

    .stat-card h3 {
      font-size: 14px;
      color: #888;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
    }

    .stat-card.production .value { color: #f59e0b; }
    .stat-card.ready .value { color: #3b82f6; }
    .stat-card.delivery .value { color: #8b5cf6; }
    .stat-card.paid .value { color: #22c55e; }

    .columns {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    .column {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 15px;
      border: 1px solid #333;
      min-height: 500px;
    }

    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #333;
    }

    .column-header h2 {
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .column-header .count {
      background: #333;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 14px;
    }

    .column.new .column-header { border-bottom-color: #f59e0b; }
    .column.production .column-header { border-bottom-color: #f97316; }
    .column.ready .column-header { border-bottom-color: #3b82f6; }
    .column.paid .column-header { border-bottom-color: #22c55e; }

    .order-card {
      background: #252525;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 4px solid #666;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .order-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .order-card.new { border-left-color: #f59e0b; }
    .order-card.production { border-left-color: #f97316; }
    .order-card.ready { border-left-color: #3b82f6; }
    .order-card.paid { border-left-color: #22c55e; }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .order-number {
      font-size: 20px;
      font-weight: bold;
    }

    .order-provider {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      background: #333;
      color: #aaa;
    }

    .order-provider.eBar { background: #7c3aed20; color: #a78bfa; }
    .order-provider.gloriafood { background: #f59e0b20; color: #fbbf24; }
    .order-provider.wolt { background: #3b82f620; color: #60a5fa; }

    .order-meta {
      font-size: 12px;
      color: #888;
      margin-bottom: 10px;
    }

    .order-meta .waiter {
      color: #a78bfa;
    }

    .order-meta .table {
      color: #60a5fa;
    }

    .order-items {
      font-size: 13px;
      color: #ccc;
      margin-bottom: 10px;
    }

    .order-items .item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #333;
    }

    .order-items .item:last-child {
      border-bottom: none;
    }

    .order-items .quantity {
      color: #888;
      margin-right: 8px;
    }

    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #333;
    }

    .order-total {
      font-size: 18px;
      font-weight: bold;
      color: #22c55e;
    }

    .order-time {
      font-size: 12px;
      color: #666;
    }

    .customer-info {
      font-size: 12px;
      color: #888;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #333;
    }

    .customer-info .name { color: #fff; font-weight: 500; }
    .customer-info .address { color: #666; margin-top: 4px; }

    .note {
      background: #3b2f00;
      color: #fbbf24;
      padding: 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 8px;
    }

    .empty-state {
      text-align: center;
      color: #555;
      padding: 40px 20px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .last-updated {
      color: #666;
      font-size: 12px;
    }

    @media (max-width: 1200px) {
      .columns {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .columns {
        grid-template-columns: 1fr;
      }
      .stats-bar {
        flex-wrap: wrap;
      }
      .stat-card {
        min-width: 45%;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üçî Collina Orders</h1>
    <div class="status">
      <div class="status-dot"></div>
      <span>Live</span>
      <span class="last-updated" id="lastUpdated">Loading...</span>
    </div>
  </div>

  <div class="stats-bar">
    <div class="stat-card new">
      <h3>New / Accepted</h3>
      <div class="value" id="statNew">0</div>
    </div>
    <div class="stat-card production">
      <h3>In Production</h3>
      <div class="value" id="statProduction">0</div>
    </div>
    <div class="stat-card ready">
      <h3>Ready / Delivery</h3>
      <div class="value" id="statReady">0</div>
    </div>
    <div class="stat-card paid">
      <h3>Paid Today</h3>
      <div class="value" id="statPaid">0</div>
    </div>
  </div>

  <div class="columns">
    <div class="column new">
      <div class="column-header">
        <h2>üÜï New / Accepted</h2>
        <span class="count" id="countNew">0</span>
      </div>
      <div id="ordersNew" class="orders-list">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <div class="column production">
      <div class="column-header">
        <h2>üë®‚Äçüç≥ In Production</h2>
        <span class="count" id="countProduction">0</span>
      </div>
      <div id="ordersProduction" class="orders-list">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <div class="column ready">
      <div class="column-header">
        <h2>‚úÖ Ready / Delivery</h2>
        <span class="count" id="countReady">0</span>
      </div>
      <div id="ordersReady" class="orders-list">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <div class="column paid">
      <div class="column-header">
        <h2>üí∞ Completed</h2>
        <span class="count" id="countPaid">0</span>
      </div>
      <div id="ordersPaid" class="orders-list">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION - Update these values
    // ============================================
    const SUPABASE_URL = 'https://bbnbbbpofelbkyuffslj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibmJiYnBvZmVsYmt5dWZmc2xqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTI0MzQsImV4cCI6MjA4MDYyODQzNH0.koW44soAB-bEfh8OzqjGBwdgov4Snscw1ITsg5OureU';

    // ============================================
    // Initialize Supabase
    // ============================================
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Status groupings
    const STATUS_GROUPS = {
      new: [1, 3, 12, 13],        // New, Accepted, NewPreorder, Pending
      production: [4],            // InProduction
      ready: [5, 6, 7],           // Ready, Dispatched, Delivered
      paid: []                    // is_paid = true (handled separately)
    };

    const STATUS_NAMES = {
      1: 'New',
      3: 'Accepted',
      4: 'In Production',
      5: 'Ready',
      6: 'Dispatched',
      7: 'Delivered',
      8: 'Rejected',
      9: 'Canceled',
      10: 'Completed',
      11: 'Invalid',
      12: 'New Preorder',
      13: 'Pending',
      14: 'Pending Payment'
    };

    // ============================================
    // Fetch Orders
    // ============================================
    async function fetchOrders() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const { data: orders, error } = await supabaseClient
        .from('emeni_orders')
        .select('*')
        .gte('created_at', today.toISOString())
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error fetching orders:', error);
        return [];
      }

      // Fetch items for all orders
      const orderIds = orders.map(o => o.order_id);
      const { data: items } = await supabaseClient
        .from('emeni_order_items')
        .select('*')
        .in('order_id', orderIds);

      // Attach items to orders
      orders.forEach(order => {
        order.items = items?.filter(i => i.order_id === order.order_id) || [];
      });

      return orders;
    }

    // ============================================
    // Render Functions
    // ============================================
    function renderOrderCard(order, statusClass) {
      const total = order.items.reduce((sum, item) => sum + (parseFloat(item.price) * parseFloat(item.quantity)), 0);
      const time = new Date(order.created_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
      
      const itemsHtml = order.items.map(item => `
        <div class="item">
          <span><span class="quantity">${item.quantity}x</span> ${item.name}</span>
          <span>${parseFloat(item.price).toFixed(0)} RSD</span>
        </div>
      `).join('');

      const customerHtml = order.customer_name ? `
        <div class="customer-info">
          <div class="name">üë§ ${order.customer_name}</div>
          ${order.customer_address ? `<div class="address">üìç ${order.customer_address}</div>` : ''}
          ${order.customer_phone ? `<div class="phone">üìû ${order.customer_phone}</div>` : ''}
        </div>
      ` : '';

      const noteHtml = order.note ? `<div class="note">üìù ${order.note}</div>` : '';

      return `
        <div class="order-card ${statusClass}">
          <div class="order-header">
            <span class="order-number">#${order.order_no}</span>
            <span class="order-provider ${order.provider}">${order.provider}</span>
          </div>
          <div class="order-meta">
            ${order.waiter_name ? `<span class="waiter">üë®‚Äçüç≥ ${order.waiter_name}</span> ‚Ä¢ ` : ''}
            ${order.table_reference_id ? `<span class="table">ü™ë Table ${order.table_reference_id}</span> ‚Ä¢ ` : ''}
            <span>${order.delivery_type || 'N/A'}</span>
          </div>
          <div class="order-items">
            ${itemsHtml}
          </div>
          ${customerHtml}
          ${noteHtml}
          <div class="order-footer">
            <span class="order-total">${total.toFixed(0)} RSD</span>
            <span class="order-time">${time}</span>
          </div>
        </div>
      `;
    }

    function renderOrders(orders) {
      // Filter orders by status groups
      const newOrders = orders.filter(o => STATUS_GROUPS.new.includes(o.status) && !o.is_paid);
      const productionOrders = orders.filter(o => STATUS_GROUPS.production.includes(o.status) && !o.is_paid);
      const readyOrders = orders.filter(o => STATUS_GROUPS.ready.includes(o.status) && !o.is_paid);
      const paidOrders = orders.filter(o => o.is_paid);

      // Render columns
      document.getElementById('ordersNew').innerHTML = newOrders.length 
        ? newOrders.map(o => renderOrderCard(o, 'new')).join('')
        : '<div class="empty-state">No new orders</div>';

      document.getElementById('ordersProduction').innerHTML = productionOrders.length
        ? productionOrders.map(o => renderOrderCard(o, 'production')).join('')
        : '<div class="empty-state">No orders in production</div>';

      document.getElementById('ordersReady').innerHTML = readyOrders.length
        ? readyOrders.map(o => renderOrderCard(o, 'ready')).join('')
        : '<div class="empty-state">No ready orders</div>';

      document.getElementById('ordersPaid').innerHTML = paidOrders.length
        ? paidOrders.map(o => renderOrderCard(o, 'paid')).join('')
        : '<div class="empty-state">No completed orders</div>';

      // Update counts
      document.getElementById('countNew').textContent = newOrders.length;
      document.getElementById('countProduction').textContent = productionOrders.length;
      document.getElementById('countReady').textContent = readyOrders.length;
      document.getElementById('countPaid').textContent = paidOrders.length;

      // Update stats
      document.getElementById('statNew').textContent = newOrders.length;
      document.getElementById('statProduction').textContent = productionOrders.length;
      document.getElementById('statReady').textContent = readyOrders.length;
      document.getElementById('statPaid').textContent = paidOrders.length;

      // Update timestamp
      document.getElementById('lastUpdated').textContent = 
        `Updated: ${new Date().toLocaleTimeString('sr-RS')}`;
    }

    // ============================================
    // Real-time Subscription
    // ============================================
    function setupRealtimeSubscription() {
      supabaseClient
        .channel('orders-changes')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'emeni_orders' },
          (payload) => {
            console.log('Order change:', payload);
            loadOrders(); // Refresh all orders
          }
        )
        .subscribe();
    }

    // ============================================
    // Initialize
    // ============================================
    async function loadOrders() {
      const orders = await fetchOrders();
      renderOrders(orders);
    }

    // Initial load
    loadOrders();

    // Setup real-time updates
    setupRealtimeSubscription();

    // Fallback polling every 30 seconds
    setInterval(loadOrders, 30000);
  </script>
</body>
</html>
