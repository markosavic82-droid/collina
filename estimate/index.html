<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collina Order Estimator</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a24;
            --accent-orange: #ff6b35;
            --accent-orange-glow: rgba(255, 107, 53, 0.3);
            --accent-green: #00d68f;
            --accent-green-dim: rgba(0, 214, 143, 0.15);
            --accent-blue: #4dabf7;
            --text-primary: #ffffff;
            --text-secondary: #8b8b9e;
            --text-dim: #5a5a6e;
            --border: #2a2a3a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 24px;
            background-image: 
                radial-gradient(ellipse at 20% 0%, rgba(255, 107, 53, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(0, 214, 143, 0.05) 0%, transparent 50%);
        }

        .container { max-width: 900px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 40px; }

        .logo {
            font-size: 14px; font-weight: 600; letter-spacing: 3px;
            text-transform: uppercase; color: var(--accent-orange); margin-bottom: 8px;
        }

        h1 {
            font-size: 32px; font-weight: 700; margin-bottom: 8px;
            background: linear-gradient(135deg, #fff 0%, #a0a0b0 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }

        .subtitle { color: var(--text-secondary); font-size: 15px; }

        /* Loading & Status */
        .status-bar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .status-dot.loading { background: var(--accent-orange); }
        .status-dot.error { background: #ef4444; animation: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            background: var(--accent-orange);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover { background: #ff8c5a; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-secondary {
            background: var(--bg-card-hover);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover { background: var(--border); }

        /* Import Section */
        .import-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            display: none;
        }

        .import-section.visible { display: block; }

        .import-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .import-drop {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .import-drop:hover, .import-drop.dragover {
            border-color: var(--accent-orange);
            background: rgba(255, 107, 53, 0.05);
        }

        .import-progress {
            margin-top: 16px;
            display: none;
        }

        .import-progress.visible { display: block; }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-green);
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* Results section */
        .results { display: none; animation: fadeIn 0.5s ease; }
        .results.visible { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }

        .stat-card {
            background: var(--bg-card); border-radius: 16px; padding: 28px;
            border: 1px solid var(--border); position: relative; overflow: hidden;
        }

        .stat-card.primary {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(255, 107, 53, 0.1) 100%);
            border-color: rgba(255, 107, 53, 0.3);
        }

        .stat-card.primary::after {
            content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 100%;
            background: radial-gradient(circle, var(--accent-orange-glow) 0%, transparent 70%);
            pointer-events: none;
        }

        .stat-label {
            font-size: 13px; font-weight: 500; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
        }

        .stat-value {
            font-family: 'Space Mono', monospace; font-size: 42px; font-weight: 700;
            line-height: 1; position: relative; z-index: 1;
        }

        .stat-card.primary .stat-value { color: var(--accent-orange); }
        .stat-sublabel { font-size: 13px; color: var(--text-dim); margin-top: 8px; }

        .progress-section {
            background: var(--bg-card); border-radius: 16px; padding: 28px;
            border: 1px solid var(--border); margin-bottom: 24px;
            display: grid; grid-template-columns: 160px 1fr; gap: 32px; align-items: center;
        }

        .progress-ring-container { position: relative; width: 140px; height: 140px; }
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-bg { stroke: var(--border); }

        .progress-ring-fill {
            stroke: var(--accent-green); stroke-linecap: round;
            transition: stroke-dashoffset 1s ease; filter: drop-shadow(0 0 8px var(--accent-green));
        }

        .progress-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); text-align: center;
        }

        .progress-percent { font-family: 'Space Mono', monospace; font-size: 28px; font-weight: 700; color: var(--accent-green); }
        .progress-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

        .progress-details h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary); }

        .detail-row {
            display: flex; justify-content: space-between; padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: var(--text-secondary); font-size: 14px; }
        .detail-value { font-family: 'Space Mono', monospace; font-weight: 600; font-size: 14px; }
        .detail-value.green { color: var(--accent-green); }
        .detail-value.blue { color: var(--accent-blue); }

        .chart-section, .similar-days-section, .venue-section {
            background: var(--bg-card); border-radius: 16px; padding: 28px;
            border: 1px solid var(--border); margin-bottom: 24px;
        }

        .chart-section h3, .similar-days-section h3, .venue-section h3 {
            font-size: 16px; font-weight: 600; margin-bottom: 8px;
        }

        .section-subtitle { font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; }

        .chart-container { position: relative; height: 300px; width: 100%; }

        .chart-legend {
            display: flex; flex-wrap: wrap; gap: 16px; margin-top: 16px; justify-content: center;
        }

        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        .legend-label { color: var(--text-secondary); }
        .legend-value { font-family: 'Space Mono', monospace; font-weight: 600; }

        .similar-day-item {
            display: grid; grid-template-columns: 1fr auto auto auto;
            gap: 16px; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border);
        }

        .similar-day-item:last-child { border-bottom: none; }
        .similar-day-date { font-size: 14px; font-weight: 500; }
        .similar-day-dayname { font-size: 12px; color: var(--text-secondary); }
        .similar-day-at-cutoff { font-family: 'Space Mono', monospace; font-size: 13px; color: var(--text-secondary); }
        .similar-day-final { font-family: 'Space Mono', monospace; font-size: 16px; font-weight: 700; color: var(--accent-green); }
        .similar-day-weight { font-size: 12px; color: var(--text-dim); background: var(--bg-card-hover); padding: 4px 8px; border-radius: 4px; }

        .venue-item {
            display: grid; grid-template-columns: 1fr auto auto;
            gap: 16px; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border);
        }

        .venue-item:last-child { border-bottom: none; }
        .venue-name { font-size: 14px; font-weight: 500; }
        .venue-orders { font-family: 'Space Mono', monospace; font-size: 14px; color: var(--text-secondary); }

        .venue-bar { width: 120px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }

        .venue-bar-fill {
            height: 100%; background: linear-gradient(90deg, var(--accent-orange) 0%, #ff8c5a 100%);
            border-radius: 3px; transition: width 0.5s ease;
        }

        .historical-section {
            background: var(--bg-card); border-radius: 16px; padding: 28px;
            border: 1px solid var(--border);
        }

        .historical-section h3 { font-size: 16px; font-weight: 600; margin-bottom: 20px; }

        .benchmark-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }

        .benchmark-item {
            text-align: center; padding: 16px;
            background: rgba(255, 255, 255, 0.02); border-radius: 12px;
        }

        .benchmark-value {
            font-family: 'Space Mono', monospace; font-size: 24px;
            font-weight: 700; color: var(--text-primary); margin-bottom: 4px;
        }

        .benchmark-label { font-size: 12px; color: var(--text-secondary); }

        .time-info {
            text-align: center; margin-top: 24px; padding: 16px;
            background: rgba(255, 255, 255, 0.02); border-radius: 12px;
            color: var(--text-dim); font-size: 13px;
        }

        .time-info strong { color: var(--text-secondary); }

        .range-estimate {
            display: flex; align-items: center; gap: 8px;
            margin-top: 12px; font-size: 14px; color: var(--text-secondary);
        }

        .range-bar {
            flex: 1; height: 4px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green), var(--accent-orange));
            border-radius: 2px; position: relative;
        }

        .range-marker {
            position: absolute; top: -6px; width: 16px; height: 16px;
            background: var(--accent-orange); border-radius: 50%;
            border: 3px solid var(--bg-card); transform: translateX(-50%);
        }

        #fileInput { display: none; }

        @media (max-width: 640px) {
            .main-stats { grid-template-columns: 1fr; }
            .progress-section { grid-template-columns: 1fr; justify-items: center; text-align: center; }
            .benchmark-grid { grid-template-columns: 1fr; }
            .venue-item { grid-template-columns: 1fr auto; }
            .venue-bar { display: none; }
            .similar-day-item { grid-template-columns: 1fr auto; }
            .similar-day-at-cutoff, .similar-day-weight { display: none; }
            .status-bar { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Collina Analytics</div>
            <h1>Order Estimator</h1>
            <p class="subtitle">Live data from Supabase</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot loading" id="statusDot"></div>
                <span id="statusText">Connecting to database...</span>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" id="importBtn">Import CSV</button>
                <button class="btn" id="refreshBtn" disabled>Refresh</button>
            </div>
        </div>

        <div class="import-section" id="importSection">
            <h3>ðŸ“¤ Import Wolt CSV Data</h3>
            <div class="import-drop" id="importDrop">
                <p>Drop your Wolt CSV here or click to browse</p>
                <p style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                    New orders will be added, duplicates will be skipped
                </p>
            </div>
            <input type="file" id="fileInput" accept=".csv">
            <div class="import-progress" id="importProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <p class="progress-text" id="progressText">Importing...</p>
            </div>
        </div>

        <div class="results" id="results">
            <div class="main-stats">
                <div class="stat-card primary">
                    <div class="stat-label">Projected Total</div>
                    <div class="stat-value" id="projectedTotal">â€”</div>
                    <div class="stat-sublabel" id="projectedRange">range: â€” â€“ â€”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Orders</div>
                    <div class="stat-value" id="currentOrders">â€”</div>
                    <div class="stat-sublabel" id="lastOrderTime">as of â€”</div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-ring-container">
                    <svg class="progress-ring" width="140" height="140">
                        <circle class="progress-ring-bg" cx="70" cy="70" r="60" fill="none" stroke-width="10"/>
                        <circle class="progress-ring-fill" id="progressRing" cx="70" cy="70" r="60" fill="none" stroke-width="10" 
                            stroke-dasharray="377" stroke-dashoffset="377"/>
                    </svg>
                    <div class="progress-text">
                        <div class="progress-percent" id="progressPercent">0%</div>
                        <div class="progress-label">Complete</div>
                    </div>
                </div>
                <div class="progress-details">
                    <h3>Today's Progress</h3>
                    <div class="detail-row">
                        <span class="detail-label">Day of week</span>
                        <span class="detail-value" id="dayOfWeek">â€”</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Orders at cutoff (45m ago)</span>
                        <span class="detail-value" id="ordersAtCutoff">â€”</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Current revenue</span>
                        <span class="detail-value blue" id="currentRevenue">â€”</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Avg order value</span>
                        <span class="detail-value" id="avgOrderValue">â€”</span>
                    </div>
                </div>
            </div>

            <div class="chart-section">
                <h3>ðŸ“ˆ Order Curves Comparison</h3>
                <p class="section-subtitle">Cumulative orders throughout the day</p>
                <div class="chart-container">
                    <canvas id="orderChart"></canvas>
                </div>
                <div class="chart-legend" id="chartLegend"></div>
            </div>

            <div class="similar-days-section">
                <h3>ðŸ“Š Similar Historical Days</h3>
                <p class="section-subtitle">Days with similar order count at the same cutoff time</p>
                <div id="similarDaysList"></div>
            </div>

            <div class="venue-section">
                <h3>Orders by Venue</h3>
                <div id="venueList"></div>
            </div>

            <div class="historical-section">
                <h3>vs Average Curve @ Cutoff</h3>
                <div class="benchmark-grid">
                    <div class="benchmark-item">
                        <div class="benchmark-value" id="benchmarkLow">â€”</div>
                        <div class="benchmark-label">Avg @ cutoff</div>
                    </div>
                    <div class="benchmark-item">
                        <div class="benchmark-value" id="benchmarkWeighted">â€”</div>
                        <div class="benchmark-label">Today @ cutoff</div>
                    </div>
                    <div class="benchmark-item">
                        <div class="benchmark-value" id="benchmarkHigh">â€”</div>
                        <div class="benchmark-label">Difference</div>
                    </div>
                </div>
                <div class="range-estimate">
                    <span id="rangeLow">430</span>
                    <div class="range-bar">
                        <div class="range-marker" id="rangeMarker" style="left: 50%"></div>
                    </div>
                    <span id="rangeHigh">520</span>
                </div>
            </div>

            <div class="time-info">
                <strong>Last updated:</strong> <span id="updateTime">â€”</span> Â· 
                <strong>Historical data:</strong> Last 3 months Â· <span id="totalOrdersDb">â€”</span> orders
            </div>
        </div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://bbnbbbpofelbkyuffslj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibmJiYnBvZmVsYmt5dWZmc2xqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTI0MzQsImV4cCI6MjA4MDYyODQzNH0.koW44soAB-bEfh8OzqjGBwdgov4Snscw1ITsg5OureU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // DOM elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const importBtn = document.getElementById('importBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const importSection = document.getElementById('importSection');
        const importDrop = document.getElementById('importDrop');
        const fileInput = document.getElementById('fileInput');
        const importProgress = document.getElementById('importProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const results = document.getElementById('results');

        // Initialize
        async function init() {
            try {
                console.log('Connecting to Supabase...', SUPABASE_URL);
                
                // Test connection and count orders from wolt_orders table
                const { count, error } = await supabase
                    .from('wolt_orders')
                    .select('*', { count: 'exact', head: true });

                if (error) {
                    console.error('Supabase error:', error.message, error.details, error.hint);
                    throw new Error(error.message || 'Database error');
                }

                statusDot.classList.remove('loading', 'error');
                statusText.textContent = `Connected Â· ${count || 0} orders in database`;
                refreshBtn.disabled = false;

                if (count > 0) {
                    await loadAndEstimate();
                } else {
                    statusText.textContent = 'Connected Â· No orders yet. Import a CSV to get started.';
                    importSection.classList.add('visible');
                }
            } catch (err) {
                console.error('Connection error:', err.message || err);
                statusDot.classList.remove('loading');
                statusDot.classList.add('error');
                statusText.textContent = `Connection failed: ${err.message || 'Unknown error'}`;
                
                // Show import section anyway
                importSection.classList.add('visible');
            }
        }

        // Event listeners
        importBtn.addEventListener('click', () => {
            importSection.classList.toggle('visible');
        });

        refreshBtn.addEventListener('click', loadAndEstimate);

        importDrop.addEventListener('click', () => fileInput.click());
        importDrop.addEventListener('dragover', (e) => { e.preventDefault(); importDrop.classList.add('dragover'); });
        importDrop.addEventListener('dragleave', () => importDrop.classList.remove('dragover'));
        importDrop.addEventListener('drop', (e) => {
            e.preventDefault();
            importDrop.classList.remove('dragover');
            if (e.dataTransfer.files[0]) importCSV(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files[0]) importCSV(e.target.files[0]); });

        // Import CSV for today's data (uses Supabase historical data)
        async function importCSV(file) {
            importProgress.classList.add('visible');
            progressFill.style.width = '0%';
            progressText.textContent = 'Reading file...';

            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n').filter(line => line.trim());
                const orders = [];

                progressText.textContent = 'Parsing orders...';
                progressFill.style.width = '50%';

                for (let i = 1; i < lines.length; i++) {
                    const fields = parseCSVLine(lines[i]);
                    if (fields.length < 9) continue;

                    const orderPlaced = parseWoltDate(fields[0]);
                    if (!orderPlaced) continue;

                    orders.push({
                        date: orderPlaced,
                        venue: fields[5],
                        price: parseFloat(fields[8]) || 0
                    });
                }

                progressFill.style.width = '100%';
                progressText.textContent = `Loaded ${orders.length} orders from CSV. Fetching historical data...`;

                // Now run estimation with CSV data for today + Supabase for historical
                setTimeout(async () => {
                    importProgress.classList.remove('visible');
                    importSection.classList.remove('visible');
                    await loadAndEstimate(orders);
                }, 1000);
            };
            reader.readAsText(file);
        }

        function parseWoltDate(dateStr) {
            // Format: "8.12.25. 16:14"
            const match = dateStr.match(/(\d+)\.(\d+)\.(\d+)\.\s+(\d+):(\d+)/);
            if (!match) return null;
            const [, day, month, year, hour, minute] = match;
            return new Date(2000 + parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute));
        }

        function parseCSVLine(line) {
            const fields = []; let current = ''; let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { fields.push(current.trim()); current = ''; }
                else current += char;
            }
            fields.push(current.trim());
            return fields;
        }

        // Load data and run estimation
        async function loadAndEstimate(todayFromCSV = null) {
            statusText.textContent = 'Loading orders...';
            statusDot.classList.add('loading');

            try {
                // Get today's date range (in local timezone)
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);

                let todayOrders = todayFromCSV;

                // If no CSV provided, try to fetch from Supabase
                if (!todayOrders) {
                    const { data, error: todayError } = await supabase
                        .from('wolt_orders')
                        .select('created_at, venue_name, amount')
                        .gte('created_at', todayStart.toISOString())
                        .lt('created_at', todayEnd.toISOString())
                        .order('created_at', { ascending: false });

                    if (todayError) throw todayError;
                    todayOrders = data;
                }

                // Fetch historical data (last 3 months) - paginate to get all orders
                const historicalStart = new Date(todayStart.getTime() - 90 * 24 * 60 * 60 * 1000);
                
                let historicalOrders = [];
                let offset = 0;
                const batchSize = 1000; // Supabase default limit
                
                statusText.textContent = 'Loading historical data...';
                
                while (true) {
                    const { data: batch, error: histError } = await supabase
                        .from('wolt_orders')
                        .select('created_at, amount, venue_name')
                        .gte('created_at', historicalStart.toISOString())
                        .lt('created_at', todayStart.toISOString())
                        .order('created_at', { ascending: true })
                        .range(offset, offset + batchSize - 1);

                    if (histError) throw histError;
                    
                    if (!batch || batch.length === 0) break;
                    
                    historicalOrders = historicalOrders.concat(batch);
                    console.log(`Fetched ${historicalOrders.length} orders...`);
                    statusText.textContent = `Loading... ${historicalOrders.length} orders`;
                    
                    if (batch.length < batchSize) break; // Last batch
                    offset += batchSize;
                }

                if (historicalOrders.length === 0) {
                    throw new Error('No historical data found');
                }

                console.log(`Loaded ${historicalOrders.length} historical orders from last 3 months`);

                document.getElementById('totalOrdersDb').textContent = historicalOrders.length;

                statusDot.classList.remove('loading');
                statusText.textContent = `Connected Â· ${historicalOrders.length} orders in last 3 months`;

                if (!todayOrders || todayOrders.length === 0) {
                    statusText.textContent = `Connected Â· ${historicalOrders.length} orders in last 3 months. Upload today's CSV!`;
                    importSection.classList.add('visible');
                    return;
                }

                // Process and estimate
                runEstimation(todayOrders, historicalOrders, !!todayFromCSV);

            } catch (err) {
                console.error('Load error:', err);
                statusDot.classList.remove('loading');
                statusDot.classList.add('error');
                statusText.textContent = 'Error loading data. Check console.';
            }
        }

        function runEstimation(todayOrders, historicalOrders, fromCSV = false) {
            // Check if todayOrders is valid
            if (!todayOrders || !Array.isArray(todayOrders) || todayOrders.length === 0) {
                statusText.textContent = 'No orders to analyze. Please upload today\'s CSV.';
                importSection.classList.add('visible');
                return;
            }
            
            // Convert to usable format
            const today = todayOrders.map(o => {
                if (fromCSV) {
                    // CSV format: already has date, venue, price
                    return {
                        date: o.date,
                        venue: o.venue,
                        price: o.price || 0
                    };
                } else {
                    // Supabase format: created_at, venue_name, amount
                    return {
                        date: new Date(o.created_at),
                        venue: o.venue_name,
                        price: o.amount || 0
                    };
                }
            }).sort((a, b) => b.date - a.date);

            const latestTime = today[0].date;
            const dayName = getDayName(latestTime);
            const todayDateKey = getDateKey(latestTime);

            // Cutoff: 45 min before latest
            const cutoffTime = new Date(latestTime.getTime() - 45 * 60 * 1000);
            const cutoffHour = cutoffTime.getHours();

            const ordersAtCutoff = today.filter(o => o.date <= cutoffTime).length;

            // Build today's hourly cumulative
            const currentHour = latestTime.getHours();
            const todayHourlyCumulative = {};
            for (let h = 0; h <= currentHour; h++) {
                todayHourlyCumulative[h] = today.filter(o => o.date.getHours() <= h).length;
            }

            // Build historical daily summaries
            const dailyData = {};
            for (const order of historicalOrders) {
                const date = new Date(order.created_at);
                const dateKey = getDateKey(date);
                
                if (!dailyData[dateKey]) {
                    dailyData[dateKey] = {
                        orders: [],
                        dayName: getDayName(date)
                    };
                }
                dailyData[dateKey].orders.push(date.getHours());
            }

            // Process historical days - ONLY same day of week
            const sameDayOfWeek = [];

            for (const [dateKey, data] of Object.entries(dailyData)) {
                if (dateKey === todayDateKey) continue;
                
                // Only consider same day of week
                if (data.dayName !== dayName) continue;

                const hourlyCumulative = {};
                for (let h = 0; h <= 23; h++) {
                    hourlyCumulative[h] = data.orders.filter(oh => oh <= h).length;
                }

                const historicalAtCutoff = hourlyCumulative[cutoffHour] || 0;
                const finalTotal = data.orders.length;

                const dayData = {
                    dateKey,
                    dayName: data.dayName,
                    finalTotal,
                    ordersAtCutoff: historicalAtCutoff,
                    hourlyCumulative,
                    date: new Date(dateKey)
                };

                sameDayOfWeek.push(dayData);
            }

            // Sort by date descending (most recent first)
            sameDayOfWeek.sort((a, b) => b.date - a.date);
            
            // Get last 4 same weekdays
            const last4Weeks = sameDayOfWeek.slice(0, 4);
            
            if (last4Weeks.length < 2) {
                statusText.textContent = `Not enough historical ${dayName}s for estimation (need at least 2).`;
                return;
            }

            // Calculate average curve from last 4 same weekdays
            const avgHourlyCurve = {};
            for (let h = 0; h <= 23; h++) {
                const values = last4Weeks.map(d => d.hourlyCumulative[h] || 0);
                avgHourlyCurve[h] = values.reduce((a, b) => a + b, 0) / values.length;
            }

            // Calculate average final total
            const avgFinalTotal = last4Weeks.reduce((sum, d) => sum + d.finalTotal, 0) / last4Weeks.length;
            
            // Average at cutoff from the curve
            const avgAtCutoff = avgHourlyCurve[cutoffHour] || 1;

            // Calculate percentage: how much is today above/below average curve at cutoff
            const percentageDiff = (ordersAtCutoff - avgAtCutoff) / avgAtCutoff;
            const percentage = 1 + percentageDiff;
            
            // Projection = average final total Ã— percentage
            const projectedTotal = Math.round(avgFinalTotal * percentage);

            // Best/worst for same day of week
            const allSameDaySorted = [...sameDayOfWeek].sort((a, b) => b.finalTotal - a.finalTotal);
            const bestDay = allSameDaySorted[0] || null;
            const worstDay = allSameDaySorted[allSameDaySorted.length - 1] || null;

            // Projection object
            const projection = {
                low: Math.min(...last4Weeks.map(d => d.finalTotal)),
                high: Math.max(...last4Weeks.map(d => d.finalTotal)),
                weightedAvg: projectedTotal,
                avgAtCutoff: Math.round(avgAtCutoff),
                avgFinalTotal: Math.round(avgFinalTotal),
                percentageDiff: percentageDiff,
                percentage: percentage,
                avgHourlyCurve: avgHourlyCurve
            };

            // Venue breakdown
            const venueOrders = {};
            let totalRevenue = 0;
            for (const order of today) {
                const venueKey = normalizeVenue(order.venue);
                venueOrders[venueKey] = (venueOrders[venueKey] || 0) + 1;
                totalRevenue += order.price;
            }

            const percentComplete = today.length / projection.weightedAvg;

            updateUI({
                currentOrders: today.length,
                ordersAtCutoff,
                cutoffTime,
                latestTime,
                dayName,
                totalRevenue,
                avgOrderValue: totalRevenue / today.length,
                venueOrders,
                similarDays: last4Weeks,
                projection,
                percentComplete,
                todayHourlyCumulative,
                currentHour,
                bestDay,
                worstDay
            });

            results.classList.add('visible');
        }

        function normalizeVenue(venue) {
            const v = venue.toLowerCase();
            if (v.includes('vraÄar') && v.includes('smash')) return 'SMASH VraÄar';
            if (v.includes('vraÄar') && v.includes('kuhinjica')) return 'Kuhinjica VraÄar';
            if (v.includes('vraÄar') && v.includes('pancake')) return 'Pancakes VraÄar';
            if (v.includes('vraÄar')) return 'Burgers VraÄar';
            if (v.includes('banovo')) return 'Banovo Brdo';
            if (v.includes('novi beograd') || v.includes('nbg')) return 'Novi Beograd';
            if (v.includes('kuhinjica')) return 'Kuhinjica NBG';
            if (v.includes('pancake')) return 'Pancakes NBG';
            return venue;
        }

        function getDayName(date) {
            return ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()];
        }

        function getDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function formatDateShort(dateKey) {
            const [y, m, d] = dateKey.split('-');
            return `${parseInt(d)}.${parseInt(m)}.`;
        }

        function formatNumber(num) { return num.toLocaleString('de-DE'); }

        function updateUI(data) {
            document.getElementById('projectedTotal').textContent = data.projection.weightedAvg;
            const pctDiff = Math.round(data.projection.percentageDiff * 100);
            const pctSign = pctDiff >= 0 ? '+' : '';
            document.getElementById('projectedRange').textContent = `avg ${data.projection.avgFinalTotal} Ã— (${pctSign}${pctDiff}%)`;
            document.getElementById('currentOrders').textContent = data.currentOrders;
            document.getElementById('lastOrderTime').textContent = `as of ${data.latestTime.getHours()}:${String(data.latestTime.getMinutes()).padStart(2, '0')}`;

            const percent = Math.min(100, Math.round(data.percentComplete * 100));
            const circumference = 2 * Math.PI * 60;
            document.getElementById('progressRing').style.strokeDashoffset = circumference * (1 - Math.min(1, data.percentComplete));
            document.getElementById('progressPercent').textContent = `${percent}%`;

            document.getElementById('dayOfWeek').textContent = data.dayName;
            document.getElementById('ordersAtCutoff').textContent = `${data.ordersAtCutoff} @ ${data.cutoffTime.getHours()}:${String(data.cutoffTime.getMinutes()).padStart(2, '0')}`;
            document.getElementById('currentRevenue').textContent = `${formatNumber(Math.round(data.totalRevenue))} RSD`;
            document.getElementById('avgOrderValue').textContent = `${formatNumber(Math.round(data.avgOrderValue))} RSD`;

            // Similar days
            document.getElementById('similarDaysList').innerHTML = data.similarDays.map(day => `
                <div class="similar-day-item">
                    <div>
                        <div class="similar-day-date">${formatDateShort(day.dateKey)}</div>
                        <div class="similar-day-dayname">${day.dayName}</div>
                    </div>
                    <div class="similar-day-at-cutoff">${day.ordersAtCutoff} @ cutoff</div>
                    <div class="similar-day-final">${day.finalTotal}</div>
                </div>
                </div>
            `).join('');

            // Venues
            const maxOrders = Math.max(...Object.values(data.venueOrders));
            document.getElementById('venueList').innerHTML = Object.entries(data.venueOrders)
                .sort((a, b) => b[1] - a[1])
                .map(([venue, orders]) => `
                    <div class="venue-item">
                        <span class="venue-name">${venue}</span>
                        <span class="venue-orders">${orders} orders</span>
                        <div class="venue-bar"><div class="venue-bar-fill" style="width: ${(orders / maxOrders) * 100}%"></div></div>
                    </div>
                `).join('');

            // Benchmarks - show average curve vs today at cutoff
            document.getElementById('benchmarkLow').textContent = data.projection.avgAtCutoff;
            document.getElementById('benchmarkWeighted').textContent = data.ordersAtCutoff;
            const pctDiffBench = Math.round(data.projection.percentageDiff * 100);
            document.getElementById('benchmarkHigh').textContent = `${pctDiffBench >= 0 ? '+' : ''}${pctDiffBench}%`;
            document.getElementById('rangeLow').textContent = data.projection.low;
            document.getElementById('rangeHigh').textContent = data.projection.high;
            // Position marker based on projection within range
            const range = data.projection.high - data.projection.low;
            const rangePos = range > 0 ? ((data.projection.weightedAvg - data.projection.low) / range) * 100 : 50;
            document.getElementById('rangeMarker').style.left = `${Math.min(100, Math.max(0, rangePos))}%`;

            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString('sr-RS');

            renderChart(data);
        }

        let orderChart = null;

        function renderChart(data) {
            const ctx = document.getElementById('orderChart').getContext('2d');
            if (orderChart) orderChart.destroy();

            // Full day from 00:00 to 24:00 (midnight to midnight)
            const hours = Array.from({ length: 25 }, (_, i) => i); // 0 to 24
            const labels = hours.map(h => h === 24 ? '24:00' : `${h}:00`);

            const colors = {
                today: { line: '#ff6b35', bg: 'rgba(255, 107, 53, 0.1)' },
                projection: { line: '#ff6b35', bg: 'rgba(255, 107, 53, 0.05)' },
                similar: [{ line: '#4dabf7' }, { line: '#00d68f' }, { line: '#a855f7' }, { line: '#f59e0b' }],
                best: { line: '#22c55e' },
                worst: { line: '#ef4444' }
            };

            const datasets = [];

            // Use the pre-calculated average curve from projection data
            const avgHourlyCumulative = data.projection.avgHourlyCurve;

            // Build projected curve: apply percentage to average curve
            const projectedCurve = {};
            for (let h = 0; h <= 24; h++) {
                const hourKey = h === 24 ? 23 : h;
                const avgValue = h === 24 ? data.projection.avgFinalTotal : (avgHourlyCumulative[hourKey] || 0);
                projectedCurve[h] = Math.round(avgValue * data.projection.percentage);
            }

            if (data.bestDay) {
                const bestData = hours.map(h => {
                    if (h === 24) return data.bestDay.finalTotal;
                    return data.bestDay.hourlyCumulative[h] || 0;
                });
                datasets.push({
                    label: `Best ${data.dayName} (${formatDateShort(data.bestDay.dateKey)}) - ${data.bestDay.finalTotal}`,
                    data: bestData,
                    borderColor: colors.best.line, backgroundColor: 'transparent',
                    borderWidth: 2, borderDash: [2, 4], fill: false, tension: 0.3,
                    pointRadius: 0, order: 4
                });
            }

            if (data.worstDay && data.worstDay !== data.bestDay) {
                const worstData = hours.map(h => {
                    if (h === 24) return data.worstDay.finalTotal;
                    return data.worstDay.hourlyCumulative[h] || 0;
                });
                datasets.push({
                    label: `Worst ${data.dayName} (${formatDateShort(data.worstDay.dateKey)}) - ${data.worstDay.finalTotal}`,
                    data: worstData,
                    borderColor: colors.worst.line, backgroundColor: 'transparent',
                    borderWidth: 2, borderDash: [2, 4], fill: false, tension: 0.3,
                    pointRadius: 0, order: 4
                });
            }

            data.similarDays.forEach((day, idx) => {
                const dayData = hours.map(h => {
                    if (h === 24) return day.finalTotal;
                    return day.hourlyCumulative[h] || 0;
                });
                datasets.push({
                    label: `${formatDateShort(day.dateKey)} (${day.finalTotal})`,
                    data: dayData,
                    borderColor: colors.similar[idx].line, backgroundColor: 'transparent',
                    borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.3,
                    pointRadius: 0, order: 3
                });
            });

            // Today's actual data (up to current hour)
            const todayData = hours.map(h => {
                if (h <= data.currentHour) {
                    return data.todayHourlyCumulative[h] || 0;
                }
                return null;
            });

            datasets.push({
                label: `Today (${data.dayName})`,
                data: todayData,
                borderColor: colors.today.line, backgroundColor: colors.today.bg,
                borderWidth: 3, fill: true, tension: 0.3,
                pointRadius: 4, pointBackgroundColor: colors.today.line, order: 1
            });

            // Projected curve (from current hour to midnight)
            const projectionData = hours.map(h => {
                if (h >= data.currentHour) {
                    return projectedCurve[h];
                }
                return null;
            });

            datasets.push({
                label: `Projection (${data.projection.weightedAvg})`,
                data: projectionData,
                borderColor: colors.projection.line, backgroundColor: colors.projection.bg,
                borderWidth: 2, borderDash: [8, 4], fill: true, tension: 0.3,
                pointRadius: 0, order: 2
            });

            orderChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(18, 18, 26, 0.95)',
                            titleColor: '#fff', bodyColor: '#8b8b9e',
                            borderColor: '#2a2a3a', borderWidth: 1, padding: 12,
                            callbacks: { label: ctx => ctx.parsed.y !== null ? `${ctx.dataset.label}: ${ctx.parsed.y} orders` : '' }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(42, 42, 58, 0.5)' }, ticks: { color: '#5a5a6e', font: { size: 11 } } },
                        y: { grid: { color: 'rgba(42, 42, 58, 0.5)' }, ticks: { color: '#5a5a6e', font: { size: 11 } }, beginAtZero: true }
                    }
                }
            });

            const legend = document.getElementById('chartLegend');
            legend.innerHTML = `
                <div class="legend-item"><div class="legend-color" style="background: ${colors.today.line}"></div><span class="legend-label">Today</span><span class="legend-value">${data.currentOrders}</span></div>
                <div class="legend-item"><div class="legend-color" style="background: ${colors.today.line}; opacity: 0.5"></div><span class="legend-label">Projected</span><span class="legend-value">${data.projection.weightedAvg}</span></div>
                ${data.similarDays.map((d, i) => `<div class="legend-item"><div class="legend-color" style="background: ${colors.similar[i].line}"></div><span class="legend-label">${formatDateShort(d.dateKey)}</span><span class="legend-value">${d.finalTotal}</span></div>`).join('')}
                ${data.bestDay ? `<div class="legend-item"><div class="legend-color" style="background: ${colors.best.line}"></div><span class="legend-label">Best ${data.dayName}</span><span class="legend-value">${data.bestDay.finalTotal}</span></div>` : ''}
                ${data.worstDay && data.worstDay !== data.bestDay ? `<div class="legend-item"><div class="legend-color" style="background: ${colors.worst.line}"></div><span class="legend-label">Worst ${data.dayName}</span><span class="legend-value">${data.worstDay.finalTotal}</span></div>` : ''}
            `;
        }

        // Start
        init();
    </script>
</body>
</html>
