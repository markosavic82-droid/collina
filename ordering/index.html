<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Collina - Naruƒçi</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0f0a0b;
            --bg-secondary: #1a1314;
            --bg-card: #241a1c;
            --bg-card-hover: #2d2123;
            --accent: #e07d62;
            --accent-light: #f0a08a;
            --accent-dark: #c46a52;
            --text-primary: #f5f0eb;
            --text-secondary: #9a8a85;
            --text-muted: #6a5a55;
            --success: #6bc77a;
            --error: #e06262;
            --border: rgba(255, 255, 255, 0.08);
            --border-light: rgba(255, 255, 255, 0.12);
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --font: 'Outfit', sans-serif;
        }

        body {
            font-family: var(--font);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(15, 10, 11, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .location-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .location-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .cart-btn {
            position: relative;
            width: 48px;
            height: 48px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cart-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent);
        }

        .cart-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            min-width: 22px;
            height: 22px;
            background: var(--accent);
            color: white;
            font-size: 12px;
            font-weight: 700;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s;
        }

        .cart-badge.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Main Content */
        .main {
            padding: 145px 16px 20px; /* Account for header + sticky categories */
            max-width: 600px;
            margin: 0 auto;
        }

        /* Categories */
        .categories-nav {
            position: fixed;
            top: 81px; /* Below header */
            left: 0;
            right: 0;
            z-index: 99;
            background: rgba(15, 10, 11, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
        }

        .categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 12px 0;
            -webkit-overflow-scrolling: touch;
        }

        .categories::-webkit-scrollbar { display: none; }

        .category-tab {
            flex-shrink: 0;
            padding: 10px 18px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .category-tab:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .category-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Menu Grid */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* Category Headers (big section titles) */
        .category-header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 28px 0 16px 0;
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            scroll-margin-top: 140px; /* Account for sticky header + tabs */
        }

        .category-header:first-child {
            padding-top: 10px;
        }

        .category-header-icon {
            font-size: 24px;
        }

        /* Section Titles (sub-dividers within category) */
        .menu-section-title {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px 0 10px 0;
        }

        .menu-section-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
        }

        .menu-section-text {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            white-space: nowrap;
        }

        .menu-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-item:hover {
            border-color: var(--border-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .menu-item-image {
            width: 100%;
            aspect-ratio: 16/9;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--text-muted);
            overflow: hidden;
        }

        .menu-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .menu-item-info {
            padding: 12px;
        }

        .menu-item-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            cursor: pointer;
        }

        .menu-item-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .menu-item-price {
            font-size: 15px;
            font-weight: 700;
            color: var(--accent);
        }

        .menu-item-old-price {
            font-size: 12px;
            color: var(--text-muted);
            text-decoration: line-through;
            margin-right: 6px;
        }

        .menu-item-prices {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .menu-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn.small {
            width: 28px;
            height: 28px;
            font-size: 16px;
            border-radius: 8px;
        }

        .qty-btn.small.add {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .qty-btn.small.add:hover {
            background: var(--accent-dark);
        }

        .discount-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--error);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .popular-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.6);
            color: #fbbf24;
            font-size: 14px;
            padding: 4px 6px;
            border-radius: 6px;
        }

        .menu-item-image {
            position: relative;
        }

        .menu-item-qty {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .qty-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .qty-btn:hover:not(:disabled) {
            background: var(--accent);
            border-color: var(--accent);
        }

        .qty-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .qty-value {
            font-size: 16px;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .add-btn {
            padding: 8px 16px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-btn:hover {
            background: var(--accent-dark);
        }

        /* Product Sheet */
        .sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .sheet-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .product-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-radius: 24px 24px 0 0;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 201;
        }

        .sheet-overlay.show .product-sheet {
            transform: translateY(0);
        }

        .sheet-image {
            width: 100%;
            aspect-ratio: 16/9;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            color: var(--text-muted);
            position: relative;
        }

        .sheet-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: var(--bg-card);
        }

        .sheet-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sheet-content {
            padding: 20px;
        }

        .sheet-name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .sheet-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .sheet-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 20px;
        }

        .sheet-old-price {
            font-size: 18px;
            color: var(--text-muted);
            text-decoration: line-through;
            margin-right: 12px;
        }

        .sheet-prices {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Ingredients */
        .ingredients-section {
            margin-bottom: 20px;
        }

        .ingredients-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ingredient-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ingredient-item:hover {
            border-color: var(--border-light);
        }

        .ingredient-item.selected {
            border-color: var(--accent);
            background: rgba(224, 125, 98, 0.1);
        }

        .ingredient-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ingredient-check {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-light);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .ingredient-item.selected .ingredient-check {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .ingredient-name {
            font-size: 14px;
            font-weight: 500;
        }

        .ingredient-price {
            font-size: 13px;
            color: var(--accent);
            font-weight: 600;
        }

        /* Sheet Footer */
        .sheet-footer {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .sheet-qty {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .sheet-qty-btn {
            width: 44px;
            height: 44px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .sheet-qty-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent);
        }

        .sheet-qty-value {
            font-size: 20px;
            font-weight: 700;
            min-width: 32px;
            text-align: center;
        }

        .sheet-add-btn {
            flex: 1;
            padding: 16px;
            background: var(--accent);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sheet-add-btn:hover {
            background: var(--accent-dark);
        }

        /* Cart Screen */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .cart-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 150;
            display: none;
            flex-direction: column;
        }

        .cart-screen.show {
            display: flex;
        }

        .cart-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .back-btn {
            width: 44px;
            height: 44px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-title {
            font-size: 20px;
            font-weight: 700;
        }

        .cart-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .cart-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .cart-empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .cart-empty-text {
            font-size: 16px;
        }

        .cart-item {
            display: flex;
            gap: 14px;
            padding: 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 12px;
        }

        .cart-item-image {
            width: 70px;
            height: 70px;
            background: var(--bg-secondary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .cart-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .cart-item-info {
            flex: 1;
            min-width: 0;
        }

        .cart-item-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .cart-item-extras {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .cart-item-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cart-item-price {
            font-size: 15px;
            font-weight: 700;
            color: var(--accent);
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cart-qty-btn {
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-qty-value {
            font-size: 14px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .cart-delete {
            width: 28px;
            height: 28px;
            background: rgba(224, 98, 98, 0.15);
            border: none;
            border-radius: 6px;
            color: var(--error);
            font-size: 14px;
            cursor: pointer;
            margin-left: 8px;
        }

        /* Checkout Form */
        .checkout-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-card-hover);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        /* Order Type */
        .order-types {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }

        .order-type-btn {
            padding: 14px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .order-type-btn:hover {
            border-color: var(--border-light);
            color: var(--text-primary);
        }

        .order-type-btn.active {
            border-color: var(--accent);
            background: rgba(224, 125, 98, 0.1);
            color: var(--accent);
        }

        .order-type-icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        /* Location Select */
        .location-select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239a8a85' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
        }

        .location-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Cart Footer */
        .cart-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .cart-summary {
            margin-bottom: 16px;
        }

        .cart-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .cart-summary-row.total {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            padding-top: 12px;
            border-top: 1px solid var(--border);
            margin-top: 12px;
        }

        .cart-summary-row.total span:last-child {
            color: var(--accent);
        }

        .order-btn {
            width: 100%;
            padding: 18px;
            background: var(--accent);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .order-btn:hover:not(:disabled) {
            background: var(--accent-dark);
        }

        .order-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Success Screen */
        .success-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .success-screen.show {
            display: flex;
        }

        .success-icon {
            font-size: 80px;
            margin-bottom: 24px;
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .success-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .success-order-num {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .success-order-num span {
            color: var(--accent);
            font-weight: 600;
        }

        .success-message {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 32px;
            max-width: 300px;
        }

        .success-btn {
            padding: 16px 40px;
            background: var(--accent);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow);
            opacity: 0;
            transition: all 0.3s;
            z-index: 300;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            border-color: var(--success);
            color: var(--success);
        }

        .toast.error {
            border-color: var(--error);
            color: var(--error);
        }

        /* Location Picker Screen */
        .location-picker {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .location-picker.hidden {
            display: none;
        }

        .location-picker-logo {
            font-size: 48px;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .location-picker-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 40px;
        }

        .location-picker-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .location-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 400px;
        }

        .location-option {
            padding: 20px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .location-option:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .location-option-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .location-option-address {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .location-option-badge {
            display: inline-block;
            margin-top: 8px;
            margin-right: 6px;
            padding: 4px 8px;
            background: rgba(224, 125, 98, 0.2);
            color: var(--accent);
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
        }

        .location-option-badge.new {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
        }
    </style>
</head>
<body>
    <!-- Location Picker Screen -->
    <div class="location-picker" id="location-picker">
        <div class="location-picker-logo">Collina</div>
        <div class="location-picker-subtitle">Burgers & Pancakes</div>
        <div class="location-picker-title">Izaberi lokaciju</div>
        <div class="location-options" id="location-options"></div>
    </div>

    <!-- Header -->
    <header class="header" id="main-header" style="display: none;">
        <div class="header-left">
            <div class="logo">Collina</div>
            <button class="location-btn" onclick="changeLocation()" id="current-location-btn">
                üìç <span id="current-location-name">Lokacija</span>
            </button>
        </div>
        <button class="cart-btn" onclick="openCart()">
            üõí
            <span class="cart-badge" id="cart-badge">0</span>
        </button>
    </header>

    <!-- Sticky Categories Navigation -->
    <nav class="categories-nav" id="categories-nav" style="display: none;">
        <div class="categories" id="categories">
            <div class="category-tab">Uƒçitavanje...</div>
        </div>
    </nav>

    <!-- Main Menu Screen -->
    <main class="main screen" id="screen-menu" style="display: none;">
        <!-- Menu Items -->
        <div class="menu-grid" id="menu-grid">
            <div class="loading">
                <div class="spinner"></div>
                Uƒçitavanje menija...
            </div>
        </div>
    </main>

    <!-- Product Detail Sheet -->
    <div class="sheet-overlay" id="product-sheet" onclick="closeSheet(event)">
        <div class="product-sheet">
            <div class="sheet-image" id="sheet-image">
                <button class="sheet-close" onclick="closeSheet()">‚úï</button>
            </div>
            <div class="sheet-content">
                <div class="sheet-name" id="sheet-name"></div>
                <div class="sheet-desc" id="sheet-desc"></div>
                <div class="sheet-price" id="sheet-price"></div>
                
                <div class="ingredients-section" id="ingredients-section" style="display: none;">
                    <div class="ingredients-title">Dodaci</div>
                    <div id="ingredients-list"></div>
                </div>
            </div>
            <div class="sheet-footer">
                <div class="sheet-qty">
                    <button class="sheet-qty-btn" onclick="updateSheetQty(-1)">‚àí</button>
                    <span class="sheet-qty-value" id="sheet-qty">1</span>
                    <button class="sheet-qty-btn" onclick="updateSheetQty(1)">+</button>
                </div>
                <button class="sheet-add-btn" id="sheet-add-btn" onclick="addToCart()">
                    Dodaj ‚Ä¢ <span id="sheet-total">0</span> RSD
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Screen -->
    <div class="cart-screen" id="cart-screen">
        <div class="cart-header">
            <button class="back-btn" onclick="closeCart()">‚Üê</button>
            <div class="cart-title">Korpa</div>
        </div>
        <div class="cart-content" id="cart-content">
            <!-- Cart items rendered here -->
        </div>
        <div class="cart-footer" id="cart-footer" style="display: none;">
            <div class="cart-summary">
                <div class="cart-summary-row">
                    <span>Proizvodi</span>
                    <span id="summary-subtotal">0 RSD</span>
                </div>
                <div class="cart-summary-row total">
                    <span>Ukupno</span>
                    <span id="summary-total">0 RSD</span>
                </div>
            </div>
            <button class="order-btn" id="order-btn" onclick="submitOrder()">
                Naruƒçi
            </button>
        </div>
    </div>

    <!-- Success Screen -->
    <div class="success-screen" id="success-screen">
        <div class="success-icon">‚úÖ</div>
        <div class="success-title">Narud≈æbina poslata!</div>
        <div class="success-order-num">Broj narud≈æbine: <span id="success-order-num">#1</span></div>
        <div class="success-message">
            Tvoja narud≈æbina je primljena. Dobiƒáe≈° obave≈°tenje kada bude spremna za preuzimanje.
        </div>
        <button class="success-btn" onclick="newOrder()">Nova narud≈æbina</button>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://bbnbbbpofelbkyuffslj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibmJiYnBvZmVsYmt5dWZmc2xqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTI0MzQsImV4cCI6MjA4MDYyODQzNH0.koW44soAB-bEfh8OzqjGBwdgov4Snscw1ITsg5OureU';

        // Default locations (will be overwritten by DB)
        let LOCATIONS = {};

        // ============================================
        // STATE
        // ============================================
        let db = null;
        let categories = [];
        let menuItems = [];
        let sections = [];
        let ingredients = [];
        let itemIngredients = {};
        let selectedCategory = null;
        let locations = []; // From database

        let cart = []; // [{item, qty, selectedIngredients: []}]
        let currentProduct = null;
        let sheetQty = 1;
        let sheetIngredients = [];

        // Checkout form state
        let orderType = 'pickup';
        let customerName = '';
        let customerPhone = '';
        let selectedLocation = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            try {
                db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Load locations from database first
                await loadLocations();
                
                // Check if location was previously selected
                const savedLocation = localStorage.getItem('collina_selected_location');
                if (savedLocation && LOCATIONS[savedLocation]) {
                    selectLocation(savedLocation);
                } else {
                    renderLocationPicker();
                }
            } catch (e) {
                console.error('Init error:', e);
                showToast('Gre≈°ka pri uƒçitavanju', 'error');
            }
        }

        async function loadLocations() {
            const { data } = await db
                .from('shop_locations')
                .select('*')
                .eq('is_active', true)
                .order('sort_order');
            
            locations = data || [];
            
            // Build LOCATIONS object for compatibility
            LOCATIONS = {};
            locations.forEach(loc => {
                LOCATIONS[loc.slug] = {
                    name: loc.name,
                    address: loc.address,
                    hasDriveThrough: loc.has_drive_through || false,
                    isNew: loc.is_new || false
                };
            });
        }

        function renderLocationPicker() {
            const container = document.getElementById('location-options');
            container.innerHTML = locations.map(loc => `
                <div class="location-option" onclick="selectLocation('${loc.slug}')">
                    <div class="location-option-name">${loc.name}</div>
                    <div class="location-option-address">${loc.address}</div>
                    ${loc.has_drive_through ? '<span class="location-option-badge">üöó Drive-Thru</span>' : ''}
                    ${loc.is_new ? '<span class="location-option-badge new">‚ú® NOVO</span>' : ''}
                </div>
            `).join('');
        }

        async function selectLocation(locationId) {
            selectedLocation = locationId;
            localStorage.setItem('collina_selected_location', locationId);
            
            // Hide location picker, show menu
            document.getElementById('location-picker').classList.add('hidden');
            document.getElementById('main-header').style.display = 'flex';
            document.getElementById('categories-nav').style.display = 'block';
            document.getElementById('screen-menu').style.display = 'block';
            
            // Update header with location name - show short version
            const loc = LOCATIONS[locationId];
            const shortName = loc.name.replace('Collina ', '').replace('Collina Kuhinjica ', '');
            document.getElementById('current-location-name').textContent = shortName;
            
            // Load and render menu
            await loadMenu();
            renderMenu();
            renderCategories();
        }

        function changeLocation() {
            document.getElementById('location-picker').classList.remove('hidden');
            document.getElementById('main-header').style.display = 'none';
            document.getElementById('categories-nav').style.display = 'none';
            document.getElementById('screen-menu').style.display = 'none';
            renderLocationPicker();
        }

        async function loadMenu() {
            // Load categories
            const { data: cats } = await db
                .from('shop_menu_categories')
                .select('*')
                .eq('is_active', true)
                .order('sort_order');
            categories = cats || [];

            // Load menu items
            const { data: items } = await db
                .from('shop_menu_items')
                .select('*')
                .eq('is_available', true)
                .order('sort_order');
            menuItems = items || [];

            // Load sections
            const { data: secs } = await db
                .from('shop_menu_sections')
                .select('*')
                .eq('is_active', true)
                .order('sort_order');
            sections = secs || [];

            // Load ingredients
            const { data: ings } = await db
                .from('shop_ingredients')
                .select('*')
                .eq('is_available', true)
                .order('sort_order');
            ingredients = ings || [];

            // Load item-ingredient mappings
            const { data: mappings } = await db
                .from('shop_item_ingredients')
                .select('*');
            
            itemIngredients = {};
            (mappings || []).forEach(m => {
                if (!itemIngredients[m.item_id]) itemIngredients[m.item_id] = [];
                itemIngredients[m.item_id].push(m);
            });
        }

        // ============================================
        // RENDER
        // ============================================
        function renderCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = `
                <div class="category-tab" onclick="scrollToSection('akcija')">üî• Akcija</div>
                <div class="category-tab" onclick="scrollToSection('popularno')">‚≠ê Popularno</div>
                ${categories.map(cat => `
                    <div class="category-tab" data-category="${cat.id}" onclick="scrollToSection('cat-${cat.id}')">
                        ${cat.name}
                    </div>
                `).join('')}
            `;
        }

        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                const headerOffset = 140; // Account for sticky header + tabs
                const elementPosition = element.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }
        }

        function renderMenu() {
            const container = document.getElementById('menu-grid');
            
            // Filter all items by location first
            const locationFiltered = menuItems.filter(item => {
                if (item.available_locations && Array.isArray(item.available_locations)) {
                    return item.available_locations.includes(selectedLocation);
                }
                return true;
            });
            
            // Get special items
            const akcija = locationFiltered.filter(item => item.discounted_price && item.discounted_price < item.price);
            const popularno = locationFiltered
                .filter(item => item.is_popular)
                .sort((a, b) => (a.popular_sort_order || 0) - (b.popular_sort_order || 0));
            
            let html = '';
            
            // Akcija section
            if (akcija.length > 0) {
                html += `
                    <div class="category-header" id="akcija">
                        <span class="category-header-icon">üî•</span>
                        <span>Akcija</span>
                    </div>
                `;
                html += renderItemsGrid(akcija);
            }
            
            // Popularno section
            if (popularno.length > 0) {
                html += `
                    <div class="category-header" id="popularno">
                        <span class="category-header-icon">‚≠ê</span>
                        <span>Popularno</span>
                    </div>
                `;
                html += renderItemsGrid(popularno);
            }
            
            // Regular categories
            categories.forEach(cat => {
                const catItems = locationFiltered.filter(item => item.category_id === cat.id);
                const catSections = sections.filter(sec => sec.category_id === cat.id);
                
                if (catItems.length === 0) return;
                
                // Category header
                html += `
                    <div class="category-header" id="cat-${cat.id}">
                        <span>${cat.name}</span>
                    </div>
                `;
                
                // Combine items and sections, sort by sort_order
                const allContent = [
                    ...catItems.map(item => ({ type: 'item', data: item, sort_order: item.sort_order })),
                    ...catSections.map(sec => ({ type: 'section', data: sec, sort_order: sec.sort_order }))
                ].sort((a, b) => a.sort_order - b.sort_order);
                
                allContent.forEach(row => {
                    if (row.type === 'section') {
                        html += `
                            <div class="menu-section-title">
                                <span class="menu-section-line"></span>
                                <span class="menu-section-text">${row.data.name}</span>
                                <span class="menu-section-line"></span>
                            </div>
                        `;
                    } else {
                        html += renderItemCard(row.data);
                    }
                });
            });
            
            container.innerHTML = html || `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-secondary);">
                    Nema proizvoda
                </div>
            `;
            
            // Setup scroll observer for active tab highlighting
            setupScrollObserver();
        }
        
        function renderItemsGrid(items) {
            return items.map(item => renderItemCard(item)).join('');
        }
        
        function renderItemCard(item) {
            const cartItem = cart.find(c => c.item.id === item.id);
            const qty = cartItem ? cartItem.qty : 0;
            const hasDiscount = item.discounted_price && item.discounted_price < item.price;
            const displayPrice = hasDiscount ? item.discounted_price : item.price;

            return `
                <div class="menu-item">
                    <div class="menu-item-image" onclick="openProduct('${item.id}')">
                        ${item.image_url 
                            ? `<img src="${item.image_url}" alt="${item.name}">`
                            : 'üçΩÔ∏è'}
                        ${hasDiscount ? '<div class="discount-badge">AKCIJA</div>' : ''}
                        ${item.is_popular ? '<div class="popular-badge">‚≠ê</div>' : ''}
                    </div>
                    <div class="menu-item-info">
                        <div class="menu-item-name" onclick="openProduct('${item.id}')">${item.name}</div>
                        <div class="menu-item-footer">
                            <div class="menu-item-prices">
                                ${hasDiscount ? `<span class="menu-item-old-price">${item.price}</span>` : ''}
                                <span class="menu-item-price">${displayPrice} RSD</span>
                            </div>
                            <div class="menu-item-controls">
                                ${qty > 0 ? `
                                    <button class="qty-btn small" onclick="quickUpdateQty('${item.id}', -1)">‚àí</button>
                                    <span class="qty-value">${qty}</span>
                                ` : ''}
                                <button class="qty-btn small add" onclick="quickAddItem('${item.id}')">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function setupScrollObserver() {
            const headers = document.querySelectorAll('.category-header');
            const tabs = document.querySelectorAll('.category-tab');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        tabs.forEach(tab => tab.classList.remove('active'));
                        
                        // Find matching tab
                        if (id === 'akcija') {
                            tabs[0]?.classList.add('active');
                        } else if (id === 'popularno') {
                            tabs[1]?.classList.add('active');
                        } else if (id.startsWith('cat-')) {
                            const catId = id.replace('cat-', '');
                            const tab = document.querySelector(`.category-tab[data-category="${catId}"]`);
                            tab?.classList.add('active');
                        }
                    }
                });
            }, {
                rootMargin: '-150px 0px -70% 0px',
                threshold: 0
            });
            
            headers.forEach(header => observer.observe(header));
        }

        // Keep for compatibility but not used for filtering anymore
        function filterCategory(catId, el) {
            scrollToSection(catId);
        }

        // ============================================
        // PRODUCT SHEET
        // ============================================
        function openProduct(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            currentProduct = item;
            sheetQty = 1;
            sheetIngredients = [];

            // Set content
            document.getElementById('sheet-name').textContent = item.name;
            document.getElementById('sheet-desc').textContent = item.description || '';
            
            // Price with discount support
            const hasDiscount = item.discounted_price && item.discounted_price < item.price;
            const priceContainer = document.getElementById('sheet-price');
            if (hasDiscount) {
                priceContainer.innerHTML = `<span class="sheet-old-price">${item.price} RSD</span><span>${item.discounted_price} RSD</span>`;
            } else {
                priceContainer.textContent = item.price + ' RSD';
            }
            
            document.getElementById('sheet-qty').textContent = sheetQty;
            
            // Image
            const imageEl = document.getElementById('sheet-image');
            if (item.image_url) {
                imageEl.innerHTML = `<img src="${item.image_url}" alt="${item.name}"><button class="sheet-close" onclick="closeSheet()">‚úï</button>`;
            } else {
                imageEl.innerHTML = `üçΩÔ∏è<button class="sheet-close" onclick="closeSheet()">‚úï</button>`;
            }

            // Ingredients
            const itemIngs = itemIngredients[item.id] || [];
            const ingSection = document.getElementById('ingredients-section');
            const ingList = document.getElementById('ingredients-list');
            
            if (itemIngs.length > 0) {
                ingSection.style.display = 'block';
                ingList.innerHTML = itemIngs.map(mapping => {
                    const ing = ingredients.find(i => i.id === mapping.ingredient_id);
                    if (!ing) return '';
                    return `
                        <div class="ingredient-item" id="ing-${ing.id}" onclick="toggleIngredient('${ing.id}')">
                            <div class="ingredient-left">
                                <div class="ingredient-check">‚úì</div>
                                <span class="ingredient-name">${ing.name}</span>
                            </div>
                            <span class="ingredient-price">+${ing.price} RSD</span>
                        </div>
                    `;
                }).join('');
            } else {
                ingSection.style.display = 'none';
            }

            updateSheetTotal();
            document.getElementById('product-sheet').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeSheet(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('product-sheet').classList.remove('show');
            document.body.style.overflow = '';
            currentProduct = null;
        }

        function toggleIngredient(ingId) {
            const idx = sheetIngredients.indexOf(ingId);
            const el = document.getElementById('ing-' + ingId);
            
            if (idx > -1) {
                sheetIngredients.splice(idx, 1);
                el?.classList.remove('selected');
            } else {
                sheetIngredients.push(ingId);
                el?.classList.add('selected');
            }
            updateSheetTotal();
        }

        function updateSheetQty(delta) {
            sheetQty = Math.max(1, sheetQty + delta);
            document.getElementById('sheet-qty').textContent = sheetQty;
            updateSheetTotal();
        }

        function updateSheetTotal() {
            if (!currentProduct) return;
            // Use discounted price if available
            const basePrice = (currentProduct.discounted_price && currentProduct.discounted_price < currentProduct.price) 
                ? currentProduct.discounted_price 
                : currentProduct.price;
            let total = basePrice;
            sheetIngredients.forEach(ingId => {
                const ing = ingredients.find(i => i.id === ingId);
                if (ing) total += ing.price;
            });
            document.getElementById('sheet-total').textContent = (total * sheetQty).toLocaleString();
        }

        // ============================================
        // CART
        // ============================================
        function addToCart() {
            if (!currentProduct) return;

            const selectedIngs = sheetIngredients.map(id => ingredients.find(i => i.id === id)).filter(Boolean);
            
            // Check if same item with same ingredients exists
            const existingIdx = cart.findIndex(c => 
                c.item.id === currentProduct.id && 
                JSON.stringify(c.selectedIngredients.map(i => i.id).sort()) === JSON.stringify(sheetIngredients.sort())
            );

            if (existingIdx > -1) {
                cart[existingIdx].qty += sheetQty;
            } else {
                cart.push({
                    item: currentProduct,
                    qty: sheetQty,
                    selectedIngredients: selectedIngs
                });
            }

            updateCartBadge();
            renderMenu();
            closeSheet();
            showToast('Dodato u korpu', 'success');
        }

        function quickUpdateQty(itemId, delta) {
            const idx = cart.findIndex(c => c.item.id === itemId);
            if (idx === -1) return;

            cart[idx].qty += delta;
            if (cart[idx].qty <= 0) {
                cart.splice(idx, 1);
            }

            updateCartBadge();
            renderMenu();
        }

        function quickAddItem(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            // Check if item already in cart (without ingredients)
            const existingIdx = cart.findIndex(c => 
                c.item.id === itemId && c.selectedIngredients.length === 0
            );

            if (existingIdx > -1) {
                cart[existingIdx].qty += 1;
            } else {
                cart.push({
                    item: item,
                    qty: 1,
                    selectedIngredients: []
                });
            }

            updateCartBadge();
            renderMenu();
            showToast('Dodato u korpu', 'success');
        }

        function updateCartBadge() {
            const count = cart.reduce((sum, c) => sum + c.qty, 0);
            const badge = document.getElementById('cart-badge');
            badge.textContent = count;
            badge.classList.toggle('show', count > 0);
        }

        function openCart() {
            renderCart();
            document.getElementById('cart-screen').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeCart() {
            document.getElementById('cart-screen').classList.remove('show');
            document.body.style.overflow = '';
        }

        function renderCart() {
            const content = document.getElementById('cart-content');
            const footer = document.getElementById('cart-footer');

            if (cart.length === 0) {
                content.innerHTML = `
                    <div class="cart-empty">
                        <div class="cart-empty-icon">üõí</div>
                        <div class="cart-empty-text">Korpa je prazna</div>
                    </div>
                `;
                footer.style.display = 'none';
                return;
            }

            let subtotal = 0;
            content.innerHTML = cart.map((c, idx) => {
                let itemTotal = c.item.price;
                c.selectedIngredients.forEach(ing => itemTotal += ing.price);
                itemTotal *= c.qty;
                subtotal += itemTotal;

                const extras = c.selectedIngredients.map(i => i.name).join(', ');

                return `
                    <div class="cart-item">
                        <div class="cart-item-image">
                            ${c.item.image_url 
                                ? `<img src="${c.item.image_url}" alt="${c.item.name}">`
                                : 'üçΩÔ∏è'}
                        </div>
                        <div class="cart-item-info">
                            <div class="cart-item-name">${c.item.name}</div>
                            ${extras ? `<div class="cart-item-extras">+ ${extras}</div>` : ''}
                            <div class="cart-item-bottom">
                                <div class="cart-item-price">${itemTotal.toLocaleString()} RSD</div>
                                <div class="cart-item-controls">
                                    <button class="cart-qty-btn" onclick="updateCartItem(${idx}, -1)">‚àí</button>
                                    <span class="cart-qty-value">${c.qty}</span>
                                    <button class="cart-qty-btn" onclick="updateCartItem(${idx}, 1)">+</button>
                                    <button class="cart-delete" onclick="removeCartItem(${idx})">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Checkout form
            const currentLoc = LOCATIONS[selectedLocation];
            const showDriveThrough = currentLoc?.hasDriveThrough;
            
            // If drive_through selected but location doesn't support it, reset to pickup
            if (orderType === 'drive_through' && !showDriveThrough) {
                orderType = 'pickup';
            }
            
            content.innerHTML += `
                <div class="checkout-section">
                    <div class="section-title">Lokal</div>
                    <select class="location-select" id="location-select" onchange="onLocationChange(this.value)">
                        ${Object.entries(LOCATIONS).map(([id, loc]) => `
                            <option value="${id}" ${selectedLocation === id ? 'selected' : ''}>
                                ${loc.name} - ${loc.address}
                            </option>
                        `).join('')}
                    </select>

                    <div class="section-title" style="margin-top: 20px;">Naƒçin preuzimanja</div>
                    <div class="order-types" id="order-types">
                        <div class="order-type-btn ${orderType === 'pickup' ? 'active' : ''}" onclick="setOrderType('pickup')">
                            <div class="order-type-icon">üè™</div>
                            Preuzimanje
                        </div>
                        ${showDriveThrough ? `
                            <div class="order-type-btn ${orderType === 'drive_through' ? 'active' : ''}" onclick="setOrderType('drive_through')">
                                <div class="order-type-icon">üöó</div>
                                Drive-Thru
                            </div>
                        ` : ''}
                    </div>
                    ${!showDriveThrough ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Drive-Thru dostupan samo na Banovo Brdo lokaciji</div>` : ''}

                    <div class="section-title" style="margin-top: 20px;">Tvoji podaci</div>
                    <div class="form-group">
                        <input type="text" class="form-input" placeholder="Ime i prezime" 
                               id="input-name" value="${customerName}" onchange="customerName = this.value">
                    </div>
                    <div class="form-group">
                        <input type="tel" class="form-input" placeholder="Broj telefona" 
                               id="input-phone" value="${customerPhone}" onchange="customerPhone = this.value">
                    </div>
                    <div class="form-group">
                        <textarea class="form-input" placeholder="Napomena (opciono)" rows="2" 
                                  id="input-notes" style="resize: none;"></textarea>
                    </div>
                </div>
            `;

            // Footer
            document.getElementById('summary-subtotal').textContent = subtotal.toLocaleString() + ' RSD';
            document.getElementById('summary-total').textContent = subtotal.toLocaleString() + ' RSD';
            footer.style.display = 'block';

            validateForm();
        }

        function updateCartItem(idx, delta) {
            cart[idx].qty += delta;
            if (cart[idx].qty <= 0) {
                cart.splice(idx, 1);
            }
            updateCartBadge();
            renderCart();
            renderMenu();
        }

        function removeCartItem(idx) {
            cart.splice(idx, 1);
            updateCartBadge();
            renderCart();
            renderMenu();
        }

        function setOrderType(type) {
            orderType = type;
            document.querySelectorAll('.order-type-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function onLocationChange(locId) {
            selectedLocation = locId;
            // Re-render cart to update order type options
            renderCart();
        }

        function validateForm() {
            const name = document.getElementById('input-name')?.value.trim();
            const phone = document.getElementById('input-phone')?.value.trim();
            const btn = document.getElementById('order-btn');
            
            btn.disabled = !name || !phone || cart.length === 0;
        }

        // ============================================
        // SUBMIT ORDER
        // ============================================
        async function submitOrder() {
            const name = document.getElementById('input-name').value.trim();
            const phone = document.getElementById('input-phone').value.trim();
            const notes = document.getElementById('input-notes').value.trim();

            if (!name || !phone) {
                showToast('Unesite ime i telefon', 'error');
                return;
            }

            if (cart.length === 0) {
                showToast('Korpa je prazna', 'error');
                return;
            }

            // Calculate total
            let subtotal = 0;
            const orderItems = cart.map(c => {
                let itemTotal = c.item.price;
                const ings = c.selectedIngredients.map(ing => ({
                    id: ing.id,
                    name: ing.name,
                    price: ing.price
                }));
                ings.forEach(ing => itemTotal += ing.price);
                
                const lineTotal = itemTotal * c.qty;
                subtotal += lineTotal;

                return {
                    item_id: c.item.id,
                    name: c.item.name,
                    price: c.item.price,
                    qty: c.qty,
                    ingredients: ings,
                    total: lineTotal
                };
            });

            const order = {
                status: 'new',
                order_type: orderType,
                customer_name: name,
                customer_phone: phone,
                location_id: selectedLocation,
                location_name: LOCATIONS[selectedLocation]?.name || '',
                items: orderItems,
                subtotal: subtotal,
                total: subtotal,
                notes: notes || null
            };

            try {
                const { data, error } = await db
                    .from('shop_orders')
                    .insert([order])
                    .select('order_number')
                    .single();

                if (error) throw error;

                // Show success
                document.getElementById('success-order-num').textContent = '#' + data.order_number;
                document.getElementById('success-screen').classList.add('show');
                closeCart();

                // Clear cart
                cart = [];
                updateCartBadge();
                renderMenu();

            } catch (e) {
                console.error('Order error:', e);
                showToast('Gre≈°ka pri slanju narud≈æbine', 'error');
            }
        }

        function newOrder() {
            document.getElementById('success-screen').classList.remove('show');
            customerName = '';
            customerPhone = '';
        }

        // ============================================
        // TOAST
        // ============================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        // ============================================
        // START
        // ============================================
        document.addEventListener('DOMContentLoaded', init);

        // Validate form on input
        document.addEventListener('input', (e) => {
            if (e.target.id === 'input-name' || e.target.id === 'input-phone') {
                if (e.target.id === 'input-name') customerName = e.target.value;
                if (e.target.id === 'input-phone') customerPhone = e.target.value;
                validateForm();
            }
        });
    </script>
</body>
</html>
