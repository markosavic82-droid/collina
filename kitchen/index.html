<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Collina Kitchen Display v2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Inter', sans-serif;
            background: #1D1D1B;
            color: #EAE4DA;
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* ============================================
           TOP HEADER BAR
           ============================================ */
        .header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #1D1D1B;
            gap: 8px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #8B5CF6;
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .tab-btn.secondary {
            background: #2a2a28;
            color: #888;
        }

        .tab-btn.secondary:hover {
            background: #3a3a38;
            color: #EAE4DA;
        }

        .view-toggle {
            display: flex;
            background: #2a2a28;
            border-radius: 4px;
            padding: 3px;
            gap: 3px;
            margin-left: auto;
        }

        .filter-toggle {
            display: flex;
            background: #2a2a28;
            border-radius: 4px;
            padding: 3px;
            gap: 3px;
            margin-left: 12px;
        }

        .filter-btn {
            padding: 8px 14px;
            border: none;
            background: transparent;
            color: #888;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.75rem;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover {
            background: #3a3a38;
            color: #EAE4DA;
        }

        .filter-btn.active {
            background: #10B981;
            color: white;
        }

        .filter-btn .icon {
            font-size: 1rem;
        }

        .sound-btn {
            padding: 8px 12px;
            border: none;
            background: #2a2a28;
            color: #888;
            font-size: 1.1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }

        .sound-btn:hover {
            background: #3a3a38;
        }

        .sound-btn.active {
            background: #10B981;
            color: white;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #888;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.75rem;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: #3a3a38;
            color: #EAE4DA;
        }

        .toggle-btn.active {
            background: #8B5CF6;
            color: white;
        }

        /* ============================================
           MAIN LAYOUT
           ============================================ */
        .main-container {
            display: flex;
            height: calc(100vh - 52px);
            padding: 0 12px 12px 12px;
            gap: 12px;
        }

        /* ============================================
           KANBAN COLUMNS
           ============================================ */
        .columns-container {
            flex: 1;
            display: flex;
            gap: 12px;
            min-width: 0;
        }

        .kanban-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #252523;
            border-radius: 8px;
            overflow: hidden;
            min-width: 0;
        }

        .kanban-column.hidden {
            display: none;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            color: white;
        }

        .column-header.priprema-header {
            background: linear-gradient(135deg, #808BC5 0%, #6B75A8 100%);
        }

        .column-header.pakovanje-header {
            background: linear-gradient(135deg, #9B59B6 0%, #8E44AD 100%);
        }

        .column-count {
            background: rgba(255,255,255,0.25);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .column-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 8px;
            padding: 12px;
            overflow: auto;
        }

        /* ============================================
           ORDER CARDS
           ============================================ */
        .order-card {
            width: 260px;
            background: #2a2a28;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid #3a3a38;
            transition: transform 0.15s, box-shadow 0.15s;
            user-select: none;
        }

        .order-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Card type borders */
        .order-card.burger {
            border-left: 5px solid #808BC5;
        }

        .order-card.pancake {
            border-left: 5px solid #ED773C;
        }

        .order-card.mixed {
            border-left: 5px solid;
            border-image: linear-gradient(to bottom, #808BC5 50%, #ED773C 50%) 1;
        }

        .order-card.other {
            border-left: 5px solid #888;
        }

        .order-card.urgent {
            background: #3d2a2a;
        }

        .order-card.urgent .card-wait {
            background: #C63F3E;
            color: white;
        }

        /* Pakovanje column cards - waiting for courier */
        .column-spremno .order-card {
            background: #2d2a2d;
            border-color: #5a4a5a;
        }

        .card-header {
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-time {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            color: #9ED6DF;
        }

        .card-wait {
            padding: 3px 8px;
            border-radius: 4px;
            background: #3a3a38;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: #888;
        }

        .card-body {
            padding: 6px 10px 10px;
        }

        .card-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .card-item {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .card-item.burger-item {
            background: rgba(128, 139, 197, 0.2);
        }

        .card-item.pancake-item {
            background: rgba(237, 119, 60, 0.2);
        }

        .card-item.other-item {
            background: rgba(136, 136, 136, 0.15);
        }

        .item-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .item-qty {
            font-weight: 700;
            color: #9ED6DF;
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .item-name {
            flex: 1;
            font-weight: 500;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .item-note {
            font-size: 0.8rem;
            color: #FF6B6B;
            padding: 6px 10px;
            font-weight: 600;
            background: rgba(255, 107, 107, 0.15);
            border-left: 3px solid #FF6B6B;
            border-radius: 0 4px 4px 0;
            margin-top: 4px;
        }

        /* Modifiers - very visible */
        .item-modifiers {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-top: 4px;
            padding-left: 28px;
        }

        .modifier-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(251, 191, 36, 0.2);
            border-left: 3px solid #FBBF24;
            border-radius: 0 4px 4px 0;
            font-size: 0.8rem;
            font-weight: 600;
            color: #FBBF24;
        }

        .modifier-tag::before {
            content: '+';
            font-weight: 700;
        }

        /* Order-level comment */
        .order-comment {
            padding: 8px 10px;
            background: rgba(255, 107, 107, 0.2);
            border-left: 4px solid #FF6B6B;
            margin: 6px 0 0 0;
            font-size: 0.85rem;
            font-weight: 600;
            color: #FF6B6B;
        }

        .order-comment::before {
            content: 'üìù ';
        }

        .card-footer {
            padding: 6px 10px;
            background: #252523;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .card-order-no {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: #EAE4DA;
        }

        .card-provider {
            color: #666;
            font-size: 0.75rem;
        }

        /* Action Buttons */
        .card-action {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 0;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .card-action:active {
            transform: scale(0.98);
        }

        .card-action.to-spremno {
            background: #4a9e8e;
            color: white;
        }

        .card-action.to-spremno:hover {
            background: #3d8577;
        }

        .card-action.to-predato {
            background: #8B5CF6;
            color: white;
        }

        .card-action.to-predato:hover {
            background: #7C3AED;
        }

        /* ============================================
           RIGHT SIDEBAR
           ============================================ */
        .sidebar {
            width: 200px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
        }

        .time-display {
            background: #EAE4DA;
            color: #1D1D1B;
            padding: 14px;
            border-radius: 6px;
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            text-align: center;
        }

        .location-select {
            background: #2a2a28;
            border: 2px solid #3a3a38;
            border-radius: 6px;
            padding: 10px 12px;
            color: #EAE4DA;
            font-size: 0.85rem;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            width: 100%;
        }

        .location-select:focus {
            outline: none;
            border-color: #8B5CF6;
        }

        /* Stat Cards */
        .stat-card {
            padding: 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .stat-card .icon {
            font-size: 1.4rem;
        }

        .stat-card .info {
            display: flex;
            flex-direction: column;
        }

        .stat-card .count {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            line-height: 1;
        }

        .stat-card .label {
            font-size: 0.7rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .stat-card.burgers {
            background: #808BC5;
        }

        .stat-card.pancakes {
            background: #ED773C;
        }

        .stat-card.urgent {
            background: #C63F3E;
        }

        /* Items Summary */
        .items-summary {
            background: #2a2a28;
            border-radius: 6px;
            border: 2px solid #3a3a38;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 150px;
        }

        .items-summary-header {
            background: #3a3a38;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 0.8rem;
            color: #EAE4DA;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .items-summary-list {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 0.75rem;
        }

        .summary-item.burger {
            background: rgba(128, 139, 197, 0.2);
            border-left: 3px solid #808BC5;
        }

        .summary-item.pancake {
            background: rgba(237, 119, 60, 0.2);
            border-left: 3px solid #ED773C;
        }

        .summary-item.other {
            background: rgba(136, 136, 136, 0.15);
            border-left: 3px solid #666;
        }

        .summary-qty {
            font-weight: 700;
            color: #9ED6DF;
            min-width: 24px;
        }

        .summary-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Predato Button */
        .predato-btn {
            padding: 12px;
            border: 2px solid #3a3a38;
            background: #2a2a28;
            color: #EAE4DA;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .predato-btn:hover {
            background: #3a3a38;
        }

        .predato-btn .badge {
            background: #8B5CF6;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* ============================================
           PREDATO SIDE PANEL
           ============================================ */
        .predato-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #252523;
            border-left: 2px solid #3a3a38;
            transition: right 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .predato-panel.open {
            right: 0;
        }

        .predato-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .predato-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .predato-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .predato-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .predato-card {
            background: #2a2a28;
            border-radius: 6px;
            padding: 10px 12px;
            border-left: 4px solid #8B5CF6;
        }

        .predato-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .predato-card-time {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: #9ED6DF;
        }

        .predato-card-no {
            color: #888;
            font-size: 0.8rem;
        }

        .predato-card-items {
            font-size: 0.8rem;
            color: #aaa;
        }

        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 99;
        }

        .panel-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* ============================================
           EMPTY STATE
           ============================================ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #555;
            font-size: 0.9rem;
            gap: 8px;
            text-align: center;
            padding: 30px;
            width: 100%;
        }

        .empty-state .icon {
            font-size: 2.5rem;
            opacity: 0.5;
        }

        .items-summary .empty-state {
            padding: 20px 10px;
            font-size: 0.75rem;
        }

        .items-summary .empty-state .icon {
            font-size: 1.5rem;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 1100px) {
            .sidebar {
                width: 180px;
            }

            .order-card {
                width: 230px;
            }

            .time-display {
                font-size: 1.6rem;
            }
        }

        @media (max-width: 800px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                order: -1;
            }

            .time-display {
                flex: 0;
            }

            .stat-card {
                flex: 1;
                min-width: 100px;
            }

            .items-summary {
                display: none;
            }

            .columns-container {
                flex: 1;
                overflow-y: auto;
            }

            .kanban-column {
                flex-wrap: nowrap;
                flex-direction: column;
            }

            .order-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <button class="tab-btn">üü¢ Kitchen Monitor</button>
        <button class="tab-btn secondary" id="predatoToggle">üìã Predato <span id="predatoCountHeader">0</span></button>
        
        <div class="view-toggle">
            <button class="toggle-btn active" data-view="oba">OBA</button>
            <button class="toggle-btn" data-view="priprema">KUHINJA</button>
            <button class="toggle-btn" data-view="pakovanje">FRONT DESK</button>
        </div>

        <div class="filter-toggle">
            <button class="filter-btn active" id="filterHrana" onclick="toggleFilter('hrana')">
                <span class="icon">üçî</span> HRANA
            </button>
            <button class="filter-btn active" id="filterPice" onclick="toggleFilter('pice')">
                <span class="icon">ü•§</span> PIƒÜE
            </button>
        </div>

        <button class="sound-btn active" id="soundToggle" onclick="toggleSound()" title="Zvuƒçna notifikacija">
            üîî
        </button>
    </header>

    <!-- Main Layout -->
    <div class="main-container">
        <!-- Kanban Columns -->
        <div class="columns-container">
            <!-- U Pripremi Column -->
            <div class="kanban-column column-priprema" id="columnPriprema">
                <div class="column-header priprema-header">
                    <span>üî• KUHINJA</span>
                    <span class="column-count" id="pripremaCount">0</span>
                </div>
                <div class="column-content" id="pripremaContent">
                    <!-- Cards will be rendered here -->
                </div>
            </div>

            <!-- Pakovanje Column (was Spremno) -->
            <div class="kanban-column column-spremno" id="columnSpremno">
                <div class="column-header pakovanje-header">
                    <span>üì¶ FRONT DESK</span>
                    <span class="column-count" id="pakovanjeCount">0</span>
                </div>
                <div class="column-content" id="pakovanjeContent">
                    <!-- Cards will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar">
            <div class="time-display" id="currentTime">00:00</div>
            
            <select class="location-select" id="locationSelect">
                <option value="">Sve lokacije</option>
            </select>

            <div class="stat-card burgers">
                <div class="icon">üçî</div>
                <div class="info">
                    <div class="count" id="burgerCount">0</div>
                    <div class="label">Burgera</div>
                </div>
            </div>

            <div class="stat-card pancakes">
                <div class="icon">ü•û</div>
                <div class="info">
                    <div class="count" id="pancakeCount">0</div>
                    <div class="label">Palaƒçinki</div>
                </div>
            </div>

            <div class="stat-card urgent">
                <div class="icon">‚ö†Ô∏è</div>
                <div class="info">
                    <div class="count" id="urgentCount">0</div>
                    <div class="label">Preko 20'</div>
                </div>
            </div>

            <div class="items-summary">
                <div class="items-summary-header">üìã Za pripremu</div>
                <div class="items-summary-list" id="itemsSummaryList">
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <div>Nema stavki</div>
                    </div>
                </div>
            </div>

            <button class="predato-btn" id="predatoBtnSidebar">
                üì¶ Predato danas
                <span class="badge" id="predatoCount">0</span>
            </button>
        </div>
    </div>

    <!-- Predato Side Panel -->
    <div class="panel-overlay" id="panelOverlay"></div>
    <aside class="predato-panel" id="predatoPanel">
        <div class="predato-header">
            <span>üì¶ Predato danas</span>
            <button class="predato-close" id="predatoClose">‚úï</button>
        </div>
        <div class="predato-content" id="predatoContent">
            <div class="empty-state">
                <div class="icon">üì¶</div>
                <div>Nema predatih porud≈æbina</div>
            </div>
        </div>
    </aside>

    <script>
        // ============================================
        // SUPABASE CONFIG
        // ============================================
        const SUPABASE_URL = 'https://bbnbbbpofelbkyuffslj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibmJiYnBvZmVsYmt5dWZmc2xqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTI0MzQsImV4cCI6MjA4MDYyODQzNH0.koW44soAB-bEfh8OzqjGBwdgov4Snscw1ITsg5OureU';

        async function supabaseFetch(endpoint) {
            const res = await fetch(endpoint, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }

        // ============================================
        // STATE
        // ============================================
        let allOrders = [];
        let locations = {};
        let selectedLocation = '';
        let currentView = 'oba';
        
        // Filter state
        let showHrana = true;
        let showPice = true;
        
        // Sound state
        let soundEnabled = true;
        let lastOrderIds = new Set();

        // ============================================
        // CLASSIFICATION
        // ============================================
        const BURGER_KEYWORDS = ['burger', 'smash', 'collina', 'chicken', 'wrap', 'big', 'double', 'baconator', 'vege', 'original', 'triple', 'nuggets', 'caesar'];
        const PANCAKE_KEYWORDS = ['palaƒçink', 'palacink', 'nutella', 'eurokrem', 'plazma', 'krem', 'ameriƒçka', 'americka'];
        
        // Drinks classification
        const DRINK_KEYWORDS = [
            'kafa', 'kafe', 'coffee', 'espreso', 'espresso', 'cappuccino', 'kapuƒáino', 'kapucino',
            'latte', 'macchiato', 'makijato', 'americano', 'nes', 'nescafe',
            'ƒçaj', 'caj', 'tea',
            'sok', 'juice', 'ceƒëeni', 'cedjeni', 'fresh', 'smoothie',
            'voda', 'water', 'aqua', 'rosa', 'mineralna', 'gazirana', 'negazirana',
            'cola', 'kola', 'fanta', 'sprite', 'schweppes', 'tonic', 'bitter',
            'pivo', 'beer', 'lager', 'ale',
            'vino', 'wine',
            'rakija', 'viski', 'whisky', 'whiskey', 'vodka', 'd≈æin', 'gin', 'rum', 'tequila',
            'koktel', 'cocktail', 'mojito', 'margarita', 'aperol', 'spritz',
            'milkshake', 'milk shake', 'shake',
            'limonada', 'lemonade', 'ice tea', 'ledeni ƒçaj',
            'red bull', 'energy', 'energetski'
        ];

        function classifyItemType(itemName) {
            const name = (itemName || '').toLowerCase();
            for (const kw of DRINK_KEYWORDS) {
                if (name.includes(kw)) return 'pice';
            }
            return 'hrana';
        }

        function classifyOrderType(items) {
            let hasHrana = false, hasPice = false;
            for (const item of items) {
                const type = classifyItemType(item.name);
                if (type === 'hrana') hasHrana = true;
                if (type === 'pice') hasPice = true;
            }
            return { hasHrana, hasPice };
        }

        function classifyItem(itemName) {
            const name = (itemName || '').toLowerCase();
            for (const kw of BURGER_KEYWORDS) {
                if (name.includes(kw)) return 'burger';
            }
            for (const kw of PANCAKE_KEYWORDS) {
                if (name.includes(kw)) return 'pancake';
            }
            return 'other';
        }

        function classifyOrder(items) {
            let hasBurger = false, hasPancake = false;
            for (const item of items) {
                const type = classifyItem(item.name);
                if (type === 'burger') hasBurger = true;
                if (type === 'pancake') hasPancake = true;
            }
            if (hasBurger && hasPancake) return 'mixed';
            if (hasBurger) return 'burger';
            if (hasPancake) return 'pancake';
            return 'other';
        }

        function getWaitMinutes(createdAt) {
            return Math.floor((new Date() - new Date(createdAt)) / 60000);
        }

        // ============================================
        // TIME DISPLAY
        // ============================================
        function updateTime() {
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ============================================
        // LOAD LOCATIONS
        // ============================================
        async function loadLocations() {
            try {
                const url = `${SUPABASE_URL}/rest/v1/emeni_locations?select=company_id,location_name&order=location_name`;
                const data = await supabaseFetch(url);
                
                const select = document.getElementById('locationSelect');
                data.forEach(loc => {
                    locations[loc.company_id] = loc.location_name;
                    const option = document.createElement('option');
                    option.value = loc.company_id;
                    option.textContent = loc.location_name;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading locations:', err);
            }
        }

        // ============================================
        // LOAD MODIFIERS MAP (wolt_products_map)
        // ============================================
        let modifiersMap = {}; // wolt_reference_id -> {name, price, isModifier}
        
        async function loadModifiersMap() {
            try {
                const url = `${SUPABASE_URL}/rest/v1/wolt_products_map?select=wolt_reference_id,name,price,is_modifier`;
                const data = await supabaseFetch(url);
                
                if (data && Array.isArray(data)) {
                    data.forEach(item => {
                        modifiersMap[item.wolt_reference_id] = {
                            name: item.name,
                            price: item.price,
                            isModifier: item.is_modifier
                        };
                    });
                    console.log(`‚úÖ Loaded ${data.length} items from wolt_products_map`);
                }
            } catch (err) {
                console.error('Error loading modifiers map:', err);
            }
        }

        // ============================================
        // LOAD ORDERS
        // ============================================
        async function loadOrders() {
            try {
                const twoHoursAgo = new Date();
                twoHoursAgo.setHours(twoHoursAgo.getHours() - 2);

                // Load orders with KDS columns - include those in production OR with kds_ready but not handed
                const url = `${SUPABASE_URL}/rest/v1/emeni_orders?select=*&created_at=gte.${encodeURIComponent(twoHoursAgo.toISOString())}&or=(status.in.(3,4,5),and(kds_ready_at.not.is.null,kds_handed_at.is.null))&order=created_at.asc`;
                
                const data = await supabaseFetch(url);
                if (data && Array.isArray(data)) {
                    // Check for new orders (for sound notification)
                    const ordersInPriprema = data.filter(o => !o.kds_ready_at);
                    checkForNewOrders(ordersInPriprema);
                    
                    allOrders = data;
                    renderAll();
                }
            } catch (err) {
                console.error('Error loading orders:', err);
            }
        }

        // Load handed orders for today (Predato panel)
        let predatoOrders = [];
        
        async function loadPredatoOrders() {
            try {
                // Get today's start
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Get orders with kds_handed_at today
                const url = `${SUPABASE_URL}/rest/v1/emeni_orders?select=*&kds_handed_at=gte.${encodeURIComponent(today.toISOString())}&order=kds_handed_at.desc`;
                
                const data = await supabaseFetch(url);
                if (data && Array.isArray(data)) {
                    predatoOrders = data;
                }
            } catch (err) {
                console.error('Error loading predato orders:', err);
            }
        }

        // ============================================
        // RENDER ORDER CARD
        // ============================================
        function renderOrderCard(order, columnType) {
            let items = order.raw_payload?.items || [];
            if (items.length === 0 && order.raw_payload?.invalidOrderDetails?.items) {
                items = order.raw_payload.invalidOrderDetails.items;
            }

            const orderType = classifyOrder(items);
            const waitMinutes = getWaitMinutes(order.created_at);
            const isUrgent = waitMinutes >= 20;
            const time = new Date(order.created_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });

            const itemsHtml = items.map(item => {
                const itemType = classifyItem(item.name || '');
                const icon = itemType === 'burger' ? 'üçî' : itemType === 'pancake' ? 'ü•û' : 'üçΩÔ∏è';
                
                // Get modifiers
                let modifiersHtml = '';
                if (item.modifiers && item.modifiers.length > 0) {
                    const modTags = item.modifiers.map(m => {
                        // Try to get modifier name from multiple sources
                        let modName = null;
                        
                        // 1. Direct name from payload
                        if (m.name && m.name.trim()) {
                            modName = m.name;
                        }
                        // 2. Lookup in wolt_products_map by referenceID
                        else {
                            const refId = m.productReferenceID || m.referenceID || m.product_reference_id;
                            if (refId && modifiersMap[refId]) {
                                modName = modifiersMap[refId].name;
                            }
                        }
                        // 3. Fallback - show price if available
                        if (!modName && m.price) {
                            modName = `${m.price} RSD`;
                        }
                        
                        return modName;
                    }).filter(Boolean);
                    
                    if (modTags.length > 0) {
                        modifiersHtml = `
                            <div class="item-modifiers">
                                ${modTags.map(name => `<span class="modifier-tag">${name}</span>`).join('')}
                            </div>
                        `;
                    }
                }
                
                // Item-level note/comment
                let itemNoteHtml = '';
                if (item.note && item.note.trim()) {
                    itemNoteHtml = `<div class="item-note">${item.note}</div>`;
                }
                if (item.comment && item.comment.trim()) {
                    itemNoteHtml = `<div class="item-note">${item.comment}</div>`;
                }
                
                return `
                    <div class="card-item ${itemType}-item">
                        <span class="item-icon">${icon}</span>
                        <span class="item-qty">${item.quantity}√ó</span>
                        <span class="item-name" title="${item.name || 'Item'}">${item.name || 'Item'}</span>
                    </div>
                    ${modifiersHtml}
                    ${itemNoteHtml}
                `;
            }).join('');

            // Order-level note/comment
            let orderCommentHtml = '';
            const orderNote = order.raw_payload?.note || order.raw_payload?.comment || order.raw_payload?.specialRequests;
            if (orderNote && orderNote.trim()) {
                orderCommentHtml = `<div class="order-comment">${orderNote}</div>`;
            }

            // Action button based on column
            const actionBtn = columnType === 'priprema' 
                ? `<button class="card-action to-spremno" onclick="event.stopPropagation(); moveToSpremno('${order.order_id}')">‚úÖ SPREMNO</button>`
                : `<button class="card-action to-predato" onclick="event.stopPropagation(); moveToPredato('${order.order_id}')">üö¥ PREDATO</button>`;

            return `
                <div class="order-card ${orderType} ${isUrgent ? 'urgent' : ''}" data-order-id="${order.order_id}">
                    <div class="card-header">
                        <span class="card-time">${time}</span>
                        <span class="card-wait">${waitMinutes}'</span>
                    </div>
                    <div class="card-body">
                        <div class="card-items">
                            ${itemsHtml || '<div class="card-item other-item"><span class="item-name">Bez stavki</span></div>'}
                        </div>
                        ${orderCommentHtml}
                    </div>
                    <div class="card-footer">
                        <span class="card-order-no">#${order.order_no}</span>
                        <span class="card-provider">${order.provider || ''}</span>
                    </div>
                    ${actionBtn}
                </div>
            `;
        }

        // ============================================
        // RENDER PREDATO CARD
        // ============================================
        function renderPredatoCard(order) {
            let items = order.raw_payload?.items || [];
            const orderTime = new Date(order.created_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
            const handedTime = order.kds_handed_at 
                ? new Date(order.kds_handed_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' })
                : '-';
            const itemsSummary = items.map(i => `${i.quantity}√ó ${i.name}`).join(', ') || 'Bez stavki';

            return `
                <div class="predato-card">
                    <div class="predato-card-header">
                        <span class="predato-card-time">${orderTime} ‚Üí üö¥ ${handedTime}</span>
                        <span class="predato-card-no">#${order.order_no}</span>
                    </div>
                    <div class="predato-card-items">${itemsSummary}</div>
                </div>
            `;
        }

        // ============================================
        // RENDER ITEMS SUMMARY
        // ============================================
        function renderItemsSummary(orders) {
            const itemsMap = {};

            orders.forEach(order => {
                const items = order.raw_payload?.items || [];
                items.forEach(item => {
                    const name = item.name || 'Unknown';
                    const type = classifyItem(name);
                    const qty = parseFloat(item.quantity) || 1;
                    
                    if (!itemsMap[name]) {
                        itemsMap[name] = { name, qty: 0, type };
                    }
                    itemsMap[name].qty += qty;
                });
            });

            const list = document.getElementById('itemsSummaryList');
            const itemsArray = Object.values(itemsMap).sort((a, b) => b.qty - a.qty);

            if (itemsArray.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <div>Nema stavki</div>
                    </div>
                `;
                return;
            }

            list.innerHTML = itemsArray.map(item => `
                <div class="summary-item ${item.type}">
                    <span class="summary-qty">${item.qty}√ó</span>
                    <span class="summary-name" title="${item.name}">${item.name}</span>
                </div>
            `).join('');
        }

        // ============================================
        // RENDER ALL
        // ============================================
        function renderAll() {
            let filteredOrders = allOrders;
            
            if (selectedLocation) {
                filteredOrders = filteredOrders.filter(o => o.company_id == selectedLocation);
            }

            // Filter paid eBar/Gloriafood
            filteredOrders = filteredOrders.filter(o => {
                const provider = (o.provider || '').toLowerCase();
                const isPaid = o.is_paid === true || o.is_paid === 'true';
                if ((provider === 'ebar' || provider === 'gloriafood') && isPaid) return false;
                return true;
            });

            // Filter by HRANA / PIƒÜE
            if (!showHrana || !showPice) {
                filteredOrders = filteredOrders.filter(o => {
                    const items = o.raw_payload?.items || [];
                    const { hasHrana, hasPice } = classifyOrderType(items);
                    
                    // Show order if it matches any active filter
                    if (showHrana && hasHrana) return true;
                    if (showPice && hasPice) return true;
                    
                    // If order has only drinks and we show drinks
                    if (showPice && !hasHrana && hasPice) return true;
                    // If order has only food and we show food
                    if (showHrana && hasHrana && !hasPice) return true;
                    
                    return false;
                });
            }

            // Column logic based on KDS timestamps:
            // KUHINJA: kds_ready_at IS NULL (not marked ready yet)
            // FRONT DESK: kds_ready_at IS NOT NULL AND kds_handed_at IS NULL
            // PREDATO: kds_handed_at IS NOT NULL (loaded separately)
            
            const pripremaOrders = filteredOrders.filter(o => !o.kds_ready_at);
            const pakovanjeOrders = filteredOrders.filter(o => o.kds_ready_at && !o.kds_handed_at);

            // Render columns
            const pripremaEl = document.getElementById('pripremaContent');
            const pakovanjeEl = document.getElementById('pakovanjeContent');

            pripremaEl.innerHTML = pripremaOrders.length 
                ? pripremaOrders.map(o => renderOrderCard(o, 'priprema')).join('')
                : '<div class="empty-state"><div class="icon">‚úÖ</div><div>Sve spremljeno!</div></div>';

            pakovanjeEl.innerHTML = pakovanjeOrders.length
                ? pakovanjeOrders.map(o => renderOrderCard(o, 'pakovanje')).join('')
                : '<div class="empty-state"><div class="icon">‚è≥</div><div>ƒåeka se iz kuhinje</div></div>';

            // Update column counts
            document.getElementById('pripremaCount').textContent = pripremaOrders.length;
            document.getElementById('pakovanjeCount').textContent = pakovanjeOrders.length;

            // Render predato from database (kds_handed_at today)
            const predatoContent = document.getElementById('predatoContent');
            
            // Filter predato by location if selected
            let filteredPredato = predatoOrders;
            if (selectedLocation) {
                filteredPredato = predatoOrders.filter(o => o.company_id == selectedLocation);
            }
            
            predatoContent.innerHTML = filteredPredato.length
                ? filteredPredato.map(o => renderPredatoCard(o)).join('')
                : '<div class="empty-state"><div class="icon">üì¶</div><div>Nema predatih porud≈æbina danas</div></div>';

            // Update counts
            document.getElementById('predatoCount').textContent = filteredPredato.length;
            document.getElementById('predatoCountHeader').textContent = filteredPredato.length;

            // Update stats (priprema + pakovanje)
            updateStats([...pripremaOrders, ...pakovanjeOrders]);

            // Render items summary (only priprema - what needs to be cooked)
            renderItemsSummary(pripremaOrders);
        }

        // ============================================
        // UPDATE STATS
        // ============================================
        function updateStats(orders) {
            let burgerCount = 0, pancakeCount = 0, urgentCount = 0;

            orders.forEach(order => {
                const items = order.raw_payload?.items || [];
                const waitMinutes = getWaitMinutes(order.created_at);
                if (waitMinutes >= 20) urgentCount++;

                items.forEach(item => {
                    const type = classifyItem(item.name || '');
                    const qty = parseFloat(item.quantity) || 1;
                    if (type === 'burger') burgerCount += qty;
                    if (type === 'pancake') pancakeCount += qty;
                });
            });

            document.getElementById('burgerCount').textContent = burgerCount;
            document.getElementById('pancakeCount').textContent = pancakeCount;
            document.getElementById('urgentCount').textContent = urgentCount;
        }

        // ============================================
        // ACTIONS
        // ============================================
        
        // Update KDS timestamp on emeni_orders
        async function updateKdsTimestamp(orderId, column) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/emeni_orders?order_id=eq.${orderId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        [column]: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    console.error('KDS update failed:', error);
                    return false;
                }
                
                console.log(`‚úÖ KDS: order ${orderId} ‚Üí ${column} = NOW()`);
                return true;
            } catch (err) {
                console.error('KDS update error:', err);
                return false;
            }
        }

        async function moveToSpremno(orderId) {
            // Write kds_ready_at timestamp
            const success = await updateKdsTimestamp(orderId, 'kds_ready_at');
            
            if (success) {
                // Reload orders to get updated data
                await loadOrders();
            } else {
                alert('Gre≈°ka pri upisu! Poku≈°ajte ponovo.');
            }
        }

        async function moveToPredato(orderId) {
            // Write kds_handed_at timestamp
            const success = await updateKdsTimestamp(orderId, 'kds_handed_at');
            
            if (success) {
                // Reload orders to get updated data
                await loadOrders();
                await loadPredatoOrders();
            } else {
                alert('Gre≈°ka pri upisu! Poku≈°ajte ponovo.');
            }
        }

        // ============================================
        // VIEW TOGGLE
        // ============================================
        function setView(view) {
            currentView = view;
            
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            const priprema = document.getElementById('columnPriprema');
            const pakovanje = document.getElementById('columnSpremno');

            priprema.classList.remove('hidden');
            pakovanje.classList.remove('hidden');

            if (view === 'priprema') {
                pakovanje.classList.add('hidden');
            } else if (view === 'pakovanje') {
                priprema.classList.add('hidden');
            }
        }

        // ============================================
        // FILTER TOGGLE (HRANA / PIƒÜE)
        // ============================================
        function toggleFilter(type) {
            if (type === 'hrana') {
                showHrana = !showHrana;
                document.getElementById('filterHrana').classList.toggle('active', showHrana);
            } else if (type === 'pice') {
                showPice = !showPice;
                document.getElementById('filterPice').classList.toggle('active', showPice);
            }
            renderAll();
        }

        // ============================================
        // SOUND NOTIFICATION
        // ============================================
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
            document.getElementById('soundToggle').textContent = soundEnabled ? 'üîî' : 'üîï';
        }

        // Create audio context for notification sound
        let audioContext = null;
        
        function playNotificationSound() {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Play two short beeps
                const playBeep = (startTime, frequency) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.15);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.15);
                };
                
                const now = audioContext.currentTime;
                playBeep(now, 880);        // First beep (A5)
                playBeep(now + 0.2, 1100);  // Second beep (higher)
                
                console.log('üîî New order notification sound');
            } catch (err) {
                console.error('Sound error:', err);
            }
        }

        function checkForNewOrders(orders) {
            const currentIds = new Set(orders.map(o => o.order_id));
            
            // Find new orders (in current but not in last)
            let newOrderCount = 0;
            for (const id of currentIds) {
                if (!lastOrderIds.has(id)) {
                    newOrderCount++;
                }
            }
            
            // Play sound if new orders appeared (and not first load)
            if (newOrderCount > 0 && lastOrderIds.size > 0) {
                playNotificationSound();
            }
            
            // Update last known IDs
            lastOrderIds = currentIds;
        }

        // ============================================
        // PREDATO PANEL
        // ============================================
        function togglePredatoPanel(open) {
            document.getElementById('predatoPanel').classList.toggle('open', open);
            document.getElementById('panelOverlay').classList.toggle('visible', open);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('locationSelect').addEventListener('change', (e) => {
            selectedLocation = e.target.value;
            renderAll();
        });

        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => setView(btn.dataset.view));
        });

        document.getElementById('predatoToggle').addEventListener('click', () => togglePredatoPanel(true));
        document.getElementById('predatoBtnSidebar').addEventListener('click', () => togglePredatoPanel(true));
        document.getElementById('predatoClose').addEventListener('click', () => togglePredatoPanel(false));
        document.getElementById('panelOverlay').addEventListener('click', () => togglePredatoPanel(false));

        // ============================================
        // POLLING
        // ============================================
        setInterval(async () => {
            await loadOrders();
            await loadPredatoOrders();
            renderAll();
        }, 5000);

        // ============================================
        // INIT
        // ============================================
        async function init() {
            await loadLocations();
            await loadModifiersMap();
            await loadPredatoOrders();
            await loadOrders();
        }

        init();
    </script>
</body>
</html>
