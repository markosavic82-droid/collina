<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Collina Kitchen Display v2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Inter', sans-serif;
            background: #1D1D1B;
            color: #EAE4DA;
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* ============================================
           TOP HEADER BAR
           ============================================ */
        .header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #1D1D1B;
            gap: 8px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #8B5CF6;
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .tab-btn.secondary {
            background: #2a2a28;
            color: #888;
        }

        .tab-btn.secondary:hover {
            background: #3a3a38;
            color: #EAE4DA;
        }

        .view-toggle {
            display: flex;
            background: #2a2a28;
            border-radius: 4px;
            padding: 3px;
            gap: 3px;
            margin-left: auto;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #888;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.75rem;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: #3a3a38;
            color: #EAE4DA;
        }

        .toggle-btn.active {
            background: #8B5CF6;
            color: white;
        }

        /* ============================================
           MAIN LAYOUT
           ============================================ */
        .main-container {
            display: flex;
            height: calc(100vh - 52px);
            padding: 0 12px 12px 12px;
            gap: 12px;
        }

        /* ============================================
           KANBAN COLUMNS
           ============================================ */
        .columns-container {
            flex: 1;
            display: flex;
            gap: 12px;
            min-width: 0;
        }

        .kanban-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 8px;
            overflow: hidden;
            min-width: 0;
        }

        .kanban-column.hidden {
            display: none;
        }

        /* ============================================
           ORDER CARDS
           ============================================ */
        .order-card {
            width: 260px;
            background: #2a2a28;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid #3a3a38;
            transition: transform 0.15s, box-shadow 0.15s;
            user-select: none;
        }

        .order-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Card type borders */
        .order-card.burger {
            border-left: 5px solid #808BC5;
        }

        .order-card.pancake {
            border-left: 5px solid #ED773C;
        }

        .order-card.mixed {
            border-left: 5px solid;
            border-image: linear-gradient(to bottom, #808BC5 50%, #ED773C 50%) 1;
        }

        .order-card.other {
            border-left: 5px solid #888;
        }

        .order-card.urgent {
            background: #3d2a2a;
        }

        .order-card.urgent .card-wait {
            background: #C63F3E;
            color: white;
        }

        /* Spremno column cards - different background */
        .column-spremno .order-card {
            background: #2d2d2a;
            border-color: #4a4a45;
        }

        .card-header {
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-time {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            color: #9ED6DF;
        }

        .card-wait {
            padding: 3px 8px;
            border-radius: 4px;
            background: #3a3a38;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: #888;
        }

        .card-body {
            padding: 6px 10px 10px;
        }

        .card-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .card-item {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .card-item.burger-item {
            background: rgba(128, 139, 197, 0.2);
        }

        .card-item.pancake-item {
            background: rgba(237, 119, 60, 0.2);
        }

        .card-item.other-item {
            background: rgba(136, 136, 136, 0.15);
        }

        .item-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .item-qty {
            font-weight: 700;
            color: #9ED6DF;
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .item-name {
            flex: 1;
            font-weight: 500;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .item-note {
            font-size: 0.8rem;
            color: #FF6B6B;
            padding: 6px 10px;
            font-weight: 600;
            background: rgba(255, 107, 107, 0.15);
            border-left: 3px solid #FF6B6B;
            border-radius: 0 4px 4px 0;
            margin-top: 4px;
        }

        /* Modifiers - very visible */
        .item-modifiers {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-top: 4px;
            padding-left: 28px;
        }

        .modifier-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(251, 191, 36, 0.2);
            border-left: 3px solid #FBBF24;
            border-radius: 0 4px 4px 0;
            font-size: 0.8rem;
            font-weight: 600;
            color: #FBBF24;
        }

        .modifier-tag::before {
            content: '+';
            font-weight: 700;
        }

        /* Order-level comment */
        .order-comment {
            padding: 8px 10px;
            background: rgba(255, 107, 107, 0.2);
            border-left: 4px solid #FF6B6B;
            margin: 6px 0 0 0;
            font-size: 0.85rem;
            font-weight: 600;
            color: #FF6B6B;
        }

        .order-comment::before {
            content: 'üìù ';
        }

        .card-footer {
            padding: 6px 10px;
            background: #252523;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .card-order-no {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: #EAE4DA;
        }

        .card-provider {
            color: #666;
            font-size: 0.75rem;
        }

        /* Action Buttons */
        .card-action {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 0;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .card-action:active {
            transform: scale(0.98);
        }

        .card-action.to-spremno {
            background: #4a9e8e;
            color: white;
        }

        .card-action.to-spremno:hover {
            background: #3d8577;
        }

        .card-action.to-predato {
            background: #8B5CF6;
            color: white;
        }

        .card-action.to-predato:hover {
            background: #7C3AED;
        }

        /* ============================================
           RIGHT SIDEBAR
           ============================================ */
        .sidebar {
            width: 200px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
        }

        .time-display {
            background: #EAE4DA;
            color: #1D1D1B;
            padding: 14px;
            border-radius: 6px;
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            text-align: center;
        }

        .location-select {
            background: #2a2a28;
            border: 2px solid #3a3a38;
            border-radius: 6px;
            padding: 10px 12px;
            color: #EAE4DA;
            font-size: 0.85rem;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            width: 100%;
        }

        .location-select:focus {
            outline: none;
            border-color: #8B5CF6;
        }

        /* Stat Cards */
        .stat-card {
            padding: 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .stat-card .icon {
            font-size: 1.4rem;
        }

        .stat-card .info {
            display: flex;
            flex-direction: column;
        }

        .stat-card .count {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            line-height: 1;
        }

        .stat-card .label {
            font-size: 0.7rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .stat-card.burgers {
            background: #808BC5;
        }

        .stat-card.pancakes {
            background: #ED773C;
        }

        .stat-card.urgent {
            background: #C63F3E;
        }

        /* Items Summary */
        .items-summary {
            background: #2a2a28;
            border-radius: 6px;
            border: 2px solid #3a3a38;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 150px;
        }

        .items-summary-header {
            background: #3a3a38;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 0.8rem;
            color: #EAE4DA;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .items-summary-list {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 0.75rem;
        }

        .summary-item.burger {
            background: rgba(128, 139, 197, 0.2);
            border-left: 3px solid #808BC5;
        }

        .summary-item.pancake {
            background: rgba(237, 119, 60, 0.2);
            border-left: 3px solid #ED773C;
        }

        .summary-item.other {
            background: rgba(136, 136, 136, 0.15);
            border-left: 3px solid #666;
        }

        .summary-qty {
            font-weight: 700;
            color: #9ED6DF;
            min-width: 24px;
        }

        .summary-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Predato Button */
        .predato-btn {
            padding: 12px;
            border: 2px solid #3a3a38;
            background: #2a2a28;
            color: #EAE4DA;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .predato-btn:hover {
            background: #3a3a38;
        }

        .predato-btn .badge {
            background: #8B5CF6;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* ============================================
           PREDATO SIDE PANEL
           ============================================ */
        .predato-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #252523;
            border-left: 2px solid #3a3a38;
            transition: right 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .predato-panel.open {
            right: 0;
        }

        .predato-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .predato-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .predato-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .predato-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .predato-card {
            background: #2a2a28;
            border-radius: 6px;
            padding: 10px 12px;
            border-left: 4px solid #8B5CF6;
        }

        .predato-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .predato-card-time {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: #9ED6DF;
        }

        .predato-card-no {
            color: #888;
            font-size: 0.8rem;
        }

        .predato-card-items {
            font-size: 0.8rem;
            color: #aaa;
        }

        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 99;
        }

        .panel-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* ============================================
           EMPTY STATE
           ============================================ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #555;
            font-size: 0.9rem;
            gap: 8px;
            text-align: center;
            padding: 30px;
            width: 100%;
        }

        .empty-state .icon {
            font-size: 2.5rem;
            opacity: 0.5;
        }

        .items-summary .empty-state {
            padding: 20px 10px;
            font-size: 0.75rem;
        }

        .items-summary .empty-state .icon {
            font-size: 1.5rem;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 1100px) {
            .sidebar {
                width: 180px;
            }

            .order-card {
                width: 230px;
            }

            .time-display {
                font-size: 1.6rem;
            }
        }

        @media (max-width: 800px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                order: -1;
            }

            .time-display {
                flex: 0;
            }

            .stat-card {
                flex: 1;
                min-width: 100px;
            }

            .items-summary {
                display: none;
            }

            .columns-container {
                flex: 1;
                overflow-y: auto;
            }

            .kanban-column {
                flex-wrap: nowrap;
                flex-direction: column;
            }

            .order-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <button class="tab-btn">üü¢ Kitchen Monitor</button>
        <button class="tab-btn secondary" id="predatoToggle">üìã Predato <span id="predatoCountHeader">0</span></button>
        
        <div class="view-toggle">
            <button class="toggle-btn active" data-view="oba">OBA</button>
            <button class="toggle-btn" data-view="priprema">PRIPREMA</button>
            <button class="toggle-btn" data-view="spremno">SPREMNO</button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-container">
        <!-- Kanban Columns -->
        <div class="columns-container">
            <!-- U Pripremi Column -->
            <div class="kanban-column column-priprema" id="columnPriprema">
                <!-- Cards will be rendered here -->
            </div>

            <!-- Spremno Column -->
            <div class="kanban-column column-spremno" id="columnSpremno">
                <!-- Cards will be rendered here -->
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar">
            <div class="time-display" id="currentTime">00:00</div>
            
            <select class="location-select" id="locationSelect">
                <option value="">Sve lokacije</option>
            </select>

            <div class="stat-card burgers">
                <div class="icon">üçî</div>
                <div class="info">
                    <div class="count" id="burgerCount">0</div>
                    <div class="label">Burgera</div>
                </div>
            </div>

            <div class="stat-card pancakes">
                <div class="icon">ü•û</div>
                <div class="info">
                    <div class="count" id="pancakeCount">0</div>
                    <div class="label">Palaƒçinki</div>
                </div>
            </div>

            <div class="stat-card urgent">
                <div class="icon">‚ö†Ô∏è</div>
                <div class="info">
                    <div class="count" id="urgentCount">0</div>
                    <div class="label">Preko 20'</div>
                </div>
            </div>

            <div class="items-summary">
                <div class="items-summary-header">üìã Za pripremu</div>
                <div class="items-summary-list" id="itemsSummaryList">
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <div>Nema stavki</div>
                    </div>
                </div>
            </div>

            <button class="predato-btn" id="predatoBtnSidebar">
                üì¶ Predato danas
                <span class="badge" id="predatoCount">0</span>
            </button>
        </div>
    </div>

    <!-- Predato Side Panel -->
    <div class="panel-overlay" id="panelOverlay"></div>
    <aside class="predato-panel" id="predatoPanel">
        <div class="predato-header">
            <span>üì¶ Predato danas</span>
            <button class="predato-close" id="predatoClose">‚úï</button>
        </div>
        <div class="predato-content" id="predatoContent">
            <div class="empty-state">
                <div class="icon">üì¶</div>
                <div>Nema predatih porud≈æbina</div>
            </div>
        </div>
    </aside>

    <script>
        // ============================================
        // SUPABASE CONFIG
        // ============================================
        const SUPABASE_URL = 'https://bbnbbbpofelbkyuffslj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibmJiYnBvZmVsYmt5dWZmc2xqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTI0MzQsImV4cCI6MjA4MDYyODQzNH0.koW44soAB-bEfh8OzqjGBwdgov4Snscw1ITsg5OureU';

        async function supabaseFetch(endpoint) {
            const res = await fetch(endpoint, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }

        // ============================================
        // STATE
        // ============================================
        let allOrders = [];
        let locations = {};
        let selectedLocation = '';
        let currentView = 'oba';
        
        // Local state for immediate UI feedback (before DB confirms)
        let localSpremno = new Set();

        // ============================================
        // CLASSIFICATION
        // ============================================
        const BURGER_KEYWORDS = ['burger', 'smash', 'collina', 'chicken', 'wrap', 'big', 'double', 'baconator', 'vege', 'original', 'triple', 'nuggets', 'caesar'];
        const PANCAKE_KEYWORDS = ['palaƒçink', 'palacink', 'nutella', 'eurokrem', 'plazma', 'krem', 'ameriƒçka', 'americka'];

        function classifyItem(itemName) {
            const name = (itemName || '').toLowerCase();
            for (const kw of BURGER_KEYWORDS) {
                if (name.includes(kw)) return 'burger';
            }
            for (const kw of PANCAKE_KEYWORDS) {
                if (name.includes(kw)) return 'pancake';
            }
            return 'other';
        }

        function classifyOrder(items) {
            let hasBurger = false, hasPancake = false;
            for (const item of items) {
                const type = classifyItem(item.name);
                if (type === 'burger') hasBurger = true;
                if (type === 'pancake') hasPancake = true;
            }
            if (hasBurger && hasPancake) return 'mixed';
            if (hasBurger) return 'burger';
            if (hasPancake) return 'pancake';
            return 'other';
        }

        function getWaitMinutes(createdAt) {
            return Math.floor((new Date() - new Date(createdAt)) / 60000);
        }

        // ============================================
        // TIME DISPLAY
        // ============================================
        function updateTime() {
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ============================================
        // LOAD LOCATIONS
        // ============================================
        async function loadLocations() {
            try {
                const url = `${SUPABASE_URL}/rest/v1/emeni_locations?select=company_id,location_name&order=location_name`;
                const data = await supabaseFetch(url);
                
                const select = document.getElementById('locationSelect');
                data.forEach(loc => {
                    locations[loc.company_id] = loc.location_name;
                    const option = document.createElement('option');
                    option.value = loc.company_id;
                    option.textContent = loc.location_name;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading locations:', err);
            }
        }

        // ============================================
        // LOAD MODIFIERS MAP (wolt_products_map)
        // ============================================
        let modifiersMap = {}; // wolt_reference_id -> {name, price, isModifier}
        
        async function loadModifiersMap() {
            try {
                const url = `${SUPABASE_URL}/rest/v1/wolt_products_map?select=wolt_reference_id,name,price,is_modifier`;
                const data = await supabaseFetch(url);
                
                if (data && Array.isArray(data)) {
                    data.forEach(item => {
                        modifiersMap[item.wolt_reference_id] = {
                            name: item.name,
                            price: item.price,
                            isModifier: item.is_modifier
                        };
                    });
                    console.log(`‚úÖ Loaded ${data.length} items from wolt_products_map`);
                }
            } catch (err) {
                console.error('Error loading modifiers map:', err);
            }
        }

        // ============================================
        // LOAD ORDERS
        // ============================================
        async function loadOrders() {
            try {
                const twoHoursAgo = new Date();
                twoHoursAgo.setHours(twoHoursAgo.getHours() - 2);

                const url = `${SUPABASE_URL}/rest/v1/emeni_orders?select=*&created_at=gte.${encodeURIComponent(twoHoursAgo.toISOString())}&or=(status.eq.3,status.eq.4,status.eq.5)&order=created_at.asc`;
                
                const data = await supabaseFetch(url);
                if (data && Array.isArray(data)) {
                    allOrders = data;
                    
                    // Load lifecycle data for these orders
                    if (allOrders.length > 0) {
                        await loadLifecycleData(allOrders.map(o => o.order_id));
                    }
                    
                    renderAll();
                }
            } catch (err) {
                console.error('Error loading orders:', err);
            }
        }

        // Load lifecycle data to determine which column each order belongs to
        let lifecycleMap = {}; // order_id -> { hasStatus5, hasStatus6, hasStatus7 }
        
        async function loadLifecycleData(orderIds) {
            try {
                const idsString = orderIds.join(',');
                const url = `${SUPABASE_URL}/rest/v1/emeni_order_lifecycle?select=order_id,status,timestamp&order_id=in.(${idsString})&status=in.(5,6,7)&order=timestamp.desc`;
                
                const data = await supabaseFetch(url);
                
                lifecycleMap = {};
                if (data && Array.isArray(data)) {
                    data.forEach(event => {
                        if (!lifecycleMap[event.order_id]) {
                            lifecycleMap[event.order_id] = { hasStatus5: false, hasStatus6: false, hasStatus7: false };
                        }
                        if (event.status === 5) lifecycleMap[event.order_id].hasStatus5 = true;
                        if (event.status === 6) lifecycleMap[event.order_id].hasStatus6 = true;
                        if (event.status === 7) lifecycleMap[event.order_id].hasStatus7 = true;
                    });
                }
            } catch (err) {
                console.error('Error loading lifecycle:', err);
            }
        }

        // Load all delivered orders for today (for Predato panel)
        let predatoOrders = [];
        
        async function loadPredatoOrders() {
            try {
                // Get today's start
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // First get order_ids with status 6 or 7 from lifecycle today
                const lifecycleUrl = `${SUPABASE_URL}/rest/v1/emeni_order_lifecycle?select=order_id,status,timestamp&timestamp=gte.${encodeURIComponent(today.toISOString())}&status=in.(6,7)&order=timestamp.desc`;
                
                const lifecycleData = await supabaseFetch(lifecycleUrl);
                
                if (!lifecycleData || lifecycleData.length === 0) {
                    predatoOrders = [];
                    return;
                }
                
                // Get unique order_ids (keep first occurrence = most recent)
                const seenIds = new Set();
                const uniqueOrderIds = [];
                lifecycleData.forEach(event => {
                    if (!seenIds.has(event.order_id)) {
                        seenIds.add(event.order_id);
                        uniqueOrderIds.push(event.order_id);
                    }
                });
                
                // Fetch order details
                const orderIdsString = uniqueOrderIds.join(',');
                const ordersUrl = `${SUPABASE_URL}/rest/v1/emeni_orders?select=*&order_id=in.(${orderIdsString})`;
                
                const ordersData = await supabaseFetch(ordersUrl);
                
                if (ordersData && Array.isArray(ordersData)) {
                    // Sort by the lifecycle timestamp (most recent first)
                    const orderMap = {};
                    ordersData.forEach(o => orderMap[o.order_id] = o);
                    
                    predatoOrders = uniqueOrderIds
                        .map(id => orderMap[id])
                        .filter(Boolean);
                }
            } catch (err) {
                console.error('Error loading predato orders:', err);
            }
        }

        // ============================================
        // RENDER ORDER CARD
        // ============================================
        function renderOrderCard(order, columnType) {
            let items = order.raw_payload?.items || [];
            if (items.length === 0 && order.raw_payload?.invalidOrderDetails?.items) {
                items = order.raw_payload.invalidOrderDetails.items;
            }

            const orderType = classifyOrder(items);
            const waitMinutes = getWaitMinutes(order.created_at);
            const isUrgent = waitMinutes >= 20;
            const time = new Date(order.created_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });

            const itemsHtml = items.map(item => {
                const itemType = classifyItem(item.name || '');
                const icon = itemType === 'burger' ? 'üçî' : itemType === 'pancake' ? 'ü•û' : 'üçΩÔ∏è';
                
                // Get modifiers
                let modifiersHtml = '';
                if (item.modifiers && item.modifiers.length > 0) {
                    const modTags = item.modifiers.map(m => {
                        // Try to get modifier name from multiple sources
                        let modName = null;
                        
                        // 1. Direct name from payload
                        if (m.name && m.name.trim()) {
                            modName = m.name;
                        }
                        // 2. Lookup in wolt_products_map by referenceID
                        else {
                            const refId = m.productReferenceID || m.referenceID || m.product_reference_id;
                            if (refId && modifiersMap[refId]) {
                                modName = modifiersMap[refId].name;
                            }
                        }
                        // 3. Fallback - show price if available
                        if (!modName && m.price) {
                            modName = `${m.price} RSD`;
                        }
                        
                        return modName;
                    }).filter(Boolean);
                    
                    if (modTags.length > 0) {
                        modifiersHtml = `
                            <div class="item-modifiers">
                                ${modTags.map(name => `<span class="modifier-tag">${name}</span>`).join('')}
                            </div>
                        `;
                    }
                }
                
                // Item-level note/comment
                let itemNoteHtml = '';
                if (item.note && item.note.trim()) {
                    itemNoteHtml = `<div class="item-note">${item.note}</div>`;
                }
                if (item.comment && item.comment.trim()) {
                    itemNoteHtml = `<div class="item-note">${item.comment}</div>`;
                }
                
                return `
                    <div class="card-item ${itemType}-item">
                        <span class="item-icon">${icon}</span>
                        <span class="item-qty">${item.quantity}√ó</span>
                        <span class="item-name" title="${item.name || 'Item'}">${item.name || 'Item'}</span>
                    </div>
                    ${modifiersHtml}
                    ${itemNoteHtml}
                `;
            }).join('');

            // Order-level note/comment
            let orderCommentHtml = '';
            const orderNote = order.raw_payload?.note || order.raw_payload?.comment || order.raw_payload?.specialRequests;
            if (orderNote && orderNote.trim()) {
                orderCommentHtml = `<div class="order-comment">${orderNote}</div>`;
            }

            // Action button based on column
            const actionBtn = columnType === 'priprema' 
                ? `<button class="card-action to-spremno" onclick="event.stopPropagation(); moveToSpremno('${order.order_id}')">‚úÖ SPREMNO</button>`
                : `<button class="card-action to-predato" onclick="event.stopPropagation(); moveToPredato('${order.order_id}')">üì¶ PREDATO</button>`;

            return `
                <div class="order-card ${orderType} ${isUrgent ? 'urgent' : ''}" data-order-id="${order.order_id}">
                    <div class="card-header">
                        <span class="card-time">${time}</span>
                        <span class="card-wait">${waitMinutes}'</span>
                    </div>
                    <div class="card-body">
                        <div class="card-items">
                            ${itemsHtml || '<div class="card-item other-item"><span class="item-name">Bez stavki</span></div>'}
                        </div>
                        ${orderCommentHtml}
                    </div>
                    <div class="card-footer">
                        <span class="card-order-no">#${order.order_no}</span>
                        <span class="card-provider">${order.provider || ''}</span>
                    </div>
                    ${actionBtn}
                </div>
            `;
        }

        // ============================================
        // RENDER PREDATO CARD
        // ============================================
        function renderPredatoCard(order) {
            let items = order.raw_payload?.items || [];
            const time = new Date(order.created_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
            const itemsSummary = items.map(i => `${i.quantity}√ó ${i.name}`).join(', ') || 'Bez stavki';

            return `
                <div class="predato-card">
                    <div class="predato-card-header">
                        <span class="predato-card-time">${time}</span>
                        <span class="predato-card-no">#${order.order_no}</span>
                    </div>
                    <div class="predato-card-items">${itemsSummary}</div>
                </div>
            `;
        }

        // ============================================
        // RENDER ITEMS SUMMARY
        // ============================================
        function renderItemsSummary(orders) {
            const itemsMap = {};

            orders.forEach(order => {
                const items = order.raw_payload?.items || [];
                items.forEach(item => {
                    const name = item.name || 'Unknown';
                    const type = classifyItem(name);
                    const qty = parseFloat(item.quantity) || 1;
                    
                    if (!itemsMap[name]) {
                        itemsMap[name] = { name, qty: 0, type };
                    }
                    itemsMap[name].qty += qty;
                });
            });

            const list = document.getElementById('itemsSummaryList');
            const itemsArray = Object.values(itemsMap).sort((a, b) => b.qty - a.qty);

            if (itemsArray.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <div>Nema stavki</div>
                    </div>
                `;
                return;
            }

            list.innerHTML = itemsArray.map(item => `
                <div class="summary-item ${item.type}">
                    <span class="summary-qty">${item.qty}√ó</span>
                    <span class="summary-name" title="${item.name}">${item.name}</span>
                </div>
            `).join('');
        }

        // ============================================
        // RENDER ALL
        // ============================================
        function renderAll() {
            let filteredOrders = allOrders;
            
            if (selectedLocation) {
                filteredOrders = filteredOrders.filter(o => o.company_id == selectedLocation);
            }

            // Filter paid eBar/Gloriafood
            filteredOrders = filteredOrders.filter(o => {
                const provider = (o.provider || '').toLowerCase();
                const isPaid = o.is_paid === true || o.is_paid === 'true';
                if ((provider === 'ebar' || provider === 'gloriafood') && isPaid) return false;
                return true;
            });

            // Use lifecycle data to determine column
            // Priprema: no status 5/6/7 in lifecycle (or only local state)
            // Spremno: has status 5 but not 6/7
            // Predato: has status 6 or 7
            
            const pripremaOrders = filteredOrders.filter(o => {
                const lc = lifecycleMap[o.order_id];
                // In priprema if: no lifecycle 5/6/7 AND not locally moved
                const hasDeliveryStatus = lc && (lc.hasStatus5 || lc.hasStatus6 || lc.hasStatus7);
                return !hasDeliveryStatus && !localSpremno.has(o.order_id);
            });

            const spremnoOrders = filteredOrders.filter(o => {
                const lc = lifecycleMap[o.order_id];
                // In spremno if: has status 5 (or locally moved) but not 6/7
                const hasReady = (lc && lc.hasStatus5) || localSpremno.has(o.order_id);
                const hasDelivered = lc && (lc.hasStatus6 || lc.hasStatus7);
                return hasReady && !hasDelivered;
            });

            // Render columns
            const pripremaEl = document.getElementById('columnPriprema');
            const spremnoEl = document.getElementById('columnSpremno');

            pripremaEl.innerHTML = pripremaOrders.length 
                ? pripremaOrders.map(o => renderOrderCard(o, 'priprema')).join('')
                : '<div class="empty-state"><div class="icon">‚úÖ</div><div>Sve spremljeno!</div></div>';

            spremnoEl.innerHTML = spremnoOrders.length
                ? spremnoOrders.map(o => renderOrderCard(o, 'spremno')).join('')
                : '<div class="empty-state"><div class="icon">üì¶</div><div>ƒåeka se priprema</div></div>';

            // Render predato from database
            const predatoContent = document.getElementById('predatoContent');
            
            // Filter predato by location if selected
            let filteredPredato = predatoOrders;
            if (selectedLocation) {
                filteredPredato = predatoOrders.filter(o => o.company_id == selectedLocation);
            }
            
            predatoContent.innerHTML = filteredPredato.length
                ? filteredPredato.map(o => renderPredatoCard(o)).join('')
                : '<div class="empty-state"><div class="icon">üì¶</div><div>Nema predatih porud≈æbina danas</div></div>';

            // Update counts
            document.getElementById('predatoCount').textContent = filteredPredato.length;
            document.getElementById('predatoCountHeader').textContent = filteredPredato.length;

            // Update stats
            updateStats([...pripremaOrders, ...spremnoOrders]);

            // Render items summary (only priprema)
            renderItemsSummary(pripremaOrders);
        }

        // ============================================
        // UPDATE STATS
        // ============================================
        function updateStats(orders) {
            let burgerCount = 0, pancakeCount = 0, urgentCount = 0;

            orders.forEach(order => {
                const items = order.raw_payload?.items || [];
                const waitMinutes = getWaitMinutes(order.created_at);
                if (waitMinutes >= 20) urgentCount++;

                items.forEach(item => {
                    const type = classifyItem(item.name || '');
                    const qty = parseFloat(item.quantity) || 1;
                    if (type === 'burger') burgerCount += qty;
                    if (type === 'pancake') pancakeCount += qty;
                });
            });

            document.getElementById('burgerCount').textContent = burgerCount;
            document.getElementById('pancakeCount').textContent = pancakeCount;
            document.getElementById('urgentCount').textContent = urgentCount;
        }

        // ============================================
        // ACTIONS
        // ============================================
        
        // Write lifecycle event to Supabase
        async function writeLifecycleEvent(orderId, status, eventType) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/emeni_order_lifecycle`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        status: status,
                        timestamp: new Date().toISOString(),
                        event_type: eventType
                    })
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    console.error('Lifecycle write failed:', error);
                    return false;
                }
                
                console.log(`‚úÖ Lifecycle: order ${orderId} ‚Üí status ${status} (${eventType})`);
                return true;
            } catch (err) {
                console.error('Lifecycle write error:', err);
                return false;
            }
        }

        async function moveToSpremno(orderId) {
            // Write status 5 (READY) to lifecycle
            const success = await writeLifecycleEvent(orderId, 5, 'kds.spremno');
            
            if (success) {
                // Immediate UI feedback
                localSpremno.add(orderId);
                renderAll();
                
                // Reload lifecycle to sync with DB
                await loadLifecycleData(allOrders.map(o => o.order_id));
                localSpremno.delete(orderId); // DB has it now
                renderAll();
            } else {
                alert('Gre≈°ka pri upisu! Poku≈°ajte ponovo.');
            }
        }

        async function moveToPredato(orderId) {
            // Write status 6 (DELIVERY) to lifecycle
            const success = await writeLifecycleEvent(orderId, 6, 'kds.predato');
            
            if (success) {
                localSpremno.delete(orderId);
                // Reload from database
                await loadLifecycleData(allOrders.map(o => o.order_id));
                await loadPredatoOrders();
                renderAll();
            } else {
                alert('Gre≈°ka pri upisu! Poku≈°ajte ponovo.');
            }
        }

        // ============================================
        // VIEW TOGGLE
        // ============================================
        function setView(view) {
            currentView = view;
            
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            const priprema = document.getElementById('columnPriprema');
            const spremno = document.getElementById('columnSpremno');

            priprema.classList.remove('hidden');
            spremno.classList.remove('hidden');

            if (view === 'priprema') {
                spremno.classList.add('hidden');
            } else if (view === 'spremno') {
                priprema.classList.add('hidden');
            }
        }

        // ============================================
        // PREDATO PANEL
        // ============================================
        function togglePredatoPanel(open) {
            document.getElementById('predatoPanel').classList.toggle('open', open);
            document.getElementById('panelOverlay').classList.toggle('visible', open);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('locationSelect').addEventListener('change', (e) => {
            selectedLocation = e.target.value;
            renderAll();
        });

        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => setView(btn.dataset.view));
        });

        document.getElementById('predatoToggle').addEventListener('click', () => togglePredatoPanel(true));
        document.getElementById('predatoBtnSidebar').addEventListener('click', () => togglePredatoPanel(true));
        document.getElementById('predatoClose').addEventListener('click', () => togglePredatoPanel(false));
        document.getElementById('panelOverlay').addEventListener('click', () => togglePredatoPanel(false));

        // ============================================
        // POLLING
        // ============================================
        setInterval(async () => {
            await loadOrders();
            await loadPredatoOrders();
        }, 5000);

        // ============================================
        // INIT
        // ============================================
        async function init() {
            await loadLocations();
            await loadModifiersMap();
            await loadPredatoOrders();
            await loadOrders();
        }

        init();
    </script>
</body>
</html>
