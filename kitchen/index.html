<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Collina Kitchen Display v2.2 (+ RestOS Dual Write)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
    <!-- Supabase JS for Realtime -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Inter', sans-serif;
            background: #1D1D1B;
            color: #EAE4DA;
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* ============================================
           TOP HEADER BAR
           ============================================ */
        .header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #1D1D1B;
            gap: 8px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #8B5CF6;
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .tab-btn.secondary {
            background: #2a2a28;
            color: #888;
        }

        .tab-btn.secondary:hover {
            background: #3a3a38;
            color: #EAE4DA;
        }

        /* Realtime connection indicator */
        .realtime-indicator {
            display: inline-block;
            margin-right: 6px;
            font-size: 0.9rem;
            animation: pulse-connecting 1s ease-in-out infinite;
        }

        .realtime-indicator.connected {
            color: #10B981;
            animation: none;
        }

        .realtime-indicator.disconnected {
            color: #EF4444;
            animation: pulse-connecting 1s ease-in-out infinite;
        }

        @keyframes pulse-connecting {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .view-toggle {
            display: flex;
            background: #2a2a28;
            border-radius: 4px;
            padding: 3px;
            gap: 3px;
            margin-left: auto;
        }

        .filter-toggle {
            display: flex;
            background: #2a2a28;
            border-radius: 4px;
            padding: 3px;
            gap: 3px;
            margin-left: 12px;
        }

        .filter-btn {
            padding: 8px 14px;
            border: none;
            background: transparent;
            color: #888;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.75rem;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover {
            background: #3a3a38;
            color: #EAE4DA;
        }

        .filter-btn.active {
            background: #10B981;
            color: white;
        }

        .filter-btn .icon {
            font-size: 1rem;
        }

        .sound-btn {
            padding: 8px 12px;
            border: none;
            background: #2a2a28;
            color: #888;
            font-size: 1.1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }

        .sound-btn:hover {
            background: #3a3a38;
        }

        .sound-btn.active {
            background: #10B981;
            color: white;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #888;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.75rem;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: #3a3a38;
            color: #EAE4DA;
        }

        .toggle-btn.active {
            background: #8B5CF6;
            color: white;
        }

        /* ============================================
           MAIN LAYOUT
           ============================================ */
        .main-container {
            display: flex;
            height: calc(100vh - 52px);
            padding: 0 12px 12px 12px;
            gap: 12px;
        }

        /* ============================================
           KANBAN COLUMNS
           ============================================ */
        .columns-container {
            flex: 1;
            display: flex;
            gap: 12px;
            min-width: 0;
        }

        .kanban-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #252523;
            border-radius: 8px;
            overflow: hidden;
            min-width: 0;
        }

        .kanban-column.hidden {
            display: none;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            color: white;
        }

        .column-header.priprema-header {
            background: linear-gradient(135deg, #808BC5 0%, #6B75A8 100%);
        }

        .column-header.pakovanje-header {
            background: linear-gradient(135deg, #9B59B6 0%, #8E44AD 100%);
        }

        /* Split FRONT DESK view */
        .split-frontdesk {
            display: flex;
            flex: 1;
            gap: 12px;
            min-width: 0;
        }

        .split-frontdesk.hidden {
            display: none;
        }

        .split-frontdesk .kanban-column {
            flex: 1;
        }

        .split-frontdesk .column-ebar {
            flex: 1;
        }

        .split-frontdesk .column-dostava {
            flex: 2;
        }

        .column-header.ebar-header {
            background: linear-gradient(135deg, #BBF7D0 0%, #86EFAC 100%);
            color: #166534;
        }

        .column-header.dostava-header {
            background: linear-gradient(135deg, #BFDBFE 0%, #93C5FD 100%);
            color: #1E3A5F;
        }
        
        .column-header.ebar-header .column-count,
        .column-header.dostava-header .column-count {
            background: rgba(0,0,0,0.15);
            color: inherit;
        }

        .column-count {
            background: rgba(255,255,255,0.25);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .column-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 8px;
            padding: 12px;
            overflow: auto;
        }

        /* ============================================
           ORDER CARDS
           ============================================ */
        .order-card {
            width: 260px;
            background: #2a2a28;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #3a3a38;
            transition: transform 0.15s, box-shadow 0.15s;
            user-select: none;
        }

        .order-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Card type borders */
        .order-card.burger {
            border-left: 3px solid #808BC5;
        }

        .order-card.pancake {
            border-left: 3px solid #ED773C;
        }

        .order-card.mixed {
            border-left: 3px solid;
            border-image: linear-gradient(to bottom, #808BC5 50%, #ED773C 50%) 1;
        }

        .order-card.other {
            border-left: 3px solid #666;
        }

        .order-card.urgent {
            background: #2a2a28;
        }

        .order-card.urgent .card-wait {
            background: #C63F3E;
            color: white;
        }

        /* Pakovanje column cards - waiting for courier */
        .column-spremno .order-card {
            background: #2d2a2d;
            border-color: #5a4a5a;
        }

        .card-time {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            color: #888;
        }

        .card-wait {
            padding: 3px 8px;
            border-radius: 4px;
            background: #3a3a38;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            color: #888;
        }

        .card-body {
            padding: 6px 10px 10px;
        }

        .card-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .card-item {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            padding: 4px 0;
            font-size: 0.9rem;
            background: transparent;
        }

        .card-item.burger-item {
            /* no extra styling */
        }

        .card-item.pancake-item {
            /* no extra styling */
        }

        .card-item.other-item {
            /* no extra styling */
        }

        .item-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .item-qty {
            font-weight: 700;
            color: #EAE4DA;
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .item-name {
            flex: 1;
            font-weight: 500;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .item-note {
            font-size: 0.85rem;
            color: #FF6B6B;
            padding: 8px 12px;
            font-weight: 700;
            background: rgba(255, 107, 107, 0.2);
            border-left: 4px solid #FF6B6B;
            border-radius: 0 6px 6px 0;
            margin: 6px 0;
        }

        /* Modifiers - VERY visible */
        .item-modifiers {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin: 6px 0 6px 20px;
        }

        .modifier-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: rgba(251, 191, 36, 0.25);
            border-left: 4px solid #FBBF24;
            border-radius: 0 6px 6px 0;
            font-size: 0.9rem;
            font-weight: 700;
            color: #FBBF24;
        }

        .modifier-tag::before {
            content: '+';
            font-weight: 800;
            font-size: 1rem;
        }

        /* Order-level comment - VERY visible (from platform - red) */
        .order-comment {
            padding: 10px 12px;
            background: rgba(255, 107, 107, 0.25);
            border-left: 5px solid #FF6B6B;
            margin: 8px 0 0 0;
            font-size: 0.95rem;
            font-weight: 700;
            color: #FF6B6B;
            border-radius: 0 6px 6px 0;
        }

        .order-comment::before {
            content: 'üìù ';
            font-size: 1.1rem;
        }

        /* DISPATCHER comment - highlighted style */
        .dispatcher-order-comment {
            padding: 8px 12px;
            background: rgba(0, 200, 255, 0.12);
            border: 2px solid rgba(0, 200, 255, 0.5);
            border-radius: 6px;
            margin: 8px 0;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            line-height: 1.4;
            color: #67e8f9;
        }

        .dispatcher-order-comment::before {
            content: 'üìã ';
        }

        /* DISPATCHER item comment */
        .dispatcher-item-comment {
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            line-height: 1.4;
            color: #86efac;
            padding: 5px 10px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 4px;
            margin: 4px 0 4px 12px;
        }

        .dispatcher-item-comment::before {
            content: '‚Üí ';
            color: #fbbf24;
        }

        /* Container */
        .dispatcher-items-comments {
            background: rgba(147, 51, 234, 0.08);
            border: 2px solid rgba(147, 51, 234, 0.3);
            border-radius: 6px;
            padding: 8px;
            margin: 8px 0;
        }

        .dispatcher-items-comments-header {
            font-family: 'Inter', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            color: #c084fc;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Table number label - for footer */
        .table-label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #4a4a48;
            color: #ccc;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 3px;
        }

        /* Delivery type label - for footer */
        .delivery-type-label {
            display: inline-block;
            background: #4a4a48;
            color: #ccc;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .delivery-type-label.in-house {
            background: #EF4444;
            color: white;
        }

        .delivery-type-label.pickup {
            /* gray base */
        }

        .delivery-type-label.delivery {
            /* gray base */
        }

        /* eBar priority card styling - subtle */
        .order-card.priority {
            border: 1px solid #555;
        }

        /* Provider labels - colored */
        .provider-label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .provider-label.ebar {
            background: #EF4444;
            color: white;
        }

        .provider-label.wolt {
            background: #00C2E8;
            color: white;
        }

        .provider-label.glovo {
            background: #FFC244;
            color: #1a1a1a;
        }

        .provider-label.gloriafood {
            background: #FF6B35;
            color: white;
        }

        .provider-label.emeni {
            background: #10B981;
            color: white;
        }

        .provider-label.other {
            background: #4a4a48;
            color: #ccc;
        }

        /* Updated card header to include provider */
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: #1D1D1B;
            gap: 8px;
        }

        /* eBar cards - full red header in KUHINJA and split LOKAL view */
        .column-priprema .order-card.priority .card-header,
        .column-ebar .order-card.priority .card-header {
            background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
        }

        .column-priprema .order-card.priority .card-header .card-order-no,
        .column-priprema .order-card.priority .card-header .card-time,
        .column-priprema .order-card.priority .card-header .card-wait,
        .column-ebar .order-card.priority .card-header .card-order-no,
        .column-ebar .order-card.priority .card-header .card-time,
        .column-ebar .order-card.priority .card-header .card-wait {
            color: white;
        }

        .column-priprema .order-card.priority .card-header .provider-label,
        .column-ebar .order-card.priority .card-header .provider-label {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .card-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-footer {
            padding: 6px 10px;
            background: #252523;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            font-size: 0.8rem;
            min-height: 0;
        }

        .card-footer:empty {
            display: none;
        }

        .card-order-no {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            color: #888;
        }

        .card-provider {
            color: #666;
            font-size: 0.75rem;
        }

        /* Action Buttons - subtle */
        .card-action {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 0;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: #3a3a38;
            color: #888;
        }

        .card-action:hover {
            background: #4a4a48;
            color: #EAE4DA;
        }

        .card-action:active {
            transform: scale(0.98);
        }

        .card-action.to-spremno {
            /* same as base */
        }

        .card-action.to-spremno:hover {
            background: #4a4a48;
            color: #EAE4DA;
        }

        .card-action.to-predato {
            background: #10B981;
            color: white;
        }

        .card-action.to-predato:hover {
            background: #059669;
        }

        /* Waiting for payment state */
        .card-action.waiting-payment {
            background: #3a3a38;
            color: #F59E0B;
            cursor: default;
            display: flex;
            justify-content: space-between;
            padding: 10px 14px;
        }

        .waiting-text {
            font-weight: 600;
        }

        .waiting-timer {
            background: #F59E0B;
            color: #1a1a1a;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        /* Waiting for courier state (paid, ready to hand over) */
        .card-action.waiting-courier {
            background: #10B981;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            padding: 10px 14px;
        }

        .card-action.waiting-courier:hover {
            background: #059669;
        }

        .courier-timer {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        /* Waiting for food from kitchen */
        .card-action.waiting-food {
            background: #7C3AED;
            color: white;
            cursor: default;
            display: flex;
            justify-content: space-between;
            padding: 10px 14px;
        }

        .card-action.waiting-food .waiting-timer {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* ============================================
           RIGHT SIDEBAR
           ============================================ */
        .sidebar {
            width: 200px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
        }

        .time-display {
            background: #EAE4DA;
            color: #1D1D1B;
            padding: 14px;
            border-radius: 6px;
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            text-align: center;
        }

        .location-select {
            background: #2a2a28;
            border: 2px solid #3a3a38;
            border-radius: 6px;
            padding: 10px 12px;
            color: #EAE4DA;
            font-size: 0.85rem;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            width: 100%;
        }

        .location-select:focus {
            outline: none;
            border-color: #8B5CF6;
        }

        /* Stat Cards */
        .stat-card {
            padding: 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .stat-card .icon {
            font-size: 1.4rem;
        }

        .stat-card .info {
            display: flex;
            flex-direction: column;
        }

        .stat-card .count {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            line-height: 1;
        }

        .stat-card .label {
            font-size: 0.7rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .stat-card.burgers {
            background: #808BC5;
        }

        .stat-card.pancakes {
            background: #ED773C;
        }

        .stat-card.urgent {
            background: #C63F3E;
        }

        /* Items Summary */
        .items-summary {
            background: #2a2a28;
            border-radius: 6px;
            border: 2px solid #3a3a38;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 150px;
        }

        .items-summary-header {
            background: #3a3a38;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 0.8rem;
            color: #EAE4DA;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .items-summary-list {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 0.75rem;
        }

        .summary-item.burger {
            background: rgba(128, 139, 197, 0.2);
            border-left: 3px solid #808BC5;
        }

        .summary-item.pancake {
            background: rgba(237, 119, 60, 0.2);
            border-left: 3px solid #ED773C;
        }

        .summary-item.other {
            background: rgba(136, 136, 136, 0.15);
            border-left: 3px solid #666;
        }

        .summary-qty {
            font-weight: 700;
            color: #9ED6DF;
            min-width: 24px;
        }

        .summary-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Predato Button */
        .predato-btn {
            padding: 12px;
            border: 2px solid #3a3a38;
            background: #2a2a28;
            color: #EAE4DA;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .predato-btn:hover {
            background: #3a3a38;
        }

        .predato-btn .badge {
            background: #8B5CF6;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* ============================================
           PREDATO SIDE PANEL
           ============================================ */
        .predato-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #252523;
            border-left: 2px solid #3a3a38;
            transition: right 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .predato-panel.open {
            right: 0;
        }

        .predato-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .predato-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .predato-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .predato-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .predato-card {
            background: #2a2a28;
            border-radius: 6px;
            padding: 10px 12px;
            border-left: 4px solid #8B5CF6;
        }

        .predato-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .predato-card-provider {
            font-weight: 700;
            font-size: 0.85rem;
        }

        .predato-card-time {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            color: #9ED6DF;
            margin-bottom: 4px;
        }

        .predato-card-no {
            color: #888;
            font-size: 0.8rem;
        }

        .predato-card-items {
            font-size: 0.8rem;
            color: #aaa;
        }

        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 99;
        }

        .panel-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* ============================================
           EMPTY STATE
           ============================================ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #555;
            font-size: 0.9rem;
            gap: 8px;
            text-align: center;
            padding: 30px;
            width: 100%;
        }

        .empty-state .icon {
            font-size: 2.5rem;
            opacity: 0.5;
        }

        .items-summary .empty-state {
            padding: 20px 10px;
            font-size: 0.75rem;
        }

        .items-summary .empty-state .icon {
            font-size: 1.5rem;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 1100px) {
            .sidebar {
                width: 180px;
            }

            .order-card {
                width: 230px;
            }

            .time-display {
                font-size: 1.6rem;
            }
        }

        @media (max-width: 800px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                order: -1;
            }

            .time-display {
                flex: 0;
            }

            .stat-card {
                flex: 1;
                min-width: 100px;
            }

            .items-summary {
                display: none;
            }

            .columns-container {
                flex: 1;
                overflow-y: auto;
            }

            .kanban-column {
                flex-wrap: nowrap;
                flex-direction: column;
            }

            .order-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <button class="tab-btn">
            <span id="realtimeIndicator" class="realtime-indicator" title="Realtime status">‚ö°</span>
            Kitchen Monitor
        </button>
        
        <div class="view-toggle">
            <button class="toggle-btn active" data-view="oba">OBA</button>
            <button class="toggle-btn" data-view="priprema">KUHINJA</button>
            <button class="toggle-btn" data-view="pakovanje">FRONT DESK</button>
        </div>

        <button class="sound-btn active" id="soundToggle" onclick="toggleSound()" title="Zvuƒçna notifikacija">
            üîî
        </button>
    </header>

    <!-- Main Layout -->
    <div class="main-container">
        <!-- Kanban Columns -->
        <div class="columns-container">
            <!-- U Pripremi Column -->
            <div class="kanban-column column-priprema" id="columnPriprema">
                <div class="column-header priprema-header">
                    <span>üî• KUHINJA</span>
                    <span class="column-count" id="pripremaCount">0</span>
                </div>
                <div class="column-content" id="pripremaContent">
                    <!-- Cards will be rendered here -->
                </div>
            </div>

            <!-- Pakovanje Column (was Spremno) - used in OBA view -->
            <div class="kanban-column column-spremno" id="columnSpremno">
                <div class="column-header pakovanje-header">
                    <span>üì¶ FRONT DESK</span>
                    <span class="column-count" id="pakovanjeCount">0</span>
                </div>
                <div class="column-content" id="pakovanjeContent">
                    <!-- Cards will be rendered here -->
                </div>
            </div>

            <!-- Split FRONT DESK - used in FRONT DESK only view -->
            <div class="split-frontdesk hidden" id="splitFrontdesk">
                <!-- LOKAL Column (eBar orders) -->
                <div class="kanban-column column-ebar">
                    <div class="column-header ebar-header">
                        <span>üè™ LOKAL</span>
                        <span class="column-count" id="ebarCount">0</span>
                    </div>
                    <div class="column-content" id="ebarContent">
                        <!-- eBar cards -->
                    </div>
                </div>

                <!-- DOSTAVA Column -->
                <div class="kanban-column column-dostava">
                    <div class="column-header dostava-header">
                        <span>üöö DOSTAVA</span>
                        <span class="column-count" id="dostavaCount">0</span>
                    </div>
                    <div class="column-content" id="dostavaContent">
                        <!-- Wolt/Glovo/Gloria/eMeni cards -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar">
            <div class="time-display" id="currentTime">00:00</div>
            
            <select class="location-select" id="locationSelect">
                <option value="">Sve lokacije</option>
            </select>

            <div class="stat-card burgers">
                <div class="icon">üçî</div>
                <div class="info">
                    <div class="count" id="burgerCount">0</div>
                    <div class="label">Burgera</div>
                </div>
            </div>

            <div class="stat-card pancakes">
                <div class="icon">ü•û</div>
                <div class="info">
                    <div class="count" id="pancakeCount">0</div>
                    <div class="label">Palaƒçinki</div>
                </div>
            </div>

            <div class="stat-card urgent">
                <div class="icon">‚ö†Ô∏è</div>
                <div class="info">
                    <div class="count" id="urgentCount">0</div>
                    <div class="label">Preko 20'</div>
                </div>
            </div>

            <div class="items-summary">
                <div class="items-summary-header">üìã Za pripremu</div>
                <div class="items-summary-list" id="itemsSummaryList">
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <div>Nema stavki</div>
                    </div>
                </div>
            </div>

            <button class="predato-btn" id="predatoBtnSidebar">
                üö¥ Predato
                <span class="badge" id="predatoCount">0</span>
            </button>
        </div>
    </div>

    <!-- Predato Side Panel -->
    <div class="panel-overlay" id="panelOverlay"></div>
    <aside class="predato-panel" id="predatoPanel">
        <div class="predato-header">
            <span>üö¥ Predato (poslednji sat)</span>
            <button class="predato-close" id="predatoClose">‚úï</button>
        </div>
        <div class="predato-content" id="predatoContent">
            <div class="empty-state">
                <div class="icon">üì¶</div>
                <div>Nema predatih porud≈æbina</div>
            </div>
        </div>
    </aside>

    <script>
        // ============================================
        // SUPABASE CONFIG
        // ============================================
        const SUPABASE_URL = 'https://bbnbbbpofelbkyuffslj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibmJiYnBvZmVsYmt5dWZmc2xqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTI0MzQsImV4cCI6MjA4MDYyODQzNH0.koW44soAB-bEfh8OzqjGBwdgov4Snscw1ITsg5OureU';

        // RestOS baza ‚Äî dual write za KDS timestampove
        const RESTOS_URL = 'https://hlmprmebwpndfgrunjok.supabase.co';
        const RESTOS_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsbXBybWVid3BuZGZncnVuam9rIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTE1NTc1NCwiZXhwIjoyMDg0NzMxNzU0fQ.Z8v8A1jtVF5VD-qnAK2cOeVELHWT5o4QuHnN0VnPTko';
        const RESTOS_TENANT_ID = '80ad41ad-769b-4c2c-b7e5-7547b244bae5';

        // Initialize Supabase client for Realtime
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function supabaseFetch(endpoint) {
            const res = await fetch(endpoint, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }

        // Track realtime subscription status
        let realtimeConnected = false;

        // ============================================
        // STATE
        // ============================================
        let allOrders = [];
        let locations = {};
        let selectedLocation = '';
        let currentView = 'oba';
        let flaggedOrderIds = new Set(); // Flagged orders - hidden from KDS

        async function loadActiveFlags() {
            try {
                const url = `${SUPABASE_URL}/rest/v1/order_flags?select=order_id&is_active=eq.true`;
                const data = await supabaseFetch(url);
                if (data && Array.isArray(data)) {
                    flaggedOrderIds = new Set(data.map(f => f.order_id));
                }
            } catch (err) {
                console.error('Error loading flags:', err);
            }
        }
        
        // Sound state
        let soundEnabled = true;
        let lastOrderIds = new Set();
        let lastReadyIds = new Set(); // Track orders that became ready (for FRONT DESK notifications)

        // ============================================
        // CLASSIFICATION
        // ============================================
        const BURGER_KEYWORDS = ['burger', 'smash', 'collina', 'chicken', 'wrap', 'big', 'double', 'baconator', 'vege', 'original', 'triple', 'nuggets', 'caesar'];
        const PANCAKE_KEYWORDS = ['palaƒçink', 'palacink', 'nutella', 'eurokrem', 'krem', 'ameriƒçka', 'americka'];
        
        // Drinks classification - from eBar product database
        const DRINK_KEYWORDS = [
            // Kafa / Topli napici
            'kafa', 'kafe', 'coffee', 'espreso', 'espresso', 'dupli espreso',
            'cappuccino', 'cappucino', 'capuccino', 'kapuƒáino', 'kapucino',
            'latte', 'caffe latte', 'macchiato', 'makijato', 'americano', 
            'nes', 'nescafe', 'neskafe', 'ice kafa', 'ice moka',
            'topla cokolada', 'cokoladno mleko',
            // ƒåaj
            'ƒçaj', 'caj', 'tea', 'ice tea', 'fuze tea', 'nestea',
            // Sokovi / Djus
            'sok', 'juice', 'djus', 'gusto', 'ceƒëeni', 'cedjeni', 'cedjena',
            'borovnica', 'breskva', 'jabuka', 'jagoda', 'pomorandza', 'grejp',
            'citrus mix', 'vitaminska', 'fresh', 'smoothie',
            // Limunade
            'limunada', 'limunana', 'lubenada', 'breskvanada', 'cedevita',
            // Voda
            'voda', 'water', 'aqua', 'aqua viva', 'rosa', 'kisela',
            'balans', 'mineralna', 'gazirana', 'negazirana',
            // Gazirano
            'cola', 'coca', 'pepsi', 'fanta', 'sprite', '7up', '7 up',
            'mirinda', 'schweppes', 'tonic', 'bitter', 'evervess',
            'guarana', 'ultra', 'energy', 'red bull',
            // Pivo
            'pivo', 'beer', 'lager', 'heineken', 'salto', 'zajecarsko', 'zajeƒçar',
            'stout', 'pale ale', 'ipa', 'wit',
            // Vino
            'vino', 'wine', 'belo vino', 'crveno vino', 'roze vino', 'proseco',
            // ≈Ωestoko / Alkohol
            'rakija', 'viski', 'whisky', 'whiskey', 'vodka', 'absolut',
            'd≈æin', 'dzin', 'gin', 'beefeater', 'rum', 'havana', 'tequila',
            'jack daniels', 'jim beam', 'jameson', 'jegermeister', 'jager',
            'vinjak', 'konjak', 'cognac', 'brandy', 'liker',
            'martini', 'gorki list', 'four roses', 'zaric', 'hubert',
            // Mleƒçno
            'mleko', 'jogurt', 'kravica', 'kiselo mleko', 'plazma sejk',
            // Kokteli
            'koktel', 'cocktail', 'mojito', 'margarita', 'aperol', 'spritz', 'kuvani', 'kuvano'
        ];

        // Table ID to Name mapping (eBar Banovo Brdo)
        const TABLE_NAMES = {
            // Banovo Brdo stolovi
            '480': 'B 1', '482': 'B 2', '483': 'B 3', '487': 'B 4', '488': 'B 5', '489': 'B 6',
            '486': 'BP 1', '501': 'BP 2',
            '518': 'GAL 1', '517': 'GAL 2',
            '497': 'HB 1', '496': 'HB 2', '495': 'HB 3',
            '522': 'HG 1', '521': 'HG 2',
            '499': 'HP 1', '481': 'HP 1', '506': 'HP 2', '505': 'HP 3', '504': 'HP 4', '503': 'HP 5',
            '525': 'HS 1', '524': 'HS 2', '520': 'HS 3', '523': 'HS 4',
            '479': 'PR 1', '494': 'PR 2',
            '512': 'S 10', '511': 'S 11', '516': 'S 6', '515': 'S 7', '514': 'S 8', '513': 'S 9',
            '519': 'SP 1', '507': 'SP 2', '508': 'SP 3', '509': 'SP 4', '510': 'SP 5',
            // Specijalni / Interni
            '585': 'Hotel GOSTI', '586': 'Hotel ZAP', '587': 'EPS',
            '588': 'T.O. Kuhinja', '589': 'T.O. Kuhinja',
            '590': 'T.O. SANK', '591': 'T.O. SANK',
            '592': 'NATASA', '593': 'ANA', '594': 'MARKO',
            '596': 'T.O. Magacin', '597': 'T.O. Vozac',
            '598': 'T.O. Kanc', '599': 'T.O. Kanc',
            '602': 'TC 1', '605': 'Cervesija', '606': 'HSS'
        };

        // Helper: Get table display name
        function getTableName(tableId) {
            if (!tableId) return null;
            const id = String(tableId);
            return TABLE_NAMES[id] || tableId; // Return mapped name or original ID
        }

        function classifyItemType(itemName) {
            const name = (itemName || '').toLowerCase();
            
            // FOOD keywords have priority - check first
            // If it's a burger/pancake combo with drink, it's still food
            for (const kw of BURGER_KEYWORDS) {
                if (name.includes(kw)) return 'hrana';
            }
            for (const kw of PANCAKE_KEYWORDS) {
                if (name.includes(kw)) return 'hrana';
            }
            
            // Then check if it's a drink
            for (const kw of DRINK_KEYWORDS) {
                if (name.includes(kw)) return 'pice';
            }
            
            return 'hrana';
        }

        // Helper: Get items from order
        function getOrderItems(order) {
            let items = order.raw_payload?.items || [];
            if (items.length === 0 && order.raw_payload?.invalidOrderDetails?.items) {
                items = order.raw_payload.invalidOrderDetails.items;
            }
            return items;
        }

        // Helper: Check if order has food items
        function orderHasFood(order) {
            const items = getOrderItems(order);
            return items.some(item => classifyItemType(item.name) !== 'pice');
        }

        // Helper: Check if order has drink items
        function orderHasDrinks(order) {
            const items = getOrderItems(order);
            return items.some(item => classifyItemType(item.name) === 'pice');
        }

        function classifyItem(itemName) {
            const name = (itemName || '').toLowerCase();
            for (const kw of BURGER_KEYWORDS) {
                if (name.includes(kw)) return 'burger';
            }
            for (const kw of PANCAKE_KEYWORDS) {
                if (name.includes(kw)) return 'pancake';
            }
            return 'other';
        }

        function classifyOrder(items) {
            let hasBurger = false, hasPancake = false;
            for (const item of items) {
                const type = classifyItem(item.name);
                if (type === 'burger') hasBurger = true;
                if (type === 'pancake') hasPancake = true;
            }
            if (hasBurger && hasPancake) return 'mixed';
            if (hasBurger) return 'burger';
            if (hasPancake) return 'pancake';
            return 'other';
        }

        function getWaitMinutes(createdAt) {
            return Math.floor((new Date() - new Date(createdAt)) / 60000);
        }

        // ============================================
        // TIME DISPLAY
        // ============================================
        function updateTime() {
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
            
            // Update all timers
            updateWaitingTimers();
            
            // Check for eBar auto-predato (every second is fine, actual update happens rarely)
            checkEbarAutoPredato();
        }
        
        function updateWaitingTimers() {
            // Update waiting for payment timers
            const paymentTimers = document.querySelectorAll('.waiting-timer');
            paymentTimers.forEach(timer => {
                const readyAt = timer.dataset.readyAt;
                const createdAt = timer.dataset.createdAt;
                const timestamp = readyAt || createdAt;
                if (timestamp) {
                    const time = new Date(timestamp);
                    const waitingMinutes = Math.floor((Date.now() - time.getTime()) / 60000);
                    timer.textContent = `${waitingMinutes}'`;
                }
            });
            
            // Update waiting for courier timers (since paid)
            const courierTimers = document.querySelectorAll('.courier-timer');
            courierTimers.forEach(timer => {
                const paidAt = timer.dataset.paidAt;
                const readyAt = timer.dataset.readyAt;
                const timestamp = paidAt || readyAt;
                if (timestamp) {
                    const time = new Date(timestamp);
                    const waitingMinutes = Math.floor((Date.now() - time.getTime()) / 60000);
                    timer.textContent = `${waitingMinutes}'`;
                }
            });
        }
        
        // Auto-predato for eBar orders after 5 minutes
        let autoPredatoProcessing = new Set(); // Prevent duplicate processing
        
        async function checkEbarAutoPredato() {
            const now = Date.now();
            const fiveMinutes = 5 * 60 * 1000;
            
            for (const order of allOrders) {
                // Skip if already processing or already handed
                if (autoPredatoProcessing.has(order.order_id)) continue;
                if (order.kds_handed_at) continue;
                
                // Only eBar orders
                const isEbar = (order.provider || '').toLowerCase() === 'ebar';
                if (!isEbar) continue;
                
                // Must have food ready (kds_ready_at set)
                if (!order.kds_ready_at) continue;
                
                // Check if 5 minutes passed since ready
                const readyTime = new Date(order.kds_ready_at).getTime();
                if (now - readyTime >= fiveMinutes) {
                    console.log(`‚è∞ Auto-predato eBar #${order.order_no} (5 min passed)`);
                    autoPredatoProcessing.add(order.order_id);
                    
                    // Auto mark as handed
                    const success = await updateKdsTimestamp(order.order_id, 'kds_handed_at');
                    if (success) {
                        await loadOrders();
                        await loadPredatoOrders();
                        renderAll();
                    }
                    
                    autoPredatoProcessing.delete(order.order_id);
                }
            }
        }
        
        setInterval(updateTime, 1000);
        updateTime();

        // ============================================
        // LOAD LOCATIONS
        // ============================================
        async function loadLocations() {
            try {
                const url = `${SUPABASE_URL}/rest/v1/emeni_locations?select=company_id,location_name&order=location_name`;
                const data = await supabaseFetch(url);
                
                const select = document.getElementById('locationSelect');
                data.forEach(loc => {
                    locations[loc.company_id] = loc.location_name;
                    const option = document.createElement('option');
                    option.value = loc.company_id;
                    option.textContent = loc.location_name;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading locations:', err);
            }
        }

        // ============================================
        // LOAD MODIFIERS MAP (wolt_products_map)
        // ============================================
        let modifiersMap = {}; // wolt_reference_id -> {name, price, isModifier}
        
        async function loadModifiersMap() {
            try {
                const url = `${SUPABASE_URL}/rest/v1/wolt_products_map?select=wolt_reference_id,name,price,is_modifier`;
                const data = await supabaseFetch(url);
                
                if (data && Array.isArray(data)) {
                    data.forEach(item => {
                        modifiersMap[item.wolt_reference_id] = {
                            name: item.name,
                            price: item.price,
                            isModifier: item.is_modifier
                        };
                    });
                    console.log(`‚úÖ Loaded ${data.length} items from wolt_products_map`);
                }
            } catch (err) {
                console.error('Error loading modifiers map:', err);
            }
        }

        // ============================================
        // LOAD DISPATCHER ITEM COMMENTS (restos_komentar)
        // ============================================
        let itemsCommentsMap = {}; // order_id -> [{item_name, quantity, restos_komentar}]
        
        async function loadItemsComments(orderIds) {
            if (!orderIds || orderIds.length === 0) {
                itemsCommentsMap = {};
                return;
            }
            
            try {
                const idsString = orderIds.join(',');
                const url = `${SUPABASE_URL}/rest/v1/emeni_order_items?select=order_id,name,quantity,restos_komentar&order_id=in.(${idsString})&restos_komentar=not.is.null`;
                
                const data = await supabaseFetch(url);
                
                // Reset map
                itemsCommentsMap = {};
                
                if (data && Array.isArray(data)) {
                    data.forEach(item => {
                        if (item.restos_komentar && item.restos_komentar.trim()) {
                            const orderId = String(item.order_id);
                            if (!itemsCommentsMap[orderId]) {
                                itemsCommentsMap[orderId] = [];
                            }
                            itemsCommentsMap[orderId].push({
                                name: item.name,
                                quantity: item.quantity,
                                comment: item.restos_komentar.trim()
                            });
                        }
                    });
                    console.log(`üìù Loaded dispatcher item comments for ${Object.keys(itemsCommentsMap).length} orders`);
                }
            } catch (err) {
                console.error('Error loading items comments:', err);
            }
        }

        // ============================================
        // LOAD ORDERS
        // ============================================
        async function loadOrders() {
            try {
                await loadActiveFlags();

                const twoHoursAgo = new Date();
                twoHoursAgo.setHours(twoHoursAgo.getHours() - 2);

                // Load orders with KDS columns - include those in production OR with kds_ready but not handed
                const url = `${SUPABASE_URL}/rest/v1/emeni_orders?select=*&created_at=gte.${encodeURIComponent(twoHoursAgo.toISOString())}&or=(status.in.(3,4,5),and(kds_ready_at.not.is.null,kds_handed_at.is.null))&order=created_at.asc`;
                
                const data = await supabaseFetch(url);
                if (data && Array.isArray(data)) {
                    // Check for new orders (for sound notification)
                    const ordersInPriprema = data.filter(o => !o.kds_ready_at);
                    checkForNewOrders(ordersInPriprema);
                    
                    allOrders = data;
                    
                    // Load dispatcher item comments for these orders
                    const orderIds = data.map(o => o.order_id);
                    await loadItemsComments(orderIds);
                    
                    // Check paid status for orders in Front Desk (kds_ready_at but not handed)
                    const frontDeskOrders = data.filter(o => o.kds_ready_at && !o.kds_handed_at);
                    await loadPaidStatus(frontDeskOrders.map(o => o.order_id));
                    
                    renderAll();
                }
            } catch (err) {
                console.error('Error loading orders:', err);
            }
        }

        // Load handed orders (last 1 hour)
        let predatoOrders = [];
        
        async function loadPredatoOrders() {
            try {
                // Get 1 hour ago
                const oneHourAgo = new Date();
                oneHourAgo.setHours(oneHourAgo.getHours() - 1);
                
                // Get orders with kds_handed_at in last hour
                const url = `${SUPABASE_URL}/rest/v1/emeni_orders?select=*&kds_handed_at=gte.${encodeURIComponent(oneHourAgo.toISOString())}&order=kds_handed_at.desc`;
                
                const data = await supabaseFetch(url);
                if (data && Array.isArray(data)) {
                    predatoOrders = data;
                }
            } catch (err) {
                console.error('Error loading predato orders:', err);
            }
        }

        // Track which orders are paid/closed (from lifecycle) with timestamp
        let paidOrderIds = new Set();
        let paidOrderTimestamps = {}; // order_id -> paid_at timestamp
        
        async function loadPaidStatus(orderIds) {
            // Clear and rebuild
            paidOrderIds = new Set();
            paidOrderTimestamps = {};
            
            if (!orderIds || orderIds.length === 0) return;
            
            try {
                // Check lifecycle for closed status (status 5 or 7)
                const idsString = orderIds.join(',');
                const url = `${SUPABASE_URL}/rest/v1/emeni_order_lifecycle?select=order_id,status,event_type,timestamp&order_id=in.(${idsString})&status=in.(5,7)&order=timestamp.desc`;
                
                const data = await supabaseFetch(url);
                
                if (data && Array.isArray(data)) {
                    data.forEach(event => {
                        paidOrderIds.add(event.order_id);
                        // Store the timestamp (first one wins - most recent)
                        if (!paidOrderTimestamps[event.order_id]) {
                            paidOrderTimestamps[event.order_id] = event.timestamp;
                        }
                    });
                }
                console.log(`üí∞ Closed orders (status 5/7): ${paidOrderIds.size} / ${orderIds.length}`);
            } catch (err) {
                console.error('Error loading paid status:', err);
            }
        }

        // ============================================
        // RENDER ORDER CARD
        // ============================================
        function renderOrderCard(order, columnType) {
            let items = getOrderItems(order);
            
            const hasFood = orderHasFood(order);
            const hasDrinks = orderHasDrinks(order);
            const foodReady = !!order.kds_ready_at;
            const isEbar = (order.provider || '').toLowerCase() === 'ebar';
            
            // Filter items based on column
            if (columnType === 'priprema') {
                // KUHINJA: only show FOOD items (never drinks)
                items = items.filter(item => classifyItemType(item.name) !== 'pice');
            }
            // FRONT DESK: show ALL items (drinks + food)
            // Button state changes based on whether food is ready

            // If no items left after filtering, don't render the card
            if (items.length === 0) {
                return '';
            }

            const orderType = classifyOrder(items);
            const waitMinutes = getWaitMinutes(order.created_at);
            const isUrgent = waitMinutes >= 20;
            const time = new Date(order.created_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });

            const itemsHtml = items.map(item => {
                const itemType = classifyItem(item.name || '');
                const itemCategory = classifyItemType(item.name || '');
                const icon = itemCategory === 'pice' ? 'ü•§' : (itemType === 'burger' ? 'üçî' : itemType === 'pancake' ? 'ü•û' : 'üçΩÔ∏è');
                
                // Get modifiers
                let modifiersHtml = '';
                if (item.modifiers && item.modifiers.length > 0) {
                    const modTags = item.modifiers.map(m => {
                        // Try to get modifier name from multiple sources
                        let modName = null;
                        
                        // 1. Direct name from payload
                        if (m.name && m.name.trim()) {
                            modName = m.name;
                        }
                        // 2. Lookup in wolt_products_map by referenceID
                        else {
                            const refId = m.productReferenceID || m.referenceID || m.product_reference_id;
                            if (refId && modifiersMap[refId]) {
                                modName = modifiersMap[refId].name;
                            }
                        }
                        // 3. Fallback - show price if available
                        if (!modName && m.price) {
                            modName = `${m.price} RSD`;
                        }
                        
                        return modName;
                    }).filter(Boolean);
                    
                    if (modTags.length > 0) {
                        modifiersHtml = `
                            <div class="item-modifiers">
                                ${modTags.map(name => `<span class="modifier-tag">${name}</span>`).join('')}
                            </div>
                        `;
                    }
                }
                
                // Item-level note/comment
                let itemNoteHtml = '';
                if (item.note && item.note.trim()) {
                    itemNoteHtml = `<div class="item-note">${item.note}</div>`;
                }
                if (item.comment && item.comment.trim()) {
                    itemNoteHtml = `<div class="item-note">${item.comment}</div>`;
                }
                
                return `
                    <div class="card-item ${itemType}-item">
                        <span class="item-icon">${icon}</span>
                        <span class="item-qty">${item.quantity}√ó</span>
                        <span class="item-name" title="${item.name || 'Item'}">${item.name || 'Item'}</span>
                    </div>
                    ${modifiersHtml}
                    ${itemNoteHtml}
                `;
            }).join('');

            // Order-level note/comment from platform (Wolt, Glovo, etc.)
            let orderCommentHtml = '';
            const orderNote = order.raw_payload?.note || order.raw_payload?.comment || order.raw_payload?.specialRequests;
            if (orderNote && orderNote.trim()) {
                orderCommentHtml = `<div class="order-comment">${orderNote}</div>`;
            }
            
            // DISPATCHER order-level comment (restos_order_komentar) - MORE PROMINENT
            let dispatcherOrderCommentHtml = '';
            if (order.restos_order_komentar && order.restos_order_komentar.trim()) {
                dispatcherOrderCommentHtml = `<div class="dispatcher-order-comment">${order.restos_order_komentar}</div>`;
            }
            
            // DISPATCHER item-level comments (from itemsCommentsMap)
            let dispatcherItemsCommentsHtml = '';
            const orderId = String(order.order_id);
            if (itemsCommentsMap[orderId] && itemsCommentsMap[orderId].length > 0) {
                const itemComments = itemsCommentsMap[orderId].map(ic => 
                    `<div class="dispatcher-item-comment"><strong>${ic.quantity}√ó ${ic.name}:</strong> ${ic.comment}</div>`
                ).join('');
                dispatcherItemsCommentsHtml = `
                    <div class="dispatcher-items-comments">
                        <div class="dispatcher-items-comments-header">Napomene za stavke:</div>
                        ${itemComments}
                    </div>
                `;
            }
            
            // Build footer labels for eBar orders (table + delivery type)
            let footerLabelsHtml = '';
            if (isEbar) {
                const footerLabels = [];
                
                // Table ID label - use tableReferenceId and mapped name
                const tableId = order.raw_payload?.tableReferenceId
                    || order.raw_payload?.tableReferenceID
                    || order.raw_payload?.table_reference_id
                    || order.raw_payload?.tableId 
                    || order.raw_payload?.table_id 
                    || order.raw_payload?.TableID 
                    || order.table_id;
                if (tableId) {
                    const tableName = getTableName(tableId);
                    footerLabels.push(`<span class="table-label">ü™ë ${tableName}</span>`);
                }
                
                // Delivery type label
                const deliveryType = order.raw_payload?.deliveryType || order.raw_payload?.delivery_type || order.raw_payload?.orderType || '';
                if (deliveryType) {
                    let typeClass = '';
                    let typeText = deliveryType;
                    
                    const typeLower = deliveryType.toLowerCase();
                    if (typeLower === 'inhouse' || typeLower === 'in_house' || typeLower === 'in-house' || typeLower.includes('dine')) {
                        typeClass = 'in-house';
                        typeText = 'IN-HOUSE';
                    } else if (typeLower === 'pickup' || typeLower === 'pick_up' || typeLower === 'takeaway' || typeLower === 'take_away') {
                        typeClass = 'pickup';
                        typeText = 'PICKUP';
                    } else if (typeLower === 'delivery' || typeLower.includes('dostava')) {
                        typeClass = 'delivery';
                        typeText = 'DELIVERY';
                    }
                    
                    footerLabels.push(`<span class="delivery-type-label ${typeClass}">${typeText}</span>`);
                }
                
                if (footerLabels.length > 0) {
                    footerLabelsHtml = footerLabels.join('');
                }
            }

            // Action button based on column, provider, and state
            let actionBtn = '';
            if (columnType === 'priprema') {
                // KUHINJA: SPREMNO button
                actionBtn = `<button class="card-action to-spremno" onclick="event.stopPropagation(); moveToSpremno('${order.order_id}')">‚úÖ SPREMNO</button>`;
            } else {
                // FRONT DESK - complex logic based on food/drinks and provider
                const waitingForFood = hasFood && !foodReady;
                const isClosed = paidOrderIds.has(order.order_id); // status 5 or 7
                
                if (waitingForFood) {
                    // Waiting for kitchen to prepare food
                    const orderTime = new Date(order.created_at);
                    const waitingMinutes = Math.floor((Date.now() - orderTime.getTime()) / 60000);
                    actionBtn = `
                        <div class="card-action waiting-food">
                            <span class="waiting-text">‚è≥ ƒåeka hranu</span>
                            <span class="waiting-timer" data-created-at="${order.created_at}">${waitingMinutes}'</span>
                        </div>
                    `;
                } else if (isEbar) {
                    // eBar: No payment check needed, no timer - can hand over immediately or auto after 5min
                    actionBtn = `
                        <div class="card-action waiting-courier" onclick="event.stopPropagation(); moveToPredato('${order.order_id}')">
                            <span class="waiting-text">üö¥ PREDATO</span>
                        </div>
                    `;
                } else if (isClosed) {
                    // Wolt/eMeni/Gloria: Payment confirmed (status 5/7) - can hand over
                    const paidAt = paidOrderTimestamps[order.order_id];
                    const paidTime = paidAt ? new Date(paidAt) : new Date();
                    const waitingMinutes = Math.floor((Date.now() - paidTime.getTime()) / 60000);
                    actionBtn = `
                        <div class="card-action waiting-courier" onclick="event.stopPropagation(); moveToPredato('${order.order_id}')">
                            <span class="waiting-text">üö¥ PREDATO</span>
                            <span class="courier-timer" data-paid-at="${paidAt || ''}">${waitingMinutes}'</span>
                        </div>
                    `;
                } else {
                    // Wolt/eMeni/Gloria: Waiting for payment
                    const readyTime = order.kds_ready_at ? new Date(order.kds_ready_at) : new Date(order.created_at);
                    const waitingMinutes = Math.floor((Date.now() - readyTime.getTime()) / 60000);
                    actionBtn = `
                        <div class="card-action waiting-payment">
                            <span class="waiting-text">üí≥ ZATVORI RAƒåUN</span>
                            <span class="waiting-timer" data-ready-at="${order.kds_ready_at || order.created_at}">${waitingMinutes}'</span>
                        </div>
                    `;
                }
            }

            // Provider label with styling
            const provider = (order.provider || '').toLowerCase();
            let providerClass = 'other';
            let providerIcon = 'üìã';
            let providerName = order.provider || 'N/A';
            
            if (provider === 'ebar') {
                providerClass = 'ebar';
                providerIcon = 'üè™';
                providerName = 'eBar';
            } else if (provider === 'wolt') {
                providerClass = 'wolt';
                providerIcon = 'üîµ';
                providerName = 'Wolt';
            } else if (provider === 'glovo') {
                providerClass = 'glovo';
                providerIcon = 'üü°';
                providerName = 'Glovo';
            } else if (provider === 'gloriafood' || provider === 'gloria') {
                providerClass = 'gloriafood';
                providerIcon = 'üçï';
                providerName = 'Gloria';
            } else if (provider === 'emeni' || provider === 'collina') {
                providerClass = 'emeni';
                providerIcon = 'üåê';
                providerName = 'eMeni';
            }

            return `
                <div class="order-card ${orderType} ${isUrgent ? 'urgent' : ''} ${isEbar ? 'priority' : ''}" data-order-id="${order.order_id}">
                    <div class="card-header">
                        <div class="card-header-left">
                            <span class="provider-label ${providerClass}">${providerIcon} ${providerName}</span>
                            <span class="card-order-no">#${order.order_no}</span>
                        </div>
                        <div class="card-header-right">
                            <span class="card-time">${time}</span>
                            <span class="card-wait">${waitMinutes}'</span>
                        </div>
                    </div>
                    <div class="card-body">
                        ${dispatcherOrderCommentHtml}
                        <div class="card-items">
                            ${itemsHtml || '<div class="card-item other-item"><span class="item-name">Bez stavki</span></div>'}
                        </div>
                        ${dispatcherItemsCommentsHtml}
                        ${orderCommentHtml}
                    </div>
                    ${footerLabelsHtml ? `<div class="card-footer">${footerLabelsHtml}</div>` : ''}
                    ${actionBtn}
                </div>
            `;
        }

        // ============================================
        // RENDER PREDATO CARD
        // ============================================
        function renderPredatoCard(order) {
            let items = order.raw_payload?.items || [];
            const orderTime = new Date(order.created_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
            const handedTime = order.kds_handed_at 
                ? new Date(order.kds_handed_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' })
                : '-';
            const itemsSummary = items.map(i => `${i.quantity}√ó ${i.name}`).join(', ') || 'Bez stavki';

            // Provider badge for predato
            const provider = (order.provider || '').toLowerCase();
            let providerBadge = order.provider || '';
            if (provider === 'ebar') providerBadge = 'üè™ eBar';
            else if (provider === 'wolt') providerBadge = 'üîµ Wolt';
            else if (provider === 'glovo') providerBadge = 'üü° Glovo';
            else if (provider === 'gloriafood' || provider === 'gloria') providerBadge = 'üçï Gloria';
            else if (provider === 'emeni') providerBadge = 'üåê eMeni';

            return `
                <div class="predato-card">
                    <div class="predato-card-header">
                        <span class="predato-card-provider">${providerBadge}</span>
                        <span class="predato-card-no">#${order.order_no}</span>
                    </div>
                    <div class="predato-card-time">${orderTime} ‚Üí üö¥ ${handedTime}</div>
                    <div class="predato-card-items">${itemsSummary}</div>
                </div>
            `;
        }

        // ============================================
        // RENDER ITEMS SUMMARY
        // ============================================
        function renderItemsSummary(orders) {
            const itemsMap = {};

            orders.forEach(order => {
                let items = order.raw_payload?.items || [];
                
                // Only count food items (drinks go to FRONT DESK directly)
                items = items.filter(item => classifyItemType(item.name) !== 'pice');
                
                items.forEach(item => {
                    const name = item.name || 'Unknown';
                    const type = classifyItem(name);
                    const qty = parseFloat(item.quantity) || 1;
                    
                    if (!itemsMap[name]) {
                        itemsMap[name] = { name, qty: 0, type };
                    }
                    itemsMap[name].qty += qty;
                });
            });

            const list = document.getElementById('itemsSummaryList');
            const itemsArray = Object.values(itemsMap).sort((a, b) => b.qty - a.qty);

            if (itemsArray.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <div>Nema stavki</div>
                    </div>
                `;
                return;
            }

            list.innerHTML = itemsArray.map(item => `
                <div class="summary-item ${item.type}">
                    <span class="summary-qty">${item.qty}√ó</span>
                    <span class="summary-name" title="${item.name}">${item.name}</span>
                </div>
            `).join('');
        }

        // ============================================
        // RENDER ALL
        // ============================================
        function renderAll() {
            let filteredOrders = allOrders;

            // Hide flagged orders
            filteredOrders = filteredOrders.filter(o => !flaggedOrderIds.has(o.order_id));
            
            if (selectedLocation) {
                filteredOrders = filteredOrders.filter(o => o.company_id == selectedLocation);
            }

            // Filter paid eBar/Gloriafood
            filteredOrders = filteredOrders.filter(o => {
                const provider = (o.provider || '').toLowerCase();
                const isPaid = o.is_paid === true || o.is_paid === 'true';
                if ((provider === 'ebar' || provider === 'gloriafood') && isPaid) return false;
                return true;
            });

            // Column logic based on KDS timestamps:
            // KUHINJA: kds_ready_at IS NULL (not marked ready yet)
            // FRONT DESK: kds_ready_at IS NOT NULL AND kds_handed_at IS NULL
            // PREDATO: kds_handed_at IS NOT NULL (loaded separately)
            
            // Sort function: eBar (priority) first, then by created_at
            const sortByPriority = (a, b) => {
                const aIsEbar = (a.provider || '').toLowerCase() === 'ebar';
                const bIsEbar = (b.provider || '').toLowerCase() === 'ebar';
                
                // eBar first
                if (aIsEbar && !bIsEbar) return -1;
                if (!aIsEbar && bIsEbar) return 1;
                
                // Then by created_at (oldest first)
                return new Date(a.created_at) - new Date(b.created_at);
            };
            
            // Time filter for FRONT DESK - only show orders less than 1:30h old
            const ninetyMinutesAgo = new Date();
            ninetyMinutesAgo.setMinutes(ninetyMinutesAgo.getMinutes() - 90);
            
            // NEW LOGIC:
            // KUHINJA: Orders with FOOD items that haven't been marked ready
            // - Shows only FOOD items (not drinks)
            // - Orders with ONLY drinks skip kuhinja entirely
            const pripremaOrders = filteredOrders.filter(o => {
                if (o.kds_ready_at) return false; // Already marked ready
                return orderHasFood(o); // Must have food items
            }).sort(sortByPriority);
            
            // FRONT DESK: 
            // - Shows ALL orders immediately (with all items)
            // - Button is purple "ƒåeka hranu" until kds_ready_at is set
            // - Then changes to PREDATO (eBar) or ZATVORI RAƒåUN (others)
            const pakovanjeOrders = filteredOrders.filter(o => {
                if (o.kds_handed_at) return false; // Already handed
                if (new Date(o.created_at) < ninetyMinutesAgo) return false; // Too old
                return true; // Show all orders
            }).sort(sortByPriority);

            // Render columns
            const pripremaEl = document.getElementById('pripremaContent');
            const pakovanjeEl = document.getElementById('pakovanjeContent');

            // Render priprema cards (only food items - empty cards filtered out)
            const pripremaCards = pripremaOrders.map(o => renderOrderCard(o, 'priprema')).filter(html => html.trim() !== '');
            pripremaEl.innerHTML = pripremaCards.length 
                ? pripremaCards.join('')
                : '<div class="empty-state"><div class="icon">‚úÖ</div><div>Sve spremljeno!</div></div>';

            // Render FRONT DESK cards (may have drinks waiting, or complete orders)
            const pakovanjeCards = pakovanjeOrders.map(o => renderOrderCard(o, 'pakovanje')).filter(html => html.trim() !== '');
            pakovanjeEl.innerHTML = pakovanjeCards.length
                ? pakovanjeCards.join('')
                : '<div class="empty-state"><div class="icon">‚è≥</div><div>ƒåeka se iz kuhinje</div></div>';

            // Update column counts
            document.getElementById('pripremaCount').textContent = pripremaCards.length;
            document.getElementById('pakovanjeCount').textContent = pakovanjeCards.length;

            // Split FRONT DESK rendering (LOKAL | DOSTAVA)
            if (currentView === 'pakovanje') {
                // Sort by created_at (oldest first) for split view
                const sortByTime = (a, b) => new Date(a.created_at) - new Date(b.created_at);
                
                // Filter eBar orders
                const ebarOrders = pakovanjeOrders.filter(o => 
                    (o.provider || '').toLowerCase() === 'ebar'
                ).sort(sortByTime);
                
                // Filter delivery orders (Wolt, Glovo, GloriaFood, eMeni)
                const dostavaOrders = pakovanjeOrders.filter(o => {
                    const provider = (o.provider || '').toLowerCase();
                    return provider !== 'ebar';
                }).sort(sortByTime);
                
                // Render LOKAL column
                const ebarEl = document.getElementById('ebarContent');
                const ebarCards = ebarOrders.map(o => renderOrderCard(o, 'pakovanje')).filter(html => html.trim() !== '');
                ebarEl.innerHTML = ebarCards.length
                    ? ebarCards.join('')
                    : '<div class="empty-state"><div class="icon">üè™</div><div>Nema lokalnih porud≈æbina</div></div>';
                document.getElementById('ebarCount').textContent = ebarCards.length;
                
                // Render DOSTAVA column
                const dostavaEl = document.getElementById('dostavaContent');
                const dostavaCards = dostavaOrders.map(o => renderOrderCard(o, 'pakovanje')).filter(html => html.trim() !== '');
                dostavaEl.innerHTML = dostavaCards.length
                    ? dostavaCards.join('')
                    : '<div class="empty-state"><div class="icon">üöö</div><div>Nema dostava porud≈æbina</div></div>';
                document.getElementById('dostavaCount').textContent = dostavaCards.length;
            }

            // Render predato from database (kds_handed_at today)
            const predatoContent = document.getElementById('predatoContent');
            
            // Filter predato by location if selected
            let filteredPredato = predatoOrders;
            if (selectedLocation) {
                filteredPredato = predatoOrders.filter(o => o.company_id == selectedLocation);
            }
            
            predatoContent.innerHTML = filteredPredato.length
                ? filteredPredato.map(o => renderPredatoCard(o)).join('')
                : '<div class="empty-state"><div class="icon">üì¶</div><div>Nema predatih porud≈æbina u poslednjih sat vremena</div></div>';

            // Update count
            document.getElementById('predatoCount').textContent = filteredPredato.length;

            // Update stats (only priprema - what needs to be cooked)
            updateStats(pripremaOrders);

            // Render items summary (only priprema - what needs to be cooked)
            renderItemsSummary(pripremaOrders);
        }

        // ============================================
        // UPDATE STATS
        // ============================================
        function updateStats(orders) {
            let burgerCount = 0, pancakeCount = 0, urgentCount = 0;

            orders.forEach(order => {
                const items = order.raw_payload?.items || [];
                const waitMinutes = getWaitMinutes(order.created_at);
                if (waitMinutes >= 20) urgentCount++;

                items.forEach(item => {
                    const type = classifyItem(item.name || '');
                    const qty = parseFloat(item.quantity) || 1;
                    if (type === 'burger') burgerCount += qty;
                    if (type === 'pancake') pancakeCount += qty;
                });
            });

            document.getElementById('burgerCount').textContent = burgerCount;
            document.getElementById('pancakeCount').textContent = pancakeCount;
            document.getElementById('urgentCount').textContent = urgentCount;
        }

        // ============================================
        // ACTIONS
        // ============================================
        
        // Update KDS timestamp on emeni_orders
        async function updateKdsTimestamp(orderId, column) {
            const timestamp = new Date().toISOString();
            
            // 1. Pi≈°i u eMeni (primarni)
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/emeni_orders?order_id=eq.${orderId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        [column]: timestamp
                    })
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    console.error('KDS eMeni update failed:', error);
                    return false;
                }
                
                console.log(`‚úÖ KDS eMeni: order ${orderId} ‚Üí ${column} = ${timestamp}`);
            } catch (err) {
                console.error('KDS eMeni error:', err);
                return false;
            }

            // 2. Dual write ‚Üí RestOS (po reference_id)
            try {
                const restosColumn = column === 'kds_ready_at' ? 'ready_at' : 'dispatched_at';
                const refId = String(orderId);
                
                // Pi≈°i i lifecycle kolonu (ready_at/dispatched_at) i KDS kolonu (kds_ready_at/kds_handed_at)
                const updateData = {
                    [restosColumn]: timestamp,
                    [column]: timestamp,
                    updated_at: timestamp
                };
                
                const response = await fetch(
                    `${RESTOS_URL}/rest/v1/orders?reference_id=eq.${refId}&tenant_id=eq.${RESTOS_TENANT_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': RESTOS_KEY,
                        'Authorization': `Bearer ${RESTOS_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();
                console.log(`[KDS‚ÜíRestOS] orderId=${orderId}, ref="${refId}", columns=${restosColumn}+${column}, matched=${Array.isArray(data) ? data.length : 0}`, data);
                
                if (!response.ok) {
                    console.error('[KDS‚ÜíRestOS] Error:', data);
                }
                if (Array.isArray(data) && data.length === 0) {
                    console.warn(`[KDS‚ÜíRestOS] NO MATCH for reference_id="${refId}" ‚Äî order not found in RestOS`);
                }
            } catch (e) {
                console.error('RestOS KDS update failed:', e);
                // RestOS fail ne blokira ‚Äî eMeni je veƒá upisan
            }

            return true;
        }

        async function moveToSpremno(orderId) {
            // Write kds_ready_at timestamp
            const success = await updateKdsTimestamp(orderId, 'kds_ready_at');
            
            if (success) {
                // Reload orders to get updated data
                await loadOrders();
            } else {
                alert('Gre≈°ka pri upisu! Poku≈°ajte ponovo.');
            }
        }

        async function moveToPredato(orderId) {
            // Write kds_handed_at timestamp
            const success = await updateKdsTimestamp(orderId, 'kds_handed_at');
            
            if (success) {
                // Reload orders to get updated data
                await loadOrders();
                await loadPredatoOrders();
            } else {
                alert('Gre≈°ka pri upisu! Poku≈°ajte ponovo.');
            }
        }

        // ============================================
        // VIEW TOGGLE
        // ============================================
        function setView(view) {
            currentView = view;
            
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            const priprema = document.getElementById('columnPriprema');
            const pakovanje = document.getElementById('columnSpremno');
            const splitFrontdesk = document.getElementById('splitFrontdesk');

            // Reset all
            priprema.classList.remove('hidden');
            pakovanje.classList.remove('hidden');
            splitFrontdesk.classList.add('hidden');

            if (view === 'priprema') {
                // KUHINJA only
                pakovanje.classList.add('hidden');
                splitFrontdesk.classList.add('hidden');
            } else if (view === 'pakovanje') {
                // FRONT DESK split view (LOKAL | DOSTAVA)
                priprema.classList.add('hidden');
                pakovanje.classList.add('hidden');
                splitFrontdesk.classList.remove('hidden');
            }
            // 'oba' - both KUHINJA and regular FRONT DESK shown
            
            renderAll();
        }

        // ============================================
        // SOUND NOTIFICATION
        // ============================================
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
            document.getElementById('soundToggle').textContent = soundEnabled ? 'üîî' : 'üîï';
        }

        // Create audio context for notification sound
        let audioContext = null;
        
        function playNotificationSound() {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Play two short beeps
                const playBeep = (startTime, frequency) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.15);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.15);
                };
                
                const now = audioContext.currentTime;
                playBeep(now, 880);        // First beep (A5)
                playBeep(now + 0.2, 1100);  // Second beep (higher)
                
                console.log('üîî New order notification sound');
            } catch (err) {
                console.error('Sound error:', err);
            }
        }

        function checkForNewOrders(orders) {
            const currentIds = new Set(orders.map(o => o.order_id));
            const currentReadyIds = new Set(orders.filter(o => o.kds_ready_at).map(o => o.order_id));
            
            // Find new orders or orders that became ready
            let shouldPlaySound = false;
            
            for (const order of orders) {
                // 1. Check location filter
                if (selectedLocation && order.company_id != selectedLocation) {
                    continue; // Skip - wrong location
                }
                
                const hasFood = orderHasFood(order);
                const hasDrinks = orderHasDrinks(order);
                
                // Check if this is a NEW order
                const isNewOrder = !lastOrderIds.has(order.order_id);
                
                // Check if food just became ready (was not ready before, is ready now)
                const justBecameReady = order.kds_ready_at && !lastReadyIds.has(order.order_id);
                
                // Determine what triggers sound for each view
                if (currentView === 'priprema') {
                    // KUHINJA: only new orders with food (not yet ready)
                    if (isNewOrder && hasFood && !order.kds_ready_at) {
                        shouldPlaySound = true;
                        break;
                    }
                } else if (currentView === 'pakovanje') {
                    // FRONT DESK: new drinks OR food just became ready
                    if ((isNewOrder && hasDrinks) || (justBecameReady && hasFood)) {
                        shouldPlaySound = true;
                        break;
                    }
                } else {
                    // OBA: all of the above
                    if (isNewOrder && (hasFood || hasDrinks)) {
                        shouldPlaySound = true;
                        break;
                    }
                    if (justBecameReady && hasFood) {
                        shouldPlaySound = true;
                        break;
                    }
                }
            }
            
            // Play sound if matching event occurred (and not first load)
            if (shouldPlaySound && lastOrderIds.size > 0) {
                playNotificationSound();
            }
            
            // Update last known state
            lastOrderIds = currentIds;
            lastReadyIds = currentReadyIds;
        }

        // ============================================
        // PREDATO PANEL
        // ============================================
        function togglePredatoPanel(open) {
            document.getElementById('predatoPanel').classList.toggle('open', open);
            document.getElementById('panelOverlay').classList.toggle('visible', open);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('locationSelect').addEventListener('change', (e) => {
            selectedLocation = e.target.value;
            renderAll();
        });

        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => setView(btn.dataset.view));
        });

        document.getElementById('predatoBtnSidebar').addEventListener('click', () => togglePredatoPanel(true));
        document.getElementById('predatoClose').addEventListener('click', () => togglePredatoPanel(false));
        document.getElementById('panelOverlay').addEventListener('click', () => togglePredatoPanel(false));

        // ============================================
        // REALTIME SUBSCRIPTIONS (replaces polling)
        // ============================================
        function setupRealtimeSubscriptions() {
            console.log('üîå Setting up Realtime subscriptions...');
            
            // Subscribe to emeni_orders changes
            const ordersChannel = supabaseClient
                .channel('kds-orders')
                .on(
                    'postgres_changes',
                    {
                        event: '*', // INSERT, UPDATE, DELETE
                        schema: 'public',
                        table: 'emeni_orders'
                    },
                    async (payload) => {
                        console.log('üì¶ Order change:', payload.eventType, payload.new?.order_id || payload.old?.order_id);
                        
                        // Reload orders on any change
                        await loadOrders();
                        
                        // If it's a handed order, also reload predato
                        if (payload.new?.kds_handed_at) {
                            await loadPredatoOrders();
                        }
                        
                        renderAll();
                    }
                )
                .subscribe((status, err) => {
                    console.log('üì° Orders subscription status:', status);
                    if (status === 'SUBSCRIBED') {
                        realtimeConnected = true;
                        updateConnectionStatus(true);
                    } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                        console.error('‚ùå Orders subscription error:', err);
                        realtimeConnected = false;
                        updateConnectionStatus(false);
                    }
                });

            // Subscribe to emeni_order_lifecycle changes (for paid status)
            const lifecycleChannel = supabaseClient
                .channel('kds-lifecycle')
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'emeni_order_lifecycle'
                    },
                    async (payload) => {
                        console.log('üí≥ Lifecycle event:', payload.new?.event_type, payload.new?.status);
                        
                        // Check if this is a closed/paid event (status 5 or 7)
                        const isClosedEvent = payload.new?.status === 5 || payload.new?.status === 7;
                        
                        if (isClosedEvent && payload.new?.order_id) {
                            console.log('üí∞ Order closed (status ' + payload.new?.status + '):', payload.new?.order_id);
                            paidOrderIds.add(payload.new.order_id);
                            paidOrderTimestamps[payload.new.order_id] = payload.new.timestamp || new Date().toISOString();
                            renderAll();
                        }
                    }
                )
                .subscribe((status, err) => {
                    console.log('üì° Lifecycle subscription status:', status);
                    if (err) {
                        console.error('‚ùå Lifecycle subscription error:', err);
                    }
                });

            // Subscribe to emeni_order_items changes (for dispatcher comments)
            const itemsChannel = supabaseClient
                .channel('kds-items-comments')
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'emeni_order_items'
                    },
                    async (payload) => {
                        // Check if restos_komentar was updated
                        if (payload.new?.restos_komentar !== payload.old?.restos_komentar) {
                            console.log('üìù Item comment updated:', payload.new?.order_id, payload.new?.name);
                            await loadOrders();
                            renderAll();
                        }
                    }
                )
                .subscribe((status, err) => {
                    console.log('üì° Items comments subscription status:', status);
                    if (err) {
                        console.error('‚ùå Items comments subscription error:', err);
                    }
                });

            // Subscribe to order_flags changes (hide flagged orders)
            const flagsChannel = supabaseClient
                .channel('kds-flags')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'order_flags'
                    },
                    async (payload) => {
                        console.log('üö© Flag change:', payload.eventType);
                        await loadActiveFlags();
                        renderAll();
                    }
                )
                .subscribe((status, err) => {
                    console.log('üì° Flags subscription status:', status);
                    if (err) {
                        console.error('‚ùå Flags subscription error:', err);
                    }
                });
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('realtimeIndicator');
            if (indicator) {
                indicator.className = connected ? 'realtime-indicator connected' : 'realtime-indicator disconnected';
                indicator.title = connected ? 'Realtime povezan' : 'Realtime nije povezan';
            }
        }

        // Fallback: minimal polling every 30 seconds as safety net
        setInterval(async () => {
            if (!realtimeConnected) {
                console.log('‚ö†Ô∏è Realtime not connected, using fallback polling...');
                await loadOrders();
                await loadPredatoOrders();
                renderAll();
            }
        }, 30000);

        // ============================================
        // INIT
        // ============================================
        async function init() {
            console.log('üöÄ Initializing KDS v2.2 with RestOS Dual Write...');
            
            // Initial data load
            await loadLocations();
            await loadModifiersMap();
            await loadPredatoOrders();
            await loadOrders();
            
            // Setup realtime subscriptions
            setupRealtimeSubscriptions();
            
            console.log('‚úÖ KDS Ready');
        }

        init();
    </script>
</body>
</html>
