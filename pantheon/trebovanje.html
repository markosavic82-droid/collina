<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trebovanje - Collina Magacin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', sans-serif; 
      background: #0f172a;
      min-height: 100vh;
      color: #e2e8f0;
    }
    
    /* HEADER - FIXED */
    .header {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-bottom: 1px solid #334155;
      padding: 12px 24px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 700;
      white-space: nowrap;
    }
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    /* HEADER CONTROLS */
    .header-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      justify-content: flex-end;
    }
    .header-select {
      padding: 10px 16px;
      background: #334155;
      border: 1px solid #475569;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 14px;
      min-width: 180px;
    }
    .header-select:focus { outline: none; border-color: #dc2626; }
    .header-select option { background: #1e293b; }
    
    .cart-summary {
      display: flex;
      align-items: center;
      gap: 16px;
      background: #334155;
      padding: 8px 16px;
      border-radius: 8px;
    }
    .cart-info {
      display: flex;
      gap: 16px;
      font-size: 14px;
    }
    .cart-info span { display: flex; align-items: center; gap: 6px; }
    .cart-info .count { 
      background: #dc2626; 
      padding: 2px 8px; 
      border-radius: 10px; 
      font-weight: 600;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-secondary {
      background: #475569;
      color: #e2e8f0;
    }
    .btn-secondary:hover { background: #64748b; }
    .btn-danger {
      background: #dc2626;
      color: white;
    }
    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .btn-success:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
    .btn-info {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    /* MAIN CONTENT */
    .main {
      padding-top: 80px;
      min-height: 100vh;
    }
    
    /* TABS & FILTERS BAR */
    .toolbar {
      background: #1e293b;
      border-bottom: 1px solid #334155;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      position: sticky;
      top: 60px;
      z-index: 50;
    }
    .tabs {
      display: flex;
      gap: 4px;
      background: #0f172a;
      padding: 4px;
      border-radius: 8px;
    }
    .tab {
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .tab:hover { background: #334155; }
    .tab.active { background: #dc2626; color: white; }
    
    .search-box {
      flex: 1;
      min-width: 200px;
      max-width: 400px;
    }
    .search-input {
      width: 100%;
      padding: 10px 16px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 14px;
    }
    .search-input:focus { outline: none; border-color: #dc2626; }
    .search-input::placeholder { color: #64748b; }
    
    .filter-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chip {
      padding: 6px 12px;
      background: #334155;
      border: 1px solid #475569;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .chip:hover { background: #475569; }
    .chip.active { background: #dc2626; border-color: #dc2626; }
    
    /* STATUS FILTER CHIPS */
    .status-chips {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .status-chip {
      padding: 8px 16px;
      background: #334155;
      border: 1px solid #475569;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-chip:hover { background: #475569; }
    .status-chip.active { border-color: #dc2626; background: rgba(220, 38, 38, 0.2); }
    .status-chip .badge {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 700;
    }
    
    /* CONTENT AREA */
    .content {
      padding: 20px 24px;
    }
    
    /* PREDLOG BANNER */
    .suggestion-banner {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      border-radius: 10px;
      padding: 12px 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .suggestion-banner:hover { opacity: 0.95; }
    .suggestion-banner.hidden { display: none; }
    .suggestion-text { display: flex; align-items: center; gap: 12px; }
    .suggestion-text h4 { font-size: 14px; font-weight: 600; }
    .suggestion-text p { font-size: 12px; opacity: 0.9; }
    
    /* PRODUCTS LIST - HORIZONTAL CARDS */
    .products-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .products-header h2 { font-size: 16px; font-weight: 600; }
    .products-count { color: #64748b; font-size: 13px; }
    
    .products-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    /* HORIZONTAL PRODUCT CARD */
    .product-row {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 12px 16px;
      display: grid;
      grid-template-columns: 80px 1fr auto 140px;
      gap: 16px;
      align-items: center;
      transition: all 0.2s;
    }
    .product-row:hover { border-color: #475569; background: #1e293b; }
    .product-row.in-cart { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
    .product-row.low-stock { border-left: 3px solid #f87171; }
    .product-row.has-reserved { border-left: 3px solid #f59e0b; }
    
    @media (max-width: 900px) {
      .product-row {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .product-stocks { justify-content: flex-start; }
      .product-actions { justify-content: flex-start; }
      .header { flex-wrap: wrap; padding: 12px 16px; }
      .header-controls { flex-wrap: wrap; justify-content: center; }
    }
    
    .product-code {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
      background: #334155;
      padding: 4px 8px;
      border-radius: 4px;
      text-align: center;
    }
    
    .product-info {
      min-width: 0;
    }
    .product-name {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .product-unit {
      font-size: 12px;
      color: #64748b;
    }
    
    /* STOCK INFO - NOVI DIZAJN */
    .stock-info-container {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }
    
    .stock-card {
      background: #0f172a;
      border-radius: 8px;
      padding: 8px 12px;
      min-width: 90px;
      text-align: center;
      border: 1px solid #334155;
    }
    .stock-card.cm { border-color: #3b82f6; }
    .stock-card.radnja { border-color: #10b981; }
    .stock-card.has-reserved { border-color: #f59e0b; }
    
    .stock-card-header {
      font-size: 10px;
      color: #64748b;
      text-transform: uppercase;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .stock-card-body {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .stock-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }
    
    .stock-label {
      color: #94a3b8;
      font-size: 10px;
    }
    
    .stock-value {
      font-weight: 700;
      font-size: 13px;
    }
    .stock-value.total { color: #e2e8f0; }
    .stock-value.reserved { color: #f59e0b; }
    .stock-value.available { color: #4ade80; }
    .stock-value.available.low { color: #f87171; }
    .stock-value.available.zero { color: #64748b; }
    
    .stock-divider {
      height: 1px;
      background: #334155;
      margin: 4px 0;
    }
    
    /* SIMPLE STOCK BADGE (za CM) */
    .stock-badge-simple {
      text-align: center;
      padding: 8px 12px;
      background: #0f172a;
      border-radius: 8px;
      min-width: 70px;
      border: 1px solid #334155;
    }
    .stock-badge-simple .label {
      font-size: 10px;
      color: #64748b;
      text-transform: uppercase;
      font-weight: 600;
    }
    .stock-badge-simple .value {
      font-size: 16px;
      font-weight: 700;
      margin-top: 2px;
    }
    .stock-badge-simple .value.ok { color: #4ade80; }
    .stock-badge-simple .value.low { color: #f87171; }
    .stock-badge-simple .value.zero { color: #64748b; }
    
    .product-status {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-low { background: rgba(248, 113, 113, 0.2); color: #f87171; }
    .badge-ok { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
    .badge-reserved { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    
    .product-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-end;
    }
    .qty-input-small {
      width: 70px;
      padding: 8px;
      background: #0f172a;
      border: 1px solid #475569;
      border-radius: 6px;
      color: #e2e8f0;
      font-size: 14px;
      text-align: center;
    }
    .qty-input-small:focus { outline: none; border-color: #dc2626; }
    
    .add-btn {
      padding: 8px 16px;
      background: #dc2626;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .add-btn:hover { background: #b91c1c; }
    .add-btn.added {
      background: #10b981;
    }
    .add-btn.added:hover { background: #059669; }
    
    /* ALERTS */
    .alert {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideUp 0.3s ease;
      max-width: 400px;
      font-size: 14px;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .alert-success { background: #065f46; border: 1px solid #10b981; }
    .alert-error { background: #7f1d1d; border: 1px solid #f87171; }
    .alert-info { background: #1e3a5f; border: 1px solid #3b82f6; }
    .alert.hidden { display: none; }
    
    /* MODAL */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: #1e293b;
      border-radius: 12px;
      width: 95%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .modal-header h3 { font-size: 16px; font-weight: 600; }
    .modal-close {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 24px;
      cursor: pointer;
    }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #334155;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-shrink: 0;
    }
    
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #334155;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .cart-item-info { flex: 1; }
    .cart-item-name { font-weight: 600; font-size: 14px; }
    .cart-item-code { font-size: 12px; color: #94a3b8; }
    .cart-item-controls { display: flex; align-items: center; gap: 10px; }
    .cart-item-qty {
      width: 70px;
      padding: 8px;
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 6px;
      color: #e2e8f0;
      text-align: center;
    }
    .cart-item-unit { color: #64748b; font-size: 13px; min-width: 40px; }
    .cart-item-remove {
      background: none;
      border: none;
      color: #f87171;
      font-size: 20px;
      cursor: pointer;
      padding: 4px 8px;
    }
    
    /* TABLES */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th, .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #334155;
    }
    .data-table th {
      background: #1e293b;
      font-weight: 600;
      color: #94a3b8;
      font-size: 12px;
      text-transform: uppercase;
      position: sticky;
      top: 0;
    }
    .data-table tr:hover { background: rgba(220, 38, 38, 0.1); }
    .data-table .actions-cell {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* STATUS BADGES */
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .status-N { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .status-T { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .status-Z { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
    
    .hidden { display: none !important; }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
    
    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #64748b;
    }
    .loading-spinner::after {
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid #334155;
      border-top-color: #dc2626;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* TREBOVANJE DETAIL */
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #334155;
    }
    .detail-title { font-size: 18px; font-weight: 700; }
    .detail-meta { font-size: 13px; color: #94a3b8; margin-top: 4px; }
    
    .detail-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .detail-info-item {
      background: #334155;
      padding: 12px;
      border-radius: 8px;
    }
    .detail-info-label {
      font-size: 11px;
      color: #94a3b8;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .detail-info-value {
      font-size: 14px;
      font-weight: 600;
    }
    
    .stavka-list {
      margin-top: 16px;
    }
    .stavka-item {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 16px;
      align-items: center;
      padding: 12px;
      background: #334155;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .stavka-item.changed {
      border: 1px solid #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }
    .stavka-info { min-width: 0; }
    .stavka-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .stavka-code { font-size: 12px; color: #94a3b8; }
    .stavka-qty { 
      font-weight: 700; 
      font-size: 16px;
      color: #3b82f6;
      text-align: right;
    }
    .stavka-received {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stavka-received input {
      width: 80px;
      padding: 8px;
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 6px;
      color: #e2e8f0;
      text-align: center;
      font-size: 14px;
    }
    .stavka-received input:focus {
      outline: none;
      border-color: #dc2626;
    }
    .stavka-received input.changed {
      border-color: #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }
    .stavka-reason {
      min-width: 120px;
    }
    .stavka-reason select {
      width: 100%;
      padding: 8px;
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 6px;
      color: #e2e8f0;
      font-size: 12px;
    }
    
    @media (max-width: 600px) {
      .stavka-item {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .stavka-received, .stavka-reason {
        justify-self: start;
      }
    }
    
    /* ROLE INDICATOR */
    .role-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #334155;
      border-radius: 6px;
      font-size: 12px;
    }
    .role-indicator.cm { border-left: 3px solid #3b82f6; }
    .role-indicator.mp { border-left: 3px solid #10b981; }
  </style>
</head>
<body>
  <!-- FIXED HEADER -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon">ü•ê</div>
      <span>Collina Trebovanje</span>
    </div>
    
    <div class="header-controls">
      <div class="role-indicator mp" id="roleIndicator">
        <span>üìç</span>
        <span id="roleText">Izaberite radnju</span>
      </div>
      
      <select class="header-select" id="radnja" onchange="onRadnjaChange()">
        <option value="">-- Izaberi radnju --</option>
      </select>
      
      <div class="cart-summary">
        <div class="cart-info">
          <span>üõí <span class="count" id="cartCount">0</span></span>
          <span>Artikala: <strong id="totalQty">0</strong></span>
        </div>
        <button class="btn btn-secondary" onclick="openCartModal()">Pregledaj</button>
      </div>
      
      <button class="btn btn-primary" id="submitBtn" onclick="submitTrebovanje()" disabled>
        üì§ Po≈°alji trebovanje
      </button>
    </div>
  </header>
  
  <div id="alert" class="alert hidden"></div>
  
  <main class="main">
    <!-- TOOLBAR -->
    <div class="toolbar">
      <div class="tabs">
        <div class="tab active" onclick="showTab('artikli', this)">üõçÔ∏è Artikli</div>
        <div class="tab" onclick="showTab('lista', this)">üìã Trebovanja</div>
        <div class="tab" onclick="showTab('prenosi', this)">üìÑ Prenosi</div>
      </div>
      
      <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="Pretra≈æi artikle..." oninput="filterProducts()">
      </div>
      
      <div class="filter-chips" id="categoryChips">
        <div class="chip active" data-cat="all" onclick="filterCategory('all', this)">Svi</div>
        <div class="chip" data-cat="low" onclick="filterCategory('low', this)">‚ö†Ô∏è Ispod min.</div>
        <div class="chip" data-cat="reserved" onclick="filterCategory('reserved', this)">üîí Rezervisano</div>
        <div class="chip" data-cat="200" onclick="filterCategory('200', this)">Piƒáe</div>
        <div class="chip" data-cat="400" onclick="filterCategory('400', this)">Gotovi</div>
        <div class="chip" data-cat="500" onclick="filterCategory('500', this)">Sirovine</div>
        <div class="chip" data-cat="600" onclick="filterCategory('600', this)">Ambalaza</div>
      </div>
    </div>
    
    <!-- CONTENT -->
    <div class="content">
      <!-- TAB: ARTIKLI -->
      <div id="tab-artikli">
        <div class="suggestion-banner hidden" id="suggestionBanner" onclick="openSuggestions()">
          <div class="suggestion-text">
            <span style="font-size: 20px;">‚ö†Ô∏è</span>
            <div>
              <h4>Predlog trebovanja</h4>
              <p><span id="suggestionsCount">0</span> artikala ispod minimuma</p>
            </div>
          </div>
          <button class="btn btn-secondary">Pregledaj ‚Üí</button>
        </div>
        
        <div class="products-header">
          <h2 id="productsTitle">Svi artikli</h2>
          <span class="products-count"><span id="productsCount">0</span> artikala</span>
        </div>
        
        <div class="products-list" id="productsList">
          <div class="loading-spinner">Uƒçitavanje</div>
        </div>
      </div>
      
      <!-- TAB: LISTA TREBOVANJA -->
      <div id="tab-lista" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
          <h2>üìã Trebovanja</h2>
          <button class="btn btn-secondary" onclick="loadTrebovanja()">üîÑ Osve≈æi</button>
        </div>
        
        <!-- Status filter -->
        <div class="status-chips" id="statusChips">
          <div class="status-chip active" data-status="" onclick="filterTrebovanjaStatus('', this)">
            Svi <span class="badge" id="countAll">0</span>
          </div>
          <div class="status-chip" data-status="N" onclick="filterTrebovanjaStatus('N', this)">
            üÜï Novo <span class="badge" style="background:#fbbf24;color:#000;" id="countN">0</span>
          </div>
          <div class="status-chip" data-status="T" onclick="filterTrebovanjaStatus('T', this)">
            üöö Na putu <span class="badge" style="background:#3b82f6;" id="countT">0</span>
          </div>
          <div class="status-chip" data-status="Z" onclick="filterTrebovanjaStatus('Z', this)">
            ‚úÖ Zavr≈°eno <span class="badge" style="background:#10b981;" id="countZ">0</span>
          </div>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Broj</th>
                <th>Radnja</th>
                <th>Datum</th>
                <th>Stavke</th>
                <th>Status</th>
                <th>Akcije</th>
              </tr>
            </thead>
            <tbody id="trebovanjaBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- TAB: PRENOSI -->
      <div id="tab-prenosi" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2>üìÑ Prenosi iz Pantheona</h2>
          <button class="btn btn-secondary" onclick="loadPrenosi()">üîÑ Osve≈æi</button>
        </div>
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr><th>Broj</th><th>Datum</th><th>Primalac</th><th>Vrednost</th><th>Stavke</th><th>Akcija</th></tr>
            </thead>
            <tbody id="prenosiBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  
  <!-- CART MODAL -->
  <div class="modal-overlay hidden" id="cartModal">
    <div class="modal">
      <div class="modal-header">
        <h3>üõí Korpa - <span id="cartModalCount">0</span> stavki</h3>
        <button class="modal-close" onclick="closeCartModal()">√ó</button>
      </div>
      <div class="modal-body" id="cartModalBody">
        <div class="empty-state"><div class="icon">üõí</div><p>Korpa je prazna</p></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="clearCart()">üóëÔ∏è Isprazni</button>
        <button class="btn btn-secondary" onclick="closeCartModal()">Zatvori</button>
        <button class="btn btn-primary" onclick="submitTrebovanje()">üì§ Po≈°alji</button>
      </div>
    </div>
  </div>
  
  <!-- SUGGESTIONS MODAL -->
  <div class="modal-overlay hidden" id="suggestionsModal">
    <div class="modal">
      <div class="modal-header">
        <h3>‚ö†Ô∏è Predlog trebovanja</h3>
        <button class="modal-close" onclick="closeSuggestions()">√ó</button>
      </div>
      <div class="modal-body" id="suggestionsBody"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSuggestions()">Zatvori</button>
        <button class="btn btn-primary" onclick="addAllSuggestions()">‚ûï Dodaj sve</button>
      </div>
    </div>
  </div>
  
  <!-- TREBOVANJE DETAIL MODAL -->
  <div class="modal-overlay hidden" id="trebovanjeModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3 id="trebovanjeModalTitle">üìã Detalji trebovanja</h3>
        <button class="modal-close" onclick="closeTrebovanjeModal()">√ó</button>
      </div>
      <div class="modal-body" id="trebovanjeModalBody">
        <div class="loading-spinner">Uƒçitavanje</div>
      </div>
      <div class="modal-footer" id="trebovanjeModalFooter">
      </div>
    </div>
  </div>
  
  <!-- PRENOS DETAIL MODAL -->
  <div class="modal-overlay hidden" id="prenosModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="prenosModalTitle">üìÑ Detalji prenosa</h3>
        <button class="modal-close" onclick="closePrenosModal()">√ó</button>
      </div>
      <div class="modal-body" id="prenosModalBody">
        <div class="loading-spinner">Uƒçitavanje</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePrenosModal()">Zatvori</button>
      </div>
    </div>
  </div>
  
  <script>
    // ==================== CONFIG ====================
    const API = window.location.hostname === 'localhost' 
      ? 'http://localhost:3002/api/trebovanje'
      : window.location.origin + '/api/trebovanje';
    
    // ==================== STATE ====================
    let artikli = [];
    let stanjeSvi = {};
    let stanjeCM = {};
    let stanjeRadnja = {};
    let minStanje = {};
    let cart = [];
    let currentCategory = 'all';
    let selectedRadnja = '';
    let suggestions = [];
    let currentTrebovanje = null;
    let trebovanjaList = [];
    let currentStatusFilter = '';
    let izmeneStavki = {};
    
    const STATUS_NAMES = {
      'N': 'NOVO',
      'T': 'NA PUTU',
      'Z': 'ZAVR≈†ENO'
    };
    
    const RAZLOZI_IZMENE = [
      { kod: 'POLOMLJENO', naziv: 'Polomljeno' },
      { kod: 'ISTEKAO_ROK', naziv: 'Istekao rok' },
      { kod: 'MANJA_KOLICINA', naziv: 'Manja koliƒçina' },
      { kod: 'VECA_KOLICINA', naziv: 'Veƒáa koliƒçina' },
      { kod: 'OSTALO', naziv: 'Ostalo' }
    ];
    
    // ==================== HELPER FUNKCIJE ====================
    function formatDate(dateValue) {
      if (!dateValue) return '-';
      try {
        const d = new Date(dateValue);
        if (isNaN(d.getTime())) return '-';
        return d.toLocaleDateString('sr-RS', { day: '2-digit', month: '2-digit', year: 'numeric' });
      } catch (e) {
        return '-';
      }
    }
    
    function formatDateTime(dateValue) {
      if (!dateValue) return '-';
      try {
        const d = new Date(dateValue);
        if (isNaN(d.getTime())) return '-';
        return d.toLocaleDateString('sr-RS', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      } catch (e) {
        return '-';
      }
    }
    
    function formatNumber(num, decimals = 0) {
      if (num === null || num === undefined) return '0';
      return Number(num).toLocaleString('sr-RS', { 
        minimumFractionDigits: decimals, 
        maximumFractionDigits: decimals 
      });
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }
    
    // ==================== TABS ====================
    function showTab(tabName, element) {
      document.getElementById('tab-artikli').classList.add('hidden');
      document.getElementById('tab-lista').classList.add('hidden');
      document.getElementById('tab-prenosi').classList.add('hidden');
      
      document.getElementById('tab-' + tabName).classList.remove('hidden');
      
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      element.classList.add('active');
      
      const categoryChips = document.getElementById('categoryChips');
      const searchBox = document.querySelector('.search-box');
      if (tabName === 'artikli') {
        categoryChips.style.display = 'flex';
        searchBox.style.display = 'block';
      } else {
        categoryChips.style.display = 'none';
        searchBox.style.display = 'none';
      }
      
      if (tabName === 'lista') loadTrebovanja();
      if (tabName === 'prenosi') loadPrenosi();
    }
    
    // ==================== FILTERS ====================
    function filterProducts() {
      renderProducts();
    }
    
    function filterCategory(cat, element) {
      currentCategory = cat;
      document.querySelectorAll('#categoryChips .chip').forEach(c => c.classList.remove('active'));
      element.classList.add('active');
      renderProducts();
    }
    
    function filterTrebovanjaStatus(status, element) {
      currentStatusFilter = status;
      document.querySelectorAll('.status-chip').forEach(c => c.classList.remove('active'));
      element.classList.add('active');
      renderTrebovanjaList();
    }
    
    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', async () => {
      await loadRadnje();
      await loadArtikli();
      await loadStanje();
      await loadMinStanje();
      renderProducts();
    });
    
    // ==================== DATA LOADING ====================
    async function loadRadnje() {
      try {
        const res = await fetch(API + '/radnje');
        const radnje = await res.json();
        const select = document.getElementById('radnja');
        radnje.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r.sifra || r.naziv;
          opt.textContent = r.naziv;
          select.appendChild(opt);
        });
      } catch (err) { 
        console.error('Gre≈°ka pri uƒçitavanju radnji:', err); 
        showAlert('Gre≈°ka pri uƒçitavanju radnji', 'error');
      }
    }
    
    async function loadArtikli() {
      try {
        const res = await fetch(API + '/artikli');
        artikli = await res.json();
      } catch (err) { 
        console.error('Gre≈°ka pri uƒçitavanju artikala:', err); 
      }
    }
    
    async function loadStanje() {
      try {
        const res = await fetch(API + '/stanje');
        stanjeSvi = await res.json();
        stanjeCM = stanjeSvi['Centralni magacin'] || {};
      } catch (err) { 
        console.error('Gre≈°ka pri uƒçitavanju stanja:', err); 
      }
    }
    
    async function loadMinStanje() {
      try {
        const res = await fetch(API + '/min-stanje');
        minStanje = await res.json();
      } catch (err) { 
        console.error('Gre≈°ka pri uƒçitavanju min stanja:', err); 
      }
    }
    
    // ==================== RADNJA CHANGE ====================
    async function onRadnjaChange() {
      selectedRadnja = document.getElementById('radnja').value;
      const roleIndicator = document.getElementById('roleIndicator');
      const roleText = document.getElementById('roleText');
      
      if (selectedRadnja) {
        stanjeRadnja = stanjeSvi[selectedRadnja] || {};
        roleText.textContent = selectedRadnja;
        roleIndicator.className = 'role-indicator mp';
        updateSuggestions();
      } else {
        stanjeRadnja = {};
        roleText.textContent = 'Izaberite radnju';
        document.getElementById('suggestionBanner').classList.add('hidden');
      }
      renderProducts();
      updateSubmitBtn();
    }
    
    function updateSuggestions() {
      suggestions = artikli.filter(a => {
        const stanje = (stanjeRadnja[a.acIdent]?.stock) || 0;
        const min = minStanje[a.acIdent] || 0;
        return min > 0 && stanje < min;
      }).map(a => ({
        ...a,
        trenutno: (stanjeRadnja[a.acIdent]?.stock) || 0,
        min: minStanje[a.acIdent] || 0,
        potrebno: Math.max(1, (minStanje[a.acIdent] || 0) - ((stanjeRadnja[a.acIdent]?.stock) || 0))
      }));
      
      const banner = document.getElementById('suggestionBanner');
      if (suggestions.length > 0) {
        banner.classList.remove('hidden');
        document.getElementById('suggestionsCount').textContent = suggestions.length;
      } else {
        banner.classList.add('hidden');
      }
    }
    
    // ==================== PRODUCTS RENDERING ====================
    function renderProducts() {
      const list = document.getElementById('productsList');
      const search = document.getElementById('searchInput').value.toLowerCase();
      
      let filtered = artikli.filter(a => {
        if (search && !a.acIdent.toLowerCase().includes(search) && !a.acName.toLowerCase().includes(search)) return false;
        if (currentCategory !== 'all' && currentCategory !== 'low' && currentCategory !== 'reserved') {
          if (a.acSetOfItem !== currentCategory) return false;
        }
        if (currentCategory === 'low') {
          const s = (stanjeRadnja[a.acIdent]?.stock) || 0;
          const m = minStanje[a.acIdent] || 0;
          if (!(m > 0 && s < m)) return false;
        }
        if (currentCategory === 'reserved') {
          const cmRes = (stanjeCM[a.acIdent]?.reserved) || 0;
          const radRes = (stanjeRadnja[a.acIdent]?.reserved) || 0;
          if (cmRes <= 0 && radRes <= 0) return false;
        }
        return true;
      });
      
      document.getElementById('productsCount').textContent = filtered.length;
      
      if (filtered.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="icon">üîç</div><p>Nema artikala</p></div>';
        return;
      }
      
      list.innerHTML = filtered.map(a => {
        // CM stanje
        const cmStock = (stanjeCM[a.acIdent]?.stock) || 0;
        const cmReserved = (stanjeCM[a.acIdent]?.reserved) || 0;
        const cmAvailable = cmStock - cmReserved;
        
        // Radnja stanje
        const radStock = (stanjeRadnja[a.acIdent]?.stock) || 0;
        const radReserved = (stanjeRadnja[a.acIdent]?.reserved) || 0;
        const radAvailable = radStock - radReserved;
        
        const min = minStanje[a.acIdent] || 0;
        const isLow = min > 0 && radStock < min;
        const hasReserved = cmReserved > 0 || radReserved > 0;
        const inCart = cart.find(c => c.sifra === a.acIdent);
        const cartQty = inCart ? inCart.kolicina : (isLow ? Math.max(1, min - radStock) : 1);
        
        // CSS klase za row
        let rowClasses = 'product-row';
        if (inCart) rowClasses += ' in-cart';
        if (isLow) rowClasses += ' low-stock';
        else if (hasReserved) rowClasses += ' has-reserved';
        
        return `
          <div class="${rowClasses}">
            <div class="product-code">${escapeHtml(a.acIdent)}</div>
            <div class="product-info">
              <div class="product-name">${escapeHtml(a.acName)}</div>
              <div class="product-unit">${escapeHtml(a.acUM) || 'KOM'}</div>
            </div>
            
            <div class="stock-info-container">
              <!-- CM Stanje -->
              <div class="stock-card cm">
                <div class="stock-card-header">CM</div>
                <div class="stock-card-body">
                  ${cmReserved > 0 ? `
                    <div class="stock-row">
                      <span class="stock-label">Ukupno:</span>
                      <span class="stock-value total">${formatNumber(cmStock)}</span>
                    </div>
                    <div class="stock-row">
                      <span class="stock-label">Rez:</span>
                      <span class="stock-value reserved">${formatNumber(cmReserved)}</span>
                    </div>
                    <div class="stock-divider"></div>
                    <div class="stock-row">
                      <span class="stock-label">Rasp:</span>
                      <span class="stock-value available ${cmAvailable <= 0 ? 'zero' : cmAvailable < 10 ? 'low' : ''}">${formatNumber(cmAvailable)}</span>
                    </div>
                  ` : `
                    <div class="stock-value available ${cmStock <= 0 ? 'zero' : ''}" style="font-size: 18px; margin-top: 4px;">${formatNumber(cmStock)}</div>
                  `}
                </div>
              </div>
              
              <!-- Radnja Stanje -->
              ${selectedRadnja ? `
                <div class="stock-card radnja ${radReserved > 0 ? 'has-reserved' : ''}">
                  <div class="stock-card-header">${escapeHtml(selectedRadnja.substring(0, 8))}</div>
                  <div class="stock-card-body">
                    ${radReserved > 0 ? `
                      <div class="stock-row">
                        <span class="stock-label">Ukupno:</span>
                        <span class="stock-value total">${formatNumber(radStock)}</span>
                      </div>
                      <div class="stock-row">
                        <span class="stock-label">Rez:</span>
                        <span class="stock-value reserved">${formatNumber(radReserved)}</span>
                      </div>
                      <div class="stock-divider"></div>
                      <div class="stock-row">
                        <span class="stock-label">Rasp:</span>
                        <span class="stock-value available ${radAvailable <= 0 ? 'zero' : isLow ? 'low' : ''}">${formatNumber(radAvailable)}</span>
                      </div>
                    ` : `
                      <div class="stock-value available ${radStock <= 0 ? 'zero' : isLow ? 'low' : ''}" style="font-size: 18px; margin-top: 4px;">${formatNumber(radStock)}</div>
                    `}
                  </div>
                </div>
              ` : ''}
            </div>
            
            <div class="product-actions">
              ${isLow ? '<span class="badge badge-low">Ispod min.</span>' : ''}
              ${hasReserved ? '<span class="badge badge-reserved">üîí Rez.</span>' : ''}
              <input type="number" class="qty-input-small" id="qty-${a.acIdent}" value="${cartQty}" min="0.001" step="0.001">
              <button class="add-btn ${inCart ? 'added' : ''}" onclick="toggleProduct('${a.acIdent}')">
                ${inCart ? '‚úì Dodato' : '+ Dodaj'}
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ==================== CART ====================
    function toggleProduct(sifra) {
      const artikal = artikli.find(a => a.acIdent === sifra);
      if (!artikal) return;
      
      const existing = cart.find(c => c.sifra === sifra);
      const qtyInput = document.getElementById('qty-' + sifra);
      const qty = parseFloat(qtyInput?.value) || 1;
      
      if (existing) {
        cart = cart.filter(c => c.sifra !== sifra);
        showAlert('Uklonjeno iz korpe', 'info');
      } else {
        cart.push({ 
          sifra, 
          naziv: artikal.acName, 
          jm: artikal.acUM || 'KOM', 
          kolicina: qty 
        });
        showAlert('Dodato u korpu', 'success');
      }
      
      updateCartUI();
      renderProducts();
    }
    
    function updateCartUI() {
      document.getElementById('cartCount').textContent = cart.length;
      document.getElementById('totalQty').textContent = cart.reduce((sum, c) => sum + c.kolicina, 0).toFixed(1);
      updateSubmitBtn();
    }
    
    function updateSubmitBtn() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = cart.length === 0 || !selectedRadnja;
    }
    
    function openCartModal() {
      const modal = document.getElementById('cartModal');
      const body = document.getElementById('cartModalBody');
      document.getElementById('cartModalCount').textContent = cart.length;
      
      if (cart.length === 0) {
        body.innerHTML = '<div class="empty-state"><div class="icon">üõí</div><p>Korpa je prazna</p></div>';
      } else {
        body.innerHTML = cart.map((c, i) => `
          <div class="cart-item">
            <div class="cart-item-info">
              <div class="cart-item-name">${escapeHtml(c.naziv)}</div>
              <div class="cart-item-code">${escapeHtml(c.sifra)}</div>
            </div>
            <div class="cart-item-controls">
              <input type="number" class="cart-item-qty" value="${c.kolicina}" min="0.001" step="0.001" onchange="updateCartQty(${i}, this.value)">
              <span class="cart-item-unit">${escapeHtml(c.jm)}</span>
              <button class="cart-item-remove" onclick="removeFromCart(${i})">√ó</button>
            </div>
          </div>
        `).join('');
      }
      
      modal.classList.remove('hidden');
    }
    
    function closeCartModal() {
      document.getElementById('cartModal').classList.add('hidden');
    }
    
    function updateCartQty(index, value) {
      cart[index].kolicina = parseFloat(value) || 1;
      updateCartUI();
    }
    
    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartUI();
      openCartModal();
      renderProducts();
    }
    
    function clearCart() {
      cart = [];
      updateCartUI();
      closeCartModal();
      renderProducts();
      showAlert('Korpa ispra≈ænjena', 'info');
    }
    
    // ==================== SUGGESTIONS ====================
    function openSuggestions() {
      const modal = document.getElementById('suggestionsModal');
      const body = document.getElementById('suggestionsBody');
      
      body.innerHTML = suggestions.map(s => `
        <div class="cart-item">
          <div class="cart-item-info">
            <div class="cart-item-name">${escapeHtml(s.acName)}</div>
            <div class="cart-item-code">${escapeHtml(s.acIdent)} | Trenutno: ${formatNumber(s.trenutno)} | Min: ${formatNumber(s.min)}</div>
          </div>
          <div class="cart-item-controls">
            <input type="number" class="cart-item-qty" id="sug-${s.acIdent}" value="${s.potrebno}" min="1" step="1">
            <span class="cart-item-unit">${escapeHtml(s.acUM) || 'KOM'}</span>
          </div>
        </div>
      `).join('');
      
      modal.classList.remove('hidden');
    }
    
    function closeSuggestions() {
      document.getElementById('suggestionsModal').classList.add('hidden');
    }
    
    function addAllSuggestions() {
      suggestions.forEach(s => {
        const qty = parseFloat(document.getElementById('sug-' + s.acIdent)?.value) || s.potrebno;
        const existing = cart.find(c => c.sifra === s.acIdent);
        if (!existing) {
          cart.push({ sifra: s.acIdent, naziv: s.acName, jm: s.acUM || 'KOM', kolicina: qty });
        }
      });
      updateCartUI();
      closeSuggestions();
      renderProducts();
      showAlert(`Dodato ${suggestions.length} artikala`, 'success');
    }
    
    // ==================== SUBMIT TREBOVANJE ====================
    async function submitTrebovanje() {
      if (cart.length === 0 || !selectedRadnja) return;
      
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Slanje...';
      
      try {
        const res = await fetch(API + '/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ radnja: selectedRadnja, stavke: cart })
        });
        
        const result = await res.json();
        
        if (result.success) {
          showAlert(`Trebovanje ${result.trebovanjeKey || ''} uspe≈°no kreirano!`, 'success');
          cart = [];
          updateCartUI();
          closeCartModal();
          renderProducts();
        } else {
          showAlert('Gre≈°ka: ' + (result.error || 'Nepoznata gre≈°ka'), 'error');
        }
      } catch (err) {
        showAlert('Gre≈°ka pri slanju: ' + err.message, 'error');
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üì§ Po≈°alji trebovanje';
        updateSubmitBtn();
      }
    }
    
    // ==================== TREBOVANJA LIST ====================
    async function loadTrebovanja() {
      const body = document.getElementById('trebovanjaBody');
      body.innerHTML = '<tr><td colspan="6" class="loading-spinner">Uƒçitavanje</td></tr>';
      
      try {
        const res = await fetch(API + '/lista');
        trebovanjaList = await res.json();
        
        document.getElementById('countAll').textContent = trebovanjaList.length;
        document.getElementById('countN').textContent = trebovanjaList.filter(t => normalizeStatus(t.status) === 'N').length;
        document.getElementById('countT').textContent = trebovanjaList.filter(t => normalizeStatus(t.status) === 'T').length;
        document.getElementById('countZ').textContent = trebovanjaList.filter(t => normalizeStatus(t.status) === 'Z').length;
        
        renderTrebovanjaList();
      } catch (err) {
        body.innerHTML = '<tr><td colspan="6" style="color:#f87171;text-align:center;padding:40px;">Gre≈°ka pri uƒçitavanju</td></tr>';
        console.error(err);
      }
    }
    
    function renderTrebovanjaList() {
      const body = document.getElementById('trebovanjaBody');
      
      let filtered = trebovanjaList;
      if (currentStatusFilter) {
        filtered = trebovanjaList.filter(t => normalizeStatus(t.status) === currentStatusFilter);
      }
      
      if (filtered.length === 0) {
        body.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#64748b;">Nema trebovanja</td></tr>';
        return;
      }
      
      body.innerHTML = filtered.map(t => {
        const trebovanjeKey = t.acKey || t.id;
        const datum = t.adDate || t.kreirano || t.azurirano;
        const status = normalizeStatus(t.status);
        const statusName = STATUS_NAMES[status] || t.status;
        const canSend = status === 'N';
        const canReceive = status === 'T';
        
        return `
          <tr>
            <td style="font-family: monospace; font-weight: 600;">${escapeHtml(String(trebovanjeKey))}</td>
            <td>${escapeHtml(t.radnja)}</td>
            <td>${formatDate(datum)}</td>
            <td>${t.stavke_count || '-'}</td>
            <td><span class="status-badge status-${status}">${statusName}</span></td>
            <td class="actions-cell">
              <button class="btn btn-secondary btn-sm" onclick="viewTrebovanje('${escapeHtml(String(trebovanjeKey))}')">üëÅÔ∏è</button>
              ${canSend ? `<button class="btn btn-warning btn-sm" onclick="posaljiRobu('${escapeHtml(String(trebovanjeKey))}')">üöö Po≈°alji</button>` : ''}
              ${canReceive ? `<button class="btn btn-success btn-sm" onclick="viewTrebovanjeZaPrijem('${escapeHtml(String(trebovanjeKey))}')">üì• Primi</button>` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function normalizeStatus(status) {
      if (!status) return 'N';
      const s = String(status).toUpperCase();
      if (s === 'NOVO' || s === 'N') return 'N';
      if (s === 'NA PUTU' || s === 'NA_PUTU' || s === 'T' || s === 'POSLATO') return 'T';
      if (s === 'ZAVR≈†ENO' || s === 'ZAVRSENO' || s === 'Z' || s === 'PRIMLJENO') return 'Z';
      return 'N';
    }
    
    // ==================== TREBOVANJE DETAIL ====================
    async function viewTrebovanje(key) {
      const modal = document.getElementById('trebovanjeModal');
      const body = document.getElementById('trebovanjeModalBody');
      const footer = document.getElementById('trebovanjeModalFooter');
      const title = document.getElementById('trebovanjeModalTitle');
      
      modal.classList.remove('hidden');
      body.innerHTML = '<div class="loading-spinner">Uƒçitavanje</div>';
      footer.innerHTML = '';
      title.textContent = 'üìã Trebovanje ' + key;
      
      try {
        let data;
        try {
          const res = await fetch(API + '/detalji/' + encodeURIComponent(key));
          if (res.ok) {
            data = await res.json();
          } else {
            throw new Error('Novi endpoint nije dostupan');
          }
        } catch (e) {
          const res = await fetch(API + '/' + encodeURIComponent(key));
          data = await res.json();
        }
        
        currentTrebovanje = data;
        
        const zaglavlje = data.zaglavlje || data;
        const stavke = data.stavke || zaglavlje.stavke || [];
        const rezervacije = data.rezervacije || [];
        
        const trebovanjeKey = zaglavlje.acKey || zaglavlje.id;
        const radnja = zaglavlje.radnja;
        const status = normalizeStatus(zaglavlje.status);
        const statusName = STATUS_NAMES[status] || zaglavlje.status;
        const datumKreirano = zaglavlje.adTimeCreated || zaglavlje.kreirano;
        const datumPoslato = zaglavlje.adTimeSent || zaglavlje.poslato;
        const datumPrimljeno = zaglavlje.adTimeReceived || zaglavlje.primljeno;
        
        body.innerHTML = `
          <div class="detail-header">
            <div>
              <div class="detail-title">#${escapeHtml(String(trebovanjeKey))}</div>
              <div class="detail-meta">${escapeHtml(radnja)}</div>
            </div>
            <span class="status-badge status-${status}">${statusName}</span>
          </div>
          
          <div class="detail-info-grid">
            <div class="detail-info-item">
              <div class="detail-info-label">Kreirano</div>
              <div class="detail-info-value">${formatDateTime(datumKreirano)}</div>
            </div>
            <div class="detail-info-item">
              <div class="detail-info-label">Poslato</div>
              <div class="detail-info-value">${formatDateTime(datumPoslato) || '-'}</div>
            </div>
            <div class="detail-info-item">
              <div class="detail-info-label">Primljeno</div>
              <div class="detail-info-value">${formatDateTime(datumPrimljeno) || '-'}</div>
            </div>
          </div>
          
          <h4 style="margin-bottom:12px;">üì¶ Stavke (${stavke?.length || 0})</h4>
          <div class="stavka-list">
            ${stavke?.map(s => `
              <div class="stavka-item">
                <div class="stavka-info">
                  <div class="stavka-name">${escapeHtml(s.acName || s.naziv)}</div>
                  <div class="stavka-code">${escapeHtml(s.acIdent || s.sifra)}</div>
                </div>
                <div class="stavka-qty">${formatNumber(s.anQty || s.kolicina, 3)} ${escapeHtml(s.acUM || s.jm || 'KOM')}</div>
              </div>
            `).join('') || '<p style="color:#64748b;">Nema stavki</p>'}
          </div>
          
          ${rezervacije?.length > 0 ? `
            <h4 style="margin: 20px 0 12px;">üîí Rezervacije</h4>
            <div class="stavka-list">
              ${rezervacije.map(r => `
                <div class="stavka-item" style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b;">
                  <div class="stavka-info">
                    <div class="stavka-name">${escapeHtml(r.IDENT)}</div>
                    <div class="stavka-code">${escapeHtml(r.SKLADISCE)}</div>
                  </div>
                  <div class="stavka-qty" style="color: #f59e0b;">${formatNumber(r.KOLICINA, 3)}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          ${zaglavlje.acTransferKey ? `
            <div style="margin-top:20px;padding:12px;background:#065f46;border-radius:8px;">
              <strong>‚úÖ Prenos kreiran:</strong> ${escapeHtml(zaglavlje.acTransferKey)}
            </div>
          ` : ''}
        `;
        
        if (status === 'N') {
          footer.innerHTML = `
            <button class="btn btn-secondary" onclick="closeTrebovanjeModal()">Zatvori</button>
            <button class="btn btn-warning" onclick="posaljiRobu('${escapeHtml(String(trebovanjeKey))}')">üöö Po≈°alji robu</button>
          `;
        } else if (status === 'T') {
          footer.innerHTML = `
            <button class="btn btn-secondary" onclick="closeTrebovanjeModal()">Zatvori</button>
            <button class="btn btn-success" onclick="viewTrebovanjeZaPrijem('${escapeHtml(String(trebovanjeKey))}')">üì• Primi robu</button>
          `;
        } else {
          footer.innerHTML = `
            <button class="btn btn-secondary" onclick="closeTrebovanjeModal()">Zatvori</button>
          `;
        }
        
      } catch (err) {
        body.innerHTML = '<p style="color:#f87171;text-align:center;padding:40px;">Gre≈°ka pri uƒçitavanju: ' + escapeHtml(err.message) + '</p>';
        console.error(err);
      }
    }
    
    // ==================== PRIJEM ROBE ====================
    async function viewTrebovanjeZaPrijem(key) {
      const modal = document.getElementById('trebovanjeModal');
      const body = document.getElementById('trebovanjeModalBody');
      const footer = document.getElementById('trebovanjeModalFooter');
      const title = document.getElementById('trebovanjeModalTitle');
      
      modal.classList.remove('hidden');
      body.innerHTML = '<div class="loading-spinner">Uƒçitavanje</div>';
      footer.innerHTML = '';
      title.textContent = 'üì• Prijem robe - ' + key;
      izmeneStavki = {};
      
      try {
        let data;
        try {
          const res = await fetch(API + '/detalji/' + encodeURIComponent(key));
          if (res.ok) {
            data = await res.json();
          } else {
            throw new Error('Novi endpoint nije dostupan');
          }
        } catch (e) {
          const res = await fetch(API + '/' + encodeURIComponent(key));
          data = await res.json();
        }
        
        currentTrebovanje = data;
        
        const zaglavlje = data.zaglavlje || data;
        const stavke = data.stavke || zaglavlje.stavke || [];
        
        const trebovanjeKey = zaglavlje.acKey || zaglavlje.id;
        const radnja = zaglavlje.radnja;
        const datumPoslato = zaglavlje.adTimeSent || zaglavlje.poslato || zaglavlje.azurirano;
        
        body.innerHTML = `
          <div class="detail-header">
            <div>
              <div class="detail-title">#${escapeHtml(String(trebovanjeKey))}</div>
              <div class="detail-meta">${escapeHtml(radnja)} ‚Ä¢ Poslato: ${formatDateTime(datumPoslato)}</div>
            </div>
            <span class="status-badge status-T">NA PUTU</span>
          </div>
          
          <div style="background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
            <p style="font-size: 13px; color: #94a3b8;">
              üí° <strong>Uputstvo:</strong> Proverite primljene koliƒçine. Ako se razlikuju od poslatih, unesite stvarno primljenu koliƒçinu i izaberite razlog.
            </p>
          </div>
          
          <h4 style="margin-bottom:12px;">üì¶ Stavke za prijem</h4>
          <div class="stavka-list" id="stavkeZaPrijem">
            ${stavke?.map((s, index) => {
              const itemNo = s.anNo || (index + 1);
              const sifra = s.acIdent || s.sifra;
              const naziv = s.acName || s.naziv;
              const kolicina = s.anQty || s.kolicina;
              const jm = s.acUM || s.jm || 'KOM';
              const receivedQty = s.anReceivedQty !== undefined ? s.anReceivedQty : kolicina;
              const hasExistingChange = s.acReason ? true : false;
              
              return `
                <div class="stavka-item ${hasExistingChange ? 'changed' : ''}" id="stavka-${itemNo}">
                  <div class="stavka-info">
                    <div class="stavka-name">${escapeHtml(naziv)}</div>
                    <div class="stavka-code">${escapeHtml(sifra)} ‚Ä¢ Poslato: <strong>${formatNumber(kolicina, 3)}</strong> ${escapeHtml(jm)}</div>
                  </div>
                  <div class="stavka-received">
                    <span style="font-size:12px;color:#94a3b8;">Primljeno:</span>
                    <input type="number" 
                           id="received-${itemNo}" 
                           value="${receivedQty}" 
                           min="0" 
                           step="0.001" 
                           onchange="onReceivedQtyChange(${itemNo}, ${kolicina}, this.value)">
                  </div>
                  <div class="stavka-reason" id="reason-container-${itemNo}" style="${Math.abs(receivedQty - kolicina) > 0.001 ? '' : 'visibility:hidden;'}">
                    <select id="reason-${itemNo}" onchange="onReasonChange(${itemNo})">
                      <option value="">-- Razlog --</option>
                      ${RAZLOZI_IZMENE.map(r => `<option value="${r.kod}" ${s.acReason === r.kod ? 'selected' : ''}>${r.naziv}</option>`).join('')}
                    </select>
                  </div>
                </div>
              `;
            }).join('') || '<p style="color:#64748b;">Nema stavki</p>'}
          </div>
        `;
        
        footer.innerHTML = `
          <button class="btn btn-secondary" onclick="closeTrebovanjeModal()">Otka≈æi</button>
          <button class="btn btn-success" onclick="potvrdiPrijem('${escapeHtml(String(trebovanjeKey))}')">‚úÖ Potvrdi prijem i kreiraj prenos</button>
        `;
        
      } catch (err) {
        body.innerHTML = '<p style="color:#f87171;text-align:center;padding:40px;">Gre≈°ka pri uƒçitavanju: ' + escapeHtml(err.message) + '</p>';
        console.error(err);
      }
    }
    
    function onReceivedQtyChange(itemNo, originalQty, newValue) {
      const newQty = parseFloat(newValue) || 0;
      const reasonContainer = document.getElementById('reason-container-' + itemNo);
      const input = document.getElementById('received-' + itemNo);
      const stavkaDiv = document.getElementById('stavka-' + itemNo);
      
      if (Math.abs(newQty - originalQty) > 0.001) {
        reasonContainer.style.visibility = 'visible';
        input.classList.add('changed');
        stavkaDiv.classList.add('changed');
        izmeneStavki[itemNo] = { receivedQty: newQty, reason: '', note: '' };
      } else {
        reasonContainer.style.visibility = 'hidden';
        input.classList.remove('changed');
        stavkaDiv.classList.remove('changed');
        delete izmeneStavki[itemNo];
      }
    }
    
    function onReasonChange(itemNo) {
      const reason = document.getElementById('reason-' + itemNo).value;
      if (izmeneStavki[itemNo]) {
        izmeneStavki[itemNo].reason = reason;
      }
    }
    
    // ==================== AKCIJE ====================
    async function posaljiRobu(key) {
      if (!confirm(`Da li ste sigurni da ≈æelite da po≈°aljete robu za trebovanje ${key}?`)) {
        return;
      }
      
      try {
        showAlert('Slanje robe...', 'info');
        
        const res = await fetch(API + '/posalji/' + encodeURIComponent(key), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: 5 })
        });
        
        const result = await res.json();
        
        if (result.success || result.Status === 'OK') {
          showAlert('Roba je poslata! Status: NA PUTU', 'success');
          closeTrebovanjeModal();
          loadTrebovanja();
        } else {
          showAlert('Gre≈°ka: ' + (result.error || result.Poruka || 'Nepoznata gre≈°ka'), 'error');
        }
      } catch (err) {
        showAlert('Gre≈°ka pri slanju: ' + err.message, 'error');
        console.error(err);
      }
    }
    
    async function potvrdiPrijem(key) {
      const izmeneKeys = Object.keys(izmeneStavki);
      for (const itemNo of izmeneKeys) {
        if (!izmeneStavki[itemNo].reason) {
          showAlert(`Unesite razlog za izmenu stavke #${itemNo}`, 'error');
          return;
        }
      }
      
      if (!confirm(`Da li ste sigurni da ≈æelite da primite robu i kreirate prenos u Pantheonu?`)) {
        return;
      }
      
      try {
        for (const itemNo of izmeneKeys) {
          const izmena = izmeneStavki[itemNo];
          showAlert(`ƒåuvanje izmene za stavku #${itemNo}...`, 'info');
          
          try {
            await fetch(API + '/izmena-kolicine', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                acOrderKey: key,
                anItemNo: parseInt(itemNo),
                anReceivedQty: izmena.receivedQty,
                acReason: izmena.reason,
                acNote: izmena.note || null,
                userId: 5
              })
            });
          } catch (e) {
            console.warn('Endpoint za izmene nije dostupan:', e);
          }
        }
        
        showAlert('Kreiranje prenosa u Pantheonu...', 'info');
        
        const res = await fetch(API + '/primi/' + encodeURIComponent(key), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: 5 })
        });
        
        const result = await res.json();
        
        if (result.success || result.Status === 'OK' || result.Status === 'SUCCESS') {
          const transferKey = result.transferKey || result.TransferKey || '';
          showAlert(`Prenos kreiran: ${transferKey}`, 'success');
          closeTrebovanjeModal();
          loadTrebovanja();
        } else {
          showAlert('Gre≈°ka: ' + (result.error || result.ErrorMessage || 'Nepoznata gre≈°ka'), 'error');
        }
      } catch (err) {
        showAlert('Gre≈°ka pri prijemu: ' + err.message, 'error');
        console.error(err);
      }
    }
    
    function closeTrebovanjeModal() {
      document.getElementById('trebovanjeModal').classList.add('hidden');
      currentTrebovanje = null;
      izmeneStavki = {};
    }
    
    // ==================== PRENOSI ====================
    async function loadPrenosi() {
      const body = document.getElementById('prenosiBody');
      body.innerHTML = '<tr><td colspan="6" class="loading-spinner">Uƒçitavanje</td></tr>';
      
      try {
        const res = await fetch(API + '/prenosi');
        const data = await res.json();
        
        if (data.length === 0) {
          body.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#64748b;">Nema prenosa</td></tr>';
          return;
        }
        
        body.innerHTML = data.map(p => `
          <tr>
            <td style="font-family: monospace; font-weight: 600;">${escapeHtml(p.acKey)}</td>
            <td>${formatDate(p.adDate)}</td>
            <td>${escapeHtml(p.acReceiver)}</td>
            <td>${formatNumber(p.anValue || 0)} RSD</td>
            <td>${p.items_count || '-'}</td>
            <td>
              <button class="btn btn-secondary btn-sm" onclick="viewPrenosDetalji('${escapeHtml(p.acKey)}')">üëÅÔ∏è Detalji</button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        body.innerHTML = '<tr><td colspan="6" style="color:#f87171;text-align:center;padding:40px;">Gre≈°ka pri uƒçitavanju</td></tr>';
        console.error(err);
      }
    }
    
    async function viewPrenosDetalji(key) {
      const modal = document.getElementById('prenosModal');
      const body = document.getElementById('prenosModalBody');
      const title = document.getElementById('prenosModalTitle');
      
      modal.classList.remove('hidden');
      body.innerHTML = '<div class="loading-spinner">Uƒçitavanje</div>';
      title.textContent = 'üìÑ Prenos ' + key;
      
      try {
        const res = await fetch(API + '/prenos/' + encodeURIComponent(key));
        const data = await res.json();
        
        const { zaglavlje, stavke } = data;
        
        body.innerHTML = `
          <div class="detail-info-grid">
            <div class="detail-info-item">
              <div class="detail-info-label">Izdavalac</div>
              <div class="detail-info-value">${escapeHtml(zaglavlje?.acIssuer)}</div>
            </div>
            <div class="detail-info-item">
              <div class="detail-info-label">Primalac</div>
              <div class="detail-info-value">${escapeHtml(zaglavlje?.acReceiver)}</div>
            </div>
            <div class="detail-info-item">
              <div class="detail-info-label">Datum</div>
              <div class="detail-info-value">${formatDate(zaglavlje?.adDate)}</div>
            </div>
            <div class="detail-info-item">
              <div class="detail-info-label">Vrednost</div>
              <div class="detail-info-value">${formatNumber(zaglavlje?.anValue)} RSD</div>
            </div>
          </div>
          
          <h4 style="margin: 20px 0 12px;">üì¶ Stavke (${stavke?.length || 0})</h4>
          <div class="stavka-list">
            ${stavke?.map(s => `
              <div class="stavka-item">
                <div class="stavka-info">
                  <div class="stavka-name">${escapeHtml(s.acName)}</div>
                  <div class="stavka-code">${escapeHtml(s.acIdent)}</div>
                </div>
                <div style="text-align:right;">
                  <div class="stavka-qty">${formatNumber(s.anQty, 2)} ${escapeHtml(s.acUM)}</div>
                  <div style="font-size:12px;color:#94a3b8;">${formatNumber(s.anPrice)} RSD</div>
                </div>
              </div>
            `).join('') || '<p style="color:#64748b;">Nema stavki</p>'}
          </div>
        `;
        
      } catch (err) {
        body.innerHTML = '<p style="color:#f87171;text-align:center;padding:40px;">Gre≈°ka pri uƒçitavanju</p>';
        console.error(err);
      }
    }
    
    function closePrenosModal() {
      document.getElementById('prenosModal').classList.add('hidden');
    }
    
    // ==================== ALERTS ====================
    function showAlert(message, type = 'success') {
      const alert = document.getElementById('alert');
      const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ' };
      
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `${icons[type] || ''} ${escapeHtml(message)}`;
      alert.classList.remove('hidden');
      
      if (alert.timeoutId) clearTimeout(alert.timeoutId);
      
      if (type !== 'info') {
        alert.timeoutId = setTimeout(() => alert.classList.add('hidden'), 4000);
      }
    }
  </script>
</body>
</html>
